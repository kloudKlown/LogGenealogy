define("dropbox",["modules/core/controller_registry","modules/clean/browse_interface","modules/clean/react/previews/preview_linkfile","modules/clean/base64","modules/clean/previews/file_view_rams_common","modules/core/uri","modules/clean/file_events","modules/clean/previews/preview_actions_helper","modules/clean/em_string","modules/core/exception","libs","modules/clean/uirequest","modules/clean/history","modules/clean/sharing/shared_link_modal","external/underscore","modules/clean/ajax","modules/clean/sso_login_checks","modules/core/notify","external/swfobject","modules/clean/display_format","modules/clean/search/search_helpers","modules/clean/job_progress","modules/clean/pagination_manager","modules/clean/notifications/file_watcher","modules/clean/previews/pdf_loader","modules/constants/viewer","modules/clean/sharing/get_editable_link_prompt","modules/clean/people/experiments/link_profile_service_modal","modules/clean/account/email","modules/clean/dbmodal","modules/clean/events/rollback","external/backbone","modules/clean/react/previews/preview_image_zoom","modules/clean/sharing/api","modules/clean/event_load","modules/clean/contacts/facebook_modal","modules/clean/contacts/facebook_oauth","modules/clean/components/role_picker","external/plupload_dev","modules/clean/react/previews/preview_video","external/keymaster","modules/clean/image_size","modules/clean/viewer","modules/constants/python","modules/clean/sprite","modules/clean/dbmodal_loading","modules/clean/undo","modules/clean/notserver","modules/clean/gandalf_util","modules/clean/multiaccount_login","modules/clean/datetime","modules/clean/video_util","modules/clean/react/previews/preview_flippable","modules/clean/contacts/types","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/react/activity/comment_count_bubble","modules/clean/db_bubble","external/flash_detect","external/purify","modules/clean/sharing/share_inband","modules/dirty/react/file_viewer/controller","modules/constants/env","modules/clean/sharing/shared_folder_settings_modal","jquery","modules/core/ordered_dictionary","modules/clean/components/bubble_picker","external/modernizr","modules/clean/teams/team_folder_modal","modules/clean/components/ajax_form","modules/clean/react/invite/invite_form_react","modules/clean/browse_events","modules/clean/react/modal","modules/clean/contacts/list","modules/clean/profile_services/profile_services_link","modules/core/i18n","modules/clean/top_notif","modules/core/dom","modules/clean/web_timing_logger","modules/clean/payments/credit_card_util","modules/clean/react/previews/preview_image","modules/clean/form","modules/core/cookies","modules/clean/clipboard","modules/clean/payments/cash","modules/clean/browse/browse_drag_utils","modules/clean/account/email_verify_reasons","modules/clean/react/hierarchical_nav_bar","modules/clean/payments/dfb_util","modules/clean/search/search_type","external/jquery_ui","modules/clean/contacts/cache","modules/clean/frame_messenger","modules/clean/analytics","modules/clean/photos/legacy_thumb_loader","modules/core/browser","modules/clean/react/previews/preview_blank","modules/clean/filepath","modules/core/html","modules/clean/static_urls"],function(bV,fh,bG,ak,bT,G,aH,m,bS,d9,cj,bw,eB,aI,bv,cC,b6,ah,c1,aF,ap,z,fj,aa,ax,a8,B,b,cV,c6,at,ei,dg,e5,an,eb,eo,dl,p,a6,e2,ai,cK,aW,cv,cB,X,cP,az,bM,b4,br,M,W,dA,c0,a4,aC,eW,cY,dN,eZ,fi,ae,bD,aZ,by,d,dU,cf,ab,dL,co,o,c8,bj,ct,C,ee,e4,cx,ba,bu,t,dQ,cL,ep,aX,c2,eA,eE,em,er,a9,bq,bZ,H,aA,ff,aM){var E={};var S=bG.PreviewLinkfile;var cN=m.LegacyFilePreviewActions;var eU=m.LegacyFileViewerActions;var b8=d9.alertd;var cJ=d9.assert;var eK=d9.reportException;var eL=d9.stackTrace;var dj=z.Job;var ez=z.ModalProgress;var cw=b.LinkProfileServiceModal;var av=cV.ChangeEmail;var d1=cV.EmailVerification;var d5=c6.DBModal;var dY=c6.DBModalStack;var dk=c6.DBUserModal;var aV=dg.PreviewImageZoom;var bk=e5.SharingApi;var cp=e5.UserlessSharingApi;var dZ=dl.RolePickerState;var eh=a6.PreviewVideo;var aG=ai.image_best_fit_size;var bN=cP.NotServer;var d6=cP.NotClients;var d2=M.PreviewFlippable;var c5=a4.CommentCountBubbleFactory;var dK=co.SimpleModal;var bi=c8.LinkedProfileServices;var d8=c8.ProfileServicesLinkingHandler;var bb=bj.ungettext;var ey=bj._;var dG=bj.N_;var F=bj.E_;var e8=bj.render_sentences;var e6=ct.TopNotificationBar;var eN=ct.EUCookieNotificationBar;var r=ct.ExpiredIOSNotificationBar;var ed=ct.PackratUnlimitedOptInNotificationBar;var cg=ct.DfBAdminEarlyAccessSharingControlsBar;var cc=ct.DfBAdminEarlyAccessFtsBar;var aQ=ct.LocaleSwitchBar;var eX=ct.SuperInactiveRecoverBar;var x=cx.PreviewImage;var bh=dQ.Cash;var fd=dQ.CashUtil;var dH=aX.HierarchicalNavBar;var fe=c2.DfBTransitionInfoFetcher;var cI=em.ContactsCache;var bY=em.DefaultContactsCache;var ef,e3,dc;INLINE_JS.$=$;INLINE_JS.$u=bv;Function.prototype.defer=Function.prototype.defer.wrap(function(j){var i;i=$A(arguments).slice(1);this.__tb__=eL();return j.apply(this,i)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(T){var j,fk,i;j=$A(arguments).slice(1);try{return T.apply(this,j)}catch(i){fk=i;return cJ(0,fk.toString())}});ef=E.Jcached={cache:{},set:function(j,T,i){var fk;fk=ef.cache[j];if(fk==null){fk=ef.cache[j]={}}fk.value=T;return fk.expires=i?new Date().getTime()+i:0},get:function(i){var j;j=ef.cache[i];if((j==null)||new Date().getTime()>j.expires){delete ef.cache[i];return false}return j.value}};Function.prototype.cached=function(i){var T,j;j=Math.random();T=this;return function(){var fk;fk=ef.get(j);if(fk!==false){return fk}fk=T();ef.set(j,fk,i);return fk}};Array.prototype.sort_by_key=function(j,T){var i;if(T==null){T=false}i=T?-1:1;return this.sort(function(fk,fl){fk=j(fk);fl=j(fl);if(fk<fl){return i*-1}else{if(fk>fl){return i*1}else{return 0}}})};Array.prototype.contains=function(i){return this.indexOf(i)!==-1};Array.prototype.remove=function(j,i){i=i||j+1;return this.splice(j,i-j)};Array.prototype.removeItem=function(j){var i;i=this.indexOf(j);if(i>=0){return this.remove(i)}else{return false}};Array.prototype.dict_by=function(fk){var fn,fo,fm,T,fl;fl={};for(fn=fm=0,T=this.length;fm<T;fn=++fm){fo=this[fn];fl[this[fn][fk]]=this[fn]}return fl};Array.prototype.unique=function(){var fm,fl,T,i,fk;fm={};for(T=0,i=this.length;T<i;T++){fl=this[T];if(typeof fl!=="string"){return this}fm[fl]=0}fk=[];for(fl in fm){fk.push(fl)}return fk};String.prototype.widthSplit=function(fk){var i,T,j,fl;if(fk==null){fk=15}i=[];T=this;fl=0;j=T.substring(fl,fl+fk);while(j!==""){i.push(j);fl+=fk;j=T.substring(fl,fl+fk)}return i};Object.extend(Effect.Transitions,{EaseIn:function(i){return Math.pow(i,2)},EaseOut:function(i){return Math.pow(i,0.5)}});(function(T){var i,j;j=function(fp){var fk,fs,fm,fl,fo,fn,fr,fq,ft;if(fp){if(Object.isArray(fp)){fk=[];for(fm=0,fo=fp.length;fm<fo;fm++){fs=fp[fm];fk.push(ff.escape(fs).toHTML())}fp=new ff(fk.join(""))}else{if(fp.top||fp.bottom||fp.before||fp.after){fq=["top","bottom","before","after"];for(fl=0,fn=fq.length;fl<fn;fl++){fr=fq[fl];ft=fp[fr];if(ft){fp[fr]=arguments.callee(ft)}}}else{if(d3.isElm(fp)||fp.toElement||fp.toHTML){}else{fp=ff.escape(fp)}}}}return fp};return Element.addMethods({db_observe:function(fl,fk,fm){return fl.observe(fk,function(fn){return fm(fn,fl)})},smoothScrollIntoView:function(fn,fm){var fr,fl,fk,fq,fp,fo;if(fm==null){fm={}}fr={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};fm=Object.extend(fr,fm);fk=fn.viewportOffset(fn);fl=fn.getDimensions();fo=document.viewport.getDimensions();fp=fm.padding||0;if(fk.top>fp&&(fk.top+fl.height)<(fo.height-fp)){return}fq=fk.top<fp?-1*Math.floor(fo.height/4):-1*Math.floor(3*fo.height/4);fm.offset=fm.offset||fq;return new Effect.ScrollTo(fn,fm)},__sert:function(fk,fl){return Element.insert(fk,j(fl))},__date:function(fk,fl){return Element.update(fk,j(fl))},replace:i=function(fk,fl){return T(fk,j(fl))}})})(Element.replace);e3=function(i){if(i!=null?i.target:void 0){try{return document.activeElement=i.target===document?null:i.target}catch(j){}}};dc=function(i){try{return document.activeElement=null}catch(j){}};if(document.addEventListener){document.addEventListener("focus",e3,true);document.addEventListener("blur",dc,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(j,i){var T;if(i==null){i="0"}T=this;while(T.length<j){T=i+T}return T.toString()};String.prototype.reverse=function(){var T,j,i;i=this.split("");j=i.reverse();T=j.join("");return T};String.prototype.count=function(i){return(this.length-this.gsub(i,"").length)/i.length};String.prototype.repeat=function(i){return(new Array(i+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,fm,fk){var ft,fr,fw,fv,fy,fx,fo,T,i,fu,fp,fl,fn,fs,fq;if(fk==null){fk={}}this.orig_req={url:fm,options:fk};this.start_time=b4.time();fk.method=fk.method||"post";fk.evalJS=false;fk.suppress_nonstandard_headers=true;fk.parameters=fk.parameters||{};fk.parameters.t=bu.read(Constants.JS_CSRF_COOKIE);fk.parameters.is_xhr=true;if(fk.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){fk.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){fk.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){fk.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){fk.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&fm.indexOf("/")===0){fk.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){fk.parameters.restrict=Ajax.DBRequest.restrict}fr=fk.cleanUp||(function(){});this.subject_user=fk.subject_user||fk.job_user;if(fk.job){this.job_id=d3.nonce();fk.parameters.job_id=this.job_id;ea.watch(this,fk.dont_hide_progress_on_complete)}if(!fk.no_watch){ar.watch(this,!!fk.job)}fu=fk.onFailure;fp=fk.onSuccess;i=fk.onComplete;T=(function(j){return function(fA){var fz,fB;if(fk.parameters.xhr_retry||!fk.allow_retries){return false}if((fz=fA.status)===0||fz===500||fz===502||fz===503){j.orig_req.options.parameters.xhr_retry=true;j.orig_req.options.onFailure=fu;j.orig_req.options.onSuccess=fp;fB=new Ajax.DBRequest(j.orig_req.url,j.orig_req.options);return true}return false}})(this);fk.onFailure=function(fA){var fB,fz,j;if(dj.handled(fA.request.job_id)){return}if(T(fA)){return}if(!fk.noAutonotify){if(!Constants.IS_PROD&&fA.status===500&&fA.getHeader("X-Debug-Url")){fm=fA.getHeader("X-Debug-Url");fB=ey("There was a problem completing this request.")+(' <a href="'+fm+'" target="_blank">View debug</a>');ah.error(new ff(fB))}else{ah.error()}}fr(false);if(fu){fu(fA)}if(fA.status===403){j=d3.session_storage_get("reload-timestamp");if(!j||b4.time()-j>30*1000){d3.session_storage_set("reload-timestamp",b4.time());location.reload(true)}}return cJ(fk.noAutonotify||((fz=fA.status)===403||fz===404||fz===502),"Ajax "+fA.status+" on "+fA.request.url)};fk.onComplete=(function(j){return function(fz){if(fz.responseText.length&&i){if(fz.responseText.indexOf("async_task_started:")!==0){return i(fz)}}}})(this);fk.onSuccess=(function(j){return function(fz){var fA,fJ,fP,fR,fI,fN,fO,fC,fL,fB,fD,fH,fK,fF,fM,fQ,fG,fE;fE=b4.time()-fz.request.start_time;if(dj.handled(fz.request.job_id)){return}if(!fz.responseText.length){if(!fk.job){if(T(fz)){return}if(!fk.noAutonotify){if(!fz||fz.status!==0){ah.error()}}if(fu){fu(fz)}}}else{if(fz.responseText.indexOf("err:")===0){if(!fk.noAutonotify){fC=fz.responseText.substr(4);if(fk.html_in_error_msg){fC=new ff(fC)}ah.error(fC)}if(fu){fu(fz)}}else{if(fz.responseText.indexOf("async_task_started:")===0){j.async_task_id=fz.responseText.split(":")[1];ea.watch(j)}else{if(fp){if(fz.responseText.indexOf("ok:")===0){ah.success(fz.responseText.substr(3))}fp(fz)}}fG=fz.getHeader("X-Server-Response-Time")||"-1";if(fk.log_timing){ee.log_ajax_transition.defer(fE,void 0,void 0,void 0,fG,fm=bc.absolutize(j.url))}fJ=bD("#cprofile");if(!fk.no_watch&&fJ.length){fF=Constants.REQUEST_ID+"-"+(fz.getHeader("X-Dropbox-Request-Id"));fm=fz.request.url.replace(/[^\/]*\/\/[^\/]+/,"").replace(/\?.*$/,"");fB={request_id:fF};fK=fz.request.url;if(fK.indexOf(Constants.BLOCK_CLUSTER)!==-1){fB.block=1}else{fD=Constants.BATCH_THUMB_ENDPOINTS;for(fN=0,fO=fD.length;fN<fO;fN++){fI=fD[fN];if(fK.indexOf(fI)!==-1){fB.block=1;break}}}fA=function(fX,fV,fU,fW){var fT,fS;if(fW){fT=bD('<a target="_blank" />')}else{fT=bD("<a />")}fS=fT.attr("href",String(G({authority:Constants.WEBSERVER,path:fV,query:fU}))).text(fX+" ");return fS};fL=[["svg","/profile/cprofile/svg",true],["pstats","/profile/cprofile/pstats",false],["callgrind","/profile/cprofile/callgrind",false],["IO","/profile/ioprofile",true],["DB","/profile/dbprofile",true]];fQ=(function(){var fS,fT,fU;fU=[];for(fS=0,fT=fL.length;fS<fT;fS++){fP=fL[fS];fU.push(fA(fP[0],fP[1],fB,fP[2]))}return fU})();fM=bD('<div class="ajax">').text("Ajax: "+fm+" ("+fG+"ms)").prepend(fQ);fR=fJ.find(".ajax");if(fR.length>=10){fR.last().remove()}fJ.prepend(fM)}if(bD("#gandalf_panel").length&&fz.request.url.substring(0,14)!=="/gandalf_panel"){if((fH=window.gandalf_panel)!=null){fH.add(fz.request.url,fz.getHeader("X-Dropbox-Request-Id"))}}}}return fr(true)}})(this);fk.onException=function(fz,fA){var fB,j;if(window.console){throw fA}fB=("Error with AJAX callback for: "+fm+" :::: ")+fA.toString();j=eL();j.pop();return eK(fB,bZ.get_href(),"",j.join("\n"))};if(fk.job){fm+=(fm.indexOf("?")===-1?"?":"&")+"long_running=1"}if(fk.subject_user&&!((fn=fk.parameters)!=null?fn[Constants.UID_PARAM_NAME]:void 0)){fm=G.parse(fm).updateQuery(Constants.UID_PARAM_NAME,fk.subject_user).toString()}ft=$H({url:fm});if(fk.parameters){ft.update(fk.parameters);fs=ft.keys();for(fw=0,fx=fs.length;fw<fx;fw++){fy=fs[fw];fq=["passwd","password","oauth","ccn","host_id"];for(fv=0,fo=fq.length;fv<fo;fv++){fl=fq[fv];if(fy.indexOf(fl)!==-1){ft.unset(fy)}}}ft.unset("t")}fk.onSuccess.__tb_ajax_info__=fk.onFailure.__tb_ajax_info__=Object.toJSON(ft);return $super(fm,fk)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(d3.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())});var cD=[].slice;if(!window.$j){window.$j=window.jQuery}INLINE_JS.$j=bD;if(!Function.prototype.bind){Function.prototype.bind=function(i){var fl,fk,j,T;if(typeof monkey_check==="function"){monkey_check()}if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}fl=Array.prototype.slice.call(arguments,1);T=this;j=function(){};fk=function(){return T.apply((this instanceof j&&i?this:i),fl.concat(Array.prototype.slice.call(arguments)))};j.prototype=this.prototype;fk.prototype=new j();return fk}}jQuery.fn.curry=function(){var i,T,j;T=arguments[0],j=arguments[1],i=3<=arguments.length?cD.call(arguments,2):[];if(j==null){j=window}if(typeof monkey_check==="function"){monkey_check()}return function(){var fk;fk=1<=arguments.length?cD.call(arguments,0):[];return T.apply(j,cD.call(i).concat(cD.call(fk)))}};jQuery.fn.stripTags=function(i){if(typeof monkey_check==="function"){monkey_check()}return i.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.hasScrollBar=function(){if(typeof monkey_check==="function"){monkey_check()}return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){if(typeof monkey_check==="function"){monkey_check()}return C.viewport_offset(this)};jQuery.fn.visible=function(){if(typeof monkey_check==="function"){monkey_check()}return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(j,i){if(typeof monkey_check==="function"){monkey_check()}C.clone_position(this,j,i);return this};jQuery.format=function(j,i){if(typeof monkey_check==="function"){monkey_check()}return j.replace(/\{([^}]+)\}/g,function(fk,T){if(T in i){return i[T]}else{return fk}})};jQuery.cachedScript=function(j,i){if(typeof monkey_check==="function"){monkey_check()}i=bD.extend(i||{},{dataType:"script",cache:true,url:j});return jQuery.ajax(i)};jQuery.browser=bZ;jQuery.addSubjectParam=function(T,i){var j;if(typeof monkey_check==="function"){monkey_check()}if(T.subject_user&&!((j=T.data)!=null?j[Constants.UID_PARAM_NAME]:void 0)){return i[Constants.UID_PARAM_NAME]=String(T.subject_user)}};jQuery.ajaxPrefilter(function(i,fk,T){var j;if(!fk.noDropboxDefaults){j={t:bu.read(Constants.JS_CSRF_COOKIE),is_xhr:true};jQuery.addSubjectParam(fk,j);if(jQuery.ajaxSettings.restrict!=null){j.restrict=jQuery.ajaxSettings.restrict}i.data=bD.param(bD.extend(fk.data,j),true);return false}});jQuery.ajax.retryOnce=function(fk,i,j){var T;if(typeof monkey_check==="function"){monkey_check()}if(i!=="abort"&&((T=fk.status)===0||T===500||T===502||T===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var eG,dh,bc,d3,dy;d3=INLINE_JS.Util=E.Util={scroll_to_thumb:function(i){var fl,fk,T,j;fk=i.cumulativeOffset().top;fl=i.getHeight();j=C.scroll_offsets().top;T=C.viewport_dimensions().height;if(fk<j||fk+fl>j+T){return C.scroll_to(0,fk-T/2)}},decode_sort_key:function(T){var fm,fk,i,fl;fl=[];for(fk=0,i=T.length;fk<i;fk++){fm=T[fk];if(typeof fm==="string"){fl.push(ak.decode(fm))}else{fl.push(fm)}}return fl},sort_by_rank_or_key:function(i,j){if((i.sort_rank!=null)&&(j.sort_rank!=null)){return i.sort_rank-j.sort_rank}cJ((i.sort_key!=null)&&(j.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(i,j)},sort_by_key:function(i,j){return this._sort_by_key(i,j)},_sort_by_key:function(fk,fp){var fn,fm,fo,T,fl;T=fk.sort_key;fl=fp.sort_key;for(fn=fm=0,fo=T.length;0<=fo?fm<fo:fm>fo;fn=0<=fo?++fm:--fm){if(fl[fn]==null){return 1}if(typeof T[fn]!==typeof fl[fn]){if(typeof T[fn]==="string"){return 1}else{return -1}}else{if(T[fn]!==fl[fn]){if(T[fn]>fl[fn]){return 1}else{return -1}}}}if(fl.length>T.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(i,fm,fl,T){var fn,fp,fq,fk,fo;fk=$$(fl);fo=[];for(fn=0,fp=fk.length;fn<fp;fn++){fq=fk[fn];fo.push((function(j){var fr;if(i!==j){cv.src(j.down("img"),"web","downtick-spacer");return j.removeClassName("bolded")}else{j.addClassName("bolded");if(j.hasClassName("noarrow")){return}fr=fm?"arrow-up-gray":"arrow-down-gray";return cv.src(j.down("img"),"web",fr)}})(fq))}return fo},add_sort_arrow_mouseover_j:function(i,fm,fl,T){var fn,fp,fq,fk,fo;fk=bD(fl);fo=[];for(fn=0,fp=fk.length;fn<fp;fn++){fq=fk[fn];fo.push((function(j){var fr;if(i.attr("data-sort")!==bD(j).attr("data-sort")){cv.src(bD(j).find("img")[0],"web","downtick-spacer");return bD(j).removeClass("bolded")}else{bD(j).addClass("bolded");if(bD(j).hasClass("noarrow")){return}fr=fm?"arrow-up-gray":"arrow-down-gray";return cv.src(bD(j).find("img")[0],"web",fr)}})(fq))}return fo},one_line_fit:function(i){var T,j;T=$$(i);if(T.length<2){return}j=(function(fk){return function(){var ft,fr,fp,fm,fn,fs,fo,fq,fl;fp=T[0];fs=T[T.length-1];fm=fp.cumulativeOffset().top;fo=fs.cumulativeOffset().top;if(fm!==fo){ft=parseInt(fp.getStyle("font-size"),10);fl=ft-1;if(fl<8){return}for(fn=0,fq=T.length;fn<fq;fn++){fr=T[fn];fr.style.fontSize=fl+"px"}return j()}}})(this);return j()},nice_list:function(j){var fm,fl,fk,i,T;if(!j){return""}else{if(j.length===1){return j[0]}else{if(j.length===2){return ey("%(x)s and %(y)s").format({x:j[0],y:j[1]})}}}T=ey("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);cJ(T.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");fl=T[0];fk=T[1];i=T[2];fm=T[3];return[fl,j.slice(0,-1).join(fk),i,j[j.length-1],fm].join("")},list_em_snippet:function(fk,T){var fq,fn,fm,fl,fp,fo;fl="";T-=new bS("...").length;for(fn=fm=0,fp=fk.length;0<=fp?fm<fp:fm>fp;fn=0<=fp?++fm:--fm){fo=fk[fn];if(fn!==0){fo=", "+fo}fq=new bS(fo).length;if(fq>T){break}T-=fq;fl+=fo}return{str:fl,snipped:fk.length-fn}},start_of_day:function(i){var j;j=new Date();j.setTime(i.getTime());j.setHours(0);j.setMinutes(0);j.setSeconds(0);j.setMilliseconds(0);return j},to_iso8601_date:function(fk,j,T){var i;if(j==null){j=false}if(T==null){T=false}if(j){i=fk.getUTCFullYear().toString()+"-"+(fk.getUTCMonth()+1).toString().lpad(2)+"-"+fk.getUTCDate().toString().lpad(2);if(T){i+=" "+fk.getUTCHours().toString().lpad(2)+":"+fk.getUTCMinutes().toString().lpad(2)+":"+fk.getUTCSeconds().toString().lpad(2)}}else{i=fk.getFullYear().toString()+"-"+(fk.getMonth()+1).toString().lpad(2)+"-"+fk.getDate().toString().lpad(2);if(T){i+=" "+fk.getHours().toString().lpad(2)+":"+fk.getMinutes().toString().lpad(2)+":"+fk.getSeconds().toString().lpad(2)}}return i},to_mysql_date:function(fl,i,T){var j,fm,fk;j=fl.getFullYear().toString()+"-"+(fl.getMonth()+1).toString().lpad(2)+"-"+fl.getDate().toString().lpad(2);fk=fl.getHours().toString().lpad(2)+":"+fl.getMinutes().toString().lpad(2)+":"+fl.getSeconds().toString().lpad(2);fm="."+fl.getMilliseconds().toString().lpad(3);if(!i){return j}if(!T){return j+" "+fk}return j+" "+fk+fm},from_mysql_date:function(j){var fk,fm,T,fo,i,fn,fl;fo=j.split(" ");fk=fo[0];fn=fo.length>1?fo[1]:false;fm=fk.split("-");cJ(fm.length===3,"weird date format on "+this+", expected yyyy-mm-dd");T=new Date(fm[0],parseInt(fm[1],10)-1,fm[2]);if(fn){fl=fn.split(":");cJ(fl.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");T.setHours(fl[0]);T.setMinutes(fl[1]);i=fl[2].split(".");T.setSeconds(i[0]);if(i.length>1){T.setMilliseconds(i[1])}}return T},make_table:function(i,fo){var T,fn,fp,j,fl,fk,fm;fp=new Element("table",fo);j=new Element("tbody");fp.__sert(j);for(fn in i){fm=i[fn];fk=new Element("tr");fl=new Element("td").insert(fn);T=new Element("td").insert(fm);fk.__sert(fl);fk.__sert(T);j.__sert(fk)}return fp},validate_email:function(i){var j;j=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return j.test(i)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(T){var j,i;i=this.scried;j=i[T];if(!j){j=$(T);i[T]=j}return j},urlquote:function(i){return i.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var j,i;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(j=$("ieconsole"))!=null?j.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(i=console.log)!=null?i.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(T,j){var i;i=this.childElementWithIndex(T,j);return i[0]},childElementWithIndex:function(fq,fm){var fo,fp,fn,fl,T,fk;fo=0;fk=fq.childNodes;for(fn=fl=0,T=fk.length;fl<T;fn=++fl){fp=fk[fn];if(fp.nodeType===1&&fo++===fm){return[fp,fn]}}return[false,false]},disableSelection:function(i){i.onselectstart=function(){return false};i.unselectable="on";i.style.MozUserSelect="none";return i.style.cursor="default"},enableSelection:function(i){i.onselectstart=function(){return true};i.unselectable="off";i.style.MozUserSelect="";return i.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(i,fo,fm,fl){var T,fk,j,fn;if(!fm){fm=function(fp,fq){return fp-fq}}T=i.length;fk=0;while(T>fk){j=Math.floor(T/2+fk/2);fn=fm(i[j],fo);if(fn>0){T=j}else{if(fn<0){fk=j+1}else{return j}}}if(fl){return fk}else{return -1}},nonce:function(){var T,i,j;T=new Date();j=T.getTime().toString();i=Math.floor(Math.random()*1000000).toString().lpad(6);return j+i},focus:function(j){if(j){j=$(j);try{return j.focus()}catch(i){}}},sumStyles:function(fm,fn){var T,fk,fl,i;fk=0;if(fm){for(fl=0,i=fn.length;fl<i;fl++){T=fn[fl];fk+=parseInt(fm.getStyle(T),10)||0}}return fk},async_load_script:function(j){var i;i=function(){var fk,T;T=document.createElement("script");T.src=j;T.type="text/javascript";T.async=true;fk=document.getElementsByTagName("script")[0];return fk.parentNode.insertBefore(T,fk)};if(document.readyState==="complete"){return i()}else{if(window.attachEvent!=null){return window.attachEvent("onload",i)}else{return window.addEventListener("load",i,false)}}},smart_window_load:function(i){if(document.readyState==="complete"){return i.defer()}else{return Event.observe(window,"load",i)}},isNumber:function(i){return !isNaN(Number(i,10))},shorten_url:function(i,j){return new Ajax.DBRequest("/shorten_url",{parameters:{url:i},onSuccess:function(T){return j(T.responseText)}})},falsy_to_empty:function(i){return i||""},preloaded_images:{},preload_image:function(fk,T,j){var i;if(this.preloaded_images[fk]){return}i=new Image();if(T!=null){Element.extend(i).observe("error",T)}if(j!=null){Element.extend(i).observe("load",j)}i.src=fk;return this.preloaded_images[fk]=i},get_preloaded_image:function(i){if(this.preloaded_images[i]){return this.preloaded_images[i].clone()}else{return new Element("img",{src:i})}},clear_selected:function(){var i;if(window.getSelection){i=window.getSelection();if(i.removeAllRanges){return i.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(i){var T,j;T=20;j=C.viewport_dimensions();return i>j.width-T},freshbutton_overlay:function(j,i){var fk,T;T=j instanceof jQuery&&j||bD(j);fk=i instanceof jQuery&&i||bD(i);T.on("mouseover",(function(fl){return function(){return fk.addClass("hovered")}})(this));T.on("mouseout",(function(fl){return function(){fk.removeClass("hovered");return fk.removeClass("pressed")}})(this));T.on("mousedown",(function(fl){return function(){fk.removeClass("hovered");return fk.addClass("pressed")}})(this));return T.on("mouseup",(function(fl){return function(){return fk.removeClass("pressed")}})(this))},isElm:function(i){if(typeof HTMLElement==="object"){return i instanceof HTMLElement}else{return i&&typeof i==="object"&&i.nodeType===1&&typeof i.nodeName==="string"}},_track_twitter_chars_left:function(j,T){var i;clearInterval(this.chars_left_interval);i=(function(fk){return function(){var fl,fm;fl=$("twitter-chars");fm=T-$F(j).strip().length;if(fm<0){fl.addClassName("too-long")}else{fl.removeClassName("too-long")}return fl.__date(fm)}})(this);return this.chars_left_interval=setInterval(i,250)},session_storage_set:function(i,j){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(i,JSON.stringify(j))},session_storage_get:function(i){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(i))}},pdf_plugins:function(){var T,j,i;i=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return T=(function(){var fl,fk,fn,fm;fn=window.navigator.plugins;fm=[];for(fl=0,fk=fn.length;fl<fk;fl++){j=fn[fl];if(i.test(j.name)){fm.push(j)}}return fm})()},get_window_location:function(){return window.location}};d3.scrollLeft=d3.scrollLeft.cached(50);d3.scrollTop=d3.scrollTop.cached(50);if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var T,i,fm,fl,fk;if(d3.ie8){fl=$$("#page-header a, #page-footer a");fk=[];for(T=0,i=fl.length;T<i;T++){fm=fl[T];if(fm.target==="_blank"){fk.push(fm.target="")}else{fk.push(void 0)}}return fk}});dh=__CONDITIONAL_JS__.Trace=E.Trace=(function(){var i;i=[];return{log:function(){var j;j=b4.time()+": "+$A(arguments).join(" ");return i.push(j)},get:function(){return i.join("\n")}}})();eG=E.T=function(){return dh.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var i;eG("dom:loaded");i=function(){var fk,j,T,fl;T=$("page-content");if(T){fl=C.viewport_dimensions();j=$(document.body);fk="absolutize";if(fl.width<T.getWidth()){return j.addClassName(fk)}else{return j.removeClassName(fk)}}};Event.observe(window,"resize",bv.debounce(i,150));return i()});Event.observe(window,"load",function(){return eG("window:load")});bc=E.URLUtil={absolutize:function(i){if(i.startsWith("https://")||i.startsWith("http://")){return i}else{if(i.charAt(0)==="/"){return window.location.protocol+"//"+window.location.host+i}else{return cJ(0,"absolutize is confused by "+i)}}}};dy=E.Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var i,j;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:C.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}j=this.scroll_container!=null?this.scroll_container.scrollTop:C.scroll_offsets().top;i=Math.abs(this.max_delta_y)<Math.abs(j-this.old_y);if(i){this.max_delta_y=j-this.old_y;return this.old_y=j}},start_capture:function(i){this.scroll_container=i;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(i){if(i==null){i=false}cJ(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(i){return this.last_nonzero_velocity}return this.velocity}};var dt;dt=E.DomUtil={fromElm:function(i){return $(i).innerHTML},updateFromElm:function(j,i){j=$(j);i=$(i);return j.update(this.fromElm(i))},fillVal:function(fp,fn){var fm,T,fo,fk,fl,j;fo=$$("."+fn);fl=[];for(fm=0,T=fo.length;fm<T;fm++){j=fo[fm];j=$(j);if(j.tagName==="INPUT"){j.value=fp;fl.push(j.defaultValue=fp)}else{if(j.innerHTML===""&&((fk=j.tagName)==="A"||fk==="B"||fk==="INPUT"||fk==="I"||fk==="LABEL"||fk==="SELECT"||fk==="SPAN"||fk==="TEXTAREA")){d3.log("Filling an empty value; this may look broken in IE7",j)}fl.push(j.innerHTML=fp)}}return fl},copy_to_clipboard:function(fp,fm,fq){var fk,T,i,j,fn,fo,fl;fk=$("hold_clipboard");fk.value=fp;if(fk.createTextRange){fl=fk.createTextRange();if(fl&&((typeof BodyLoaded==="undefined"||BodyLoaded===null)||BodyLoaded===1)){try{return fl.execCommand("Copy")}catch(fo){fn=fo;fq=fq||ey("Please copy the text below:");fm=fm||ey("Copy text");this.fillVal(fp,"text-to-copy");this.fillVal(fq,"copy-modal-body");fa.show(fm,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){i=document.createElement("div");i.id="flashcb";document.body.appendChild(i)}$("flashcb").innerHTML="";T=encodeURIComponent(fk.value);j='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=j}}};var ar;ar=E.RequestWatcher={reqs:[],working_msg:ey("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(j,T){var i;i=this.reqs;if(!i.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(T){j.skip_message=true}return i.push([j,b4.time()])},check_up:function(){return this.scan(false)},remove:function(i){return this.scan(i)},scan:function(fn){var fr,fm,fo,T,fl,j,fk,fq,fp;T=b4.time();fl=[];fk=this.reqs;for(fm=0,fo=fk.length;fm<fo;fm++){j=fk[fm];fq=j[0];fp=j[1];fr=T-fp;if(fq.transport.readyState===4){this.clearWorkingMessage();continue}if(fr>4000&&!fq.skip_message){fq.skip_message=true;if(ah.isShown()&&ah.current()===!X.undo_notification){this.last_notification=ah.success(this.working_msg)}}if(fr>this.TIMEOUT*1000&&fq.job){fq.transport.abort()}if(fq!==fn){fl.push([fq,fp])}else{fq.transport.abort()}}this.reqs=fl;if(!fl.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(ah.isShown()&&ah.current()===this.last_notification){return ah.clear()}}};bD(function(){var j,i,fk,T;fk=Prototype.Browser;T=[];for(j in fk){i=fk[j];if(i===true){T.push(bD(document.body).addClass(j.toLowerCase()))}}return T});var dJ,a2,cD=[].slice;dJ=E.HTML5_HISTORY=Modernizr.history;bD((function(i){return function(){return eB.init()}})(this));a2=E.HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(i){return window.location.href=i},_replace_location:function(i){return window.location.replace(i)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(i,j){this.callback_map[i]=j;if(!this.watch_timer){return this.init()}},check_hash:function(){var j,T,fk,fm,fl,i;fm=this._get_location().split("#")[1];if(fm!=null){fm=fm.replace(/%27/g,"'")}if(this.last_hash===fm){return}this.last_hash=fm;if(this.last_prefix&&fm===""){fm=this.last_prefix+":"}else{if(!fm){return}}i=fm.split(":");fl=i.first();this.last_prefix=fl;fk=this.callback_map[fl];if(fk!=null){T=(function(){var fp,fn,fq,fo;fq=i.slice(1);fo=[];for(fp=0,fn=fq.length;fp<fn;fp++){j=fq[fp];fo.push(decodeURIComponent(j))}return fo})();fk.apply(null,T)}return $(document).fire("db:hash_change",{hash:fm})},_prepare_hash:function(T){var j,i;i=$A(T).map(d3.falsy_to_empty);j=i.map(encodeURIComponent);return j.join(":")},set_hash:function(){var i,j;i=1<=arguments.length?cD.call(arguments,0):[];j=this._prepare_hash(i);return this._set_hash(j)},replace_hash:function(){var i,j;i=1<=arguments.length?cD.call(arguments,0):[];j=this._prepare_hash(i);return this._set_hash(j,true)},_set_hash:function(j,i){if(j===""){j="/"}this.last_hash=j;if(!i){return this._set_location("#"+j)}else{return this._replace_location("#"+j)}}};var aY;aY=E.SharingUtil=(function(){function i(){}i.success_string_for_recipients=function(j){var T;if(j.length===1){if(j[0].indexOf("@")===-1){T=ey("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:j[0]})}else{T=ey("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:j[0]})}}else{if(j.length===2){if(j[0].indexOf("@")===-1){if(j[1].indexOf("@")===-1){T=ey("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:j[0],recipient_second:j[1]})}else{T=ey("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:j[0],recipient_second:j[1]})}}else{if(j[1].indexOf("@")===-1){T=ey("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:j[0],recipient_second:j[1]})}else{T=ey("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:j[0],recipient_second:j[1]})}}}else{if(j[0].indexOf("@")===-1){T=ey("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:j[0],num_others:j.length-1})}else{T=ey("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:j[0],num_others:j.length-1})}}}return T};return i})();var s;s=INLINE_JS.SharingModals=E.SharingModals=(function(){function i(){}i.show_shared_folder_options_modal=function(fl,j,T,fk){if(T==null){T=true}if(fk==null){fk=true}return dY.push(new de(j,fl,T,fk))};i.show_share_inband_modal=function(fk,T,j,fl){return eD.createAndShowInbandModal(T,fk,true,j,true,false,fl)};i.show_shared_folder_wizard=function(j){return new en(j,{element_id:"share-a-folder-wizard-modal"}).show()};i.get_select_role_modal=function(){return new cG({element_id:"select-role-modal"})};i.start_wizard_without_user=function(){if(cK.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=i.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(cK.get_viewer().get_users()[0])}};i.start_wizard_for_user=function(j){if(d1.get_for_user(j).verified_or_show(ep.SHARE_FOLDER)){return i.show_shared_folder_wizard(j)}};i.show_share_existing_modal=function(fk,j){var T;if(d1.get_for_user(j).verified_or_show()){T=new cn(j,{folder_name:fk,element_id:"invite-to-new-sf-wizard-modal-"+j.id});return T.show()}};i.show_shmodel_or_invite_modal=function(T,fl,j,fk){if(d1.get_for_user(j).verified_or_show()){return new dW(j,{path:T,existing_sf:fl,element_id:"create-link-or-invite-wizard-modal",target_item:fk}).show()}};i.show_unshare_team_sf_modal=function(T,j,fl){var fk;fk=new b3(T,{element_id:"unshare-confirm-modal",team_shared_folder:true,nested_shared_folder:false,ns_id:j,folder_path:fl});return fk.show()};i.show_ignore_modal=function(fk,T,j){var fm,fl,fn;cJ(j,"Share ignore did not get an ns_id");fn=ey("Permanently remove '%(folder_name)s'").format({folder_name:bS.em_snippet(T,15)});fm={ns_id:j};fl=new dk(fk,{element_id:"ignore-confirm",title:fn});fl.on_confirm_button_click=function(fq){var fp,fo,fr;fq.preventDefault();fp=bD(fq.target);fo=fp.closest("form");fr=function(fs){ah.success(ey("Removed shared folder successfully."));document.fire(aH.SF_IGNORE,{target_ns_id:j,user_id:fk.id});return fl.hide()};return bR.ajax_submit(fo[0],false,fr,void 0,fp[0],fm)};return fl.show()};i.show_rejoin_modal=function(fk,T,j){var fm,fl,fn;cJ(j,"Rejoin didn't get an ns_id");fn=ey("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:bS.em_snippet(T,13)});fm={ns_id:j};fl=new dk(fk,{element_id:"rejoin-confirm",title:fn});fl.on_confirm_button_click=function(fq){var fp,fo,fr;fq.preventDefault();fp=bD(fq.target);fo=fp.closest("form");fr=function(ft){var fs;fs=ft.responseText;T=aA.filename(fs);ah.success(ey("Rejoined shared folder successfully."));document.fire(aH.SF_REJOIN,{target_ns_id:j,user_id:fk.id,filename:T,mount_point:fs});return fl.hide()};return bR.ajax_submit(fo[0],false,fr,void 0,fp[0],fm)};return fl.show()};i.show_invites=function(){return dY.push(new cB({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};i.show_shared_subfolder_modal=function(T,fl){var fo,fm,fn,j,fk;fn=bS.em_snippet(aA.filename(T),14);fm=ey("Can't share folder");j="'%(parent_shared_folder)s' ".format({parent_shared_folder:fn});dt.fillVal(j.escapeHTML(),"parent_shared_folder_name");fo=ey("Share '%(parent_shared_folder)s' folder");fk=fo.format({parent_shared_folder:fn});($("share_parent_folder_button")).value=fk;fa.show(ey("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'> <img src='/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif' alt=''/></p>");bD("#share_parent_folder_button").on("click",(function(fp){return function(fq){fa.hide();return fp.show_shared_folder_options_modal(T,fl)}})(this));return fa.show(fm,$("share_subfolder"))};return i})();var dd;dd=E.InviteFormController=(function(){function i(fl,fk,T,j,fp,fo){var fn,fm;this.user=fl;this.$form=fk;this.members=T;this.invitees=j;this.new_style_groups=fp;this.team_only=this.$form.data("team-only");fm={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){fn=Autocompleter.TeamTokenizer;fm.team_only=this.team_only}else{fn=Autocompleter.ContactsTokenizer;fm.include_team=true}if(this.user.role==="work"&&(__CIRCULAR_DEPENDENCY__.GroupsApi!=null)){fm.include_new_style_groups=true}this.sharing_options_auto_completer=new fn(this.user,fo+"-new-collab-input",fo+"-new-whobulk",fo+"-hidden-input",fm);ch._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new h(this.$form)}}i.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};i.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};i.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};i.prototype.reset_options=function(){return bD(this.sharing_options_auto_completer.get_entry_container()).hide()};i.prototype.set_team_only=function(j){this.team_only=j;return this.sharing_options_auto_completer.setTeamOnly(j)};i.prototype.get_token_count=function(){return this.sharing_options_auto_completer.getTokenCount()};i.prototype.extract_invitees=function(){var fn,fk,fl,T,fo,j,fm;fo={};fm=["emails","fb_ids","group_ids","new_style_group_ids"];for(fl=0,j=fm.length;fl<j;fl++){fk=fm[fl];T=this.$form.find("input[name="+fk+"]");fo[fk]=[(function(){var fq,fp,fr;fr=[];for(fq=0,fp=T.length;fq<fp;fq++){fn=T[fq];fr.push(bD(fn).val())}return fr})()]}return fo};i.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};i.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return i})();var aO,de,R,eu,bt,fc,c4,dz,aU,eP,du,cu,dP,bK,aJ,b3,fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty,b1=function(i,j){return function(){return i.apply(j,arguments)}};dP=E.SharedFolderBaseModal=(function(i){fb(j,i);function j(fk,T){this.user=fk;this.options=T;j.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.nested_shared_folder=this.options.nested_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new bk(this.user)}j.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return j})(d5);de=E.ExistingSharedFolderOptionsModal=(function(j){fb(i,j);function i(fp,fl,fk,fm,T){var fo,fn;this.user=fp;if(fk==null){fk=true}if(fm==null){fm=true}this.restore_modal=T;this.__show_modal=b1(this.__show_modal,this);this.__x_click_handler=b1(this.__x_click_handler,this);cJ(fl!=null,"Missing folder path");this.path=aA.normalize(fl);fn=ey("Shared folder options for '%(folder)s'");fn=fn.format({folder:bS.em_snippet(aA.filename(fl),13)});fo={};fo[Constants.UID_PARAM_NAME]=this.user.id;fo.max_results=20;fo.show_invite_form=fk;fo.show_folder_settings=fm;dY.register(aO.MODAL_DONE_VIEWING_EVENT,(function(fq){return function(){return typeof fq.restore_modal==="function"?fq.restore_modal():void 0}})(this));i.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:fn,endpoint_url:G({path:"/share_options"+this.path}).toString(),parameters:fo})}i.prototype.__x_click_handler=function(fk){var T;i.__super__.__x_click_handler.apply(this,arguments);T={path:this.path};a9.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,T);return typeof this.restore_modal==="function"?this.restore_modal():void 0};i.prototype.__show_modal=function(fk){var T;i.__super__.__show_modal.apply(this,arguments);T={path:this.path};return a9.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,T)};return i})(cB);aO=E.ExistingSharedFolderOptionsContent=(function(){i.CONTENT_LOADED_EVENT="db:sharing_options:content_loaded";i.MODAL_DONE_VIEWING_EVENT="db:sharing_options:modal_done_viewing_event";function i(fm,fk,fl,fn,j,T){this.$root=fm;this.options=fn;this.show_invite_form=j;this.allows_editor_manage_membership=T;this.show_email_verification=b1(this.show_email_verification,this);this.show_golden_gate_warning=b1(this.show_golden_gate_warning,this);this.show_folder_settings=b1(this.show_folder_settings,this);this.show_m2_folder_settings=b1(this.show_m2_folder_settings,this);this.toggle_from_invite_mode=b1(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=b1(this.toggle_to_invite_mode,this);this.toggle_get_link_button_visibility=b1(this.toggle_get_link_button_visibility,this);this.show_leave_folder_modal=b1(this.show_leave_folder_modal,this);this.show_owner_leave_folder_warning=b1(this.show_owner_leave_folder_warning,this);this.show_access_request_link_modal=b1(this.show_access_request_link_modal,this);this.show_unshare_folder_modal=b1(this.show_unshare_folder_modal,this);this.show_uninvite_modal=b1(this.show_uninvite_modal,this);this.show_transfer_user_modal=b1(this.show_transfer_user_modal,this);this.show_kick_group_modal=b1(this.show_kick_group_modal,this);this.show_kick_user_modal=b1(this.show_kick_user_modal,this);this.update_tf_access=b1(this.update_tf_access,this);this.update_sf_perms=b1(this.update_sf_perms,this);this.reinvite_user=b1(this.reinvite_user,this);this.submit_invitations=b1(this.submit_invitations,this);this.maybe_load_more=b1(this.maybe_load_more,this);this.extract_user_data_and_call=b1(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=b1(this.extract_invitee_data_and_call,this);this.create_m2_inband_modal=b1(this.create_m2_inband_modal,this);this._disable_token_for_sf=b1(this._disable_token_for_sf,this);this.user=cK.get_viewer().get_user_by_id(fk);this.path=aA.normalize(fl);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups;this.num_total=this.options.num_total}this.$root.find(".bubble-dropdown").click(function(fo){C.controller(bD(fo.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.start=20;this.max_results=20;this.$root.find(".member-container").on("scroll",(function(fo){return function(fr){var fq,fp;fq=bD(fr.currentTarget);fp=fq.find("#sf-members");if(fq.scrollTop()+fq.innerHeight()>=fp.innerHeight()){return fo.maybe_load_more()}}})(this));this.sharing_api=new bk(this.user);this.sharing_api.loading_elem=this.$root;bd.register_all();c3.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.nested_shared_folder=this.$root.data("nested-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");if(this.$root.find(".get-editable-link").length>0){B.showInstance(dA.createElement(B,{onDismiss:eD.dismissM2Prompt,shouldShow:cr.simple_sharing_show_m2_prompt,targetedButton:this.$root.find(".get-editable-link").get(0)}));a9.SimpleSharingLogger.log(this.user.id,29)}this.has_show_invite_form=false;this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen();dY.trigger(i.CONTENT_LOADED_EVENT)}i.prototype.listen=function(){var fk,T,fl,j,fm;this.$root.find(".confirm-button").click((function(fn){return function(fo){fo.preventDefault();return fn.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(fn){return function(fo){fo.preventDefault();return fn.toggle_from_invite_mode()}})(this));if(this.show_invite_form){this.get_link_button=this.$root.find(".get-editable-link-invite");this.$invite_input=this.$root.find("#sharing-options-new-collab-input");fm=["focus","keypress","contextmenu"];for(fl=0,j=fm.length;fl<j;fl++){T=fm[fl];this.$invite_input.off(T);this.$invite_input.on(T,this.toggle_to_invite_mode)}this.$invite_input.keyup(this.toggle_get_link_button_visibility);if(this.$invite_input[0]){this.$invite_input[0].on("token:remove",this.toggle_get_link_button_visibility);this.$invite_input[0].on("token:add",this.toggle_get_link_button_visibility)}fk=this.$root.find("#custom-message-wizard");fk.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".change-m2-settings-link").on("click",this.show_m2_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);this.$root.find(".golden-gate-upgrade-link").on("click",this.show_golden_gate_warning);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new dd(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}}this.$root.on("click","a.leave-folder",(function(fn){return function(fo){fo.preventDefault();a9.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fn.user,fn.log_extras);return fn.show_leave_folder_modal()}})(this));this.$root.on("click",".get-editable-link",(function(fn){return function(fp){var fo;bD(document).trigger("collab:m2:prompt:dismiss");return fn.create_m2_inband_modal(fp,fo=false)}})(this));this.$root.on("click",".get-editable-link-invite",(function(fn){return function(fp){var fo;bD(document).trigger("collab:m2:prompt:dismiss");return fn.create_m2_inband_modal(fp,fo=true)}})(this));this.$root.on("click","a.owner-leave-folder",(function(fn){return function(fo){fo.preventDefault();a9.SharedFolderActivityLogger.log("web","invite_modal_owner_leave_button",fn.user,fn.log_extras);return fn.show_owner_leave_folder_warning()}})(this));this.$root.on("click","a.kick-user",(function(fn){return function(fo){return fn.extract_user_data_and_call(fo,fn.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(fn){return function(fq){var fo,fp,fr;fq.preventDefault();fo=bD(fq.currentTarget);fr=fo.data("group-name");fp=fo.data("group-gid");return fn.show_kick_group_modal(fr,fp)}})(this));this.$root.on("click","a.make-owner",(function(fn){return function(fo){return fn.extract_user_data_and_call(fo,fn.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(fn){return function(fp){var fo,fq;fp.preventDefault();fo=bD(fp.currentTarget);fq=fo.data("email");return window.location=G({scheme:"mailto",path:fq}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(fn){return function(fo){return fn.extract_invitee_data_and_call(fo,fn.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(fn){return function(fo){return fn.extract_invitee_data_and_call(fo,fn.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(fn){return function(fo){fo.preventDefault();a9.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fn.user,fn.log_extras);return fn.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(fn){return function(fo){fo.preventDefault();a9.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fn.user,fn.log_extras);return fn.show_unshare_folder_modal()}})(this));this.$root.on("click","a.unshare_folder_link",(function(fn){return function(fo){fo.preventDefault();a9.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fn.user,fn.log_extras);return fn.show_unshare_folder_modal()}})(this));this.$root.on("click","input.simple-sharing-remove-link",(function(fn){return function(fo){fo.preventDefault();return fn._disable_token_for_sf(function(){return dY.pop()})}})(this));this.$root.on("click","a.remove-link",(function(fn){return function(fo){var fp;fo.preventDefault();fp=function(){var fq;fq=d5.get_containing_modal(fn.$root);if(fq&&fq instanceof cB){return fq.fetch()}};return fn._disable_token_for_sf(fp)}})(this));this.$root.on("click","input.sf-action-get-link",(function(fn){return function(fo){fo.preventDefault();return fn.show_access_request_link_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(fn){return function(fo){fo.preventDefault();a9.SharedFolderActivityLogger.log("web","invite_modal_done_button",fn.user,fn.log_extras);dY.trigger(i.MODAL_DONE_VIEWING_EVENT);return dY.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(fn){return function(fp){var fo;fo=bD(fp.currentTarget);return fn.update_sf_perms(fo.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(fn){return function(fp){var fo;fo=bD(fp.currentTarget);return fn.update_tf_access(!fo.prop("checked"))}})(this))};i.prototype._disable_token_for_sf=function(j){return cC.WebRequest({url:G({path:"/sm/disable_token_at_path"+aA.normalize(this.path)}),subject_user:this.user.id,type:"POST",success:(function(T){return function(){bD(document).trigger(dL.UPDATE);ah.success(ey("Link removed"));a9.SimpleSharingLogger.log(T.user.id,25);return typeof j==="function"?j():void 0}})(this),error:(function(T){return function(){return ah.error(ey("An error occurred when removing link"))}})(this)})};i.prototype.create_m2_inband_modal=function(T,j){T.preventDefault();dY.pop();if(j){a9.SimpleSharingLogger.log(this.user.id,32)}else{a9.SimpleSharingLogger.log(this.user.id,30)}return eD.createAndShowM2InbandModal(this.user,this.path)};i.prototype.extract_invitee_data_and_call=function(fl,fk){var j,fm,T;fl.preventDefault();j=bD(fl.currentTarget);T=j.data("email-or-fbname");fm=j.data("invite-id");return fk(T,this.ns_id,fm)};i.prototype.extract_user_data_and_call=function(fn,fm){var T,fl,fk,j;fn.preventDefault();T=bD(fn.currentTarget);fk=T.data("display-name");fl=T.data("email");j=T.data("user-id");return fm(fk,fl,j)};i.prototype.maybe_load_more=function(){var T,j,fk;j=this.$root.closest("body").length;if(!j){return}if((this.num_total==null)||(this.start>=this.num_total)){bD("#more-members-spinner").hide();return}bD("#more-members-spinner").show();fk={};fk[Constants.UID_PARAM_NAME]=this.user.id;fk.start=this.start;fk.max_results=this.max_results;T=G({path:"/share_options"+this.path}).toString();this.$root.removeClass("ajax-loading");new bw(this.$root,T,{data:fk,success:(function(fl){return function(fp,fm,fq){var fo,fn;if(((fn=fp.data)!=null?fn.options:void 0)!=null){fo=fp.data.options;if((fl.members!=null)&&(fo.folder_members!=null)){Array.prototype.push.apply(fl.members,fo.folder_members)}if((fl.invitees!=null)&&(fo.folder_invitees!=null)){Array.prototype.push.apply(fl.invitees,fo.folder_invitees)}if((fl.new_style_groups!=null)&&(fo.new_style_groups!=null)){return Array.prototype.push.apply(fl.new_style_groups,fo.new_style_groups)}}}})(this),error:(function(fl){return function(fo,fm,fn){return ah.error("Unable to load all members of this folder.")}})(this)});return this.start=this.start+this.max_results};i.prototype.submit_invitations=function(){var fl,fk,fn,T,fm,j;this.invite_form_controller.tokenize();fn=this.invite_form_controller.extract_invitees();fm=this.invite_form_controller.get_custom_message();fl=this.invite_form_controller.get_access_type();T=bv.clone(this.log_extras);T.access_type=fl;a9.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,T);j=(function(fo){return function(fq){var fp;fp=d5.get_containing_modal(fo.$root);if(fp&&fp instanceof cB){fp.fetch()}else{dY.pop()}ah.success(fq.responseText);return document.fire(aH.SF_INVITE,{target_ns_id:fo.ns_id,user_id:fo.user.id})}})(this);fk=(function(fo){return function(fp){return eI.show_validation_error(fp,fo.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,fn,fm,fl,j,fk)};i.prototype.reinvite_user=function(fk,j,T){return this.sharing_api.reinvite_user(j,T,(function(fl){return function(fs){var fp,fq,fr,fo,fm,fn;fo=JSON.parse(fs.responseText);fm=fo.status;if(fm==="OK"){fn=ey("%(email_or_fbname)s was reinvited successfully");fn=fn.format({email_or_fbname:fk});return ah.success(fn)}else{fr=fo.reason;if(fr==="ACCEPTED"){fp=ey("That invitation has already been accepted.")}else{if(fr==="DECLINED"){fp=ey("That invitation has already been declined.")}else{fp=ey("You no longer have permission to perform this action.")}}ah.error(fp);if(fo.reload){fq=d5.get_containing_modal(fl.$root);if(fq&&fq instanceof cB){return fq.fetch()}}}}})(this))};i.prototype.update_sf_perms=function(T){var fk,fl,j;this.$root.find("#change-sf-perm-saving").show();fk=(T?1:0);j=(function(fm){return function(fn){if(T){ah.success(ey("Editors can now manage membership of this folder."))}else{ah.success(ey("Editors can no longer manage membership of this folder."))}return fm.$root.find("#change-sf-perm-saving").hide()}})(this);fl=(function(fm){return function(fn){if(fn.responseText.indexOf("err:")===0){ah.error(fn.responseText.substr(4))}else{ah.error(ey("Error updating your preference! Please try again."))}return fm.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,fk,j,fl)};i.prototype.update_tf_access=function(T){var fk,j;j=(function(fl){return function(fm){if(T){return ah.success(ey("Team members can now change folder contents."))}else{return ah.success(ey("Team members can no longer change folder contents."))}}})(this);fk=(function(fl){return function(fm){return ah.error(ey("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_team_folder_access_type(this.ns_id,T,j,fk)};i.prototype.show_kick_user_modal=function(fk,T,j){return dY.push(new eP(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:fk,folder_path:this.path,user_id:j}))};i.prototype.show_kick_group_modal=function(j,T){return dY.push(new aU(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:j,folder_path:this.path,group_id:T}))};i.prototype.show_transfer_user_modal=function(fk,T,j){return dY.push(new bK(this.user,{element_id:"transfer-confirm-modal",user_id:j,user_name:fk,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.show_uninvite_modal=function(fk,j,T){return dY.push(new aJ(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:fk,ns_id:j,invite_id:T,folder_path:this.path}))};i.prototype.show_unshare_folder_modal=function(){return dY.push(new b3(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,nested_shared_folder:this.nested_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.show_access_request_link_modal=function(){return dY.push(new df(this.user.id,this.path,void 0,true))};i.prototype.show_owner_leave_folder_warning=function(){return ah.error(ey("You can't leave this folder because you're the owner. You must transfer ownership to another member before you can leave."))};i.prototype.show_leave_folder_modal=function(){return dY.push(new du(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};i.prototype.toggle_get_link_button_visibility=function(){var fn,fm,fl,fk,T,j;fm=((fl=this.invite_form_controller)!=null?fl.get_token_count():void 0)===0;fn=((fk=this.$invite_input)!=null?fk.val():void 0)==="";if(fm&&fn){return(T=this.get_link_button)!=null?T.show():void 0}else{return(j=this.get_link_button)!=null?j.hide():void 0}};i.prototype.toggle_to_invite_mode=function(){var j;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");if((j=this.sf_access_type)!=null){j.show()}this.toggle_get_link_button_visibility();if(!this.has_show_invite_form&&this.get_link_button.length>0){a9.SimpleSharingLogger.log(this.user.id,31)}this.has_show_invite_form=true;return bD(document).trigger("collab:m2:prompt:hide")};i.prototype.toggle_from_invite_mode=function(){var T,j;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((T=this.sf_access_type)!=null){T.hide()}if((j=this.invite_form_controller)!=null){j.reset_autocompleter()}return this.toggle_get_link_button_visibility()};i.prototype.show_m2_folder_settings=function(T){var fk,j;j=this.path;fk=function(){var fl;fl=new de(cr.active_user,j);return fl.show()};dY.pop();return ae.showInstance(dA.createElement(ae,{user:this.user,fq_path:this.path,is_shared_folder:true,ns_id:this.ns_id,initial_allows_editor_manage_membership:this.allows_editor_manage_membership,done_callback:fk}))};i.prototype.show_folder_settings=function(j){a9.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);j.preventDefault();dY.register(eu.SAVED_PERMISSIONS,(function(T){return function(fl,fk){if(fk!=null){return T.set_team_only(fk)}}})(this));return dY.push(new eu(this.user,this.path,this.ns_id))};i.prototype.show_golden_gate_warning=function(j){j.preventDefault();return dY.push(new c4(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};i.prototype.show_email_verification=function(j){dY.pop();return d1.get_for_user(this.user).show()};i.prototype.set_team_only=function(j){var T;this.invite_form_controller.set_team_only(j);T=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(j){return T.addClass("team-only")}else{return T.removeClass("team-only")}};return i})();du=E.LeaveFolderModal=(function(i){fb(j,i);function j(){this.before_show=b1(this.before_show,this);this.on_show=b1(this.on_show,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(fk){var T;fk.preventDefault();T=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,T,(function(fl){return function(){var fm;fm=ey("You removed yourself from '%(msg)s'.").format({msg:bS.em_snippet(aA.filename(fl.path),25)});ah.success(fm);document.fire(aH.SF_LEAVE,{target_ns_id:fl.ns_id,folder_deleted:!T,user_id:fl.user.id});return dY.clear()}})(this))};j.prototype.on_show=function(){j.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};j.prototype.before_show=function(){var T;T=ey("Leave the shared folder '%(folder_name)s'");T=T.format({folder_name:bS.em_snippet(aA.filename(this.path),14)});return this.format({".db-modal-title-text":T})};return j})(dP);b3=E.UnshareFolderModal=(function(j){fb(i,j);function i(){this.before_show=b1(this.before_show,this);this.on_show=b1(this.on_show,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);return i.__super__.constructor.apply(this,arguments)}i.prototype.on_confirm_button_click=function(fk){var T;fk.preventDefault();T=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,T,(function(fl){return function(){var fm;fm=ey("Unshared folder '%(folder_name)s'");fm=fm.format({folder_name:bS.em_snippet(aA.filename(fl.path),25)});ah.success(fm);document.fire(aH.SF_UNSHARE,{target_ns_id:fl.ns_id,user_id:fl.user.id});return dY.clear()}})(this))};i.prototype.on_show=function(){i.__super__.on_show.apply(this,arguments);this.$modal_window.find(".tsf_unshare_desc").hide();this.$modal_window.find(".nestedsf_unshare_desc").hide();this.$modal_window.find(".regular_unshare_desc").hide();if(this.team_shared_folder){return this.$modal_window.find(".tsf_unshare_desc").show()}else{if(this.nested_shared_folder){return this.$modal_window.find(".nestedsf_unshare_desc").show()}else{return this.$modal_window.find(".regular_unshare_desc").show()}}};i.prototype.before_show=function(){var T;if(this.nested_shared_folder){T=ey("Reset membership for '%(folder_name)s'")}else{T=ey("Unshare '%(folder_name)s'")}T=T.format({folder_name:bS.em_snippet(aA.filename(this.path),21)});return this.format({".db-modal-title-text":T})};return i})(dP);aJ=E.UninviteModal=(function(j){fb(i,j);function i(T,fk){this.before_show=b1(this.before_show,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.email_or_fbname=fk.email_or_fbname;this.ns_id=fk.ns_id;this.invite_id=fk.invite_id;i.__super__.constructor.call(this,T,fk)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(fk){return function(fq){var fo,fp,fn,fl,fm;fn=JSON.parse(fq.responseText);fl=fn.status;if(fl==="OK"){fm=ey("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:fk.email_or_fbname});ah.success(fm)}else{fp=fn.reason;if(fp==="ACCEPTED"){fo=ey("That invitation has already been accepted.")}else{if(fp==="DECLINED"){fo=ey("That invitation has already been declined.")}}ah.error(fo)}return dY.pop()}})(this))};i.prototype.before_show=function(T){var fk;fk=ey("Uninvite %(email_or_fbname)s?").format({email_or_fbname:bS.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":aA.filename(this.path),".db-modal-title-text":fk})};return i})(dP);eP=E.KickUserModal=(function(i){fb(j,i);function j(fk,T){this.user=fk;this.options=T;this.before_show=b1(this.before_show,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.user_id=this.options.user_id;this.user_name=this.options.user_name;j.__super__.constructor.call(this,this.user,this.options)}j.prototype.on_confirm_button_click=function(fl){var T,fk;fl.preventDefault();T=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,T,(function(fm){return function(){ah.success(ey("User removed successfully."));bX.reload_folder_info_if_two_account();return dY.pop()}})(this));fk={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:T};return a9.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,fk)};j.prototype.before_show=function(T){var fk;fk=ey("Remove %(person_name)s from this folder?");fk=fk.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":fk})};return j})(dP);aU=E.KickGroupModal=(function(i){fb(j,i);function j(fk,T){this.user=fk;this.options=T;this.before_show=b1(this.before_show,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.group_id=this.options.group_id;this.group_name=this.options.group_name;j.__super__.constructor.call(this,this.user,this.options)}j.prototype.on_confirm_button_click=function(T){T.preventDefault();return __CIRCULAR_DEPENDENCY__.GroupsApi.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},(function(fk){return function(){ah.success(ey("Group removed successfully."));bX.reload_folder_info_if_two_account();return dY.pop()}})(this))};j.prototype.before_show=function(){var T;T=ey("Remove %(group_name)s from this folder?");T=T.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":T})};return j})(dP);cu=E.MakeOwnerModal=(function(j){fb(i,j);function i(fk,T){this.user=fk;this.options=T;this.before_show=b1(this.before_show,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.member_uid=this.options.member_uid;this.member_name=this.options.member_name;this.ns_id=this.options.ns_id;this.access_type=this.options.access_type;i.__super__.constructor.call(this,this.user,this.options)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(fk){return function(){ah.success(ey("%(name)s now is the owner.").format({name:fk.member_name}));return dY.pop()}})(this))};i.prototype.before_show=function(){var T;T=ey("Make %(name)s the owner of this folder?");T=T.format({name:bS.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":T})};return i})(dP);bK=E.TransferOwnershipModal=(function(j){fb(i,j);function i(fk,T){this.user=fk;this.options=T;this.before_show=b1(this.before_show,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.user_id=this.options.user_id;this.user_name=this.options.user_name;i.__super__.constructor.call(this,this.user,this.options)}i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(fk){return function(fl){ah.success(ey("Ownership changed successfully"));return dY.pop()}})(this))};i.prototype.before_show=function(){var T;T=ey("Make %(person_name)s the owner of this folder?");T=T.format({person_name:bS.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":T})};return i})(dP);eu=E.ExistingSharedFolderPermissionsModal=(function(i){fb(j,i);j.SAVED_PERMISSIONS="existing_sf_permissions:saved";function j(fo,fm,T,fn){var fl,fk;this.user=fo;this.path=fm;this.ns_id=T;this.on_hide=fn;fl={ns_id:this.ns_id,folder_name:this.path};fl[Constants.UID_PARAM_NAME]=this.user.id;fk=ey("'%(folder_name)s' settings");fk=fk.format({folder_name:bS.em_snippet(aA.filename(this.path),13)});j.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:fk,endpoint_url:"/share_ajax/folder_settings",parameters:fl})}return j})(cB);c4=c4=(function(i){fb(j,i);function j(fm,T){var fl,fk;this.user=fm;this.ns_id=T;fl={ns_id:this.ns_id};fl[Constants.UID_PARAM_NAME]=this.user.id;fk=ey("Confirm converting to Golden Gate folder");j.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fk,endpoint_url:"/share_ajax/golden_gate_warning",parameters:fl})}return j})(cB);dz=E.GoldenGateWarningModalContents=(function(){function i(j,T,fk){this.$form=j;this.ns_id=fk;this._submit=b1(this._submit,this);this.user=cK.get_viewer().get_user_by_id(T);this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._submit=function(j){return dY.push(new bt(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};i.prototype._cancel=function(j){return dY.pop()};return i})();bt=bt=(function(j){fb(i,j);function i(fm,T){var fl,fk;this.user=fm;this.ns_id=T;fl={ns_id:this.ns_id};fl[Constants.UID_PARAM_NAME]=this.user.id;fk=ey("Confirm converting to Golden Gate folder");i.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fk,endpoint_url:"/share_ajax/golden_gate_confirm",parameters:fl})}return i})(cB);fc=E.GoldenGateConfirmModalContents=(function(j){fb(i,j);function i(T,fk,fl){this.$form=T;this.ns_id=fl;this.user=cK.get_viewer().get_user_by_id(fk);new cf(this.$form,null,{should_submit_once:true});this.$form.on(cf.SUCCESS_EVENT,(function(fm){return function(){return cC.WebRequest({url:"/share_ajax/enable_golden_gate_step_two",subject_user:fm.user,data:{ns_id:fm.ns_id},success:function(){ah.success("Golden Gate enabled for this folder");return location.reload()}})}})(this));this._listen()}i.prototype._listen=function(){return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(T){return dY.pop()};return i})(cB);R=E.ExistingSharedFolderPermissionsContent=(function(){function i(j,T,fk){this.$form=j;this.ns_id=fk;this._submit=b1(this._submit,this);this.user=cK.get_viewer().get_user_by_id(T);this.sharing_api=new bk(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(){return dY.pop()};i.prototype._submit=function(fn){var fo,j,fm,fk,fl,T;fn.preventDefault();j=this.$form.find("input[name=audience]:checked").val();fm=this.$form.find("input[name=inviter]:checked").val();T=this.$form.find("input[name=shared_link_policy]:checked").val();fo=(fl=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?fl.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,j,fm,T,fo,(function(fp){return function(fr){var fq,fs;fq=JSON.parse(fr.responseText);fs=fq.team_only_invite;ah.success(fq.message);dY.trigger(eu.SAVED_PERMISSIONS,fs);return dY.pop()}})(this));false;fk={ns_id:this.ns_id,audience:j,inviter:fm};return a9.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,fk)};return i})();var a0,d4,eS,dW,a1,eI,cn,cz,al,en,c9,cd,bQ,cX,cW,cU,cS,fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty,b1=function(i,j){return function(){return i.apply(j,arguments)}};a0=E.BaseShareAFolderWizardModal=(function(i){fb(j,i);j.prototype.base_title=null;j.prototype.personal_title=null;j.prototype.work_title=null;function j(T,fk){this.user=T;this.options=fk;j.__super__.constructor.call(this,this.options);this.sharing_api=new bk(this.user)}j.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=this.base_title;if(cK.get_viewer().is_paired){if(this.user.role==="personal"){T=this.personal_title}else{T=this.work_title.format({team_name:cK.get_viewer().team_name})}}return this.format({".db-modal-title-text":T})};return j})(d5);en=E.ShareAFolderWizardModal=(function(i){fb(j,i);function j(T,fk){this.user=T;this.options=fk;j.__super__.constructor.call(this,this.user,this.options);this.base_title=ey("Share a folder");this.personal_title=ey("Share a folder from your personal Dropbox");this.work_title=ey("Share a folder from your %(team_name)s Dropbox")}j.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(T){return function(fk){fk.preventDefault();s.start_wizard_without_user();return T.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(T){return function(fk){bD(fk.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(T.$modal_window.find("input#create-new-sf").is(":checked")){return a9.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",T.user)}else{return a9.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",T.user)}}})(this))};j.prototype.on_confirm_button_click=function(fp){var fm,fo,T,fl,fn,fk;fp.preventDefault();fo=this.$modal_window.find("input#create-new-sf").is(":checked");if(fo){fl=null;if(this.user.role==="work"){fn="shared-folder-type-wizard-modal";fk=d5.get_template(fn);if(fk.length){fl=new bQ(this.user,{element_id:fn})}}if(fl===null){fl=new cd(this.user,{element_id:"share-new-folder-wizard-modal"})}this.hide();T={selection:"new_folder"};a9.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,T);return fl.show()}fm=this.$modal_window.find(".ajax-loading-indicator").show();return bD.ajax({url:"/share_ajax/account_has_existing_folders",type:"post",subject_user:this.user,success:(function(fq){return function(fr){var fs;fr=JSON.parse(fr);if(fr===true){fl=new c9(fq.user,{element_id:"share-existing-folder-wizard-modal"});T.has_existing_folder=true}else{fs=ey("You don't have any existing folders. Please create and share a new folder.");fl=new cd(fq.user,{element_id:"share-new-folder-wizard-modal",error_msg:fs});T.has_existing_folder=false}fq.hide();return fl.show()}})(this),error:(function(fq){return function(){return ah.error()}})(this),complete:(function(fq){return function(){return fm.hide()}})(this)},T={selection:"existing_folder"},a9.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,T))};return j})(a0);bQ=E.SharedFolderTypeWizardModal=(function(j){fb(i,j);function i(T,fk){this.user=T;this.options=fk;i.__super__.constructor.call(this,this.user,this.options);this.work_title=ey("Share a folder from your %(team_name)s Dropbox")}i.prototype.on_show=function(){this.$modal_window.find("input#team-folder-option").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(T){return function(fk){fk.preventDefault();s.start_wizard_for_user(T.user);return T.hide()}})(this));return this.$modal_window.find("#shared-folder-type li").on("click",(function(T){return function(fk){bD(fk.currentTarget).find('input[name="shared_folder_type"]').prop("checked",true);if(T.$modal_window.find("input#team-folder-option").is(":checked")){return a9.SharedFolderActivityLogger.log("web","shared_folder_type_team_folder",T.user)}else{return a9.SharedFolderActivityLogger.log("web","shared_folder_type_shared_folder",T.user)}}})(this))};i.prototype.on_confirm_button_click=function(fn){var T,fl,fm,fk;fn.preventDefault();T=(function(fo){return function(fr,fp){var fq;fr.preventDefault();fp.hide();fq=new fo.constructor(fo.user,fo.options);return fq.show()}})(this);fl=this.$modal_window.find("input#team-folder-option").is(":checked");if(fl){fm=new dU({element_id:"new-team-folder-modal",open_created_folder:true,back_fn:T});fk="team_folder"}else{fm=new cd(this.user,{element_id:"share-new-folder-wizard-modal",back_fn:T});fk="shared_folder"}a9.SharedFolderActivityLogger.log("web","shared_folder_type_next_button",this.user,{selection:fk});this.hide();return fm.show()};return i})(a0);eI=E.InlineModalValidationError=(function(){function i(){}i.show_validation_error=function(fp,fl){var fm,fn,fk,T,fo,j;if(fp.responseText.indexOf("err:{")===0){j=fp.responseText.substr(4);fo=JSON.parse(j);for(fn in fo){fm=fo[fn];if("message_text" in fm){T=fl.find("span.error-message");if(T.length===0){T=bD("<span/>").addClass("error-message");fl.prepend(T)}T.text(fm.message_text);return}}fl.find("span.error-message").remove();return ah.error()}else{fl.find("span.error-message").remove();if(fp.responseText.indexOf("err:")===0){fk=fp.responseText.substr(4);return ah.error(fk)}else{return ah.error()}}};return i})();cX=E.TeamSharedFolderWizardModalPage1=(function(i){fb(j,i);function j(T,fk){this.user=T;this.options=fk;this.__fix_position=b1(this.__fix_position,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=ey("Now, let's set up your team");this.options.vertical_offset=5}j.prototype.on_show=function(){var fl,fk,T,fm;fm=this.$modal_window.find(".suggestion-input");for(fk=0,T=fm.length;fk<T;fk++){fl=fm[fk];c3.register($(fl))}this.$modal_window.find("#validate-team-name").submit((function(fn){return function(fo){fo.preventDefault();return fn.on_confirm_button_click(fo)}})(this));if(this.options.error_msg){ah.error(this.options.error_msg)}return a9.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};j.prototype.on_confirm_button_click=function(fm){var fk,T,fl;fm.preventDefault();fl=this.$modal_window.find("#new-team-shared-folder-name-input").val();T=(function(fn){return function(){var fo;fo=new cW(fn.user,{team_name:fl,element_id:"team-shared-folder-wizard-modal-page2"});fn.hide();return fo.show()}})(this);fk=(function(fn){return function(fo){a9.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",fn.user);return eI.show_validation_error(fo,fn.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(fl,T,fk)};j.prototype.__fix_position=function(fk){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return j})(a0);cW=E.TeamSharedFolderWizardModalPage2=(function(i){fb(j,i);function j(T,fk){this.user=T;this.options=fk;this.__fix_position=b1(this.__fix_position,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=ey("Invite teammates");this.folder_name=this.options.team_name}j.prototype.before_show=function(){var T;T=ey("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":T})};j.prototype.on_show=function(){a9.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(T){return function(fk){fk.preventDefault();return T.on_confirm_button_click(fk)}})(this))};j.prototype.on_confirm_button_click=function(fn){var fl,fk,fm,fp,T,fo;fn.preventDefault();fp={emails:[]};a9.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(T=fm=1;fm<=10;T=++fm){fl=this.$modal_window.find("#new-team-shared-folder-email"+T).val();if(fl){fp.emails.push(fl)}}fk=d1.getForRole(cr.active_user.role);if(!fk.verified_or_show()){a9.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return fk.send_email("share_folder",(function(fq){return function(){var fr;fr=new cU(fq.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:fq.folder_name,invitees:fp,from_email_verification:true});fq.hide();return fr.show()}})(this))}else{a9.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);fo=new cU(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:fp,from_email_verification:true});this.hide();return fo.show()}};j.prototype.__fix_position=function(fk){var T;T=this.$modal_window.find(".db-modal");T.css;return{margin:"0",position:"fixed"}};return j})(a0);cU=E.TeamSharedFolderWizardModalPage3=(function(i){fb(j,i);function j(T,fk){this.user=T;this.options=fk;this.__fix_position=b1(this.__fix_position,this);j.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=ey("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}j.prototype.on_show=function(){var fo,fm,fl,fk,fq,fp,fn,T;a9.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(fr){return function(fs){fs.preventDefault();return fr.on_close_button_click(fs)}})(this));fq="";fp=true;fm=false;fk="all";fn=false;fo=null;T=(function(fr){return function(fu){var fs,ft;fs=JSON.parse(fu.responseText);ah.success(fs.success_msg);ft=new cS(fr.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:fr.options.folder_name,invitees:fr.options.invitees,from_email_verification:true});fr.hide();return ft.show()}})(this);fl=(function(fr){return function(fs){return fr.hide()}})(this);return this.sharing_api.share_folder(fp,this.options.folder_name,this.options.invitees,fq,fm,fk,fn,fo,false,T,fl)};j.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.hide()};j.prototype.__fix_position=function(fk){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return j})(a0);cS=E.TeamSharedFolderWizardModalPage4=(function(j){fb(i,j);function i(T,fk){this.user=T;this.options=fk;this.__fix_position=b1(this.__fix_position,this);i.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=ey("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}i.prototype.before_show=function(){var T;T=this.$modal_window.find("#back_to_home");T.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};i.prototype.on_show=function(){return a9.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};i.prototype.__fix_position=function(fk){var T;T=this.$modal_window.find(".db-modal");return T.css({margin:"0",position:"fixed"})};return i})(a0);cd=E.ShareNewFolderWizardModal=(function(j){fb(i,j);function i(T,fk){this.user=T;this.options=fk;this.options.focus="#new-shared-folder-wizard input[type=text]";i.__super__.constructor.call(this,this.user,this.options);this.base_title=ey("Create a new shared folder");this.personal_title=ey("Create a shared folder in your personal Dropbox");this.work_title=ey("Create a shared folder in your %(team_name)s Dropbox")}i.prototype.on_show=function(){var fl,fk,T,fm;fm=this.$modal_window.find(".suggestion-input");for(fk=0,T=fm.length;fk<T;fk++){fl=fm[fk];c3.register($(fl))}this.$modal_window.find("#validate-folder-name").submit((function(fn){return function(fo){fo.preventDefault();return fn.on_confirm_button_click(fo)}})(this));if(this.options.error_msg){ah.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(fn){return function(fo){if(fn.options.back_fn){return fn.options.back_fn(fo,fn)}else{fo.preventDefault();fn.hide();return s.start_wizard_for_user(fn.user)}}})(this))};i.prototype.on_confirm_button_click=function(fm){var fl,fn,fk,T;fm.preventDefault();fn=this.$modal_window.find("#new-shared-folder-name-input").val();fk={folder_name:fn};a9.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,fk);bD(document).trigger("db:share_new_folder:next");T=(function(fo){return function(){var fp;fp=new cn(fo.user,{folder_name:fn,element_id:"invite-to-new-sf-wizard-modal-"+fo.user.id});fo.hide();fp.new_folder=true;fp.show();return a9.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",fo.user,fk)}})(this);fl=(function(fo){return function(fp){var fq;fq=cf.extract_errors(fp.responseText);a9.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",fo.user,fk);if(fq===false){}else{if(typeof fq==="string"){return ah.error(fq)}else{bD("#new-shared-folder-name-input .error-message").remove();return cf.fill_errors(bD("#validate-folder-name"),fq)}}}})(this);return this.sharing_api.validate_new_sf_path(fn,T,fl)};return i})(a0);c9=E.ShareExistingFolderWizardModal=(function(j){fb(i,j);function i(T,fk){this.user=T;this.options=fk;this._hide=b1(this._hide,this);this.on_show=b1(this.on_show,this);i.__super__.constructor.call(this,this.user,this.options);this.base_title=ey("Choose folder to share");this.personal_title=ey("Choose a folder from your personal Dropbox");this.work_title=ey("Choose a folder from your %(team_name)s Dropbox")}i.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=bD("#"+this.treeview_id).parent().attr("id");b0.schedule_reset();b0.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(T){return function(){var fk;bD(document).on("db:treeview_selected",function(fm,fl){return T.folder_name=fl});fk=bD(".first-treeview-link");if(!d3.ie){return fk.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(T){return function(fk){fk.preventDefault();T.hide();return s.start_wizard_for_user(T.user)}})(this))};i.prototype._hide=function(){b0.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return i.__super__._hide.apply(this,arguments)};i.prototype.on_hide=function(){return bD(document).off("db:treeview_selected")};i.prototype.on_confirm_button_click=function(fm){var fl,fk,T;fk={folder_name:this.folder_name};fm.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();a9.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,fk);return s.show_shared_folder_options_modal(this.folder_name,this.user)}else{T=(function(fn){return function(){var fo;fo=new cn(fn.user,{folder_name:fn.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+fn.user.id});fn.hide();a9.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",fn.user,fk);fo.new_folder=false;return fo.show()}})(this);fl=(function(fn){return function(fo){return eI.show_validation_error(fo,fn.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,T,fl)}};return i})(a0);a1=E.CreateOrShareNewFolderWizardModal=(function(i){fb(j,i);function j(T,fk){this.user=T;this.options=fk;this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this._extract_invitees=b1(this._extract_invitees,this);this._toggle_send_button_state=b1(this._toggle_send_button_state,this);j.__super__.constructor.call(this,this.options);this.destination_dir=this.options.destination_dir;this.sharing_api=new bk(this.user);this.state="Create"}j.prototype.on_show=function(){var fk,fl,fn,fm,T;this.$send_button=this.$modal_window.find(".confirm-button");this.$cancel_button=this.$modal_window.find(".cancel-button");fn="create-and-share-new-folder-invite-wizard-"+this.user.id;this.file_name_input=this.$modal_window.find("#create-and-share-new-folder-name-input");this.file_name_input.focus();fl=fn+"-new-collab-input";this.collab_input=this.$modal_window.find("#"+fl);fk={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:this.user.id,max_textbox_height:30};this.autocompleter=new Autocompleter.ContactsTokenizer(this.user,fl,fn+"-new-whobulk",fn+"-hidden-input",fk);if((fm=this.file_name_input)!=null){fm.keyup(this._toggle_send_button_state)}if((T=this.collab_input)!=null){T.keyup(this._toggle_send_button_state)}if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_send_button_state);this.collab_input[0].on("token:add",this._toggle_send_button_state)}return this._toggle_send_button_state()};j.prototype._toggle_send_button_state=function(){var fm,fl,fk,T;T=((fl=this.autocompleter)!=null?fl.token_manager.tokens.length:void 0)===0;T=T&&this.collab_input.val()==="";fm=this.file_name_input.val();fk=fm==="";this.$send_button.prop("disabled",fk);if(T){this.$send_button.text(ey("Create folder"));return this.state="Create"}else{this.$send_button.text(ey("Share folder"));return this.state="Share"}};j.prototype._extract_invitees=function(){var fp,fl,fo,fm,fk,fq,T,fn;fo=this.$modal_window.find(".tokenized_autocompleter_container");fq={};fn=["emails","fb_ids","group_ids","new_style_group_ids"];for(fm=0,T=fn.length;fm<T;fm++){fl=fn[fm];fk=fo.find("input[name="+fl+"]");fq[fl]=(function(){var fs,fr,ft;ft=[];for(fs=0,fr=fk.length;fs<fr;fs++){fp=fk[fs];ft.push(bD(fp).val())}return ft})()}return fq};j.prototype.on_confirm_button_click=function(fu){var fl,fr,fo,fw,fp,fs,fm,fn,T,fq,ft,fv,fk;fu.preventDefault();T=this.file_name_input.val();fw=ey("We can\u2019t create folder '%(folder_name)s'");fw=fw.format({folder_name:T});fo=function(){return ah.error(fw)};if(this.state==="Create"){fk="/cmd/new"+d3.urlquote(this.destination_dir);fq={to_path:T};fq[Constants.UID_PARAM_NAME]=this.user.id;fv=function(){var fx;fx=ey("Created new folder '%(folder_name)s'");fx=fx.format({folder_name:T});return ah.success(fx)};new cC.WebRequest({url:fk,data:fq,success:fv,error:fo})}else{this.autocompleter.tokenize_emails_input(true);fs=this._extract_invitees();fv=function(){var fx;fx=ey("Shared new folder '%(folder_name)s'");fx=fx.format({folder_name:T});return ah.success(fx)};fn="";fr=false;fm="all";ft=false;fl=null;fp=this.destination_dir+"/"+T;this.sharing_api.share_path(fp,fs,fn,fr,fm,ft,fl,false,fv,fo)}return this.hide()};return j})(d5);dW=E.CreateLinkOrInviteToFolderWizardModal=(function(j){fb(i,j);function i(T,fk){this.user=T;this.options=fk;i.__super__.constructor.call(this,this.options);this.sharing_api=new bk(this.user)}i.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=ey("Share '%(folder_name)s' with others");T=T.format({folder_name:bS.em_snippet(aA.filename(this.options.path),16)});return this.format({".db-modal-title-text":T})};i.prototype.on_show=function(){var T,fk,fl;T="edu_modal";fl=(fk=this.options.target_item)!=null?fk:null;a9.ShmodelUILogger.log("view",T,fl);this.$modal_window.find(".option-to-share-folder").on("click",(function(fm){return function(fo){var fn;if(fm.options.existing_sf){a9.ShmodelUILogger.log("sf_options",T,fl);fn=new de(cr.active_user,fm.options.path)}else{a9.ShmodelUILogger.log("sf_invite",T,fl);fn=new cn(fm.user,{folder_name:fm.options.path,element_id:"invite-to-new-sf-wizard-modal-"+fm.user.id})}fm.hide();return fn.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(fm){return function(fn){a9.ShmodelUILogger.log("token_share",T,fl);dv.shmodel(fm.options.path,"create_link_or_invite_to_folder_modal");return fm.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(fm){return function(fn){fn.preventDefault();a9.ShmodelUILogger.log("clicked_learn_more",T,fl);return window.open("/help/274","_blank")}})(this))};return i})(d5);cn=E.InviteToNewSharedFolderWizardModal=(function(j){fb(i,j);function i(T,fk){this.user=T;this.options=fk;this.insert_folder_settings=b1(this.insert_folder_settings,this);this.share_folder=b1(this.share_folder,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.show_settings_modal=b1(this.show_settings_modal,this);this.show_m2_settings_modal=b1(this.show_m2_settings_modal,this);this._toggle_get_link_button_visibility=b1(this._toggle_get_link_button_visibility,this);this.options.focus=".new-collab-input";i.__super__.constructor.call(this,this.options);this.sharing_api=new bk(this.user);this.folder_name=this.options.folder_name;this.is_file=this.options.is_file;this.must_check_verified=(this.options.must_check_verified!=null)||false;this.progress_ever_blocked_by_verify=false;this.has_inviter_restriction=this.options.has_inviter_restriction}i.prototype.before_show=function(){var T;this.sharing_api.loading_elem=this.$modal_window;T=ey("Share '%(folder_name)s' with others");T=T.format({folder_name:bS.em_snippet(aA.filename(this.folder_name),16)});return this.format({".db-modal-title-text":T})};i.prototype.on_show=function(){var fk,fm,fl,T,fo,fn;fn=this.$modal_window.find(".suggestion-input");for(fl=0,T=fn.length;fl<T;fl++){fm=fn[fl];c3.register($(fm))}fk=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){fo="invite-wizard-"+this.user.id;this.invite_form_controller=new dd(this.user,fk,[],[],[],fo);this.insert_folder_settings(this.invite_form_controller.team_only?"team":"")}else{this.invite_form_controller.listen()}this.get_link_button=this.$modal_window.find(".get-editable-link-invite");if(this.get_link_button.length>0){B.showInstance(dA.createElement(B,{onDismiss:eD.dismissM2Prompt,shouldShow:cr.simple_sharing_show_m2_prompt,targetedButton:this.get_link_button.get(0)}));a9.SimpleSharingLogger.log(this.user.id,27)}this.collab_input=this.$modal_window.find(".new-collab-input");this.collab_input.focus();this.collab_input.keyup(this._toggle_get_link_button_visibility);if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_get_link_button_visibility);this.collab_input[0].on("token:add",this._toggle_get_link_button_visibility)}this.$modal_window.find(".change-new-folder-settings").on("click",(function(fp){return function(fq){fq.preventDefault();return fp.show_settings_modal()}})(this));this.$modal_window.find(".m2-settings-link").on("click",(function(fp){return function(fq){fq.preventDefault();return fp.show_m2_settings_modal()}})(this));this.$modal_window.find(".get-editable-link-invite").on("click",(function(fp){return function(fu){var fv,ft,fr,fq,fs;fu.preventDefault();bD(document).trigger("collab:m2:prompt:dismiss");fq=fp.$modal_window.find(".m2-settings-link");if(fq.length>0){fp.inviter_restriction=fp.has_inviter_restriction?"me":"all"}a9.SimpleSharingLogger.log(fp.user.id,28);fv=fp.$modal_window.find(".get-link-invite-loading");if(fv!=null){fv.show()}fs=function(fy){var fA,fz,fC,fx,fw,fB;if(fv!=null){fv.hide()}fx=ba.parse_response(fy),fB=fx[0],fC=fx[1];if(fB){return eD.createAndShowM2InbandModal(fp.user,fp.folder_name)}else{fw=ba.parse_error(fC),fz=fw[0],fA=fw[1];if(fz){return ah.error(fA)}else{return ah.error(ey("Failed to create link."))}}};fr=function(){if(fv!=null){fv.hide()}return ah.error(ey("Failed to create link."))};ft={path:fp.folder_name,emails:[],fb_ids:[],new_style_group_ids:[],custom_message:"",access_type:2,is_simple_sharing:true,folder_settings:1,shared_link_policy:fp.shared_link_policy_restriction,audience:fp.audience_restriction,inviter:fp.inviter_restriction};if(fp.audience_restriction||fp.inviter_restriction){ft.custom_folder_settings=1}return cC.FormWebRequest({subject_user:fp.user.id,url:"/share_ajax/existing_no_recipient",data:ft,success:fs.bind(fp),error:fr.bind(fp),skipErrorHandling:true})}})(this));this.log_extras={path:this.folder_name};a9.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,this.log_extras);if(this.is_file){return a9.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_displayed",this.user,this.log_extras)}};i.prototype._toggle_get_link_button_visibility=function(){var fn,fm,fl,fk,T;if(this.shared_link_policy_restriction==="1"){if((fl=this.get_link_button)!=null){fl.hide()}return}fm=this.invite_form_controller.get_token_count()===0;fn=this.collab_input&&this.collab_input.val()==="";if(fm&&fn){return(fk=this.get_link_button)!=null?fk.show():void 0}else{return(T=this.get_link_button)!=null?T.hide():void 0}};i.prototype.show_m2_settings_modal=function(){var fk,T;fk=this.folder_name;T=function(fl){var fm;fm=new i(cr.active_user,{folder_name:fk,element_id:"invite-to-new-share-file-wizard-modal-"+cr.active_user.id,has_inviter_restriction:!fl});return fm.show()};dY.pop();return ae.showInstance(dA.createElement(ae,{user:this.user,fq_path:this.folder_name,is_shared_folder:false,initial_allows_editor_manage_membership:!this.has_inviter_restriction,done_callback:T}))};i.prototype.show_settings_modal=function(){var fk,T;T=ey("'%(folder_name)s' settings");T=T.format({folder_name:bS.em_snippet(aA.filename(this.folder_name),13)});fk={folder_name:this.folder_name};if(this.audience_restriction){fk.audience=this.audience_restriction}if(this.inviter_restriction){fk.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){fk.shared_link_policy=this.shared_link_policy_restriction}fk[Constants.UID_PARAM_NAME]=this.user.id;if(this.is_file){fk.is_file=this.is_file}dY.register(cz.SAVED_PERMISSIONS,(function(fl){return function(fn,fm){fl.insert_folder_settings(fm.audience,fm.inviter,fm.shared_link_policy);return fl.invite_form_controller.reset_options()}})(this));return dY.push(new cB({element_id:"folder-permissions-modal",title:T,endpoint_url:"/share_ajax/default_folder_settings",parameters:fk}))};i.prototype.on_confirm_button_click=function(fn){var fm,fl,fp,fk,T,fo;fn.preventDefault();this.invite_form_controller.tokenize();fp=this.invite_form_controller.extract_invitees();fo=this.invite_form_controller.get_custom_message();fm=this.invite_form_controller.get_access_type();fk=this.$modal_window.find("input#allow_other_members_to_share");if(fk.length>0){this.inviter_restriction=fk.is(":checked")?"all":"me"}T=this.$modal_window.find(".m2-settings-link");if(T.length>0){this.inviter_restriction=this.has_inviter_restriction?"me":"all"}if(this.is_file){fl=new eS(this.user,{element_id:"confirm-share-new-file-wizard-modal",invitees:fp,msg:fo,access_type:fm,audience_restriction:this.audience_restriction,inviter_restriction:this.inviter_restriction,shared_link_policy_restriction:this.shared_link_policy_restriction,file_path:this.folder_name});this.hide();fl.show();return a9.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_continued",this.user,this.log_extras)}else{return this.share_folder(fp,fo,fm,true,false)}};i.prototype.share_folder=function(fo,fl,T,fp,fn,fk){var ft,fm,fq,fs,fr;if(fp==null){fp=true}if(fn==null){fn=false}if(fk==null){fk=false}fm=(function(fu){return function(fv){return eI.show_validation_error(fv,fu.$modal_window.find(".tokenized_autocompleter_container"))}})(this);fs=(function(fu){return function(fx){var fw,fv;fv=JSON.parse(fx.responseText);ah.success(fv.success_msg);if(fu.progress_ever_blocked_by_verify){a9.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_share_succeess",fu.user,fq)}document.fire(aH.SF_NEW,{sf_info:bX.decode_sort_key(fv.sf_info)});if(fp){fu.hide()}if(fk){fw=new de(fu.user,aA.normalize(fu.folder_name));return fw.show()}}})(this);if(this.must_check_verified&&!this.user.is_email_verified){this.progress_ever_blocked_by_verify=true;a9.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_blocked_on_verify",this.user,fq);this.$modal_window.find(".confirm-button").prop("disabled",true);fr=ey("Verification email sent to %(email)s").format({email:this.user.email});ft=d1.get_for_user(this.user);ft.send_email("share_folder",function(){return ah.success(fr)});bD("#resend-email-verification-link").click(function(){return ft.send_email("share_folder",function(){return ah.success(fr)})});this.$modal_window.find(".email-verify-message").show();return ft.ensure_polling((function(fu){return function(){a9.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_unblocked",fu.user,fq);ah.success(ey("Email verified. Try sharing your folder again."));fu.$modal_window.find(".confirm-button").prop("disabled",false);return fu.$modal_window.find(".email-verify-message").hide()}})(this))}else{this.sharing_api.share_folder(this.new_folder,this.folder_name,fo,fl,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,T,fn,fs,fm);fq={path:this.folder_name,access_type:T};a9.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,fq);return bD(document).trigger("db:invite_to_new_folder:share")}};i.prototype.insert_folder_settings=function(T,fk,fm){var fl;this.audience_restriction=T;this.inviter_restriction=fk;this.shared_link_policy_restriction=fm;fl=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(cr.inside_team_folder){fl.addClass("in-team-folder");fl.removeClass("team-only")}else{fl.removeClass("in-team-folder");if(this.audience_restriction==="team"){fl.addClass("team-only")}else{fl.removeClass("team-only")}if(this.user.role==="work"){this.invite_form_controller.set_team_only(this.audience_restriction==="team")}}return this._toggle_get_link_button_visibility()};return i})(d5);al=E.NewSharedFolderPermissionsModal=(function(i){fb(j,i);function j(fk,fo,T,fl){var fn,fm;this.user=fk;this.path=fo;this.saved_state=T;this.done_callback=fl;fn={folder_name:this.path,audience:this.saved_state.audience?this.saved_state.audience:void 0,inviter:this.saved_state.inviter?this.saved_state.inviter:void 0,shared_link_policy:this.saved_state.shared_link_policy?this.saved_state.shared_link_policy:void 0,is_file:false};fn[Constants.UID_PARAM_NAME]=this.user.id;fm=ey("\u2018%(folder_name)s\u2019 settings");fm=fm.format({folder_name:bS.em_snippet(aA.filename(this.path),13)});dY.register(cz.SAVED_PERMISSIONS,(function(fp){return function(fr,fq){return fp.done_callback.bind(null,fq.audience,fq.inviter,fq.shared_link_policy)()}})(this));j.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:fm,endpoint_url:"/share_ajax/default_folder_settings",parameters:fn})}return j})(cB);eS=E.ConfirmShareNewFileWizardModal=(function(i){fb(j,i);function j(T,fk){this.user=T;this.options=fk;j.__super__.constructor.call(this,this.options);this.file_path=this.options.file_path;this.file_name=aA.filename(this.file_path);this.folder_name=aA.filename_without_extension(this.file_name);this.folder_path=aA.parent_dir(this.file_path)+"/"+this.folder_name;this.invitees=this.options.invitees;this.msg=this.options.msg;this.audience_restriction=this.options.audience_restriction;this.inviter_restriction=this.options.inviter_restriction;this.shared_link_policy_restriction=this.options.shared_link_policy_restriction;this.access_type=this.options.access_type;this.sharing_api=new bk(this.user);this.log_extras={path:this.file_path}}j.prototype.before_show=function(){this.format({".confirm-share-file-invitees":this.format_invitees(),".confirm-share-file-name":this.file_name,".confirm-share-folder-name":this.folder_name});return a9.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_displayed",this.user,this.log_extras)};j.prototype.on_confirm_button_click=function(fl){var fk,T;fk=(function(fm){return function(fp){var fn,fo,fq;a9.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_failed",fm.user,fm.log_extras);fq=cf.extract_errors(fp.responseText);if(fq===false){return}else{if(typeof fq==="string"){ah.error(fq)}else{if(typeof fq==="object"){for(fo in fq){fn=fq[fo];if("message_text" in fn){ah.error(fn.message_text);break}}}}}return fm.hide()}})(this);T=(function(fm){return function(){var fn;a9.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_succeeded",fm.user,fm.log_extras);fn=ey("%(folder_name)s was shared successfully.").format({folder_name:fm.folder_name});ah.success(fn);return fm.hide()}})(this);this.sharing_api.share_file(this.folder_path,this.file_path,this.invitees,this.msg,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,this.access_type,T,fk);return a9.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_confirmed",this.user,this.log_extras)};j.prototype.format_invitees=function(){var fo,fn,fl,fk,T,fm;if(!this.invitees){return ey("others")}fo=this.invitees.emails[0];fn=this.invitees.fb_ids[0];fl=this.invitees.group_ids[0];fk=this.invitees.new_style_group_ids[0];if(!fo.length){return ey("others")}T=fo[0];fm=fo.length+fn.length+fl.length+fk.length;if(fm>1){T=T+ey(" and others")}return T};return j})(d5);d4=E.ConfirmShareExistingFileWizardModal=(function(j){fb(i,j);function i(T,fk){this.user=T;this.options=fk;i.__super__.constructor.call(this,this.options);this.folder_name=this.options.folder_name;this.folder_path=this.options.folder_path;this.log_extras={path:this.folder_name}}i.prototype.before_show=function(){this.format({".confirm-share-existing-folder-name":this.folder_name});return a9.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_displayed",this.user,this.log_extras)};i.prototype.on_confirm_button_click=function(fk){var T;a9.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_confirmed",this.user,this.log_extras);T=new de(this.user,this.folder_path);this.hide();return T.show()};return i})(d5);cz=E.NewSharedFolderPermissionsContent=(function(){i.SAVED_PERMISSIONS="new_sf_permissions:saved";function i(j){this.$form=j;this._submit=b1(this._submit,this);this._listen()}i.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};i.prototype._cancel=function(){return dY.pop()};i.prototype._submit=function(fl){var T,fk,j;fl.preventDefault();T=this.$form.find("input[name=audience]:checked").val();fk=this.$form.find("input[name=inviter]:checked").val();j=this.$form.find("input[name=shared_link_policy]:checked").val();dY.trigger(i.SAVED_PERMISSIONS,{audience:T,inviter:fk,shared_link_policy:j});return dY.pop()};return i})();var dv;dv=E.SharingShmodel=(function(){function i(){}i.shmodel=function(T,j){return new df(cr.active_user.id,T,j).show()};return i})();var bX;bX=INLINE_JS.Sharing=E.Sharing={init:function(j,i){this.show_inbox=j;this.simple_sharing_enabled=i;this._state={sf_info:{},cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{},sf_loading:true,delay_reload_folder:false,pending_new_folders:[]};if(cK.get_viewer().is_paired){this.role_picker=C.controller(bD("#role-selector"));this.role_picker.on_state_change=this._render.bind(this);bM.set_during_login_callback((function(T){return function(fl,fk){return T._reload_folder_info(function(){return fk()},function(fm){fk(ey("Error displaying shared folders"));return window.location.reload()})}})(this))}this._listen();this._tmpl=ff.tmpl("sf_list_item_tmpl");this._display_spinner();cC.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(T){return function(fk){T._load_and_render_sf_list(fk);return ee.mark_time_to_interactive()}})(this),error:(function(T){return function(fk){return T._sf_list_error()}})(this)});this.refresh_inbox_counts(true);this._display_view();return bD(document).on(bk.REQUEST_SUCCEEDED_EVENT,(function(T){return function(fk,fl){if(fl.request_url==="/share_ajax/cancel_invite"||fl.request_url==="/share_ajax/invite_more"||fl.request_url==="/share_ajax/kick_user"){return T._reload_folder_info()}}})(this))},_load_and_render_sf_list:function(i){this._decode_sort_keys(i);this._state.sf_info=i;this._state.sf_loading=false;this._hide_spinner();if(this._state.pending_new_folders.length>0){this._state.sf_info.current.push.apply(this._state.sf_info.current,this._state.pending_new_folders);this._state.pending_new_folders=[]}this._render();if(this._state.delay_reload_folder){this._state.delay_reload_folder=false;return this._reload_folder_info()}},_sf_list_error:function(){this._hide_spinner();return ah.error(ey("We weren\u2019t able to load the list of shared folders. Please refresh the page to try again."))},is_share_page:function(){return this._state!=null},_decode_sort_keys:function(i){return[i.current,i.past].each((function(j){return function(T){return T.each(function(fk){return j.decode_sort_key(fk)})}})(this))},decode_sort_key:function(i){cJ((i.encoded_sort_key!=null)&&(i.sort_key==null),"expected encoded sort keys on each elm");i.sort_key=d3.decode_sort_key(i.encoded_sort_key);delete i.encoded_sort_key;return i},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(T,i){var j;if(!this.is_share_page()){return}j=(function(fk){return function(fl){var fm;fm=JSON.parse(fl.responseText);fk._decode_sort_keys(fm);fk._state.sf_info=fm;fk._render();return typeof T==="function"?T():void 0}})(this);if(this._state.sf_loading){return this._state.delay_reload_folder=true}else{return new cp().get_folder_info(j,i)}},refresh_inbox_counts:function(i){return new cp().get_inbox_counts((function(j){return function(T){return j._update_inbox_counts(T,i)}})(this))},_update_inbox_counts:function(j,fl){var fo,T,i,fn,fm,fk;fk=0;for(fn in j){fo=j[fn];fk+=fo}bD("#inbox-count").text(fk);bD("#inbox-count").toggleClass("show",fk>0);if(!this.is_share_page()){return}T=function(fq,fp){var fr;for(fn in fq){fr=fq[fn];if(fp[fn]!==fq[fn]){return false}}return true};if((!fl)&&this._state&&T(this._state.inbox_counts,j)){return}this._state.inbox_counts=j;if(fk){i=new Element("a",{id:"new-invites-link",href:"#"});i.__sert(cv.make("web","email_32",{"class":"link-img"}));fm=bb("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",fk);fm+=" \n";fm=fm.format({total_count:fk});i.__sert(fm);i.observe("click",(function(fp){return function(fq){Event.stop(fq);return fp.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(i)}else{$("invites-box").hide()}if(fk>0&&this.show_inbox){this.show_inbox=false;return this.show_invites()}},register_accept:function(i){bD(i).closest(".sf-invite-action").addClass("loading");new bw(bD(i),i.action,{data:bR.collect_form_vars(i),complete:(function(j){return function(fk,T){bD(i).closest(".sf-invite-action").removeClass("loading");j.refresh_inbox_counts();return j._reload_folder_info()}})(this),success:(function(j){return function(fn,T,fp){var fl,fm,fo,fk;fn=(fk=JSON.parse(fp.responseText))!=null?fk.data:void 0;fl=bD(i).closest(".sf-invite-action");fl.addClass("sf-accepted");if(fn!=null?fn.redirect:void 0){if(j._state&&j._state.current_total_count>1){fm=fl.find(".view-folder-button");return fm.click(function(){return window.location.href=fn!=null?fn.redirect:void 0})}else{return window.location.href=fn!=null?fn.redirect:void 0}}else{fo=bD(i).closest(".invitation-row").attr("data-invite-id");return j._remove_invite_row(fo)}}})(this)});return false},register_decline:function(j,fk,fl){var i,T;i=bD(j).closest("form");if((T=i.closest(".sf-invite-action"))!=null){T.addClass("loading")}if(i.length){new bw(i,i[0].action,{data:bR.collect_form_vars(i[0]),complete:(function(fm){return function(fp,fn){var fo;if((fo=i.closest(".sf-invite-action"))!=null){fo.removeClass("loading")}fm._remove_invite_row(fk);fm.refresh_inbox_counts();fm._reload_folder_info();if(fl){return fl()}}})(this)})}return false},_remove_invite_row:function(fl){var i,fk,T,j;i=bD("#invites-container");fk=i.find('[data-invite-id="'+fl+'"]');if(fk){j=fk.parent("tbody");fk.remove();if(j.children().length===0){i.find(".invitation-table-container").hide();i.find(".message-bottom").removeClass("message-bottom");i.find(".message-top").removeClass("message-top");if(i.find(".invites-message").length===0){T=d5.get_containing_modal(i);return T!=null?T.hide():void 0}}}},_quietly_reload_content:function(){return cC.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(i){return function(j){return i._load_and_render_sf_list(j)}})(this),error:(function(i){return function(j){return i._sf_list_error()}})(this)})},_listen:function(){var T,j,i;this.listen_modals();T=(function(fk){return function(fn,fv,fp){var fq,fm,fu,fo,fr,ft,fl,fs,fw;fl=fk._get_current_sf_list_info(fp),ft=fl[0],fu=fl[1];cJ(fv,"SF _transfer w/o target_ns_id");for(fq=fo=0,fr=ft.length;fo<fr;fq=++fo){fm=ft[fq];if(fm.target_ns_id===fv&&fm.user_id===fn){fs=fm;fw=fq;break}}cJ(fw!=null,"SF _transfer w/o js obj");return[fs,fw]}})(this);i=(function(fk){return function(fp,fv,fs){var fu,fl,fr,fo,fq,fw,ft,fn,fm;fl=fk._get_current_sf_list_info(fv),fu=fl[0],fm=fl[1];fr=fk._get_current_sf_list_info(fs),ft=fr[0],fn=fr[1];fo=T(fp.memo.user_id,fp.memo.target_ns_id,fv),fq=fo[0],fw=fo[1];fu.splice(fw,1);fk._empty_check(fv);if(fp.memo.filename!=null){fq.filename=fp.memo.filename}if(fp.memo.mount_point!=null){fq.mount_point=fp.memo.mount_point}ft.push(fq);return fk._render()}})(this);j=(function(fk){return function(fq,fn){var fs,fo,fm,fp,fr,fl;fo=fk._get_current_sf_list_info(fn),fs=fo[0],fl=fo[1];fm=T(fq.memo.user_id,fq.memo.target_ns_id,fn),fp=fm[0],fr=fm[1];fs.splice(fr,1);return fk._render()}})(this);document.observe(aH.SF_UNSHARE,(function(fk){return function(fl){return j(fl,"#sf-current")}})(this));document.observe(aH.SF_LEAVE,(function(fk){return function(fl){return i(fl,"#sf-current","#sf-past")}})(this));document.observe(aH.SF_REJOIN,(function(fk){return function(fl){i(fl,"#sf-past","#sf-current");return fk._quietly_reload_content()}})(this));document.observe(aH.SF_IGNORE,(function(fk){return function(fl){return j(fl,"#sf-past")}})(this));document.observe(aH.SF_NEW,(function(fk){return function(fm){var fl;fl=fm.memo.sf_info;cJ(fl,"SF_NEW without info");if(fk._state.sf_loading){return fk._state.pending_new_folders.push(fl)}else{fk._state.sf_info.current.push(fl);return fk._render()}}})(this));$("create-share").observe("click",(function(fk){return function(fl){a9.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(fl);return s.start_wizard_without_user()}}})(this));bD("#learn-more-link").click((function(fk){return function(fl){return a9.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(fk){return function(fl){Event.stop(fl);return fk.show_invites()}})(this))}bD("#sf-current, #sf-past").each((function(fk){return function(fl,fm){var fn;fn=["#sf-current","#sf-past"][fl];bD(".sf-list",fm).on("click","a.options-link",function(fq){var fo,fu,fs,fw,fr,fx,fv,ft,fp;fq.preventDefault();fu=bD(fq.target).closest("a.options-link");fr=fu.attr("data-type");fo=fu.attr("data-filename");fw=fu.attr("data-mount");ft=parseInt(fu.attr("data-nsid"),10);fp=cK.get_viewer().get_user_by_id(fu.attr("data-user_id"));fv=bD(fq.target).closest("li.sf-folder").data("role");fx=fu.attr("data-sf-perm-role");if(fr==="normal"){if(fk.simple_sharing_enabled){if(d1.get_for_user(fp).verified_or_show()){eD.createAndShowInbandModal(fp,fw,true,ft,true,false,fx)}}else{s.show_shared_folder_options_modal(fw,fp)}}else{if(fr==="remove"){s.show_ignore_modal(fp,fo,ft)}else{if(fr==="rejoin"){s.show_rejoin_modal(fp,fo,ft)}}}fs={option_type:fr};if(ft){fs.ns_id=ft}if(fw){fs.path=fw}return a9.SharedFolderActivityLogger.log("web","sharing_view_share_existing",fp.id,fs,true)});bD(".sf-sort",fm).on("click","a.sort-option",function(fq){var fp,fo,fr;fq.preventDefault();fp=bD(fq.target).closest("a.sort-option");fr={SF_BY_NAME:fk._name_cmp,SF_BY_MODIFIED:fk._modified_cmp};fo=fr[fp.attr("data-sort")];if(fk._state.cmp[fn]===fo){fk._state.is_ascending[fn]=!fk._state.is_ascending[fn]}else{fk._state.cmp[fn]=fo;fk._state.is_ascending[fn]=true}d3.add_sort_arrow_mouseover_j(fp,fk._state.is_ascending[fn],fn+" .sf-sort a.sort-option",true);return fk._render_list_id(fn)});return d3.add_sort_arrow_mouseover_j(bD(".modified-sorter",fm),fk._state.is_ascending[fn],fn+" .sf-sort a.sort-option",false)}})(this));return bD(".empty-share-button").click((function(fk){return function(fl){fl.preventDefault();a9.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);return s.start_wizard_without_user()}})(this))},listen_modals:function(){return bD("#new-or-existing-sf li").click((function(i){return function(T){var j;bD("#new-or-existing-sf li").removeClass("active");j=bD(T.target).closest("li");j.find("input").prop("checked",true);return j.addClass("active")}})(this))},_showing_two_accounts:function(){var i;return cK.get_viewer().is_paired&&((i=this.role_picker)!=null?i.get_state():void 0)===dZ.ALL},_render:function(){cJ(!this._state.sf_loading);this._render_list_id("#sf-current");this._render_list_id("#sf-past");if(bD("#sf-current").hasClass("empty-list")&&bD("#sf-past").hasClass("empty-list")){bD("#page-content").addClass("no-shares");return bD("#empty-content").show()}else{bD("#page-content").removeClass("no-shares");return bD("#empty-content").hide()}},_render_list_id:function(fk){var fs,fp,fr,T,fm,fn,fo,i,fl,fq;i=this._get_current_sf_list_info(fk),fn=i[0],fr=i[1];fq=this._showing_two_accounts();fs=(function(j){return function(ft,fv){var fu;fu=j._state.is_ascending[fk]?1:-1;return fu*j._state.cmp[fk](ft,fv,fq)}})(this);fn.sort(fs);fo=bD(".sf-list",fk);fo.empty();for(T=0,fm=fn.length;T<fm;T++){fl=fn[T];if(this._should_render(fl)){fp=this._tmpl({options_str:ey("Options"),remove_str:ey("Remove"),rejoin_str:ey("Rejoin"),is_past:fr,sf:fl,Sprite:cv,Emstring:bS,Util:d3,_:ey});fo.append(fp.toHTML())}}return this._empty_check(fk)},_should_render:function(i){if(this.role_picker!=null){return this.role_picker.is_role_visible(i.role)}else{return true}},_empty_check:function(fk){var T,j,i;j=this._get_current_sf_list_info(fk),T=j[0],i=j[1];if(bD(".sf-list",fk).children().length){return bD(fk).removeClass("empty-list")}else{return bD(fk).addClass("empty-list")}},_get_current_sf_list_info:function(i){switch(i){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return cJ(false,"invalid sf list id")}},_name_cmp:function(j,T,i){if(i){return d3.sort_by_key(j,T)}else{return d3.sort_by_rank_or_key(j,T)}},_modified_cmp:function(j,T,i){return j.modified_ts-T.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){var T,j,i;this._state.current_total_count=0;j=this._state.inbox_counts;for(i in j){T=j[i];this._state.current_total_count+=T}if(this._state.current_total_count>0){return s.show_invites()}},_display_view:(function(i){return function(){return bD("#sf-view").show()}})(this),_hide_view:(function(i){return function(){return bD("#sf-view").hide()}})(this),_display_spinner:function(){this._hide_view();return bD(".sf-spinner").show()},_hide_spinner:function(){return bD(".sf-spinner").hide()}};var bp;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(fk,fl,T,fp){var fo,j,fn,i,fm;this.user=fk;this.baseInitialize(fl,T,fp);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;this._num_contacts_shown=0;this._num_query_results=0;j=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}fm=this.options.include_team===true;i=this.options.include_new_style_groups===true;fn=this.options.include_me===true;this.profile_services=bi.get_linked_profile_services_for_user(this.user.id,this.update_import_contacts_link);this.link_handler=new d8();this._autocompleter_profile_services_item_tmpl=ff.tmpl("autocompleter_item_tmpl");this.listen();this.possible_email_pattern=/[.@_-]/;fo=(function(fq){return function(fr){if(fq.options.include_from_linked_accounts&&fq.options.viewer){fr=fr.includeForViewer(fq.options.viewer)}else{fr=fr.includeForUser(fq.user.id)}if(fq.options.contact_filter){fr=fq.options.contact_filter(fr)}else{if(!j){fr=fr.excludeFacebook()}if(!i){fr=fr.excludeNewStyleGroups()}if(!fm){fr=fr.excludeTeamMembers()}if(!fn){fr=fr.excludeMe()}}return fq.setContacts(fr)}})(this);(function(){var fq;return bY.load_contacts(fq=false,(function(fr){fo(fr);return bY.register_for_updates("autocompleter_contacts",fo)}))}).defer();return this.options.onShow=function(fq,fr){if(!fr.style.position||fr.style.position==="absolute"){fr.style.position="absolute";bD(fr).clonePosition(bD(fq),{setHeight:false,setTop:false,setLeft:false})}return bD(fr).fadeTo(150,1)}},link_callback:function(i){return d8.show_import_notifications(i)},getToken:function(){var i;i=this.getTokenBounds();return this.element.value.substring(i[0],i[1])},listen:function(){var i;this.install_profile_services_link_listener();i=(function(j){return function(T){if(j.profile_services.has_connected_services()){return}if(bD(j.element).val()){return}j.activate();setTimeout(function(){var fk;return(fk=j.get_entry_container())!=null?fk.show():void 0},300);return true}})(this);return bD(this.element).click(i)},install_profile_services_link_listener:function(){var i;Event.stopObserving(this.element,"blur");i=(function(j){return function(fk){var T;T=j.get_entry_container();if(bD(fk.target).hasClass("new-collab-input")&&bD(T).hasClass("people-default-show-import-shmodal-experiment")){return}if(!bD(fk.target).closest("li").hasClass("profile-services-link-handler")){if(bD(T).hasClass("people-default-show-import-shmodal-experiment")){bD(T).removeClass("people-default-show-import-shmodal-experiment");a9.PeopleExperimentsLogger.log(a9.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_LINK_DISMISS,j.user.id)}return T!=null?T.hide():void 0}}})(this);bD(this.element).closest(".db-modal-box").click(i);return bD(this.element).closest("#modal-box").click(i)},get_entry_container:function(){var i;return(i=this.element.up(".tokenized_autocompleter_container"))!=null?i.down(".autocomplete"):void 0},profile_services_show:function(){var fk,T,j,i;fk=this.get_entry_container();if(((T=fk.firstChild)!=null?(j=T.firstChild)!=null?j.value:void 0:void 0)>0){this.old_display=fk.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.profile_services_render_buttons();if((i=$("flash_copy_container"))!=null){i.hide()}return this.element.focus()},profile_services_render_buttons:function(){var i;i=this.get_profile_services_button_list();this.hasFocus=true;return this.updateChoices("<ul>"+(i.join(""))+"</ul>")},get_profile_services_button_list:function(){var T,fl,j,fn,fm,fk;fk=[];fm=c0.contact_services();for(fl=0,j=fm.length;fl<j;fl++){fn=fm[fl];cJ(this.profile_services.is_updated,"profile_services has not been updated");T="";if(this.profile_services.service_is_connected(fn)){T=ey("Connected")}else{if(this.profile_services.service_was_connected(fn)){T=ey("Reconnect")}}fk.push(this._autocompleter_profile_services_item_tmpl({email_provider_num:fn,email_provider_img:c0.to_img(fn),email_provider_name:c0.to_name(fn),bottom_text:T}).toHTML())}return fk},update_import_contacts_link:(function(i){return function(j){i.profile_services=j;if(i.profile_services.has_unconnected_services(true)){return bD(i.element).closest("form").find(".import-contacts-link").show()}else{return bD(i.element).closest("form").find(".import-contacts-link").hide()}}})(this),hide_containing_modal:function(){this.$hidden_modals=bD(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=bD("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(i){this.options.array=i.contacts;this.options.larray=i.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){return this.updateChoices(this.options.selector())},selectEntry:function(){var T,j,i;j=this.getCurrentEntry();T=this.options.array[j.value];if(T.type===W.FB||T.type===W.NEW_STYLE_GROUP){j.innerHTML=T.name}else{j.innerHTML=T.email}if(this.options.tokens.length>1){i=this.options.tokens[0]+" "}else{i=""}j.innerHTML+=i;this.active=false;this.updateElement(j);return bD(this.element).trigger("db:autocompleted")}},bp=function(i,j){var T;T=bD("<div>");T.addClass(i);if(typeof j==="string"||j instanceof String){T.text(j)}else{T.append(j)}return T},{getNumContactsShown:function(){return this._num_contacts_shown},getNumQueryResults:function(){return this._num_query_results},setOptions:function(j){var i;if(j==null){j={}}i={choices:5,selector:(function(T){return function(){var fn,fC,fB,fv,fx,fO,fp,f2,f3,fq,fM,fY,fG,fX,fz,fw,fN,fL,fW,fu,fV,fU,fo,fK,fy,fs,fr,f1,fH,fQ,fI,fP,fk,fT,fZ,ft,fA,fJ,fl,fR,fD,fF,fS,fm,f0,fE;fD=[];fM=T.getToken().toLowerCase();fU=T.options.array.length;fx=T.options.array;fQ=T.options.larray;fR=[];if(fM.indexOf(" ")===-1){fR.push("\\s+")}if(fM.indexOf("+")===-1){fR.push("\\+")}if(fM.indexOf("@")===-1){fR.push("@")}if(fM.indexOf(".")===-1){fR.push("\\.")}if(fM.indexOf("&lt;")===-1){fR.push("&lt;")}fl=RegExp("("+fR.join("|")+")");fN=0;while(fM.length>0&&fN<fU){fv=fx[fN];fH=fQ[fN];fY=-1;fq=[];fP=[];fw="";switch(fv.type){case W.EMAIL:fq.push(fv.name,fv.email_snippet);fP.push(fH.name,fH.email);fw="/static/images/icons/mail28-vflHfHPJ0.png";break;case W.FB:fq.push(fv.name);fP.push(fH.name);if(bX.use_fb_profile_pics){fw="https://graph.facebook.com/"+fH.fb_id+"/picture"}else{fw="/static/images/icons/fb24-vflGnjfAv.png"}break;case W.NEW_STYLE_GROUP:fq.push(fv.name,fv.members);fP.push(fH.name,"");fw="";if(__CIRCULAR_DEPENDENCY__.GroupsListController!=null){fC=__CIRCULAR_DEPENDENCY__.GroupsListController.string_to_hsl(fv.name);fB=__CIRCULAR_DEPENDENCY__.GroupsListController.get_initials(fv.name);fG=bD("<span class='group-icon'>").css("border-color",fC).css("color",fC).text(fB)}break;default:cJ(false,"should never get here due to type: "+(fv.type+", "+fv.name+", "+fv.email+", "+fv))}for(fu=fX=0,fy=fP.length;fX<fy;fu=++fX){fI=fP[fu];fZ=fR.length?fI.split(fl):[fI];fp=0;for(fW=0,fs=fZ.length;fW<fs;fW++){fT=fZ[fW];if(!fT){continue}if(fT.indexOf(fM)===0){fY=fp;break}fp+=fT.length}if(fY!==-1){fJ=((fM.length/fT.length)*9.4).toFixed(0);if(fv.sort_key!=null){fJ+=fv.sort_key}fo=document.createTextNode(fq[fu].substr(0,fY));fk=bD("<strong>").text(fq[fu].substr(fY,fM.length));fS=document.createTextNode(fq[fu].substr(fY+fM.length));fq[fu]=[fo,fk,fS];break}}if(fv.type===W.FB){fq.push(ey("Facebook message"))}if(fY!==-1){if(fw){fz=bD('<img width="28px" height="28px">').attr("src",fw)}else{if(fG){fz=fG}}ft=bp("autocomplete-line",fq[0]);fE=bp("autocomplete-line autocomplete-secondary",fq[1]);fK=bp("autocomplete-left",fz);fm=bp(null,[ft,fE]);f1=bD("<li>").attr("value",fN).append(fK,fm);fD.push([fJ,f1])}fN++}fD.sort(function(f5,f4){if(f5[0]<f4[0]){return 1}else{if(f5[0]>f4[0]){return -1}else{return 0}}});T._num_query_results=fD.length;fD=fD.slice(0,T.options.choices);fF=bD("<ul>");for(fV=0,fr=fD.length;fV<fr;fV++){f0=fD[fV];fF.append(f0[1])}T._num_contacts_shown=fD.length;if(!bD(T.element).hasClass("no-profile-services-link-handler")){if(T.profile_services.has_unconnected_services(true)){fO=bD(T.element).closest(".tokenized_autocompleter_container");fA=fO.attr("data-provider");fL=fA===c0.GOOGLE?ey("Select from your Gmail contacts"):fA===c0.YAHOO?ey("Select from your Yahoo contacts"):ey("Select from your contacts");f2=false;if((fA===c0.GOOGLE||fA===c0.YAHOO)&&!T.profile_services.service_is_connected(fA)){f2=true}else{if(T.profile_services.has_connected_services()){f2=false;fL=ey("Import Contacts")}}if(f2){f3=T._autocompleter_profile_services_item_tmpl({email_provider_num:fA,email_provider_img:c0.to_img(fA),email_provider_name:fL,bottom_text:""}).toHTML();fF.append(f3)}else{fz=cv.make("web","user_add");ft=bp("autocomplete-line autocomplete-line-center",fL);fK=bp("autocomplete-left",fz);fm=bp(null,[ft]);f1=bD("<li>").addClass("profile-services-link-handler").append(fK,fm);fF.append(f1)}}}fn=fF.wrap("<span>").parent().html();T.old_contents=fn;return fn}})(this)};return this.options=Object.extend(i,j)}});var cM;cM=E.Token=Class.create({initialize:function(j,i,T,fk){this.element=$(j);this.token_manager=T;this.hidden_input=i;this.element.token=this;this.selected=false;this.info=fk;return bD(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var i;this.token_manager.token=this;if((i=this.hidden_input)!=null){i.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(i){if(i&&i.preventDefault){i.preventDefault()}if(this.detect(i)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(i){return this.token_manager.remove(this)},detect:function(fk){var j,T,i;T=fk.target?fk.target:fk.srcElement;i=T.token;j=T;while((i==null)&&j.parentNode){j=j.parentNode;i=j.token}return(i!=null)&&i.element===this.element}});var Q;Q=E.TokenManager=Class.create({initialize:function(T,fk,j,i){this.contact_search_logger=i;this.shift_boundary_right_func=fk;this.shift_boundary_left_func=j;this.element=T;this.tokens=[];return this.token=null},add:function(i){this.tokens.push(i);return this.element.fire("token:add",i.info)},populate:function(){var fo,fl,j,fk,T,fn,fm;fm=this.element.select(".token");fk=[];for(fl=0,j=fm.length;fl<j;fl++){fn=fm[fl];fo=fn.hasClassName("token-warn");T=new cM(fn,null,this,{external:fo});fk.push(this.add(T))}return fk},remove:function(j){var i;if(j==null){j=this.token}if(j!=null){this.contact_search_logger.flag_record_as_removed(j.info.value);i=this.tokens.indexOf(j);this.tokens.splice(i,1);j.element.remove();if(this.token===j&&i<this.tokens.length){this.tokens[i].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",j.info)}},removeAll:function(){var fl,j,fk,T,fm;fm=this.tokens.slice(0);this.tokens.clear();fk=[];for(fl=0,j=fm.length;fl<j;fl++){T=fm[fl];T.element.remove();fk.push(this.element.fire("token:remove",T.info))}return fk},shift_left:function(){var i;i=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(i>0){if(this.token){this.token.deselect()}return this.tokens[i-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var i;i=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(i+1<this.tokens.length){return this.tokens[i+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var d7;d7=E.HiddenInput=Class.create({initialize:function(i,T,j){this.element=$(i);this.auto_complete_element=T;this.token_manager=j;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(i){switch(i.keyCode){case Event.KEY_LEFT:i.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:i.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:i.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,i,fk,fm,T,j){var fl;this.user=i;$super(this.user,fk,fm,j);this.contact_search_logger=new a9.ContactSearchLogger;this.token_manager=new Q(this.element,this.generate_shift_boundary_right_func(),null,this.contact_search_logger);this.hidden_input=new d7(T,this.element,this.token_manager);this.textbox_height=0;if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){bD(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(fn,fo){bD(fo).clonePosition(bD(fn.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return fo.show()};this.options.onHide=function(fn,fo){fo.hide();if(bD(fo).hasClass("people-default-show-import-shmodal-experiment")){return bD(fo).removeClass("people-default-show-import-shmodal-experiment")}};this.max_textbox_height=270;if(j.max_textbox_height!=null){this.max_textbox_height=j.max_textbox_height}this.members=[];if(j.members!=null){this.members=j.members}this.invitees=[];if(j.invitees!=null){this.invitees=j.invitees}this.new_style_groups=[];if(j.new_style_groups!=null){this.new_style_groups=j.new_style_groups}this.contacts_only=false;if(j.contacts_only!=null){this.contacts_only=j.contacts_only}if(eB.get_url().indexOf("/referrals")!==-1){fl=bD("#retrieve-contacts-button")}else{fl=bD(this.element).closest("form").find(".tokenizer-submit-button")[0]}bD(fl).on("mousedown",this.beforeSubmit.bindAsEventListener(this));bD(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!j.hide_import_contacts){this.import_links=bD(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(j){var i,T;i=j.findElement("li");this.index=i.autocompleteIndex;T=this.selectEntry();if(!T){return this.hide()}},onBlur:function($super,i){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(i)},onFocus:function(i){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(i){return this.tokenize_emails_input(true)},clearTokens:function(i){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getTokenCount:function(){return this.token_manager.tokens.length},getEmails:function(){var j,i;j=bD(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var fl,T,fk;fk=[];for(fl=0,T=j.length;fl<T;fl++){i=j[fl];fk.push(bD(i).val())}return fk})()).join(", ")},check_populated:function(){var j,i;j=$(this.element.parentNode);i=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(j.hasClassName("populated")&&i){return j.removeClassName("populated")}else{if(!j.hasClassName("populated")&&!i){return j.addClassName("populated")}}},clean_email_addr:function(fm,fl){var T,fk,j;for(fk=0,j=fm.length;fk<j;fk++){T=fm[fk];fl=fl.sub(T,"")}return fl.strip()},get_regexp_from_delimiters:function(fm){var T,fl,fk,j;fl="";for(fk=0,j=fm.length;fk<j;fk++){T=fm[fk];fl+=T+"|"}return new RegExp("["+fl+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(fk,T,i){var fl,j;j=true;fl=T;if(i===W.FB){fl=fk}if(i===W.EMAIL&&!d3.validate_email(T)){j=false}else{if(cR.call(this.members,T)>=0){j=false;fl=ey("Already member")}else{if(cR.call(this.invitees,T)>=0){j=false;fl=ey("Already invited")}else{if(i===W.NEW_STYLE_GROUP){if(cR.call(this.new_style_groups,T)>=0){j=false;fl=ey("Already member group")}else{j=true;fl=ey("Group")}}}}}if(T===this.user.email||T===this.user.id){fl=ey("You");j=!this.contacts_only}if(!fk&&T){fk=T.toString()}return{display:fk,value:T,type:i,valid:j,bubble_title:fl}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(j){var i,T;i=j.match(this.COMPOUND_EMAIL_REGEX);if(i){T=this.createTokenInfo(i[0],i[2],W.EMAIL);return T}return null},tokenize_emails_input:function(fr,fk){var fx,fp,fl,fv,T,fz,fy,fw,fA,fs,fq,fC,fB,fo,fu,ft,fm,fD,fn;fp=this.options.tokens;ft=this.get_regexp_from_delimiters(fp);if(this.options.single_token){fv=[this.element.value]}else{fv=this.element.value.split(ft)}fD="";if(!fr){fD=fv[fv.length-1];fu=this.clean_email_addr(fp,fD);fv=fv.slice(0,fv.length-1);if((fo=fD[fD.length-1])===" "||fo===">"){if(fu.match(this.COMPOUND_EMAIL_REGEX)||d3.validate_email(fu)){fv.push(fu);fD=""}}}fx=false;fn=[];if(fv.length>0){for(fz=0,fA=fv.length;fz<fA;fz++){fl=fv[fz];fm=this.parse_compound_email(fl);if(fm!=null?fm.valid:void 0){fx=true;this.set_input_size(1);if(this.addContact(fm)){fC={sort_variant:bY.sort_variant,context:"legacy_tokenizer",contact_type:W.EMAIL,contact_id:fm.value,contact_name:fm.display,did_select_suggestion:false};this.contact_search_logger.add_record(fC)}}else{fn.push(fl)}}}fv=fn;if(!this.options.single_token){fB=[];for(fy=0,fs=fv.length;fy<fs;fy++){fl=fv[fy];fB.push.apply(fB,fl.split(" "))}fv=fB}if(fv.length>0){for(fw=0,fq=fv.length;fw<fq;fw++){fl=fv[fw];fl=this.clean_email_addr(fp,fl);if(fl){fm=this.createTokenInfo(fl,fl,W.EMAIL);if(fm.valid){fx=true}else{if(fk){continue}}this.set_input_size(1);if(this.addContact(fm)){fC={sort_variant:bY.sort_variant,context:"legacy_tokenizer",contact_type:W.EMAIL,contact_id:fl,did_select_suggestion:false};this.contact_search_logger.add_record(fC)}}}}if(this.element.value!==fD){this.element.value=fD}T=this.element.up("form");if(fx){bR.clear_errors(T)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var j,i;j=this.element;i=function(){return j.focus()};return i},set_input_size:function(i){if((i==null)||i<0){i=20}return this.element.setStyle({width:i+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var fu,fB,fo,fl,fx,fv,fC,fz,fn,fp,fy,fA,fk,ft,fs,T,fq,fm,fr,fw;fs=$(this.element.parentNode.parentNode);fq=parseInt(fs.getStyle("width"),10)-15;T=parseInt(fs.getStyle("height"),10);if(T!==this.textbox_height){this.textbox_height=T;if(T>=this.max_textbox_height){fs.setStyle({"overflow-y":"auto"})}else{fs.setStyle({"overflow-y":"hidden"})}}fC=fq;fu=bD(".tokenizer-link",fs.parentNode);if(fu.length>0){fC-=fu.width()}fr=this.token_manager.tokens;fp=false;fw=0;for(fx=0,fz=fr.length;fx<fz;fx++){fm=fr[fx];fl=fm.element;fo=parseInt(fl.getStyle("width"),10)+parseInt(fl.getStyle("margin-right"),10);fA=fw+fo;if(fA>fq){fw=fo;fp=true}else{if(fo>fq){fw=0;fp=true}else{fw=fA}}}fy=fC-fw;fB=this.element.value.length*7;if(fB>fy){fy=fq}this.set_input_size(fy);if(this.import_links.length&&this.import_links_visible){if(fp||fq-fw-fB<1.25*this.import_links_width){this.import_links_visible=false;fk=this.import_links;ft=[];for(fv=0,fn=fk.length;fv<fn;fv++){fl=fk[fv];ft.push(bD(fl).fadeOut(100))}return ft}}},onKeyPress:function(T){var j,i;this.dynamically_resize_input();if(this.active){switch(T.keyCode){case 44:case 188:case 59:case 186:if(!T.shiftKey){if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true)}}this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_profile_services_entry()||this.has_selected_profile_services()){this.tokenize_emails_input(true);this.hide();Event.stop(T);return}this.selectEntry();this.hide();this.active=false;Event.stop(T);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(T);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(T);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(T);return}}else{this.tokenize_emails_input(false);if(T.keyCode===Event.KEY_TAB||T.keyCode===Event.KEY_RETURN){if(this.element.value&&T.preventDefault){T.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((j=T.keyCode)===Event.KEY_LEFT||j===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((i=T.keyCode)===Event.KEY_LEFT||i===Event.KEY_RIGHT||i===Event.KEY_UP||i===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var T,fl,fk,j,fm,fn;if(this.active){fn=this.element.value;fm=this.options.tokens;for(fk=0,j=fm.length;fk<j;fk++){T=fm[fk];fl=fn.indexOf(T);if(fl!==-1){if(this.has_selected_profile_services_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=fn.substr(0,fl);this.selectEntry();this.hide();this.active=false;this.element.value=fn.substr(fl+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_profile_services:function(i){if(i==null){i=this.getCurrentEntry()}return bD(i).hasClass("profile-services-link-handler")},has_selected_profile_services_entry:function(j){var i;if(j==null){j=this.getCurrentEntry()}return j.value===0&&((i=j.id)!=null?i.length:void 0)!==0},selectEntry:function(){var T,fn,i,fl,fk,fm,fp,fo,j;fn=this.getCurrentEntry();if(this.has_selected_profile_services(fn)){a9.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.profile_services_show();return true}else{if(this.has_selected_profile_services_entry(fn)){fm="suggestion";if(bD(this.get_entry_container()).hasClass("people-default-show-import-shmodal-experiment")){fm=fm+" people-default-show-import-shmodal-experiment";a9.PeopleExperimentsLogger.log(a9.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_CLICK,this.user.id,{provider:i})}i=fn.id.split("_")[0];cJ((cR.call(c0.contact_services(),i)>=0),"The 'id-value' of an autocompleter-entry is not a valid Third Party contact import service");fo=c0.to_name(i);if(this.profile_services.service_is_connected(i)){ah.success(ey("You're already connected to %(service_name)s").format({service_name:fo}));return}if(cR.call(c0.contact_services(),i)>=0){return this.link_handler.auth_service_with_user(i,this.user.id,((function(fq){return function(fr){return fq.link_callback(fr)}})(this)),fm)}else{return cJ(false,"Should never get here. entry_value: "+i)}}else{T=this.options.array[fn.value];fl=T.type===W.FB?T.fb_id:T.type===W.NEW_STYLE_GROUP?T.group_id:T.email;this.set_input_size(1);fp=this.element.value;j=this.createTokenInfo(T.name.strip(),fl,T.type);if(this.addContact(j)){fk={sort_variant:bY.sort_variant,context:"legacy_tokenizer",search_expr:fp,selected_pos:this.index,num_query_results:this.getNumQueryResults(),contact_type:T.type,contact_id:fl,contact_name:T.name.strip(),did_select_suggestion:true};this.contact_search_logger.add_record(fk)}bR.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(fm){var fs,fo,fy,fB,fk,fw,fx,fz,fq,fn,ft,fp,fu,fA,fC,T,fl,fr,fv;fv=this.token_manager.tokens;for(fy=0,fz=fv.length;fy<fz;fy++){fp=fv[fy];if(fm.value===fp.info.value){return false}}this.element.value="";switch(fm.type){case W.FB:fw="fb_ids";fB=new Element("img",{src:"/static/images/icons/fb_16-vflbiYTkC.png"});break;case W.EMAIL:fw="emails";fB=new Element("img",{src:"/static/images/icons/email_16-vflcFyDTl.png"});break;case W.NEW_STYLE_GROUP:fw="new_style_group_ids";fB=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case W.INVALID:fw="invalids";fB=new Element("span",{"class":"hidden"});break;default:cJ(false,"should never get here due to type: "+fm.type)}fu=this.getTokenClass(fm);fr=bD("<span class='x'>").addClass(fu);fr.on("click",function(i){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(i);return false});fC=new Element("input",{type:"hidden",name:fw,value:fm.value.toString()});fp=new Element("a",{"class":"title_bubble token "+fu,href:"#",tabindex:"-1",title:fm.bubble_title});fk=new Element("span");if(this.options.wrap_name){T=new Element("div",{"class":"token-display-text"});T.__sert(fm.display);fA=T;fs=1}else{fA=fm.display;fs=0}fn=[fC,fB,fA];for(fx=0,fq=fn.length;fx<fq;fx++){fo=fn[fx];fk.__sert(fo)}bD(fk).append(fr);fp.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(fk))));if((ft=$(fp).down(5).next(fs))!=null){ft.innerHTML="&nbsp;"}fl=new cM(fp,this.hidden_input,this.token_manager,fm);this.token_manager.add(fl);this.element.up().__sert({before:fp});return true},getTokenClass:function(i){if(!i.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,i,fk,fl,T,j){$super(i,fk,fl,T,j);this.warn_only=!j.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));this.team_contacts={};this.suspended_contacts={};this.pending_contacts={};return this.reloadContacts(true)},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(i){this.warn_only=!i;return this.reloadContacts()},reloadContacts:function(i){if(i==null){i=false}return bY.load_contacts(i=i,(function(j){return function(T){return j.setContacts(T)}})(this))},setContacts:function($super,fm){var T,fk,j,fl;this.team_contacts={};this.team_contacts[cK.get_viewer().work_email]=1;if(!bD(this.element).hasClass("team-admin")){fm=fm.excludeSuspended()}fm=fm.sortByTeamFirst();fl=fm.contacts;for(fk=0,j=fl.length;fk<j;fk++){T=fl[fk];if(T.team&&T.join_state==="active"){this.team_contacts[T.email]=1}if(T.team&&T.join_state==="suspended"){this.suspended_contacts[T.email]=1}if(T.team&&T.join_state==="pending"){this.pending_contacts[T.email]=1}}if(this.options.autocomplete_filter){return $super(this.options.autocomplete_filter(fm))}else{return $super(fm)}},createTokenInfo:function(fm,fk,j){var fo,fn,fl,i,T;T=true;fn=false;fo=fk;i=false;if(j===W.FB){fo=fm}if(j===W.EMAIL&&!d3.validate_email(fk)){T=false}else{if(cR.call(this.members,fk)>=0){T=false;fo=ey("Already member")}else{if(cR.call(this.invitees,fk)>=0){T=false;fo=ey("Already invited")}else{if((this.options.exclude_emails!=null)&&cR.call(this.options.exclude_emails,fk)>=0){T=false;fo=ey("You cannot choose this member")}else{if(j===W.EMAIL&&!this.team_contacts[fk]&&!this.pending_contacts[fk]){T=this.warn_only;fn=true}else{if(j===W.FB){T=this.warn_only;fn=true}else{if(j===W.NEW_STYLE_GROUP){if(cR.call(this.new_style_groups,fk)>=0){T=false;fo=ey("Already member group")}else{T=true;fo=ey("Group")}}}}}}}}if(fk===this.user.email||fk===this.user.id){fo=ey("You");T=!this.contacts_only}if(this.suspended_contacts[fk]){i=true}if(!fm&&fk){fm=fk.toString()}return fl={display:fm,value:fk,type:j,valid:T,external:fn,bubble_title:fo,suspended:i}},getTokenClass:function(i){if(!i.valid){return"token-error"}if(i.suspended){return"token-warn token-suspended"}if(i.external){return"token-warn"}return"token-valid"},notifyExternal:function(j){var i,T,fk;fk=j.memo;if(fk.external){T=this.token_manager.tokens.filter(function(fl){return fl.info.external});i=T?T.length:0;return this.element.fire("sf:token:external",{count:i})}}});var h;h=E.TeamSharedFolderInviteController=(function(){function i(j){var T;this.element=$(j[0]);T=this.element.down(".new-collab-input");T.observe("sf:token:external",this.handle_external.bind(this))}i.prototype.handle_external=function(T){var j,fk;j=T.memo.count;fk=this.element.down(".external-invite-message");if(j>1){dt.fillVal(j,"external-invite-num");if(fk!=null){fk.removeClassName("single")}return fk!=null?fk.show():void 0}else{if(j===1){if(fk!=null){fk.addClassName("single")}return fk!=null?fk.show():void 0}else{return fk!=null?fk.hide():void 0}}};return i})();var am;am=INLINE_JS.SharingModel=E.SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,file_viewer_files:[],send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(j,i,T){this.filename=j;this.c2d_vars=i;this.c2d_url=T!=null?T:"/sm/c2d";this.init_logger();bD(".nav-close").on("click",this.close_embedded_fileviewer.bind(this));return on_script_loaded((function(fk){return function(){var fn,fm,fl;fm=$("login-create-an-account");if(fm){fm.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);bD("#download_button_link[data-dl-link]").on("click",fk.download_zip);fk.set_viewport_size();fn=function(fp,fo){return fk.do_c2d(fo.id)};bD("#c2d-modal .login-form").on("db:login:success",fn);bD("#c2d-modal .register-form").on("db:register:success",fn);fl=G.parse(window.location.href);if(fl.getQuery()["force_dl"]){fl.updateQuery({force_dl:0,dl:1});return window.location=fl.toString()}}})(this))},init_folder:function(j,fk,T,i){this.is_folder=true;this.gallery_enabled=j;this.gallery_showing=fk;this.file_viewer_files=T;this.file_view_mode=i;return on_script_loaded((function(fl){return function(){fl.load_thumbs();bD("#gallery-toggle").click(function(){return fl.switch_mode("gallery")});bD("#list-toggle").click(function(){return fl.switch_mode("list")});bD(".file-link").click(function(fm){return fl.open_file_viewer(bD(fm.currentTarget).data("mediaIndex"))});return bD(document).on(aH.FILE_ACTIVITY_UPDATE,function(fn,fm,fo){return bD("[data-file-activity-key='"+fo.activity_key+"']").find(".comment-count-bubble-wrapper").each(function(){var fp;return(fp=this.reactComponent)!=null?fp.setProps({unresolvedCommentCount:fo.unresolvedCommentCount(),unseenCommentCount:fo.unseenCommentCount()}):void 0})})}})(this))},open_file_viewer:function(i){if(!bv.isNumber(i)||i<0){return}n.show(this.file_viewer_files[i],cK.get_viewer(),{files:this.file_viewer_files,file_view_mode:this.file_view_mode});n.set_preview_url();return false},init_album:function(){this.is_album=true;this._resize_album_view();Event.observe(window,"resize",this._resize_album_view.bind(this));return on_script_loaded((function(i){return function(){return bD("#add_to_my_dropbox_link").on("click",function(){return i.show_c2d_modal()})}})(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(j){var T,i;i=j.icon.split("_");i.pop();T=i.join("_");return"/static/images/icons128/"+T+".png"},init_logger:function(){on_script_loaded((function(i){return function(){var j;j=$("login-hover-link");if(j){j.observe("click",function(){return aP.log(aP.CLICK_SIGN_IN)});j.observe("click",function(){return dI.log("click_sign_in")})}if($("download_button_link")){aP.attachLogListener(aP.CLICK_DOWNLOAD,$("download_button_link"))}j=$("add_to_my_dropbox_link");if(j){aP.attachLogListener(aP.CLICK_ADD_TO_MY_DROPBOX,j);dI.attachLogListener("click_add_to_my_dropbox",j)}if($$(".remove-link").length){aP.attachLogListener(aP.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){aP.attachLogListener(aP.CLICK_FILENAME,$$(".shmodel-filename")[0])}j=$("default_content_download_button");if(j){aP.attachLogListener(aP.CLICK_DOWNLOAD,j)}j=$("default_content_a2md");if(j){aP.attachLogListener(aP.CLICK_ADD_TO_MY_DROPBOX,j)}j=bD("#login-create-an-account")[0];aP.attachLogListener(aP.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,j);j=bD("#login-hover-cont .login-form")[0];aP.attachLogListener(aP.LOGIN_THRU_DEFAULT_DROPDOWN,j);return bD("#share-button").click(function(T){return aP.log(aP.CLICK_SHARE)})}})(this));return document.observe(aL.ACTIONS_ADDED,(function(i){return function(){var fl,fk,j,T;T=$("view_original");if(T){aP.attachLogListener("shmodel_lightbox_click_vieworiginal",T)}fk=$("lightbox_share_link");if(fk){aP.attachLogListener("shmodel_lightbox_click_getlink",fk)}j=bD("lightbox-share-link");if(j[0]){aP.attachLogListener("shmodel_lightbox_click_getlink",j[0])}fl=$("lightbox_download_link");if(fl){return aP.attachLogListener("shmodel_lightbox_click_download",fl)}}})(this))},set_team_only_shmodel:function(j,i){this.team_only_shmodel=j;return this.owner_name=i},_resize_album_view:function(){var i;i=Math.floor((C.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:i+"px"})},load_thumbs:function(){var j,i;i=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");j=function(T){if(!T.src.endsWith(cv.SPACER)){return T.addClassName("thumbnail")}};return bq.batch_load_thumbs(i,this.THUMBS_BATCH_SIZE,j)},switch_mode:function(fo){var fl,fp,fk,T,fn,j,fm;fm=$A(["gallery","list"]);for(fk=0,T=fm.length;fk<T;fk++){j=fm[fk];fp=$(j+"-view-container");fl=$(j+"-toggle");if(fo===j){fp.show();fl.addClassName("selected")}else{fp.hide();fl.removeClassName("selected")}}if(history.replaceState){fn=window.location.pathname;if(fo==="list"){fn+="?lst"}history.replaceState({},"",fn)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var i;if($(document.body).hasClassName("mobile")){i=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(i)}},toggle_dropdown:function(fk,fl,T){var i,j;if(fk){Event.extend(fk).preventDefault()}if(!fl.visible()){if(this.is_album){return eR.show(fl,T,null,true)}else{j=$$(".nav-header").first().getHeight();i=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(i<0&&d3.ie8){i=4}return eR.show(fl,T,j-i,true)}}},prepare_confirm_remove_modal:function(j,fk,i,fm,fr,fn,fq,fo){var T,fl,fp;if(i){fp=fm?ey("Unshare?"):ey("Unshare album?");T=bD("#album-disable-token-modal")[0];dt.fillVal(j.escapeHTML(),"album_unshare_name")}else{if(fn){fp=ey("Remove link created by %(name)s").format({name:fq});if(fk){fl=ey('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{fl=ey('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}fl=fl.format({fname:bS.em_snippet(j,17),owner:fq,owner_email:fo})}else{fp=ey("Remove link to '%(name)s'").format({name:bS.em_snippet(j,17)});if(fk){fl=ey("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{fl=ey("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}T=bD("#disable-token-modal")[0];dt.fillVal(fl,"disable-token-desc")}return{title:fp,contents:T}},confirm_remove:function(j,fm,T,i,fk,fq,fn,fp,fo){var fl;if(T==null){T=false}if(i==null){i=false}if(fk==null){fk=false}if(fq==null){fq=null}if(fn==null){fn=false}if(fp==null){fp=null}if(fo==null){fo=null}cJ(fm,"confirm_remove missing tkey");cJ(j,"confirm_remove missing name");cJ(fq,"confirm_remove missing user_id");cJ(!fn||!i,"admin removal of collections not supported");cJ(!fn||fp,"missing link owner name for admin removal");cJ(!fn||fo,"missing link owner email for admin removal");if(!cK.get_viewer().is_uid_signed_in(fq)){bM.show_modal({user_id:fq,on_success:(function(fr){return function(){return fr.confirm_remove(j,fm,T,i,fk,fq,fn,fp,fo)}})(this)});return}fl=am.prepare_confirm_remove_modal(j,T,i,fk,fq,fn,fp,fo);return fa.show(fl.title,fl.contents,{token:fm,name:j,is_album:i,user_id:fq})},confirm_remove_from_event_gid:function(i,fp,T,fo,fl,fn,fm,j){var fk;if(fl==null){fl=false}if(fn==null){fn=null}if(fm==null){fm=null}if(j==null){j=null}cJ(fp,"confirm_remove missing event gid");cJ(i,"confirm_remove missing name");cJ(fo,"confirm_remove missing user_id");cJ(cK.get_viewer().is_uid_signed_in(fo),"user not logged in");cJ(!fl||fn,"missing link owner name for admin removal");cJ(!fl||fm,"missing link owner email for admin removal");fk=am.prepare_confirm_remove_modal(i,T,false,false,fo,fl,fn,fm);return fa.show(fk.title,fk.contents,{name:i,user_id:fo,activity_log_event_gid_dbase64:fp,redirect_to_member_id:j})},do_remove:function(fk){var i,T,j;cJ(fk.token||fk.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");i=bD("#modal-content input").first();i.attr("disabled",true);bD("#modal-content").addClass("ajax-loading");j=window.location.pathname;if((j==="/links"||j==="/links/your_links"||j==="/recents")||j.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+fk.token,{subject_user:fk.user_id,onSuccess:(function(fl){return function(){var fm;fa.hide();if(fk.is_album){fm=ey("Unshared '%(name)s'")}else{fm=ey("Removed link for '%(name)s'")}fm=fm.format({name:fk.name});ah.success(fm);return document.fire(aH.LINKS_REMOVE,{token:fk.token})}})(this),onComplete:(function(fl){return function(){i.attr("disabled",false);return bD("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(fk.token){T=G({path:"/sm/disable/"+fk.token})}else{T=G({path:"/sm/disable_by_event_gid/"+fk.activity_log_event_gid_dbase64});T.updateQuery("redirect_to_member_id",fk.redirect_to_member_id).toString()}return bR.postRequest(T.updateQuery(Constants.UID_PARAM_NAME,fk.user_id).toString())}},show_shmodal_onload:function(T,fk,j,i){if(i==null){i=null}return bD((function(fl){return function(){eB.remove_query_param("m");if(!cK.get_viewer().is_uid_signed_in(i)){bM.show_modal({user_id:i,on_success:function(){return fl.show_shmodal_onload(T,fk,j,i)}});return}if((i!=null)&&d1.get_for_user(cK.get_viewer().get_user_by_id(i)).verified_or_show()){return fl.show_shmodal(T,fk,j,i)}else{if(i==null){cJ(cK.get_viewer().is_paired,"Expected viewer to be paired.");return fl.show_share_shmodel_role_chooser(T,fk,j)}}}})(this))},show_shmodal:function(fp,fv,j,fu){var ft,fr,fs,fq,fm,fl,fo,fn,T,fk;this.url=fp;this.short_url=fv;if(!cK.get_viewer().is_uid_signed_in(fu)){bM.show_modal({user_id:fu,on_success:(function(i){return function(){return i.show_shmodal(url,short_url,j,fu)}})(this)});return}fk=cK.get_viewer().get_user_by_id(fu);if(d1.get_for_user(fk).verified_or_show()){fn="shmodal-user-"+fu;fa.show(this._get_shmodal_title(fk.is_team),dt.fromElm($(fn)));fm={};fm[Constants.UID_PARAM_NAME]=fu;bR.add_vars("shmodal-send-form",fm);if(this._get_thumbnail_type()){T=$$(".shmodal-image");for(fl=0,fo=T.length;fl<fo;fl++){fq=T[fl];fq.addClassName("thumbnail")}}if(j==="contacts"){fs=Autocompleter.ContactsTokenizer}else{fs=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new fs(fk,fn+"-new-collab-input",fn+"-new-whobulk",fn+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:j==="team_only",user_id:fu});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){ft=t.clipboard_overlay(url,bD("#"+fn+"-copy-link"),am.copied_to_clipboard);ft.css({position:"fixed",zIndex:1001});ft.children().height(ft.height());clearInterval(this.follow_freshbutton);fr=(function(i){return function(){return ft.clonePosition(bD("#"+fn+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(fr,500)}else{$(fn+"-copy-link").hide()}}ch._create($("modal").down(".custom-message-container"));ch._create($("modal").down(".fb-post-sickinput"));ch._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(short_url,fu);$(fn+"-new-collab-input").focus();return aP.log("shmodal_show")}},configure_dropdown:function(){var fm,fk,j,fl,T;fl=$$(".dropdown-menu-container");for(fk=0,j=fl.length;fk<j;fk++){fm=fl[fk];T=fm.down(".dropdown-menu-trigger");if(T!=null){T.observe("click",(function(i){return function(fo){var fn;fn=fo.target.up(".dropdown-menu-container");return fn.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(i){return function(fs){var fr,fp,fo,fn,fq;if(fs.target.hasClassName("dropdown-menu-trigger")||fs.target.up(".dropdown-menu-trigger")){return}fn=$$(".dropdown-shown");fq=[];for(fp=0,fo=fn.length;fp<fo;fp++){fr=fn[fp];fq.push(fr.removeClassName("dropdown-shown"))}return fq}})(this))},copied_to_clipboard:function(){ah.success(ey("Link copied to clipboard"));fa.hide();aP.log("shmodal_copy_link");return a9.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cQ.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(fk){var fl,fu,fs,fq,fv,fw,fp,fr,fo,fn,ft,T,fm;cJ(fk,"Must pass the shmodal send form into get_shmodel_send_recipients");fl=fk.select('input[name="emails"]');fu=fk.select('input[name="fb_ids"]');fs=fk.select('input[name="group_ids"]');fn=fk.select('input[name="new_style_group_ids"]');T=[];fm=[fl,fu,fs,fn];for(fq=0,fr=fm.length;fq<fr;fq++){fw=fm[fq];for(fp=0,fo=fw.length;fp<fo;fp++){fv=fw[fp];ft=fv.up().innerHTML.stripTags().escapeHTML();T.push(ft.substring(0,ft.indexOf("&")))}}return T},close_embedded_fileviewer:function(j){var i;j.preventDefault();i=new er();i.configureParentMessaging(function(){},["parent-ready"]);i.startListening();return i.postMessageToParent("close-fileviewer")},send_shmodel_link:function(fk){var T,j,fl,i;T=$("shmodal-send-form");cJ(T,"Couldn't find the shmodal send form.");i=this.get_shmodel_send_recipients(T);fl=(function(fm){return function(fn){var fo;fo=aY.success_string_for_recipients(i);ah.success(fo);fa.hide();return aP.log("shmodal_send")}})(this);j=(function(fm){return function(fn){return bR.remove_loading()}})(this);return bR.ajax_submit(T,"/sm/share",fl,j,T.down(".tokenizer-submit-button"))},show_content:function(T){var fk,j,fl,fm;$("shmodal-title-text").__date(dp.to_title_str(T));fl=dp.list;for(fk=0,j=fl.length;fk<j;fk++){fm=fl[fk];if(fm!==T){$(dp.to_toggle_str(fm)).removeClassName("toggled");$(dp.to_content_str(fm)).hide()}}$(dp.to_content_str(T)).show();$(dp.to_toggle_str(T)).addClassName("toggled");return bD("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(dp.SEND)},show_fb_content:function(){return this.show_content(dp.FB)},show_twitter_content:function(){return this.show_content(dp.TWITTER)},start_fb_post:function(fl,j){var fm,T,i,fk;T=(function(fn){return function(){return eo.do_auth(fn.do_fb_post.curry(fl,j),j)}})(this);fm=bD("#modal:visible, #modal-overlay:visible");i=function(){return fm.show()};if(eo.authed_user_id===j){return this.do_fb_post(fl,j)}else{if(cK.get_viewer().is_uid_associated(eo.authed_user_id)){fm.hide();fk=new eb(cK.get_viewer().get_user_by_id(j),i,T.bind(this));return fk.show()}else{return T()}}},start_twitter_post:function(i){if(cE.is_authed(i)){return this.do_twitter_post(i)}else{return cE.do_auth(this.do_twitter_post,i)}},do_fb_post:function(j,i){eo.custom_show_posting=function(){return bR.add_loading($("shmodal-fb-post-submit"))};eo.custom_show_complete=function(){fa.hide();ah.success(ey("Successfully posted to Facebook"));aP.log("shmodal_fb_post");return a9.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cQ.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})};return eo.post($F("shmodal-fb-post-input"),j,null,null,null,function(){return fa.hide()},i)},do_twitter_post:function(i){var j;j=$F("shmodal-twitter-post-input");if(!j){ah.error(ey("Please enter a Twitter post"));return}else{if(j.length>140){ah.error(ey("Your post must be 140 characters or less"));return}}cE.custom_show_posting=function(){$("twitter-chars").hide();return bR.add_loading($("shmodal-twitter-post-submit"))};return cE.custom_post(j,(function(T){return function(){fa.hide();ah.success(ey("Successfully posted to Twitter"));aP.log("shmodal_tweet");return a9.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:am.is_album?"collection":am.is_folder?"folder":am.filename.indexOf(".")===-1?"file":cQ.EXTENSION_TO_CATEGORY[aA.file_extension(am.filename).toLowerCase()]||"file"})}})(this),i)},_get_shmodal_title:function(i){if(i==null){i=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(j){return function(){return j.show_send_content()}})(this)),((function(j){return function(){return j.show_fb_content()}})(this)),((function(j){return function(){return j.show_twitter_content()}})(this)),i)},generate_title_content:function(j,fp,fm,fr,fk){var fl,fn,i,fq,T,fo;if(fk==null){fk=false}fq=bD("<div/>",{id:"shmodal-title"});T=bD("<div/>",{id:"shmodal-title-text",text:j});fq.append(T);if(!fk){i=bD("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});i.html(cv.make("web","email_20"));i.on("click",fp);fn=bD("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});fn.html(cv.make("web","fb_20"));fn.on("click",fm);fo=bD("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});fo.html(cv.make("web","twitter_20"));fo.on("click",fr);fq.append([i,fn,fo])}fl=bD("<div/>",{"class":"clear"});fq.append(fl);return fq[0]},_get_shmodal_title_text:function(){var j,i;if(this.is_folder){j=ey("Share link to \u2018%(folder_name)s\u2019");return j=j.format({folder_name:bS.em_snippet(this.filename,15)})}else{i=this._get_thumbnail_type();if(i===cQ.CATEGORY_TO_TRANSLATION.IMAGE){return ey("Share this image")}else{if(i===cQ.CATEGORY_TO_TRANSLATION.VIDEO){return ey("Share this video")}else{return ey("Share '%(filename)s'").format({filename:bS.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var j,i;if(this.filename.indexOf(".")===-1){return false}i=aA.file_extension(this.filename).toLowerCase();j=cQ.EXTENSION_TO_CATEGORY[i];if(j&&(j==="IMAGE"||j==="VIDEO")){return cQ.CATEGORY_TO_TRANSLATION[j]}return false},_populate_twitter_info:function(T,i){var fk,j;fk=this.is_folder?ey("Just shared some files using @Dropbox"):(j=this._get_thumbnail_type(),j&&j===cQ.CATEGORY_TO_TRANSLATION.IMAGE?ey("Just shared an image using @Dropbox"):ey("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(fk+" "+T);d3._track_twitter_chars_left("shmodal-twitter-post-input",140);if(cE.is_authed(i)){return cE.get_user_info(function(fl){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:fl.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(fl.name);$("shmodal-twitter-profile").down(".username").__date("@"+fl.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},i)}},download_zip:function(fk){var j,T,fl,i,fm;j=bD("#download_button_link").attr("data-dl-link");fm=bD("#download_button_link").attr("data-test-link");i=bD("#download_button_link").attr("data-owner")==="true";fl=(function(fn){return function(fo){var fp;if(fo==="OK"){window.location=j}else{if(fo.indexOf("err:")===0){if(i){fp=ey("The zip file is too large.")}else{fp=ey("The zip file is too large. Please add it to your Dropbox.")}ah.error(fp)}else{ah.error(ey("Failed to download zip file."))}}return false}})(this);T=(function(fn){return function(fo){ah.error(ey("Failed to download zip file."));return false}})(this);if(fm&&bD.support.cors===true){bD.ajax({url:fm,type:"POST",success:fl,error:T})}else{window.location=j}return false},show_share_shmodel_role_chooser:function(j,T,i){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new dx({element_id:"share-shmodel-select-role-modal",link_url:j,short_url:T,tokenizer_type:i})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(j,T,i,fl){var fk;fk=(function(fm){return function(){var fn;fa.hide();bD("#role-selector option").removeClass("disabled");fn=cK.get_viewer().get_uid_by_role(fl);cK.get_viewer().sign_in_user_by_id(fn);a9.ShmodelUILogger.log("via-shmodel-viewer");return am.show_shmodal(j,T,i,fn)}})(this);if(!cK.get_viewer().is_role_signed_in(fl)){return bM.show_modal({role:fl,on_success:fk})}else{return fk()}},show_c2d_modal:function(fn,j){var fm,i,fl,T,fk;if(fn==null){fn=""}if(j==null){j=false}if(fn){if(fn===Constants.ROLE_PERSONAL){cJ(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!cK.get_viewer().is_role_signed_in(fn)){bM.show_modal({role:fn,on_success:(function(fo){return function(){return fo.show_c2d_modal(fn)}})(this)});return}}else{if(cK.get_viewer().is_paired){new aS({element_id:"select-role-modal"}).show();return}}a9.WebMiscActivityLogger.log("show-c2d-modal",{filename:this.filename,auth_google:bD.find(".auth-google")!=null});if(fn){T="#c2d-modal-"+fn}else{T="#c2d-modal"}fk=this._c2d_modal_msg(fn,cK.get_viewer().team_name);fm=this._c2d_modal_button_msg(fn,cK.get_viewer().team_name);i=this._c2d_modal_desc(fn,cK.get_viewer().team_name);if(j){i=this._c2d_modal_team_only_desc(cK.get_viewer().team_name)+"<br/><br/>"+i}fl=this._c2d_modal_login_desc(fn,cK.get_viewer().team_name);dt.fillVal(i,"c2d-desc");dt.fillVal(fl,"c2d-login-desc");bD(".c2d-submit-button").val(fm);bD(".c2d-login-register-desc").hide();if(this.is_album){bD(".c2d-login-register-album-desc").show()}else{if(this.is_folder){bD(".c2d-login-register-folder-desc").show()}else{bD(".c2d-login-register-file-desc").show()}}return fa.show(fk,bD(T)[0],false,false,false,false)},_c2d_modal_msg:function(fk,j){var i,T;if(fk==null){fk=""}if(j==null){j=""}if(this.c2d_vars.title){return T=this.c2d_vars.title}else{if(fk===Constants.ROLE_PERSONAL){T=ey("Save '%(filename)s' to my personal Dropbox");return T.format({filename:bS.em_snippet(this.filename,10)})}else{if(fk===Constants.ROLE_WORK){T=ey("Save '%(filename)s' to my %(team_name)s Dropbox");i=Math.max(10,15-new bS(j).length);return T.format({filename:bS.em_snippet(this.filename,i),team_name:j})}else{T=ey("Save '%(filename)s' to my Dropbox");return T.format({filename:bS.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){return j=ey("Save to my personal Dropbox")}else{if(T===Constants.ROLE_WORK){j=ey("Save to my %(team_name)s Dropbox");return j.format({team_name:i})}else{return ey("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(i){var j;if(this.is_album){j=ey("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){j=ey("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{j=ey("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return j.format({owner_name:this.owner_name,team_name:i})},_c2d_modal_desc:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){j=ey("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=ey("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){j=ey("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=ey("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){j=ey("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return j.format({owner_name:this.owner_name,team_name:i})}else{return j=ey("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(T===Constants.ROLE_WORK){if(this.is_album){j=ey("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){j=ey("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{j=ey("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return j.format({team_name:i})}else{if(this.is_album){return ey("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return ey("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return ey("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(T,i){var j;if(T==null){T=""}if(i==null){i=""}if(T===Constants.ROLE_PERSONAL){if(this.is_album){return j=ey("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return j=ey("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return j=ey("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(T===Constants.ROLE_WORK){if(this.is_album){j=ey("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){j=ey("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{j=ey("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return j.format({team_name:i})}}},do_c2d:function(i){var j;cJ(i,"Must specify a user_id for saving to Dropbox.");j=ey("Saving to your Dropbox...");if(cK.get_viewer().is_paired){if(cK.get_viewer().get_user_by_id(i).is_team){j=ey("Saving to your %(team_name)s Dropbox...");j=j.format({team_name:cK.get_viewer().team_name})}else{j=ey("Saving to your personal Dropbox...")}}ah.success(j);fa.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:j,subject_user:i,onSuccess:(function(T){return function(fk){if(fk.responseText){return bZ.redirect(fk.responseText)}}})(this)})},c2d_show_twofactor_error:function(j){var i;i=$("c2d-twofactor-error");i.__date(j);return i.show()},c2d_hide_twofactor_error:function(i){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(ey("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(ey("Unfortunately, your carrier isn\u2019t supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(ey("That isn\u2019t a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(ey("That phone number doesn\u2019t appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(ey("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(ey("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var dp;dp=E.ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",ey("Share on Facebook"),ey("Share on Twitter")],to_content_str:function(i){return this._content_str[i]},to_toggle_str:function(i){return this._toggle_str[i]},to_title_str:function(i){if(i===0){return am._get_shmodal_title_text()}return this._title_str[i]},to_focus_str:function(i){return this._focus_str[i]}};var Z,df,bJ,b1=function(i,j){return function(){return i.apply(j,arguments)}},fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty;df=INLINE_JS.ShareLinkModal=E.ShareLinkModal=(function(i){fb(j,i);function j(T,fm,fk,fo,fn){var fl,fp;this.user_id=T;if(fo==null){fo=false}if(fn==null){fn=void 0}this.before_show=b1(this.before_show,this);this.show=b1(this.show,this);this.prompt_login_then_show=b1(this.prompt_login_then_show,this);fp={origin:fk};fp[Constants.UID_PARAM_NAME]=this.user_id;if(fn){fl=G({path:"/sm/get_link_modal_content/"+fn}).toString()}else{fl=G({path:"/sm/share_link"+fm}).toString()}j.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:fl,parameters:fp})}j.prototype.prompt_login_then_show=function(){var T;T=(function(fk){return function(){fa.hide();bD("#role-selector option").removeClass("disabled");cK.get_viewer().sign_in_user_by_id(fk.user_id);a9.ShmodelUILogger.log("via-shmodel-viewer");return fk.show()}})(this);if(!cK.get_viewer().is_uid_signed_in(this.user_id)){return bM.show_modal({user_id:this.user_id,on_success:T})}else{return T()}};j.prototype.show=function(){var T;T=cK.get_viewer().get_user_by_id(this.user_id);if(d1.get_for_user(T).verified_or_show(ep.SHMODAL)){return j.__super__.show.call(this)}};j.prototype.before_show=function(){var fm,fl,T,fk;fk=this.$modal_window.find(".share-link-modal-content").length;if(fk){fm={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"};T=bD("<img />",fm);fl=bD("<div />",{"class":"loading-spinner"}).append(T);return this.$modal_window.find(".dynamic-content").html(fl)}};return j})(cB);bJ=E.ShareLinkModalContent=(function(){function i(fm,fo,ft,fp,j,T,fs,fl,fq){var fk,fn,fr,fu;this.owner_id=fm;this.tkey=fo;this.fq_path=ft;this.link=fp;this.filename=j;this.tokenizer_type=T;this.tokenizer_ctx_str=fs;this.fq_path_of_restricting_sf=fq;this._send_link=b1(this._send_link,this);this._show_shared_link_settings_modal=b1(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=b1(this._show_shared_folder_settings_modal,this);this._select_all_text=b1(this._select_all_text,this);this._toggle_send_link_button=b1(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=b1(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=b1(this._toggle_close_button_text,this);this._listen=b1(this._listen,this);this._init_autocompleter=b1(this._init_autocompleter,this);this.$content=bD(".share-link-modal-content");this.modal=d5.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=o.create_contacts_list(fl)}fr={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(aH.LINKS_ADD,fr);this.modal.set_title(ey("Share link to \u2018%(filename)s\u2019").format({filename:bS.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this._init_autocompleter();this._listen();if((fk=this.$share_link_url_input[0])!=null){fk.select()}if(((fn=az.getGandalfRule("people-link-profile-on-share-experiment"))===null||fn==="CONTROL")&&az.isGandalfInVariant("people-default-show-import-shmodal-experiment","EXPERIMENT")&&this.tokenizer_type!=="shared_folder"){fu=(function(fv){return function(fw){var fx;fx=bD(fv.autocompleter.element).closest(".tokenized_autocompleter_container").attr("data-provider");fv.autocompleter.activate();bD(fv.autocompleter.get_entry_container()).addClass("people-default-show-import-shmodal-experiment");if(container.find("#autocompleter_item_tmpl")!=null){return a9.PeopleExperimentsLogger.log(a9.PeopleExperimentsLogger.DEFAULT_SHOW_IMPORT_SHOW,fv.owner_id,{provider:fx})}}})(this);bi.get_linked_profile_services_for_user(this.owner_id,fu)}}i.prototype._init_autocompleter=function(){var j,T;j={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(cK.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(cK.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j)}else{this.autocompleter=new Autocompleter.TeamTokenizer(cK.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",j)}}T=(function(fk){return function(fl){return function(){return fk.autocompleter.contact_search_logger.log_records(fk.owner_id,fl)}}})(this);this.modal.logger_keydown_close_handler=T(true);this.modal.$overlay.on("click",T(true));this.modal.$db_modal_x.on("click",T(true));this.$send_link_button.on("click",T(false));this.$cancel_button.on("click",T(true));ch.init();return this.$collab_input.focus()};i.prototype._listen=function(){var fl,fk,T,j,fn,fm;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(fo){return function(fp){return dY.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);if((fl=this.$collab_input)!=null){fl.keyup(this._toggle_send_link_button)}if((fk=this.$collab_input)!=null){fk.on("input",this._toggle_send_link_button)}if((T=this.$collab_input[0])!=null){T.observe("token:remove",this._toggle_send_link_button)}if((j=this.$collab_input[0])!=null){j.observe("token:add",this._toggle_close_button_text)}if((fn=this.$collab_input[0])!=null){fn.observe("token:remove",this._toggle_close_button_text)}return(fm=this.$collab_input[0])!=null?fm.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};i.prototype._toggle_close_button_text=function(fk){var T,j;j=((T=this.autocompleter)!=null?T.token_manager.tokens.length:void 0)===0;if(j){return this.$cancel_button.text(ey("Close"))}else{return this.$cancel_button.text(ey("Cancel"))}};i.prototype._toggle_recipients_outside_team_warning=function(fk){var j,T;j=bD(".external-recipient-warning-message");if(j.length){T=fk.memo.count;if(fk.memo.shared_folder_warning){if(T>0){return j.show()}else{return j.hide()}}else{if(T>1){j.find(".external-recpient-num").text(T);return j.removeClass("single").show()}else{if(T===1){return j.addClass("single").show()}else{return j.hide()}}}}};i.prototype._toggle_send_link_button=function(fk){var T,j;j=((T=this.autocompleter)!=null?T.token_manager.tokens.length:void 0)===0;j=j&&bD.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",j)};i.prototype._select_all_text=function(j){return bD(j.currentTarget)[0].select()};i.prototype._show_shared_folder_settings_modal=function(T){var j;T.preventDefault();j=cK.get_viewer().get_user_by_id(this.owner_id);return s.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,j)};i.prototype._show_shared_link_settings_modal=function(T){var j;T.preventDefault();j=new dV(this.owner_id,this.tkey);return dY.push(j)};i.prototype._send_link=function(fm){var fk,T,fl,j,fn;fl=this.$content.find(".share-link-modal-send-form")[0];j=this.get_shmodel_send_recipients(fl);fn=(function(fo){return function(fp){var fq;fq=aY.success_string_for_recipients(j);ah.success(fq);dY.pop();return aP.log("shmodal_send")}})(this);T=(function(fo){return function(fp){return bR.remove_loading()}})(this);fk=this.$content.find(".tokenizer-submit-button")[0];return bR.ajax_submit(fl,"/sm/share",fn,T,fk)};i.prototype.get_shmodel_send_recipients=function(fk){var fl,fu,fs,fq,fv,fw,fp,fr,fo,fn,ft,T,fm;cJ(fk,"Must pass the shmodal send form into get_shmodel_send_recipients");fl=fk.select('input[name="emails"]');fu=fk.select('input[name="fb_ids"]');fs=fk.select('input[name="group_ids"]');fn=fk.select('input[name="new_style_group_ids"]');T=[];fm=[fl,fu,fs,fn];for(fq=0,fr=fm.length;fq<fr;fq++){fw=fm[fq];for(fp=0,fo=fw.length;fp<fo;fp++){fv=fw[fp];ft=fv.up().innerHTML.stripTags().escapeHTML();T.push(ft.substring(0,ft.indexOf("&")))}}return T};return i})();Z=INLINE_JS.QuickSend=E.QuickSend={_files:{},_uploading_fileids:{},init:function(i,T,fk){var j;this.owner_id=i;this.tokenizer_ctx_str=T;this.keep_visible=fk;this.$content=bD("#browse-root-quick-send");this.$content[0].writeAttribute("dropzone","copy move");this.$content[0].writeAttribute("quicksend","true");this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);if((j=this.$collab_input)!=null){j.keyup(this._toggle_send_button_state)}if(this.$collab_input[0]){this.$collab_input[0].on("token:remove",this._toggle_send_button_state);this.$collab_input[0].on("token:add",this._toggle_send_button_state)}this.$send_button=this.$content.find("#quick-send-submit");this.$send_button.on("click",this._send_link);this.$cancel_button=this.$content.find("#quick-send-cancel");this.$cancel_button.on("click",this._cancel_button_clicked);this.$import_services=this.$content.find(".autocomplete");bD("#browse-files").addClass("quicksend-collapsed");Z._update_location();this.has_autocompleter_inited=false;a9.SharedFolderActivityLogger.log("web","quick_send_displayed",cr.active_user,{});this.$collab_input.on("blur",function(){return setTimeout(function(){var fl;return(fl=Z.$import_services)!=null?fl.hide():void 0},100)});bD("#quick-send-top-choose-button-send").click(function(){return bD("#quick-send-file-box").click()});bD("#quick-send-choose-button").click(function(){return bD("#quick-send-file-box").click()});bD(".quick-send-choose-file-link").click(function(){return bD("#quick-send-file-box").click()});bD("#quick-send-file-box").on("change",function(){var fm,fl;fl=bD("#quick-send-file-box")[0].files;fm=function(){if(!cr.active_user){cr.active_user=cK.get_viewer().get_user_by_id(Z.owner_id)}return bn.upload(Z.DEST_FOLDER+"/",fl)};return Z.get_folder_name(fm)});document.on(cA.COMPLETE_EVT,Z._file_upload_completed);document.on(cA.ERROR_EVT,Z._file_upload_errored);return document.on(dL.UPDATE,Z._update_location)},_cancel_button_clicked:function(i){a9.SharedFolderActivityLogger.log("web","quick_send_cancel_button_clicked",cr.active_user,{});return Z._reset()},_init_autocompleter:function(){var i;if(Z.has_autocompleter_inited){return}Z.has_autocompleter_inited=true;i={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:Z.owner_id,max_textbox_height:30,viewer:cK.get_viewer(),include_from_linked_accounts:true};return Z.autocompleter=new Autocompleter.ContactsTokenizer(cK.get_viewer().get_user_by_id(Z.owner_id),Z.collab_input_id,Z.tokenizer_ctx_str+"-new-whobulk",Z.tokenizer_ctx_str+"-hidden-input",i)},_send_link:function(fo){var fl,fk,fm,T,j,fp,fq,i,fn;a9.SharedFolderActivityLogger.log("web","quick_send_send_button_clicked",cr.active_user,{});Z.autocompleter.tokenize_emails_input(true);i=Z.autocompleter.getTokenCount();T=bD(".quick-send-left-form")[0];j=[];fq=0;for(fm in Z._files){fq+=1;fk=Z._files[fm];j.push(fk.fq_path)}fp={num_recipients:i,num_files:fq};a9.SharedFolderActivityLogger.log("web","quick_send_send_attempted",cr.active_user,fp);fn=(function(fr){return function(fs){Z._reset();Z._toggle_top_area_view();return a9.SharedFolderActivityLogger.log("web","quick_send_send_succeeded",cr.active_user,{})}})(this);fl=(function(fr){return function(fs){return a9.SharedFolderActivityLogger.log("web","quick_send_send_failed",cr.active_user,{})}})(this);return bR.ajax_submit(T,"/sm/quick_send",fn,fl,null,{fq_paths:j.join(",")})},_update_file_area_view:function(){if(Object.keys(Z._files).length){bD("#quick-send-drop-area").hide();bD("#quick-send-files-area").show()}else{bD("#quick-send-drop-area").show();bD("#quick-send-files-area").hide()}return Z._toggle_send_button_state()},_toggle_top_area_view:function(){bD("#quick-send-top-part-send").hide();bD("#quick-send-top-part-confirm").show();return setTimeout(function(){bD("#quick-send-top-part-send").show();return bD("#quick-send-top-part-confirm").hide()},3000)},_update_location:function(){var i;i=Z.keep_visible||!!cr.inside_root_folder;return Z._toggle_quick_send_module(i)},_toggle_quick_send_module:function(T){var i,j;if(Z._visible===T){return}j=Z.$content;if(T){Z._visible=true;j.show();return Z._update_collapsed_state()}else{Z._visible=false;j.hide();j.removeClass("collapsed expanded");i=bD("#browse-files");return i.removeClass("quicksend-collapsed quicksend-expanded")}},_update_collapsed_view:function(fl){var j,fk,i,T;fk=Z.$content;T=fl?"collapsed":"expanded";if(fk.hasClass(T)){return}i=fl?"expanded":"collapsed";fk.removeClass(i);fk.addClass(T);j=bD("#browse-files");T=fl?"quicksend-collapsed":"quicksend-expanded";i=fl?"quicksend-expanded":"quicksend-collpased";j.removeClass(i);j.addClass(T);if(!fl){return Z._init_autocompleter()}},_update_collapsed_state:function(){var i;i=Object.keys(Z._files).length;return Z._update_collapsed_view(i===0)},_remove_file:function(j,i){var T;T=false;if(j in Z._uploading_fileids){T=true;document.fire(cA.CANCEL_EVT,{file:i});bD(document).trigger(cA.CANCEL_EVT,{file:i});delete Z._uploading_fileids[j]}if(j in Z._files){$(j).remove();delete Z._files[j];Z._update_upload_list_scroll();Z._update_file_area_view();return Z._update_collapsed_state()}},_reset:function(){var j,fk,T,i;Z.autocompleter.clearTokens();T=bD(".quick-send-left-form")[0];T.reset();i=[];for(fk in Z._files){j=Z._files[fk];i.push(Z._remove_file(fk,j.file_obj))}return i},_has_added_fq_path:function(T){var i,j;for(j in Z._files){i=Z._files[j];if(i.fq_path===T){return true}}return false},_update_upload_list_scroll:function(){var j,i;j=Object.keys(Z._files).length;i=bD("#quick-send-upload-files-list");if(j<3){return i.removeClass("scroll")}else{i.addClass("scroll");return i.scrollTop=i.scrollHeight}},_add_file:function(fl,i){var fm,fr,fk,fq,fo,fp,T,j,fs,fn;fp={size:fl.bytes,source:i};a9.SharedFolderActivityLogger.log("web","quick_send_file_added",cr.active_user,fp);fr=fl.dest||Z.DEST_FOLDER;fs=aF.format_bytes(fl.bytes||0);fm=ff.tmpl("upload_list_item_tmpl");fk=fm({file:fl,icon:aA.file_icon(fl.name),filename_snippet:bS.em_snippet(fl.name,d0.FILENAME_SNIPPET_LENGTH),size:fs,dest:fr,dest_snippet:bS.em_snippet(ey("Dropbox")+fr,d0.DEST_SNIPPET_LENGTH,0),Sprite:cv});j=cY.sanitize(fk.toHTML());bD("#quick-send-upload-files-list").append(j);fq=bD("#"+fl.id);Z._update_upload_list_scroll();fq.find(".dest-col").hide();fq.find(".time-col").hide();fn=fq.find(".status-col").find("a.small-x-button");fo=fl.id;fn.on("click",function(ft){return Z._remove_file(fo,fl)});T=fq.find(".remove-link");T.on("click",function(ft){return Z._remove_file(fo,fl)});fq.on("mouseenter",(function(ft){return function(fu){fq.find(".status-col").hide();return T.show()}})(this));fq.on("mouseleave",(function(ft){return function(fu){fq.find(".status-col").show();return T.hide()}})(this));Z._files[fl.id]={file_div:fk,fq_path:fl.fq_path,bytes:fl.size,file_obj:fl};Z._update_file_area_view();return Z._update_collapsed_state()},_toggle_send_button_state:function(){var j,T,i;i=((j=Z.autocompleter)!=null?j.token_manager.tokens.length:void 0)===0;i=i&&Z.$collab_input.val()==="";T=Object.keys(Z._files).length===0||Object.keys(Z._uploading_fileids).length>0;return Z.$send_button.prop("disabled",i||T)},_file_upload_errored:function(T){var j,i;j=T.memo.file;if(j.id in Z._uploading_fileids){i={message:T.memo.message};a9.SharedFolderActivityLogger.log("web","quick_send_file_errored",cr.active_user,i);return delete Z._uploading_fileids[j.id]}},_file_upload_completed:function(j){var i;i=j.memo.file;if(i.id in Z._uploading_fileids){a9.SharedFolderActivityLogger.log("web","quick_send_file_uploaded",cr.active_user,{});delete Z._uploading_fileids[i.id];return Z._toggle_send_button_state()}},get_folder_name:function(fk){var j,T,i;if(Z.DEST_FOLDER){fk();return}i=function(fm){var fl;fl=JSON.parse(fm);Z.DEST_FOLDER=fl.folder_name;return fk()};j=function(){return ah.error(ey("We couldn\u2019t upload your file. Please try again."))};T={};T[Constants.UID_PARAM_NAME]=Z.owner_id;return new cC.WebRequest({url:"/share/quick_send_folder_name",data:T,success:i,error:j})},is_quicksend_dest:function(i){var j;j=aA.normalize(i);return j===Z.DEST_FOLDER},add_external_file:function(i){var T,j;j=i.dest+i.name;if(Z._has_added_fq_path(j)){ah.success(ey("You\u2019ve already added this file."));document.fire(cA.CANCEL_EVT,{file:i});bD(document).trigger(cA.CANCEL_EVT,{file:i});return}i.fq_path=j;i.bytes=i.size;Z._uploading_fileids[i.id]=true;Z._add_file(i,"external");T=bD("#"+i.id);return T.find(".upload-progress-bar").css({width:"0"})},add_dropbox_file:function(i){var j;if(i.dir){ah.error(ey("Please select files instead of folders."));return}if(Z._has_added_fq_path(i.fq_path)){ah.success(ey("You\u2019ve already added this file."));return}i.name=i.filename;Z._add_file(i,"dropbox");j=bD("#"+i.id);j.find(".upload-progress-bar").css({width:"100%"});j.addClass("complete");return setTimeout(function(){var T;T=j.find(".status-col");T.empty();return T.append(cv.make("web","s_check"))},0)}};var dV,cs,fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty,b1=function(i,j){return function(){return i.apply(j,arguments)}};dV=E.SharedLinkSettingsModal=(function(j){fb(i,j);function i(T,fl,fk){var fm;this.owner_id=T;this.tkey=fl;this.dismiss_callback=fk;fm={tkey:this.tkey};fm[Constants.UID_PARAM_NAME]=this.owner_id;i.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:fm});if(this.dismiss_callback){this.on_hide=this.dismiss_callback}}return i})(cB);cs=E.SharedLinkSettingsModalContent=(function(){function i(T,fk,j,fm){var fn,fl;this.owner_id=T;this.tkey=fk;this.filename=j;this.saved_password_placeholder_value=fm;this._save_settings=b1(this._save_settings,this);this._toggle_password_input=b1(this._toggle_password_input,this);this._enable_password_input_for_editing=b1(this._enable_password_input_for_editing,this);this._date_change_callback=b1(this._date_change_callback,this);this._show_calendar=b1(this._show_calendar,this);this._hide_calendar=b1(this._hide_calendar,this);this._future_date=b1(this._future_date,this);this._enable_save_button=b1(this._enable_save_button,this);this._custom_expiry_click_handler=b1(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=b1(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=b1(this._show_custom_expiry_label,this);this._toggle_expiration=b1(this._toggle_expiration,this);this._expiry_picker_callback=b1(this._expiry_picker_callback,this);this._listen=b1(this._listen,this);this._detect_and_handle_blur_when_password_empty=b1(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=b1(this._is_clicked,this);this._change_password_click=b1(this._change_password_click,this);this._init_expiration_section=b1(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=bD(".sharing-settings-modal-content");this.modal=d5.get_containing_modal(this.$content);if(!this.modal){return}fl=ey("'%(filename)s' permissions").format({filename:bS.em_snippet(this.filename,18)});this.modal.set_title(fl);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.$static_expiry=this.$form.find(".static-expiration");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(fn=true)}this._init_expiration_section();this._listen()}i.prototype._init_expiration_section=function(){var j;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){bD("#expiration-yes").prop("checked",true);j=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(j);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};i.prototype._change_password_click=function(j){j.preventDefault();return this._enable_password_input_for_editing()};i.prototype._is_clicked=function(j,T){return j.is(T.target)||j.has(T.target).length};i.prototype._detect_and_handle_blur_when_password_empty=function(j){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,j)){return}return this._show_password_input(true)};i.prototype._listen=function(){if(this.loaded_with_saved_password){bD(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(j){return function(T){return dY.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return bD(window).on(by.CHANGED,this._expiry_picker_callback)};i.prototype._expiry_picker_callback=function(fl,fk){var j,T;if(fk.clicked_val===fk.old_val){return}j=fk.clicked_val;if(j!=="custom"){T=this._future_date(parseInt(j));return this._set_expiration(T)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};i.prototype._toggle_expiration=function(fk){var T,j;if(bD(fk.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();C.controller(bD(".expiration-picker")).set_value(30);j=30;T=this._future_date(j);this._set_expiration(T);return this._set_selected_date_text(T)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this.$static_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};i.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return bD(window).on("click",this._custom_expiry_click_handler)};i.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return bD(window).off("click",this._custom_expiry_click_handler)};i.prototype._custom_expiry_click_handler=function(j){if(this._is_clicked(this.$calendar,j)){return}if(this.$selected_date_box.is(j.target)||this.$selected_date_box.has(j.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};i.prototype._enable_save_button=function(j){return this.$save_button.removeAttr("disabled")};i.prototype._future_date=function(j){var T;T=d3.start_of_day(new Date());T.setDate(T.getDate()+j);return T};i.prototype._hide_calendar=function(){return this.$calendar.hide()};i.prototype._show_calendar=function(){var fk,T,j;bD(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){j=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{j=this._future_date(30)}T={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:j,onDateChange:bD.proxy(this._date_change_callback,this)};this.calendar=new I("expiration-calendar-container",T)}else{this.$calendar.show()}fk=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:fk})};i.prototype._posix_time_to_date=function(j){return new Date(j*1000)};i.prototype._set_selected_date_text=function(j){return this.$selected_date.text(N.localize(j))};i.prototype._set_expiration=function(T){var j,fk;cJ(T.getMilliseconds()===0);cJ(T.getSeconds()===0);cJ(T.getMinutes()===0);cJ(T.getHours()===0);fk=(T.getTime()+this.MS_PER_DAY)/1000;j=fk-1;return this.$expiry_posix.val(j)};i.prototype._date_change_callback=function(j){this._set_selected_date_text(j);this._set_expiration(j);this._enable_save_button();return this._hide_calendar()};i.prototype._show_password_input=function(fn){var fm,fk,T,fl,j;if(fn==null){fn=false}fm=this.$content.find("label[for=audience-password]").position().left;fl=this.$content.find("#audience-password").position().left;fk=fm-fl+10;this.$password.show().css({left:fk});this.$password_input.val("");if(fn){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");j="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(j).show();T=this.$password.position();return this.$change_password.css({left:T.left,top:T.top}).show()}else{return this._enable_password_input_for_editing()}};i.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(ey("Set password")).show();this.$password_input.focus();return this._enable_save_button()};i.prototype._toggle_password_input=function(j){var T;if(bD(j.currentTarget).attr("id")==="audience-password"){return this._show_password_input(T=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};i.prototype._save_settings=function(fl){var T,j,fk,fm;if(this.$password_input.data("is-saved-password")==="yes"){fk={type:"hidden",name:"password",value:this.saved_password_placeholder_value};T=bD("<input />",fk);this.$form.append(T);this.$password_input.attr("name","inoperative_password")}fm=(function(fn){return function(fo){dY.pop();return ah.success(ey("Settings saved."))}})(this);j=(function(fn){return function(fo){if(fn.$password.length&&fn.$password.is(":visible")){fn.$password_input.focus()}return bR.remove_loading()}})(this);return bR.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",fm,j,this.$save_button[0])};return i})();var eD;eD=E.SimpleSharing=(function(){function i(){}i.createAndShowInbandModalFromBrowseFile=function(j,T){return i.createAndShowInbandModal(j,T.fq_path,T.dir,T.target_ns,T.is_shared_folder(),T.could_be_shared_folder(),parseInt(T.sf_perm_role))};i.createAndShowM2InbandModal=function(T,fk){var fl,j;j=function(fm,fo,fn){return dY.push(new dV(fm,fo,fn))};fl=function(fn){var fm;fm=new de(cr.active_user,fn);return fm.show()};return aI.showInstance(aI({needsFetchingTokenInfo:true,user:T,fqPath:fk,isDir:true,canReaderSync:false,isSharedFolder:true,couldBeSharedFolder:false,canEdit:true,editableLinksM2Enabled:true,showSharedLinkSettingsModal:j,onGoBackButtonClicked:fl}))};i.createAndShowInbandModal=function(j,fl,fk,fm,T,fo,fq){var fp,fn;fp=function(fs,fu,fr,ft){return window.INLINE_JS.DBModalStack.push(new eu(fs,fu,fr,ft))};fn=function(ft,fv,fu,fs,fr){return window.INLINE_JS.DBModalStack.push(new al(ft,fv,fu,fs,fr))};return dN.ShareInband.createAndShowModal(j,fl,{show_dfb_existing_folder_settings_modal:fp,show_dfb_new_folder_settings_modal:fn},Boolean(fk),fm,T,fo,parseInt(fq),cr.simple_sharing_react_member_list_enabled,cr.simple_sharing_individual_files_enabled)};i.dismissM2Prompt=function(){cr.simple_sharing_show_m2_prompt=false;return cC.WebRequest({url:"/simple_sharing_ajax/dismiss_m2_prompt"})};return i})();var ex,es;es=E.FoshmodalPanes=Object.clone(dp);es.to_title_str=function(){var i,j,fm,T,fk,fl;if(ex.sharing_collection){fk=bS.em_snippet(ex.collection_to_share.name,18,1);return ey("Share '%(snippeted_name)s'").format({snippeted_name:fk})}else{i=ex._selection;T=c7.categorize_files(i),j=T[0],fm=T[1];if(j&&fm){fl=bb("Share %(file_count)s item","Share %(file_count)s items",i.length)}else{if(j){fl=bb("Share %(file_count)s photo","Share %(file_count)s photos",i.length)}else{fl=bb("Share %(file_count)s video","Share %(file_count)s videos",i.length)}}fl=fl.format({file_count:i.length});return fl}};ex=INLINE_JS.Foshmodal=E.Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:es.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=es.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;eT.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();bD(".link-image").attr("src","static/images/empty_album_big.png");bR.remove_loading(bD("#modal").find(".tokenizer-submit-button")[0]);bR.remove_loading(bD("#modal").find(".foshmodal-copy-link")[0]);bR.remove_loading(bD("#shmodal-twitter-post-submit")[0]);return bR.remove_loading(bD("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(i){var j;cJ(this._selection.length,"This should never be called with an empty selection");cJ(this.current_tkey!=null,"Missing tkey");cJ(this.current_shmodel_url!=null,"Missing shmodel url");cJ(this.current_short_url!=null,"Missing short url");cJ(i!=null,"Missing collection info");i.is_anonymous=this.creating_anonymous_collection();i.share_tkey=this.current_tkey;i.shmodel_url=this.current_shmodel_url;i.short_url=this.current_short_url;return j=new ad(i)},set_shmodel_url:function(j,i){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof j==="function"?j():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(T){return function(fl){var fk;fk=JSON.parse(fl.responseText);T.current_shmodel_url=fk.token_link;T.current_short_url=fk.short_link;T.current_tkey=fk.tkey;if(typeof j==="function"){j()}return typeof T.callback_for_when_we_have_shmodel_url==="function"?T.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof i==="function"?i():void 0}})}},attach_collection_to_token:function(j,i){cJ(this.collection_to_share!=null,"Should get called only when there is an existing collection");cJ(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof j==="function"){j(this.collection_to_share.gid)}return}cJ(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,j,i)},create_collection_and_attach_to_token:function(fm,i){var T,fl,fk,j;cJ(this.sharing_collection===false,"Should not get called when we already have a collection");cJ(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");fl=(function(fn){return function(fo){var fp;fp=JSON.parse(fo.responseText);fn.create_album_from_selected_photos(fp);return typeof fm==="function"?fm(fp.gid):void 0}})(this);T=function(fn){return typeof i==="function"?i(fn):void 0};fk={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fp,fn,fq,fo;fq=this._selection;fo=[];for(fp=0,fn=fq.length;fp<fn;fp++){j=fq[fp];fo.push(j.item_counter)}return fo}).call(this)),source_collection_gid:bO.get_current_collection_gid()};return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:fl,onFailure:T,parameters:fk})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){ah.error(ey("Please enter a name for this album"));this.unlock();return true}if(cH.collection_name_in_use(this.current_album_name)){ah.error(ey("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(T){var j,i;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}j=$("shmodal-send-form");cJ(j,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}i=(function(fk){return function(fl){fk.unlock();if(!fl.responseText.startsWith("err:")){ah.error(ey("We couldn't send this album. Please try again."));fa.hide();return fk.refresh()}}})(this);if(this.sharing_collection){this.send_collection(j,i)}else{this.send_selection(j,i)}return g.log_interaction(ej.SEND,da.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var fk,j,T,i,fl;fk=this.get_current_display_name();i=am.get_shmodel_send_recipients($("shmodal-send-form"));j=i[0].split(" ")[0];if(i.length===1){fl=ey("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:fk,first_name_of_recipient:j})}else{if(i.length===2){T=i[1].split(" ")[0];fl=ey("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:fk,first_name_of_recipient:j,first_name_of_second_recipient:T})}else{fl=ey("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:fk,first_name_of_recipient:j,num_other_recipients:i.length-1})}}return fl},send_selection:function(T,j){var fl,fk,i;fl=(function(fm){return function(fn){var fo;fo=JSON.parse(fn.responseText);fm.create_album_from_selected_photos(fo);ah.success(fm.get_send_success_text());fm.refresh();return fa.hide()}})(this);fk={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fo,fm,fp,fn;fp=this._selection;fn=[];for(fo=0,fm=fp.length;fo<fm;fo++){i=fp[fo];fn.push(i.item_counter)}return fn}).call(this)),source_collection_gid:bO.get_current_collection_gid()};if(this.creating_anonymous_collection()){fk.collection_name=""}else{if(this.current_album_name.trim().length===0){fk.collection_name=cH.get_default_album_name()}}return bR.ajax_submit(T,"/collection_create_and_send_link",fl,j,T.down(".tokenizer-submit-button"),fk)},send_collection:function(j,i){var T;cJ(this.current_tkey!=null,"tkey should be set");cJ(this.current_shmodel_url!=null,"shmodel url should be set");T=(function(fk){return function(){ah.success(fk.get_send_success_text());fa.hide();return fk.refresh()}})(this);return this.collection_to_share.send_link(j,this.current_tkey,this.current_shmodel_url,this.current_short_url,T,i)},get_link_button_onclick:function(){var i,T,j;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}j=$("modal").down(".tokenizer-submit-button");T=(function(fk){return function(fm){var fl;fl=fk.get_current_display_name();if(FlashDetect.installed){ah.success(ey("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:fl}))}fk.show_get_link_modal(fk.current_shmodel_url,fl,fm);a9.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(fk.collection_to_share!=null){cy.log_share("share_link",fm,fk.num_photos_to_share,fk.creating_anonymous_collection(),!fk.sharing_collection)}return fk.refresh()}})(this);i=(function(fk){return function(fl){fk.unlock();bR.remove_loading(j);if(!fl.responseText.startsWith("err")){ah.error(ey("We couldn't create a link to this album. Please try again."));fa.hide();return fk.refresh()}}})(this);if(this.sharing_collection){bR.add_loading(j);this.attach_collection_to_token(T,i)}else{if(this.alert_if_album_name_invalid()){return}bR.add_loading(j);this.create_collection_and_attach_to_token(T,i)}return g.log_interaction(ej.GET_LINK,da.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var i,j;if(FlashDetect.installed){i=t.clipboard_overlay(this.current_shmodel_url,bD("#foshmodal-copy-link"),ex.get_link_button_onclick.bind(this));i.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);j=(function(T){return function(){return i.clonePosition(bD("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(j,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(fm,j){var fl,T,i,fk;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(fm,j);return}fl=bD("#modal:visible, #modal-overlay:visible");i=function(){return fl.show()};T=(function(fn){return function(){fn.lock();setTimeout(fn.unlock.bind(fn),750);return eo.do_auth((function(){return fn.do_fb_post(j)}),j)}})(this);if(eo.authed_user_id===j){this.do_fb_post(j)}else{if(cK.get_viewer().is_uid_associated(eo.authed_user_id)){this.unlock();fl.hide();fk=new eb(cK.get_viewer().get_user_by_id(j),i,T.bind(this));fk.show()}else{T()}}return g.log_interaction(ej.FB_SHARE,da.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(j,i){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(j,i);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(cE.is_authed(i)){this.do_twitter_post(i)}else{setTimeout(this.unlock.bind(this),750);cE.do_auth(((function(T){return function(){return T.do_twitter_post(i)}})(this)),i)}return g.log_interaction(ej.TWITTER_SHARE,da.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(i){var j,T;j=(function(fk){return function(){ah.error(ey("We couldn't share this album on Facebook. Please try again."));fa.hide();return fk.refresh()}})(this);T=(function(fk){return function(fm){var fl;eo.custom_show_posting=function(){return bR.add_loading($("shmodal-fb-post-submit"))};eo.progress_container=$("modal").down(".modal-buttons");fl=fk.get_current_display_name();eo.custom_show_complete=function(){fa.hide();ah.success(ey("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:fl}));return fk.refresh()};eo.post($F("shmodal-fb-post-input"),fk.current_shmodel_url,null,null,null,j,i);a9.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return cy.log_share("share_facebook",fm,fk.num_photos_to_share,fk.creating_anonymous_collection(),!fk.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(T,j)}else{return this.create_collection_and_attach_to_token(T,j)}},do_twitter_post:function(i){var fk,j,T;fk=$F("shmodal-twitter-post-input");if(!fk){ah.error(ey("Please enter a tweet"));this.unlock();return}if(fk.length>140){ah.error(ey("Your tweet must be 140 characters or less"));this.unlock();return}T=(function(fl){return function(fm){cE.custom_show_posting=function(){$("twitter-chars").hide();return bR.add_loading($("shmodal-twitter-post-submit"))};cE.custom_post(fk,function(){fa.hide();ah.success(ey("Your tweet has been posted!"));return fl.refresh()},i);a9.ViralLogger.log(cK.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return cy.log_share("share_twitter",fm,fl.num_photos_to_share,fl.creating_anonymous_collection(),!fl.sharing_collection)}})(this);j=(function(fl){return function(){ah.error(ey("We couldn't share this album on Twitter. Please try again."));fa.hide();return fl.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(T,j)}else{return this.create_collection_and_attach_to_token(T,j)}},show_get_link_modal:function(j,i,T){var fk;fa.show(ey("Link to %(album_name)s").format({album_name:i.escapeHTML()}),$("get-link-modal"));fk=$("get-link-modal").down(".link-input");fk.setValue(j);fk.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(j,"_blank");return fa.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(T!=null){cH.flash_sidebar_album(T)}return fa.hide()}},update_current_album_name_text:function(i){this.current_album_name=$(es.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===es.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(fl){var j,fk,T,i;i=this.sharing_collection?bO.get_timeline().get_photos():this._selection;if(fl){if(this.num_photos_to_share===1){j=fl}else{j=ey("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:fl,album_desc:c7.file_desc(i)})}}else{if(i.length===1){T=i[0];if(T.preview_type==="photo"){fk=ey("Photo from %(date_taken)s")}else{fk=ey("Video from %(date_taken)s")}j=fk.format({date_taken:b4.nice_date_with_month_name(new Date(T.time_taken),true,true,true)})}else{j=c7.file_desc(i)}}return $(es.to_content_str(es.FB)).down(".link-name").__date(j)},set_current_album_name_text:function(j,i){$(es.to_content_str(j)).down(".album-name-input").value=i;if(j===es.FB){return this.set_fb_post_title(i)}},show_content:function(fm){var fk,T,j,fl;if(this.working){return}$("shmodal-title-text").__date(es.to_title_str());fl=es.list;for(T=0,j=fl.length;T<j;T++){fk=fl[T];if(fk!==fm){$(es.to_toggle_str(fk)).removeClassName("toggled");$(es.to_content_str(fk)).hide()}}$(es.to_content_str(fm)).show();$(es.to_toggle_str(fm)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(fm,this.current_album_name)}switch(fm){case es.FB:$("shmodal-fb-post-input").focus();break;case es.TWITTER:$("shmodal-twitter-post-input").focus();break;case es.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=fm},_get_foshmodal_title:function(){return am.generate_title_content(es.to_title_str(),((function(i){return function(){return i.show_content(es.SEND)}})(this)),((function(i){return function(){return i.show_content(es.FB)}})(this)),((function(i){return function(){return i.show_content(es.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return c7.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var i,fk,j,fl,T;i=this.sharing_collection?bO.get_timeline().get_photos():this._selection;if(i.length===1){T=c7.categorize_files(i),j=T[0],fl=T[1];if(j){fk=ey("Just shared a photo using @Dropbox")}else{if(fl){fk=ey("Just shared a video using @Dropbox")}else{cJ(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{fk=ey("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(fk+" "+this.current_short_url)},update_shmodal_image_text:function(){var fo,fp,fl,fq,fm,ft,T,fr,fn,fk,fs;if(this.sharing_collection){ft=this.collection_to_share.num_items;fs=c7.album_desc(this.collection_to_share,false,true)}else{ft=this._selection.length;fs=c7.file_desc(this._selection,false,true)}if(ft>1){T=$$(".shmodal-image");fn=[];for(fp=0,fq=T.length;fp<fq;fp++){fo=T[fp];fo.down("span").__date(fs);fn.push(fo.down(".share-file-count").show())}return fn}else{fr=$$(".shmodal-image");fk=[];for(fl=0,fm=fr.length;fl<fm;fl++){fo=fr[fl];fk.push(fo.down(".share-file-count").hide())}return fk}},show:function(fp,fy){var fr,fo,fv,fw,fn,fl,ft,fm,fk,fq,T,fu,fs,fx;this.unlock();fa.onHide=(function(i){return function(){var fz,j;if((fz=$("flash_copy_container"))!=null){fz.remove()}if((j=i.send_link_autocompleter)!=null){j.hide()}bD("#modal").find(".new-collab-input").val("");clearInterval(i.follow_freshbutton);bO.disable_selection();delete fa.onHide;return fa.hide()}})(this);this.sharing_collection=fy;fx=this.sharing_collection?fp.thumbnail_url_256:fp[0].thumbnail_url;T=$$(".link_image");for(fo=0,ft=T.length;fo<ft;fo++){fv=T[fo];if(fx!=null){fv.src=fx}else{fv.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=es.SEND;this.have_real_tkey=this.sharing_collection&&(fp.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=fp;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=fp.sort(function(j,i){return j.time_taken-i.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");fu=$$(".save-as-album-checkbox");for(fn=0,fm=fu.length;fn<fm;fn++){fr=fu[fn];fr.checked=false;fq=(function(i){return function(fG){var fH,fB,fz,fC,fA,fF,fE,fD,j;if(fG.target.checked){$("shmodal").addClassName("saving-as-album");i.current_album_name=i.previous_album_name||cH.get_default_album_name();i.set_current_album_name_text(i.current_foshmodal_pane,i.current_album_name);fH=$(es.to_content_str(i.current_foshmodal_pane)).down(".album-name-input");fH.focus();fH.select();fF=$$(".save-as-album-checkbox");fD=[];for(fB=0,fC=fF.length;fB<fC;fB++){fr=fF[fB];fD.push(fr.checked=true)}return fD}else{$("shmodal").removeClassName("saving-as-album");i.previous_album_name=i.current_album_name;i.current_album_name="";i.set_current_album_name_text(i.current_foshmodal_pane,i.current_album_name);fE=$$(".save-as-album-checkbox");j=[];for(fz=0,fA=fE.length;fz<fA;fz++){fr=fE[fz];j.push(fr.checked=false)}return j}}})(this);fr.observe("change",fq);if(bZ.msie_version_at_most(8)){fr.observe("click",fq)}}fs=$$(".album-name-input");for(fl=0,fk=fs.length;fl<fk;fl++){fw=fs[fl];fw.observe("keyup",this.update_current_album_name_text.bind(this))}}bO.enable_selection();fa.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(i){return function(){i.initialize_get_link_button();return i.set_twitter_message()}})(this)),(function(){ah.error(ey("This request could not be completed.  Please try again."));return fa.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(cK.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();V.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return d3._track_twitter_chars_left("shmodal-twitter-post-input",140)}};var eC,aq,cZ,dR,cA,d0,bn,cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};cA=INLINE_JS.Upload=E.Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var T,j,fk,i;fk={"MSIE 8.0":"flash","MSIE 9.0":"flash"};j="html5";for(T in fk){i=fk[T];if(navigator.userAgent.indexOf(T)!==-1){j=i}}return j})(),choose_button_id:"choose-button",set_dest:function(i){dt.fillVal(i,"dest-folder");return this.current_dest=i},init:function(T,fk,fl,j){var i;this.set_dest(T);i=this.initPLU(fl,j);if(!fk){an.window_load(i)}else{i()}bD("#flash-upload-container > .moxie-shim").each(function(fm){if(fm.observe){d3.freshbutton_overlay(fm,$("choose-button"));return d3.freshbutton_overlay(fm,$("add-button"))}});return aq.clear()},init_basic:function(){d3.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(i){return document.fire(cA.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(T){var j,i,fk;j=$("modal").cumulativeOffset();fk=T.clientY-j.top-3;i=T.clientX-j.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:fk+"px",left:i+"px"})});return $("file-box").observe("change",function(){var fl,T,fm,fk,i,j;fa.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();T=$("file-box").getValue().split("\\").pop();fk=cv.make("web",aA.file_icon(T));$("basic-upload-status").down(".icon").__date(fk);fl=ey("Uploading %(filename)s").format({filename:bS.em_snippet(T,25)});$("basic-upload-status").down(".file-desc").__date(fl);$("basic-upload-status").show();$("basic-uploading-message").show();fm=$("file-box").files;j=0;if(fm){i=fm[0].lastModifiedDate;if(i){j=Math.round(Date.parse(i)/1000)||0}}if(!j){j=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=j;return $("basic-upload-form").submit()})},initPLU:function(j,i){return(function(T){return function(){var fl,fk;fl={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:T.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:T.choose_button_id,container:"flash-upload-container",preinit:{PostInit:function(){if(j){j()}return T.uploaderLoaded()},Error:T.uploadError.bind(T)},init:{FilesAdded:T.fileQueued.bind(T),UploadProgress:T.uploadProgress.bind(T),FileUploaded:T.uploadSuccess.bind(T),BeforeUpload:T.prepareFileForUploading.bind(T),ChunkUploaded:T.chunkUploaded.bind(T),UploadComplete:aq.finished.bind(aq),Refresh:function(){if(T.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){bD("#flash-upload-container").clonePosition(bD("#add-button"));bD("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bD("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:aM.UrlConstants.MOXIE_SWF_URL};if(i!=null){bD.extend(fl,i)}fk=new p.Uploader(fl);T.PLU=fk;return T.PLU.init()}})(this)},reset:function(){if(aq.uploading&&aq.current_file){this.PLU.removeFile(aq.current_file)}return cZ.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return cZ.show()}},updatePostParams:function(T){var j,i;i=this.PLU.settings.multipart_params;for(j in T){if(T.hasOwnProperty(j)){i[j]=T[j]}}return this.PLU.settings.multipart_params=i},fileQueued:function(fl,fn){var fm,T,i,fk;for(T=0,i=fn.length;T<i;T++){fm=fn[T];if((typeof fm.getNative==="function"?(fk=fm.getNative())!=null?fk.dest:void 0:void 0)===void 0){fm.dest=cA.current_dest}else{fm.dest=fm.getNative().dest}}document.fire(this.QUEUE_EVT,{files:fn});bD(document).trigger(this.QUEUE_EVT,{files:fn});if(Z.is_quicksend_dest(fm.dest)){return}return this.show_upload()},uploadNext:function(){var fl,T,i,j,fm,fk;j=aq.next();i=(bv.contains(cA.APPLE_PACKAGE_EXTENSIONS,aA.file_extension_for_logging(j.name))&&j.size%34===0)||(aA.file_extension_for_logging(j.name)===""&&j.size%34===0&&j.size<=3400);if(i){j.status=p.FAILED;T={file:j,code:cA.APPLE_PACKAGE_ERROR,message:ey("Can\u2019t Upload"),tooltip_text:ey('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,T);return false}fm={dest:aq.next().dest,t:bu.read(Constants.JS_CSRF_COOKIE)};fm[Constants.UID_PARAM_NAME]=cr.active_user;if((fk=aA.file_extension(j.name,fl=true))==="url"||fk==="webloc"||fk==="website"){fm.overwrite=0}cA.updatePostParams(fm);this.PLU.start();aq.last_update_time=0;aq.last_update_size=0;return true},pause:function(){return cA.PLU.stop()},uploadProgress:function(j,i){if(!aq.cancelled_files[i.id]){document.fire(this.UPDATE_EVT,{file:i,percent_complete:i.loaded/i.size});return bD(document).trigger(this.UPDATE_EVT,{file:i,percent_complete:i.loaded/i.size})}},generateUploadId:function(){var T,fl,fk,fm;T="";for(fl=fk=0;fk<=15;fl=++fk){T+=String.fromCharCode(Math.floor(Math.random()*256))}fm=ak.encode(T);fm=fm.replace(/\+/g,"-");fm=fm.replace(/\//g,"_");fm=fm.replace(/\=*$/,"");return fm},chunkUploaded:function(j,T,fk){var i;i=JSON.parse(fk.response||"");return this.updatePostParams({offset:i.offset})},prepareFileForUploading:function(){var i;i=aq.next();return this.updatePostParams({reported_total_size:i.size,dest:i.dest,t:bu.read(Constants.JS_CSRF_COOKIE),upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(fl,fk,T){var j,fm,i;try{i=JSON.parse(T.response)}catch(fm){j=fm;i=null}if(T.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:fk,message:ey("Quota exceeded"),tooltip_text:ey("Your upload failed because you are over quota.")});return bD(document).trigger(this.ERROR_EVT,{file:fk,message:ey("Quota exceeded"),tooltip_text:ey("Your upload failed because you are over quota.")})}else{if(T.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:fk,message:ey("Empty File")});return bD(document).trigger(this.CANCEL_EVT,{file:fk,message:ey("Empty File")})}else{if(T.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:fk,message:ey("File Ignored")});return bD(document).trigger(this.CANCEL_EVT,{file:fk,message:ey("File Ignored")})}else{if((i!=null?i.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:fk});return bD(document).trigger(this.COMPLETE_EVT,{file:fk})}else{document.fire(this.ERROR_EVT,{file:fk});return bD(document).trigger(this.ERROR_EVT,{file:fk})}}}}},uploadComplete:function(j,i){document.fire(this.COMPLETE_EVT,{file:i});return bD(document).trigger(this.COMPLETE_EVT,{file:i})},uploadError:function(fl,i){var fk,T,j;if((j=i.file.id,cR.call(aq.file_ids(),j)<0)&&i.code!==cA.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[i.file]});bD(document).trigger(this.QUEUE_EVT,{files:[i.file]})}T=(function(){switch(i.code){case p.FILE_SIZE_ERROR:return ey("File too large");default:return ey("Upload Error")}})();this.show_upload();fk={file:i.file,error_code:i.code,message:T};if(i!=null?i.tooltip_text:void 0){fk.tooltip_text=i.tooltip_text}document.fire(this.ERROR_EVT,fk);return bD(document).trigger(this.ERROR_EVT,fk)},grabURL:function(){var i;i=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(i)){$("url").value=i}return true},treeview_handler:function(j,i){var T;dt.fillVal(j,"dest-folder");T=$("basic-uploader-url");if(T){T.href=T.href.replace(/(\/upload)(.*)(\?basic=1)/,function(fm,fl,fn,fk){return fl+d3.urlquote(j)+fk})}return aq.clear()},new_folder:function(){b0.hide();fa.show(ey("Create new folder..."),dt.fromElm("create-folder"),{action:this.do_new_folder.bind(this,cr.active_user),wit_group:"new-folder-confirm"});if(!d3.ie){return bD("#first-treeview-link").trigger("click")}},do_new_folder:function(i){var T,j;if(!fa.vars.selected_path){ah.error(ey("Please select a parent folder."));return}j=$F("entered-name");T=fa.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+d3.urlquote(T)+"?to_path="+d3.urlquote(j),{subject_user:i,onSuccess:(function(fk){return function(fl){fk.treeview_handler(aA.normalize(T)+"/"+j);return b0.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(cA.PLU.runtime==="flash"){bD("#flash-upload-container").clonePosition(bD("#choose-button"));bD("#flash-upload-container > .moxie-shim")[0].style.top="0px";bD("#flash-upload-container > .moxie-shim")[0].style.left="0px";bD("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bD("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{bD("#"+this.choose_button_id).click((function(i){return function(j){return bD("#"+i.PLU.id+"_html5").click()}})(this));return bD("#add-button").click((function(i){return function(j){return bD("#choose-button").click()}})(this))}}};aq=E.FileQueue={init:function(){return aq._listen()},_listen:function(){document.observe(cA.QUEUE_EVT,aq._file_queued.bind(this));document.observe(cA.QUEUE_ERROR_EVT,aq._file_queue_errored.bind(this));document.observe(cA.UPDATE_EVT,aq._file_updated.bind(this));document.observe(cA.COMPLETE_EVT,aq._file_completed.bind(this));document.observe(cA.ERROR_EVT,aq._file_errored.bind(this));return document.observe(cA.CANCEL_EVT,aq._file_cancelled.bind(this))},_file_queued:function(fn){var fl,T,i,fm,fk;fm=fn.memo.files;fk=[];for(T=0,i=fm.length;T<i;T++){fl=fm[T];this.files[fl.id]=fl;if(!aq.uploading){this._start_uploading()}this.current_file=fl;fk.push(eG("File queued:",fl.name))}return fk},_file_queue_errored:function(i){this._file_queued(i);return setTimeout(((function(j){return function(){return j._file_errored(i)}})(this)),250)},_file_updated:function(fp){var fk,i,j,T,fn,fm,fl,fo,fq;T=fp.memo.file;fm=fp.memo.percent_complete;fn=fm*T.size;fq=fn+this.completed_size();j=new Date().getTime();if(this.last_update_time){fl=(j-this.last_update_time)/1000;if(cA.PLU.total.bytesPerSec){this.average_bps=cA.PLU.total.bytesPerSec}else{i=fn-this.last_update_size;fk=i/fl;this.average_bps=((fq-i)*this.average_bps+i*fk)/fq}fo=(this.queue_size()-fq)/this.average_bps;this.formatted_time=b4.format_time(fo+this.num_left())}this.current_file=T;this.last_update_time=new Date().getTime();return this.last_update_size=fn},_file_completed:function(j){var i;i=j.memo.file;this.completed_files[i.id]=true;eG("File completed:",i.name);return this._check_if_finished(i)},_file_errored:function(j){var i;i=j.memo.file;this.errored_files[i.id]=true;eC.update_errors();cZ.update_errors();eG("File errored:",i.name);return this._check_if_finished(i)},_file_cancelled:function(j){var i;i=j.memo.file;this.cancelled_files[i.id]=true;if(i.status===p.UPLOADING){cA.PLU.stop();cA.PLU.removeFile(i);cA.PLU.start()}else{cA.PLU.removeFile(i)}eG("File cancelled:",i.name);return this._check_if_finished(i)},_start_uploading:function(){var i;this.uploading=cA.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=i=(function(j){return function(){return ey("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(i){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return cA.uploadNext()}},_finished_uploading:function(){var j,T,fk,i;this.uploading=false;if(!this.num_files()){eC.cancelled()}else{if(this.errors()){eC.errored();cZ.errored()}else{eC.completed();cZ.completed()}}i=$("inline-upload-status").visible();cr.select_fq_paths=[];if(cr.inside_dir){for(fk in this.completed_files){T=this.files[fk];j=aA.normalize(T.dest);cr.select_fq_paths.push(j+"/"+T.name)}cr.force_reload()}else{if(cr.in_search_mode()){b9.force_reload()}}if(i){cZ.show()}fa.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return bv(this.files).filter((function(i){return function(j){return !(i.cancelled_files[j.id]||i.errored_files[j.id]||i.completed_files[j.id])}})(this))[0]},cancels:function(){return bv(this.cancelled_files).keys().length},errors:function(){return bv(this.errored_files).keys().length},queue_size:function(){var fk,fn,T,i,fm,fl;fl=0;fm=this.file_ids();for(T=0,i=fm.length;T<i;T++){fn=fm[T];fk=this.files[fn];if(!this.errored_files[fn]&&!this.cancelled_files[fn]&&typeof fk.size!=="undefined"){fl+=fk.size}}return fl},completed_size:function(){var fm,T,i,fl,fk;fk=0;fl=bv(this.completed_files).keys();for(T=0,i=fl.length;T<i;T++){fm=fl[T];if(typeof this.files[fm].size!=="undefined"){fk+=this.files[fm].size}}return fk},file_ids:function(){return bv(this.files).map((function(i){return function(j,T){return T}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return bv(this.file_ids()).filter((function(i){return function(j){return !(i.cancelled_files[j]||i.errored_files[j]||i.completed_files[j])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof fa!=="undefined"&&fa!==null){return fa.onHide=null}}};aq.clear();d0=E.UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){d0._tmpl=ff.tmpl("upload_list_item_tmpl");return d0._listen()},_listen:function(){document.observe(cA.QUEUE_EVT,d0._file_queued);document.observe(cA.QUEUE_ERROR_EVT,d0._file_queue_errored);document.observe(cA.UPDATE_EVT,d0._file_updated);document.observe(cA.COMPLETE_EVT,d0._file_completed);document.observe(cA.ERROR_EVT,d0._file_errored);return document.observe(cA.CANCEL_EVT,d0._file_cancelled)},_file_queued:function(fn){var fl,T,i,fm,fk;fm=fn.memo.files;fk=[];for(T=0,i=fm.length;T<i;T++){fl=fm[T];fk.push((function(fo){var fu,j,fr,ft,fs,fv,fp,fq;fu=fo.dest;if(Z.is_quicksend_dest(fu)){Z.add_external_file(fo);return}fv=aF.format_bytes(fo.size||0);j=d0._tmpl({file:fo,icon:aA.file_icon(fo.name),filename_snippet:bS.em_snippet(fo.name,d0.FILENAME_SNIPPET_LENGTH),size:fv,dest:fu,dest_snippet:bS.em_snippet(ey("Dropbox")+fu,d0.DEST_SNIPPET_LENGTH,0),Sprite:cv});$("upload-files-list").__sert(j);ft=$(fo.id);fs=aq.num_files();if(dv.show_share_button_in_file_uploader){fr=bD("#"+fo.id);fr.find(".dest-col").hide()}fp=$("upload-files-list");if(fs<=6){fp.removeClassName("scroll")}else{fp.addClassName("scroll")}fp.scrollTop=fp.scrollHeight;ft.down(".dest").observe("click",function(){cr.reload_fqpath(ft.readAttribute("data-dest"),true);return fa.hide()});fq=ft.down(".status-col").down("a.small-x-button");fq.stopObserving("click");fq.observe("click",function(fw){document.fire(cA.CANCEL_EVT,{file:fo});return bD(document).trigger(cA.CANCEL_EVT,{file:fo})});return ft.down(".upload-progress-bar").setStyle({width:"0"})})(fl))}return fk},_file_queue_errored:function(i){d0._file_queued(i);return d0._file_errored(i)},_file_updated:function(fk){var T,fl,j,i;T=fk.memo.file;fl=$(T.id);if(aq.num_files()===1){i=ey("%(time_left)s left").format({time_left:aq.formatted_time});fl.down(".time-col").__date(i)}j=parseInt(T.percent,10)+"%";if(j==="100%"){fl.down(".time-col").__date();fl.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))}return fl.down(".upload-progress-bar").setStyle({width:j})},_file_completed:function(j){var i,T,fk;i=j.memo.file;i.completed=true;fk=$(i.id);fk.addClassName("complete");if(dv.show_share_button_in_file_uploader&&!Z.is_quicksend_dest(i.dest)){T=bD("#"+i.id);T.find(".share-link").show();a9.SharedFolderActivityLogger.log("web","share_button_in_uploader_impression",cr.active_user,{});T.on("click",function(fn){var fm,fl;fa.hide();a9.SharedFolderActivityLogger.log("web","share_button_in_uploader_click",cr.active_user,{});fm=i.dest+"/"+i.name;fl="file_uploader";return dv.shmodel(fm,fl)})}setTimeout(function(){return fk.down(".status-col").__date(cv.make("web","s_check"))},0);return fk.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(j){var i,T;i=j.memo.file;T=$(i.id);if(T){return d0._actual_file_errored(j)}else{return setTimeout((function(fk){return function(){return d0._actual_file_errored(j)}})(this),0)}},_actual_file_errored:function(fl){var i,T,j,fm,fk;j=fl.memo.file;fm=$(j.id);fm.addClassName("error");fm.down(".dest-col").hide();fm.down(".time-col").__date();fm.down(".status-col").__date(Element("img",{src:"/static/images/nosync-vfl18cuTS.png",srcset:"/static/images/nosync@2x.png 2x"}));fm.down(".upload-progress-bar").setStyle({width:"100%"});if(Z.is_quicksend_dest(j.dest)){return}T=fl.memo.message||ey("Upload Error");i=void 0;if(fl.memo.tooltip_text){i=fl.memo.tooltip_text}else{i=ey('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');bD(document).on("click","a#basic_link",function(){dB.show_basic_upload();return false})}fm.down(".error-msg").__date(T);fk=fm.down(".error-details");fk.observe("mouseover",function(){return eg.show(fk,i)});return fm.down(".error-col").show()},_file_cancelled:function(j){var i,T;i=j.memo.file;T=$(i.id);T.addClassName("cancelled");T.down(".dest-col").__date(ey(j.memo.message||"Canceled"));T.down(".time-col").__date();T.down(".status-col").__date(Element("img",{src:"/static/images/cancelsync-vflGFIEUK.png",srcset:"/static/images/cancelsync@2x.png 2x"}));return T.down(".upload-progress-bar").setStyle({width:"100%"})}};eC=E.BulkUpload={init:function(){this.elem=$("bulk-upload-status");return eC._listen()},_listen:function(){document.observe(cA.QUEUE_EVT,eC._file_queued.bind(this));return document.observe(cA.UPDATE_EVT,eC._file_updated.bind(this))},_file_queued:function(j){var i;i=new Element("a",{"class":"small-x-button"});i.observe("click",function(){var fm,fn,fk,T,fl;aq.all_cancelled=true;fm=aq.file_ids().slice(0);fl=[];for(fk=0,T=fm.length;fk<T;fk++){fn=fm[fk];if(!aq.completed_files[fn]&&!aq.errored_files[fn]){document.fire(cA.CANCEL_EVT,{file:aq.files[fn]});fl.push(bD(document).trigger(cA.CANCEL_EVT,{file:aq.files[fn]}))}else{fl.push(void 0)}}return fl});return this.elem.down(".status").__date(i)},_file_updated:function(fk){var T,j,i;if(aq.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");T=bb("%d file","%d files",aq.num_non_cancelled_files()).format(aq.num_non_cancelled_files());this.elem.down(".num-files").__date(T);j=ey("- %(size)s").format({size:aF.format_bytes(cA.PLU.total.size)});this.elem.down(".size").__date(j);if(aq.formatted_time){i=ey("%(time_left)s left").format({time_left:aq.formatted_time});this.elem.down(".time-left").__date(i)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(aq.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(cA.PLU.runtime==="flash"){return bD("#flash-upload-container").clonePosition(bD("#add-button"))}}},update_errors:function(){var i;i=bb("- %d error","- %d errors",aq.errors()).format(aq.errors());return $("bulk-upload-status").down(".num-errors").__date(i)},completed:function(){var j,i;$("hide-button").hide();$("done-button").show();if(aq.num_files()>1){this.elem.addClassName("complete");j=bb("Uploaded %d file","Uploaded %d files",aq.num_non_cancelled_files()).format(aq.num_non_cancelled_files());this.elem.down(".num-files").__date(j);i=ey("- %(size)s").format({size:aF.format_bytes(aq.completed_size())});this.elem.down(".size").__date(i);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cv.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var i;$("hide-button").hide();$("done-button").show();this.completed();i=bb("- %d error","- %d errors",aq.errors()).format(aq.errors());return this.elem.down(".num-errors").__date(i)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(aq.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(ey("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(Element("img",{src:"/static/images/cancelsync-vflGFIEUK.png",srcset:"/static/images/cancelsync@2x.png 2x"}));return this.elem.down(".upload-progress-bar").style.width="100%"}}};cZ=E.InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(cA.QUEUE_EVT,cZ._file_queued.bind(this));return document.observe(cA.UPDATE_EVT,cZ._file_updated.bind(this))},_file_queued:function(T){var j,i;j=$("inline-upload-status");j.removeClassName("error");j.removeClassName("complete");j.down(".icon").__date(cv.make("web","s_sync"));j.down(".file-desc").__date(ey("Starting upload..."));j.down(".num-errors").__date();i=bb("%d file","%d files",aq.num_left()).format(aq.num_left());j.down(".view-details").__date(i);j.down(".status").__date();return j.down(".inline-upload-progress").style.width="0%"},_file_updated:function(fn){var fm,T,fk,fl,j,i;fm=$("inline-upload-status");T=fn.memo.file;fm.down(".icon").__date(cv.make("web","s_sync"));fk=ey("Uploading %(filename)s").format({filename:bS.em_snippet(T.name,this.FILENAME_SNIPPET_LENGTH)});fm.down(".file-desc").__date(fk);if(aq.num_left()>1){i=bb("%d file left","%d files left",aq.num_left()-1).format(aq.num_left()-1);fm.down(".view-details").__date(i)}else{fm.down(".view-details").__date(ey("View details"))}if(aq.formatted_time){j=ey("%(time_left)s left").format({time_left:aq.formatted_time});fm.down(".status").__date(j)}fl=T.percent+"%";return fm.down(".inline-upload-progress").style.width=fl},update_errors:function(){var i,j;i=$("inline-upload-status");j=bb("- %d error","- %d errors",aq.errors()).format(aq.errors());return i.down(".num-errors").__date(j)},add_x_button:function(){var i,j;j=new Element("a",{"class":"small-x-button"});j.observe("click",function(){cZ.hide();return cA.reset()});i=$("inline-upload-status");return i.down(".status").__date(j)},completed:function(){var j,i;j=$("inline-upload-status");j.addClassName("complete");j.removeClassName("error");j.down(".icon").__date(cv.make("web","s_check"));if(aq.num_files()>1){i=ey("Uploaded %(num_files)d files").format({num_files:aq.num_non_cancelled_files()})}else{i=ey("Uploaded %(filename)s").format({filename:bS.em_snippet(aq.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}j.down(".file-desc").__date(i);j.down(".num-errors").__date();j.down(".view-details").__date(ey("View details"));this.add_x_button();return j.down(".inline-upload-progress").style.width="100%"},errored:function(){var T,j,i,fk;T=$("inline-upload-status");T.addClassName("error");T.removeClassName("complete");T.down(".icon").__date(Element("img",{src:"/static/images/nosync-vfl18cuTS.png",srcset:"/static/images/nosync@2x.png 2x"}));j=void 0;if(aq.num_files()>1){j=ey("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:aq.num_non_cancelled_files()-aq.errors(),num_files:aq.num_non_cancelled_files()});T.down(".file-desc").__date(j);fk=bb("- %d error","- %d errors",aq.errors()).format(aq.errors());T.down(".num-errors").__date(fk)}else{if(aq.current_file!=null){i=bS.em_snippet(aq.current_file.name,this.FILENAME_SNIPPET_LENGTH)}j=i?ey("Unable to upload %(filename)s").format({filename:i}):ey("Unable to upload file");T.down(".file-desc").__date(j);T.down(".num-errors").__date()}T.down(".view-details").__date(ey("View details"));this.add_x_button();return T.down(".inline-upload-progress").style.width="100%"},show:function(i){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};bn=E.UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return bn.supported()&&cr.inside_dir&&!(cr.in_search_mode()&&b9.fulltext_search_enabled)},browse_indicators_enabled:function(){var fl,T,i,fk;if(!bn.enabled()){return false}fk=["modal-overlay"];if(cA.choose_button_id.startsWith("wizard-")){fk.push("wizard-overlay")}for(T=0,i=fk.length;T<i;T++){fl=fk[T];if($(fl).visible()){return false}}return true},modal_indicators_enabled:function(){var i;return bn.enabled()&&bD("#modal #upload-modal-dropzone").length&&bD("#modal").visible()&&((i=bD("#modal").offset())!=null?i.left:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(i){return bD(i).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(j){var i;if(!bn._drop_indicators){if(bn.modal_indicators_enabled()){i=$("upload-modal-dropzone");bD(i).clonePosition(bD("#modal"),{setLeft:false,setTop:false});bD(i).fadeIn(500);bn._show_border_drop_indicators()}else{if(bn.browse_indicators_enabled()){bP._add_drop_indicators(j)}else{return}}$("drag-status").removeClassName("active");return bn._drop_indicators=true}},hide_drop_indicators:function(){if(bn._drop_indicators){bn._hide_border_drop_indicators();bP._remove_drop_indicators();if(!bn._notifications_cleared){ah.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){bn._drop_indicators=false;bn._drop_dest_folder=null;return bn._notifications_cleared=false}),500)}return bn._notifications_cleared=true},folder_dragover:function(i){var j;if(bn.browse_indicators_enabled()&&bn._drop_indicators){if(dR.disabled){if(bn._drop_dest_folder==null){j=ey("You can't upload files because you're out of space.");ah.error(j,60);bn._notifications_cleared=false;bn._show_border_drop_indicators()}}else{if(i!==bn._drop_dest_folder){if(i===cr.containing_fq_path()){if(cr.inside_read_only_shared_folder){j=ey("You don't have permission to add to this folder.");ah.error(j,60)}else{j=ey("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:dB.upload_plain_snippet()});ah.success(new ff(j),60);bn._show_border_drop_indicators()}bn._notifications_cleared=false}else{ah.clear();bn._hide_border_drop_indicators()}}}return bn._drop_dest_folder=i}},supports_recursive_upload:function(i){var j;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(i!=null?(j=i[0])!=null?j.webkitGetAsEntry:void 0:void 0)},upload:function(fl,fn,T){var fm,fk,i,fo;if(T==null){T=null}if(cr.inside_read_only_shared_folder){return}if(dR.disabled){fo=ey("You can't upload files because you're out of space.");return ah.error(fo)}else{if(bn.supports_recursive_upload(T)){return bn._recursive_upload(fl,T)}else{for(fk=0,i=fn.length;fk<i;fk++){fm=fn[fk];fm.dest=fl}return bn._upload(fn,T)}}},_recursive_upload:function(ft,fr){var fv,fq,i,fk,fl,fs,fp,fw,T,fu,fm,fo,fn;T=[];fn=[];fq=function(j,fx){j.dest=ft+aA.parent_dir(fx.fullPath);return T.push(j)};for(fm=0,fo=fr.length;fm<fo;fm++){fu=fr[fm];fs=fu.webkitGetAsEntry();if(fs!==null){if(fs.isDirectory){if(Z.is_quicksend_dest(ft)){ah.error(ey("Please select files instead of folders."))}else{fn.push(fs)}}else{fq(fu.getAsFile(),fs)}}}fl=0;fw=0;i=function(j,fy){var fx;fx=ey('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:fy.name});ah.error(new ff(fx));return bD("#use-advanced-uploader").on("click",function(fz){fz.preventDefault();return dB.show_upload()})};fv=3000;fp=0;fk=function(){var j;while(fn.length){fs=fn.pop();if(fs!==null){if(fs.isDirectory){(function(fy){var fx;fx=fy.createReader();fl+=1;return fx.readEntries(function(fz){var fC,fA,fB;if(fz.length!==0){for(fA=0,fB=fz.length;fA<fB;fA++){fC=fz[fA];fn.push(fC)}return fx.readEntries(arguments.callee)}else{return fl-=1}},function(fz){fl-=1;return i(fz,fy)})})(fs)}else{fw+=1;j=function(fx){return function(fy){fq(fy,fx);return fw-=1}};fs.file(j(fs),function(fx){fw-=1;return i(fx,fs)})}}}if(T.length>fv&&!fp){fp=1;ah.error(ey("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:fv}));return}if(fl||fw){return fk.defer()}else{if(T.length){return bn._upload(T)}}};return fk()},_upload:function(fk,j){var i,T;if(j==null){j=null}if(j){i=this._parse_upload_items(j)}T=function(){var fo,fm,fl,fp,fn;fn=[];for(fm=0,fl=fk.length;fm<fl;fm++){fo=fk[fm];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(i!=null?(fp=i[fo.name])!=null?fp.isDirectory:void 0:void 0)){fo.is_directory=true}fo.id=p.guid();fn.push(cA.PLU.addFile(fo))}return fn};if($("modal").visible()){return T()}else{dB.show_upload(T);return fa.hide(null,true)}},_parse_upload_items:function(T){var fl,fm,fk,i;fl={};for(fk=0,i=T.length;fk<i;fk++){fm=T[fk];if(fm.getAsEntry){fm=fm.getAsEntry()}else{if(fm.webkitGetAsEntry){fm=fm.webkitGetAsEntry()}}fl[fm.name]=fm}return fl}};dR=E.OverQuotaUploads={disabled:false,init:function(i){this.disabled=i;if(this.disabled){return bD("body").addClass("uploads-disabled")}}};var dB;dB=INLINE_JS.FileOps=E.FileOps={NOTIFICATION_SNIPPET_LEN:40,SHOW_UPLOAD_EVT:"db:fileops:show_upload",_find_app_by_id:function(fk){var fm,T,i,fl;fl=fa.vars.apps;for(T=0,i=fl.length;T<i;T++){fm=fl[T];if(fm.app_id!==fk){continue}return fm}return null},create_album_from_folder:function(j,i){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:j,album_name:i},job:true,job_user:cK.get_viewer().photos_user,dont_hide_progress_on_complete:true,progress_text:ey("Creating album..."),onSuccess:function(T){var fk;fk=JSON.parse(T.responseText);return window.location.href=fk.url}})},dir_handler:function(fk,T){var j,i;if(typeof T==="string"){T=$(T)}j=$$(".treeview .highlight")[0];if(j){j.removeClassName("highlight")}i=T.up("div");i.addClassName("highlight");fa.selected_div=i;if(fa.shown()){T.blur()}document.fire("db:dir_click",{path:fk});return fa.vars.selected_path=fk},show_folder_pick:function(fm,fk,T,fl,i){var j;dt.fillVal(aA.filename(fk).escapeHTML(),"folder-pick-file");b0.move("copy-move-treeview","folder-pick-treeview",{user:cr.active_user});j=(i?ey("Move"):ey("Copy"));dt.fillVal(j,"folder-pick-action-text");fa.show(fm,$("folder-pick"),{fq_path:fk,action:T,folder:fl});return bD("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(fn,fm,fk,fl){var j,i,T;T=a5.profile_files(fk);i=a5.profile_summary(T);dt.fillVal(i,"bulk-folder-pick-file");b0.move("copy-move-treeview","bulk-folder-pick-treeview",{user:cr.active_user});if(fm==="move"){j=ey("Move")}else{if(fm==="copy"){j=ey("Copy")}else{j=ey("Restore")}}dt.fillVal(j,"bulk-folder-pick-action-text");fa.show(fn,$("bulk-folder-pick"),{files:fk,action:fl});return bD("#first-treeview-link").trigger("click")},show_copy:function(i,j){var T;T=(j?ey("Copy folder to..."):ey("Copy file to..."));b0.set_params({disable_read_only:true});return dB.show_folder_pick(T,i,dB.do_copy,j,false)},show_copy_bulk:function(i){var j;j=bb("Copy %(item_count)s item to...","Copy %(item_count)s items to...",i.length).format({item_count:i.length});b0.set_params({disable_read_only:true});return dB.show_bulk_folder_pick(j,"copy",i,dB.do_bulk_copy)},show_compress_bulk:function(i,j){b0.set_params({disable_read_only:true});return dK.show({title_text:bb("Compress file?","Compress files?",j.length),body_html:bb("Do you want to compress <strong>%(filename)s</strong>?<br/>This might take a while.","Do you want to compress %(file_count)s files?<br/>This might take a while.",j.length).format({file_count:j.length,filename:bv.escape(j.first().filename)}),confirm_text:ey("Compress"),cancel_text:ey("Cancel"),confirm_callback:function(){return dB.do_bulk_compress(i,j)}})},do_bulk_compress:function(i,T){var j;ah.clear();j=T.pluck("fq_path");return cC.WebProgressRequest({url:"/cmd/compress",data:{files:j},subject_user:i,progress_text:ey("Compressing..."),success:function(fn){var fm,fl,fk;fk=JSON.parse(fn);fm=fk.compressed_files;cJ(fm.length>0,"Must have at least 1 compressed file");fl=bv.escape(aA.filename(fm.first().fq_path));ah.success(bb("Compressed successfully to %(filename)s","Compressed %(file_count)s files successfully.",fm.length).format({file_count:fm.length,filename:fl}));return bD(document).trigger(aH.COMPRESS,{original_files:T,compressed_files:fm})}})},show_move_bulk:function(i){var j;j=bb("Move %(item_count)s item to...","Move %(item_count)s items to...",i.length).format({item_count:i.length});b0.set_params({disable_read_only:true});return dB.show_bulk_folder_pick(j,"move",i,dB.do_bulk_move)},show_move:function(i,j){var T;T=(j?ey("Move folder to..."):ey("Move file to..."));b0.set_params({disable_read_only:true});return dB.show_folder_pick(T,i,dB.do_move,j,true)},show_delete:function(i,T,fk,j,fm){var fl;if(fm==null){fm=null}if(fm){fl=ey("Are you sure you want to delete <strong>%(items)s</strong> from the shared folder \u2018%(sf_name)s\u2019?").format({items:aA.filename(T).escapeHTML(),sf_name:fm.escapeHTML()})}else{fl=ey("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:aA.filename(T).escapeHTML()})}return dK.show({title_text:fk?ey("Delete folder?"):ey("Delete file?"),body_html:'<div class="simple-modal-word-wrap-content">'+fl+"</div>",confirm_text:ey("Delete"),cancel_text:ey("Cancel"),confirm_callback:function(){if(j){return dB.do_nonbrowse_delete(i,[T])}else{return dB.do_delete(i,T)}}})},show_bulk_delete:function(i,j,fk){var T;if(fk==null){fk=null}if(fk){T=bb("Are you sure you want to delete %(item_count)s item from the shared folder \u2018%(sf_name)s\u2019?","Are you sure you want to delete %(item_count)s items from the shared folder \u2018%(sf_name)s\u2019?",j.length).format({item_count:j.length,sf_name:fk.escapeHTML()})}else{T=bb("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",j.length).format({item_count:j.length})}return dK.show({title_text:bb("Delete %(item_count)s item?","Delete %(item_count)s items?",j.length).format({item_count:j.length}),body_html:T,confirm_text:ey("Delete"),cancel_text:ey("Cancel"),confirm_callback:function(){return dB.do_bulk_delete(i,j)}})},show_purge:function(i,j){return dK.show({title_text:j?ey("Permanently delete folder?"):ey("Permanently delete file?"),body_html:ey("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:aA.filename(i).escapeHTML()}),confirm_text:ey("Permanently delete"),cancel_text:ey("Cancel"),confirm_callback:function(){return dB.do_purge(cr.find_file(i))}})},show_bulk_purge:function(i){return dK.show({title_text:bb("Permanently delete %d item?","Permanently delete %d items?",i.length).format(i.length),body_html:bb("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",i.length).format({item_count:i.length}),confirm_text:ey("Permanently delete"),cancel_text:ey("Cancel"),confirm_callback:function(){return dB.do_bulk_purge(i)}})},show_bulk_restore:function(j,i){return dK.show({title_text:bb("Restore %d item...","Restore %d items...",j.length).format(j.length),body_html:bb("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",j.length).format({item_count:j.length}),confirm_text:ey("Restore"),cancel_text:ey("Cancel"),confirm_callback:function(){return dB.do_bulk_restore(j)}})},wrap_strong:function(i){if(cr.containing_fq_path()===""){return i.escapeHTML()}else{return"<strong>"+i.escapeHTML()+"</strong>"}},upload_snippet:function(T){var i,j;if(T==null){T=1000}if(cK.get_viewer().is_paired&&cr.active_user.is_team){j=bS.em_snippet(cK.get_viewer().team_name,T).escapeHTML()}if(cr.containing_fq_path()===""){if(cK.get_viewer().is_paired){if(cr.active_user.is_team){return ey(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:j})}else{return ey(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return ey(" upload to your Dropbox")}}else{i=bS.em_snippet(aA.filename(cr.containing_fq_path()),T).escapeHTML();if(cK.get_viewer().is_paired){if(cr.active_user.is_team){return ey(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i,team_name:j})}else{return ey(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i})}}else{return ey(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:i})}}},upload_short_snippet:function(T){var j,i;if(T==null){T=1000}i=cr.containing_fq_path();if(!i){return ey("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}j=bS.em_snippet(aA.filename(i),T);return ey("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:j})},upload_plain_snippet:function(i){if(i==null){i=1000}return this.upload_snippet(i).replace("<strong>","'").replace("</strong>","'")},show_upload:function(fq,i,fo){var fl,fm,fn,fp,fk,T;fl=cr.containing_fq_path();if(dR.disabled){dt.fillVal(this.wrap_strong(aA.filename(fl)),"disabled-upload-foldername");fk=this.upload_short_snippet(20);fa.show(fk,$("disabled-upload-modal"),{},false);return}bD(document).trigger(this.SHOW_UPLOAD_EVT,{source:i,has_callback:fq!=null});if((!FlashDetect.versionAtLeast(9))&&cA.runtimes==="flash"){dB.show_basic_upload();$("enhanced-upload-toggle").hide();return}dt.fillVal(this.upload_snippet(20),"upload-foldername");dt.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&bn.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}fk=this.upload_short_snippet(20);fa.show(fk,dt.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,aq.num_files());T=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(fm=0,fn=T.length;fm<fn;fm++){fp=T[fm];if(fp!=null){fp.observe("click",function(){dB.show_basic_upload();return false})}}if(!aq.num_files()){cA.init(aA.normalize(fl),true,fq,fo)}else{cA.set_dest(aA.normalize(fl))}return cZ.hide()},show_basic_upload:function(){dt.fillVal(this.upload_snippet(20),"basic-upload-foldername");fa.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){dB.show_upload();return false});cA.set_dest(aA.normalize(cr.containing_fq_path()));return cA.init_basic()},show_undelete:function(i){var j,T,fk;dt.fillVal(i.filename.escapeHTML(),"undelete_filename");j=cv.make("web",i.icon,{});j.addClassName("link-img");j.style.backgroundColor="transparent";T=dB.build_revisions_uri(i.fq_path,cr.active_user,{undelete:1});$$(".undelete-icon").invoke("update",j);$$(".undelete-other-versions")[0].href=T;$$(".undelete-link")[0].href=T;fk=ey("Restore file?");return fa.show(fk,$("undelete-modal"),{file:i})},do_undelete:function(j){var i,T;i=fa.vars.file;T=ey("Restored '%(file_name)s'").format({file_name:i.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[i.fq_path]},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:ey("Restoring..."),onSuccess:function(fk){fa.hide();ah.success(T);return document.fire(aH.RESTORE,{files:[i]})}});return false},do_copy:function(T,j){var i;T=T||fa.vars.fq_path;j=j||fa.vars.selected_path;i=cr.find_file(T);cJ(i,"Trying to copy a file we couldn't find.");return dB.do_bulk_copy([i],j)},do_bulk_copy:function(fp,fk){var fn,fo,fm,fl,T;cr.pre_action_selection=eV.get_selected_fq_paths();fp=fp||fa.vars.files;cJ(fp.length>0,"Tried to copy 0 files");if(typeof fk==="undefined"){if(typeof fa.vars.selected_path==="undefined"){ah.error(ey("You need to select a destination for the file."));return}else{fk=fa.vars.selected_path}}fk=aA.normalize(fk);fm=0;for(fl=0,T=fp.length;fl<T;fl++){fn=fp[fl];if(fn.dir){if((fk+"/").indexOf(fn.fq_path+"/")===0){ah.error(ey("You cannot copy a folder into itself."));return}}}fo=fp.pluck("fq_path");ah.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:fo,to_path:fk},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:ey("Copying..."),onSuccess:function(fv){var fr,fu,i,fs,ft,fw,fq,j;fr=fv.responseText.evalJSON().changesets;fu=fo.length;fw=bS.em_snippet(aA.filename(fk),dB.NOTIFICATION_SNIPPET_LEN).escapeHTML();fq=bb("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",fu);fq=fq.format({count:fu,location:fw});X.notifyWithUndo(new ff(fq),fr,dB.do_rollback);i=[];j=fv.responseText.evalJSON().new_browse_files;for(fs=0,ft=j.length;fs<ft;fs++){fn=j[fs];i.push(fn.fq_path)}cr.select_fq_paths=i;$("reload-link").observe("click",function(){return a3.set_path_url(null,fk)});b0.schedule_reset();return document.fire(aH.COPY,{files:fp,to_fq_path:fk})}})},bulk_move_error:function(i,fp){var fn,fk,fq,fl,fr,fm,j,T,fo;fq=cr.find_file(fp);fl=a5.profile_files(i);T=void 0;fm=void 0;fo=void 0;if(fq){fm=fq.dir;T=fq.fq_path;fo=fq.target_ns||fq.ns_id}else{if(cr.inside_dir&&cr.can_get_details_from_fq_path(fp)){fk=cr.details_from_fq_path(fp);fm=true;T=fk.fq_path;fo=fk.ns_id}else{fm=true;T=fp;fo=void 0}}fr=i.pluck("fq_path").collect(aA.normalize);if(-1!==fr.indexOf(aA.normalize(T))){return ey("You cannot copy a folder into itself.")}fn=j=function(fs){var ft;ft=aA.parent_dir(fs.fq_path);return ft===(T||"/")};if(i.all(fn)){return bb("That file already exists in that folder.","Those files already exist in that folder.",i.length)}if(!fm){return ey("You cannot put files inside one another.")}if(fl.target_namespaces>0&&fo&&fo!==Constants.root_ns&&fq){if(fl.sandboxes>0){if(fq.is_sandbox()){return ey("You're not allowed to put an application folder inside another application folder.")}else{if(fq.is_shared_folder()){return ey("You're not allowed to put an application folder inside a shared folder.")}}}else{if(fl.shared_folders>0){if(fq.is_sandbox()){return ey("You're not allowed to put a shared folder inside an application folder.")}else{if(fq.allows_nesting&&fl.team_shared_folders===0){return}else{if(fq.is_shared_folder()){return ey("You're not allowed to put a shared folder inside another shared folder.")}}}}}return ey("You're not allowed to nest special folders.")}if(cr.public_folder_enabled){if(T==="/Public"&&fl.target_namespaces>0){return ey("You're not allowed to move shared folders to your Public folder.")}}if(fl.public_folder>0){return ey("You're not allowed to move your Public folder.")}if(fl.deleted>0){return ey("Moving deleted folders or files isn\u2019t allowed.")}},do_move:function(T,j){var i;T=T||fa.vars.fq_path;j=j||fa.vars.selected_path;i=cr.find_file(T);cJ(i,"Trying to move a file we couldn't find.");return dB.do_bulk_move([i],j)},do_nonbrowse_move:function(fk,fl,j){var i,T;i=bD.Deferred();T="/cmd/move";new Ajax.DBRequest(T,{parameters:{files:fl,to_path:j},subject_user:fk,job:true,html_in_error_msg:true,progress_text:ey("Moving\u2026"),onSuccess:i.resolve,onFailure:i.reject});return i.promise()},do_bulk_move:function(fk,fm){var j,T,fl,i;cr.pre_action_selection=eV.get_selected_fq_paths();fk=fk||fa.vars.files;if(!fk){return}cJ(fk.length>0,"Tried to move 0 files");i=fm||fa.vars.selected_path||"";i=aA.normalize(i);j=dB.bulk_move_error(fk,i);if(j){ah.error(j);return}T=fk.pluck("fq_path");ah.clear();fl=function(fq){var fp,fo,fn,fr;fp=fq.responseText.evalJSON().changesets;fo=T.length;fn=bS.em_snippet(aA.filename(i),dB.NOTIFICATION_SNIPPET_LEN).escapeHTML();fr=bb('Moved %(count)d item to \u2018<a id="reload-link">%(location)s</a>\u2019.','Moved %(count)d items to \u2018<a id="reload-link">%(location)s</a>\u2019.',fo);fr=fr.format({count:fo,location:fn});X.notifyWithUndo(new ff(fr),fp,dB.do_rollback);$("reload-link").observe("click",function(){return a3.set_path_url(null,i)});b0.schedule_reset();return document.fire(aH.MOVE,{files:fk,to_fq_path:i})};return dB.do_nonbrowse_move(cr.active_user.id,T,i).then(fl)},do_rollback:function(i){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(i)},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:ey("Undoing..."),onSuccess:function(j){var T;T=ey("Undo complete.");ah.success(T);cJ(cr.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(cr.in_search_mode()){b9.select_fq_paths=cr.pre_action_selection;b9.force_reload()}else{cr.select_fq_paths=cr.pre_action_selection;cr.force_reload()}return cr.pre_action_selection=false}})},do_bulk_delete:function(i,fk){var j,T;cr.pre_action_selection=eV.get_selected_fq_paths();fk=fk||fa.vars.files;cJ(fk.length>0,"Tried to delete 0 files");T=(function(){var fm,fl,fn;fn=[];for(fm=0,fl=fk.length;fm<fl;fm++){j=fk[fm];fn.push(j.fq_path)}return fn})();ah.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:T},subject_user:i,job:true,html_in_error_msg:true,progress_text:ey("Deleting..."),onSuccess:function(fl){var fn,fm;fm=fl.responseText.evalJSON();fn=bb("Deleted %d item.","Deleted %d items.",T.length).format(T.length);X.notifyWithUndo(fn,fm.changesets,dB.do_rollback);b0.schedule_reset();return document.fire(aH.DELETE,{files:fk})}})},do_delete:function(i,T){var j;j=cr.find_file(T||fa.vars.fq_path);cJ(j,"Trying to delete a file we couldn't find.");return dB.do_bulk_delete(i,[j])},do_nonbrowse_delete:function(j,T){var i;i=bD.Deferred();new Ajax.DBRequest("/cmd/delete",{parameters:{files:T},subject_user:j,html_in_error_msg:true,onSuccess:function(fk){var fl;fl=bb("Deleted %(file_count)s item","Deleted %(file_count)s items",T.length);fl=fl.format({file_count:T.length});ah.success(fl);document.fire(aH.DELETE,{fq_paths:T});return i.resolve(fk)},onFailure:function(fk){return i.reject(fk)}});return i.promise()},do_nonbrowse_rename:function(T,fk,j){var i;i=bD.Deferred();new Ajax.DBRequest("/cmd/rename"+encodeURIComponent(fk),{parameters:{to_path:j},subject_user:T,html_in_error_msg:true,onSuccess:function(fl){return i.resolve(fl)},onFailure:function(fl){return i.reject(fl)}});return i.promise()},do_purge:function(i){cJ(i,"Trying to purge a file we couldn't find.");return dB.do_bulk_purge([i])},do_bulk_purge:function(j){var i,T;cJ(j.length>0,"Tried to purge 0 files");i=j.collect(function(fk){return fk.fq_path});T=bb("Permanently deleted %d item","Permanently deleted %d items",i.length).format(i.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:i},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:ey("Deleting..."),onSuccess:function(fk){ah.success(T);b0.schedule_reset();return document.fire(aH.PURGE,{files:j})}})},do_bulk_restore:function(T){var j,fk,i;T=T||fa.vars.files;i=fa.vars.user;cJ(T.length>0,"Tried to restore 0 files");j=T.collect(function(fl){return fl.fq_path});fk=bb("Restored %d item","Restored %d items",j.length,{comment:"meaning, successfully restored x files and folders"}).format(j.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:j},subject_user:cr.active_user,job:true,html_in_error_msg:true,progress_text:ey("Restoring..."),onSuccess:function(fl){ah.success(fk);b0.schedule_reset();return document.fire(aH.RESTORE,{files:T})}})},do_folder_restore:function(j,i){var T;T=function(fk){var fm,fl;fm=ey("Restoring '%(folder_name)s'").format({folder_name:aA.filename(j)});fl=fk.responseText;if(fl.startsWith("err:")){fl=fl.substring(4);bD("#async-result").html(fl);ah.error(new ff(fl),60)}else{fm=ey("Restored '%(folder_name)s'").format({folder_name:aA.filename(j)});bD("#status-of-files").text(ey("Restored files"));ah.success(fm,60)}bD("#restore-done-heading").text(fm);bD(".pre-restore").hide();return bD(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[j]},job:true,html_in_error_msg:true,progress_text:ey("Restoring..."),onSuccess:T,onFailure:T,subject_user:i})},do_bulk_download:function(fl){var fm,fk,T,i;fm=new Element("form",{action:G({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(Constants.UID_PARAM_NAME,cr.active_user.id).toString(),method:"post"});for(T=0,i=fl.length;T<i;T++){fk=fl[T];bR.add_vars(fm,{files:fk.fq_path})}bR.add_vars(fm,{parent_path:cr.block_hash_param||"/",w:cr.block_hash});$(document.body).__sert(fm);return fm.submit()},do_bulk_photo_view:function(T,i){var fm,fl,j,fk;if(i==="carousel"||i==="carousel_as_dropbox_photos"){fk={};fk[a8.UID_PARAM_NAME]=cK.get_viewer().personal_user.id;fm=String(G({scheme:"https",authority:fi.WEBSERVER,path:"/app/view_in_timeline",query:fk}))}else{fm=String(G({scheme:"https",authority:fi.WEBSERVER,path:"/photos"}))}fl=new Element("form",{action:fm,method:"post"});bR.add_vars(fl,{t:bu.read(Constants.JS_CSRF_COOKIE),ns_ids:JSON.stringify((function(){var fo,fn,fp;fp=[];for(fo=0,fn=T.length;fo<fn;fo++){j=T[fo];fp.push(j.ns_id)}return fp})()),ns_paths:JSON.stringify((function(){var fo,fn,fp;fp=[];for(fo=0,fn=T.length;fo<fn;fo++){j=T[fo];fp.push(j.ns_path)}return fp})())});$(document.body).__sert(fl);return fl.submit()},build_revisions_uri:function(T,i,j){if(j==null){j={}}j[Constants.UID_PARAM_NAME]=String(i);if(az.getGandalfRule("revision-history-web")){return G({path:"/history"+T}).updateQuery(j)}else{return G({path:"/revisions"+T}).updateQuery(j)}}};var bR,di={}.hasOwnProperty;bR=__CONDITIONAL_JS__.Forms=INLINE_JS.Forms=E.Forms={submitOnlyOnce:function(){var i;i=bR.submitted!==true;bR.submitted=true;return i},disable:function(i){if(i){return setTimeout((function(){return i.disabled=true}),0)}},enable:function(i){if(i){return setTimeout((function(){return i.disabled=false}),0)}},show_button_on_change:function(i,fk){var T,fl,fm,j;T=bD(i);T.hide();if(fk==null){fk=T.closest("form")}fl=fk[0];if(this.next_id==null){this.next_id=0}fm=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[fm]=this.collect_form_vars(fl);T.attr("data-id",fm);fk.data("button-id",fm);j=(function(fn){return function(){var fq,fo,fp;T.hide();fo=fn.collect_form_vars(fl);if(Object.keys(fo).length!==Object.keys(fn.initial_vars[fm]).length){T.show()}fp=[];for(fq in fo){if(fo[fq]!==fn.initial_vars[fm][fq]){fp.push(T.show())}else{fp.push(void 0)}}return fp}})(this);fk.change(j);fk.find("input").filter(":text").on("input",j);return fk.find("textarea").on("input",j)},add_vars:function(T,fk){var fl,i,j;T=$(T);j=[];for(i in fk){if(!di.call(fk,i)){continue}fl=new Element("input",{type:"hidden",name:i});fl.setValue(fk[i]);j.push(T.__sert(fl))}return j},collect_form_vars:function(fn,fm){var fp,fl,fk,j,T,fo;if(fm==null){fm=false}fn=fn||$(document.body);fl=fn.select("input").concat(fn.select("textarea")).concat(fn.select("select"));T={};for(fk=0,j=fl.length;fk<j;fk++){fp=fl[fk];if(fp.name&&fp.name!=="t"){fo=fp.getValue();if(fo||fm){if(typeof fo!=="string"){fo=fo.join(",")}if(T[fp.name]!=null){if(typeof T[fp.name]==="string"){T[fp.name]=[T[fp.name],fo]}else{T[fp.name].push(fo)}}else{T[fp.name]=fo}}}}return T},add_loading:function(T,i){var j;if(T){T=$(T);j=new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});j.addClassName("text-img ajax_submit_loading");if(i==="after"){return bD(T).after(j)}else{return bD(T).before(j)}}},remove_loading:function(i){return bD(".ajax_submit_loading").remove()},ui_form_submit:function(j,i){i=i||j.action;if(j.ajax_submitted){return false}j.ajax_submitted=true;return new bw(bD(j),i,{data:bR.collect_form_vars(j),success:(function(T){return function(fn,fk,fo){var fm,fl;fl=bD(j).data("button-id");if(fl!=null){fm=bD(j).find("*[type='submit'][data-id='"+fl+"']");T.initial_vars[fl]=T.collect_form_vars(j);return fm.hide()}}})(this),complete:(function(T){return function(fl,fk){return j.ajax_submitted=false}})(this)})},ajax_submit_obj:function(fs){var fp,fr,T,fk,j,fl,fn,fo,fm,fq,i;fk=fs.form,i=fs.url,fq=fs.success_callback,T=fs.fail_callback,fp=fs.button,fn=fs.more_vars,fo=fs.position,fl=fs.job,j=fs.html_response,fr=fs.complete_callback,fm=fs.progress_text;return bR.ajax_submit(fk,i,fq,T,fp,fn,fo,fl,j,fr,fm)},ajax_submit:function(fl,T,fv,fk,fs,fq,ft,fm,j,fx,fo){var fw,fr,fu,fp,fn;if(j==null){j=false}if(fl.ajax_submitted){return false}fl.ajax_submitted=true;fn=bD(fl).find(".suggestion-input");for(fr=0,fu=fn.length;fr<fu;fr++){fw=fn[fr];c3.blank(fw.identify())()}if(fs){bR.add_loading(fs,ft)}fp=bR.collect_form_vars(fl);if(fq){Object.extend(fp,fq)}new Ajax.DBRequest(T||fl.action,{noAutonotify:true,parameters:fp,job:fm,progress_text:fo,evalJSON:false,onSuccess:function(i){bR.remove_loading();if(fv&&typeof fv==="function"){return fv(i)}},onFailure:function(fz){var i,fy;if(fz){if(fz.responseText.indexOf("err:")===0){i=fz.responseText.substr(4);if(i.indexOf("{")===0){fy=i.evalJSON(true);bR.fill_errors(fl,fy)}else{if(j){i=new ff(i)}ah.error(i)}}else{ah.error()}bR.remove_loading();if(fk&&typeof fk==="function"){return fk(fz)}}},onComplete:function(fA){var fz,fy,i;i=fl.select(".suggestion-input");for(fz=0,fy=i.length;fz<fy;fz++){fw=i[fz];c3.blur_elm(fw)}fl.ajax_submitted=false;if(fx&&typeof fx==="function"){return fx(fA)}}});return false},clear_errors:function(i){i=i||$(document.body);this.hide_errors(i);return i.select(".error-removable").invoke("remove")},fill_errors:function(fm,fl){var T,fo,j,fk,fn,i;fl=fl||{};fm=fm||$(document.body);bR.clear_errors(fm);for(fn in fl){if(!di.call(fl,fn)){continue}fo=fm.down("[data-error-field-name='"+fn+"']")||fm.down("[name='"+fn+"']");if(fo){T=new Element("br",{"class":"error-removable"});j=new Element("span",{"class":"error-message error-removable"});fk=fl[fn];cJ(fk.message_html||fk.message_text,"Error message must have a message_html or message_text property");if(fk.message_html){j.update(fk.message_html)}else{j.__date(fk.message_text)}bD(fo).before(j);bD(fo).before(T);i=bD(fm).find("input[name='"+fn+"'], textarea[name='"+fn+"']");if(i){i.addClass("input-error")}}}return this.show_errors(fm)},value:function(fl){var fm,fk,T,j,fn;T=$$('input[name="'+fl+'"]');fn=null;for(fm=0,j=T.length;fm<j;fm++){fk=T[fm];fn=$(fk).getValue()||fn}return fn},postRequest:function(T,fk,i){var j;if(fk==null){fk={}}if(i==null){i={}}cJ(T!=null,"postRequest missing action");fk.t=bu.read(Constants.JS_CSRF_COOKIE);j=new Element("form",{action:T,method:"POST"});if(i.target){j.target=i.target}document.body.appendChild(j);bR.add_vars(j,fk);return j.submit()},hide_errors:function(fl){var fn,fk,j,T,fm;fn=this.get_errors(fl);T=[];for(fk=0,j=fn.length;fk<j;fk++){fm=fn[fk];if(fm.down("span.error-message")){T.push(fm.hide())}else{T.push(void 0)}}return T},show_errors:function(fk){var fm,T,j,fl;fm=this.get_errors(fk);for(T=0,j=fm.length;T<j;T++){fl=fm[T];if(fl.down("span.error-message")){fl.show()}}return bD(".sick-input").find("label").css("top","")},get_errors:function(j){var T,i;i=".error-bubble, .error-plain-text";T=j?j.select(i):$$(i);return T}};bD(function(){return bR.show_errors()});var V;V=E.ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(fm,fn){var fk,j,fl,T;if(fn==null){fn=document.body}fl=$(fn).getElementsByClassName("act_as_block");T=[];for(fk=0,j=fl.length;fk<j;fk++){fm=fl[fk];T.push(this.resize(fm))}return T},resize:function(fl){var i,T,fk,j;fl=$(fl);T=fl.up();i=d3.sumStyles(fl,this.elm_list);fk=d3.sumStyles(T,this.parent_list);fl.style.width="1px";j=T.getWidth()-i-fk;if(j>0){return fl.style.width=j+"px"}}};var bd;bd=E.BrowseStyleRows={register_all:function(){var T,j,fk,fl;fk=$$(".bs-row");for(T=0,j=fk.length;T<j;T++){fl=fk[T];this.register(fl)}Event.observe(document,"click",this.kill_current.bind(this));return bD(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(j){var i;j=$(j);j.db_observe("mouseover",this.mouseover.bind(this));j.db_observe("mouseout",this.mouseout.bind(this));i=j.down(".action-button");if(i){return i.db_observe("click",this.click.bind(this))}},mouseover:function(j,i){if(!i.hasClassName("no-hover")){return i.addClassName("hover")}},mouseout:function(j,i){return i.removeClassName("hover")},click:function(fk,j){var i,fl,T;if(fk.target.tagName==="A"){return}fl=j.up(".bs-row");Event.stop(fk);if(fl.hasClassName("selected")){this.kill_current(false);return}bD(document).trigger("dropdown-opened");this.kill_current(false);T=$(fk.target);if(!T.match(".bs-actions-list *")){fl.addClassName("selected")}i=(T.hasClassName("bs-row")?T:T.up(".bs-row"));return i.style.zIndex=9},kill_current:function(fm){var fn,fk,j,fl,T;fl=$$(".bs-row.selected");T=[];for(fk=0,j=fl.length;fk<j;fk++){fn=fl[fk];fn.removeClassName("selected");T.push(fn.style.zIndex="")}return T}};var ek;ek=E.Bubble={make:function(fu,fF,fx,fs,fo){var fl,fv,fC,fk,T,fE,fz,ft,fr,fm,fq,fw,fB,fp,i,fn,j,fD,fA,fy;if(fF==null){fF="left"}fo=fo!=null?fo:{};if(["left","right"].contains(fF)){fx=fx||"middle";cJ(["top","middle","bottom"].contains(fx),"expected tail position ['top', 'middle', 'bottom'], got "+fx)}else{if(["bottom","top"].contains(fF)){fx=fx||"center";cJ(["left","center","right"].contains(fx),"expected tail position ['left', 'center', 'right'], got "+fx)}else{if(!["none"].contains(fF)){cJ(false,"unexpected tail side, got "+fF)}}}fw=new Element("table");if(fo.style==="titled"){fw.addClassName("bluebubble");fB="bluebubble"}else{fw.addClassName("bubble");fB="bubble"}if(fs){fw.style.width=fs+"px"}i=new Element("tbody");fD=new Element("tr");fn=new Element("td");fn.addClassName("tl");fq=new Element("td");fq.addClassName("t");if(fo.style==="titled"){if(fs){fq.style.width=(fs-42)+"px"}}j=new Element("td");j.addClassName("tr");if(fF==="top"){fp=new Element("img",{src:"/static/images/"+fB+"_arrow_top.png"});fp.addClassName("tarrow");if(fo.style==="titled"){fp.addClassName("arrow-"+fx);fv=new Element("div");fv.addClassName("arrow-container");if(fs){fv.style.width=(fs-42)+"px"}fv.__sert(fp);fq.__sert(fv)}else{fq.style.textAlign=fx;fq.__sert(fp)}}fD.__sert(fn);fD.__sert(fq);fD.__sert(j);i.__sert(fD);fA=new Element("tr");ft=new Element("td");ft.addClassName("l");if(fF==="left"){if(fo.style==="titled"){fl=new Element("img",{src:"/static/images/bluebubble_arrow_left-vfl8zzy_-.png"})}else{fl=new Element("img",{src:"/static/images/bubble_arrow-vfl8m7tk-.png"})}fl.addClassName("arrow");ft.__sert(fl);ft.vAlign=fx}fz=new Element("td");fz.addClassName("c");fz.update(fu);fr=new Element("td");fr.addClassName("r");if(fF==="right"){fm=new Element("img",{src:"/static/images/bubble_arrow_right-vflmW3_2s.png"});fm.addClassName("rarrow");fr.__sert(fm);fr.vAlign=fx}fA.__sert(ft);fA.__sert(fz);fA.__sert(fr);i.__sert(fA);fy=new Element("tr");T=new Element("td");T.addClassName("bl");fC=new Element("td");fC.addClassName("b");if(fF==="bottom"){fk=new Element("img",{src:"/static/images/"+fB+"_arrow_bottom.png"});fk.addClassName("barrow");if(fo.style==="titled"){fk.addClassName("arrow-"+fx);fv=new Element("div");fv.addClassName("arrow-container");if(fs){fv.style.width=(fs-42)+"px"}fv.__sert(fk);fC.__sert(fv)}else{fC.style.textAlign=fx;fC.__sert(fk)}}fE=new Element("td");fE.addClassName("br");fy.__sert(T);fy.__sert(fC);fy.__sert(fE);i.__sert(fy);fw.__sert(i);return fw}};var eR;eR=INLINE_JS.FreshDropdown=E.FreshDropdown={show:function(fn,fk,T,j){var fm,fl,fo,i;if(j==null){j=false}bD(document).trigger("dropdownOpened",[1]);fm=bD(fk);if(!T){T=fm[0].offsetHeight+10}this.hide_all();fl=bD(fn).show();i=fl[0].offsetWidth;fo=fm[0].offsetWidth;fl.clonePosition(fm,{setHeight:false,setWidth:false,offsetLeft:-1*(i-fo)+22,offsetTop:T});if(j){fl.width(i)}fm.addClass("pressed");return((function(fp){return function(){return document.observe("click",eR.hide_all)}})(this)).defer()},hide_all:function(T){var j,i;i=bD(".freshdropdown-menu");j=0;i.each(function(){if(bD(this).is(":visible")){return j+=1}});i.hide();bD(document).trigger("dropdownClosed",[j]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",eR.hide_all)}};var ac;ac=E.JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&ac.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=G.parse(window.location.href).fragment}},report:function(){clearInterval(ac.interval);return cJ(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var dM;dM=E.LoginDropdown={init:function(){var i;i=bD("#login-hover-link");if(!(i.length>0)){return}this.login_link=i;return this.register()},register:function(i){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(i){return this.clicking=true},click:function(i){i.preventDefault();if(this.clicking&&i.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}bD(document).trigger("dropdownOpened",[1]);this.down=true;this.login_link.parent().addClass("down");return bD("input[name='login_email']").focus()},unclick:function(j){var i;if(j){i=bD(j.target);if(i[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}if(this.down){bD(document).trigger("dropdownClosed",[1])}this.down=false;return this.login_link.parent().removeClass("down")}};var fa;fa=__CONDITIONAL_JS__.Modal=INLINE_JS.Modal=E.Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(ft,fp,fq,fv,T,fr,fn,fo,fu){var j,fl,fs,i,fk,fm;if(fq==null){fq=false}if(fv==null){fv=false}if(T==null){T=false}if(fr==null){fr=false}if(fn==null){fn=""}if(fo==null){fo=true}if(fu==null){fu=false}if(fa.shown()){fa._cleanup()}T=T||this.width;fl="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(fl).invoke("hide");if(aq.uploading&&!fr){b8(ey("You can't do this while uploading."));return false}cJ(fp,"Missing modal content!");fk=this.vars._prev_scope;this.vars=fq||{};this.vars._prev_scope=fk;$("modal").setStyle({width:T+"px",margin:"0 0 0 "+(Math.floor(-T/2).toString())+"px"});this.vars.extra_class="";if(fn){$("modal").addClassName(fn);this.vars.extra_class=fn}if(!fr){if(aq.num_files()){cA.reset();aq.clear()}i=d3.childElement($("modal-content"),0);if(i&&i!==fp){$("grave-yard").__sert(i)}j=new Element("div");j.update(fp);$("modal-content").__sert(j);if(fp.show){fp.show()}Element.show("modal")}bD("#modal-overlay").off("click");if(fo){bD("#modal-overlay").on("click",function(fw){fa.hide(null,false,true);fw.preventDefault();return fw.stopPropagation()})}else{bD("#modal-overlay").on("click",function(fw){fw.preventDefault();return fw.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:(T+20)+"px",margin:"0 0 0 "+(Math.floor(-T/2-10).toString())+"px"});bD("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(fv){$("modal-content").select("#"+fv.id).first().focus()}else{if(!d3.ie){fs=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(fs){fs.focus()}}}if(!this.track_id){this.track_resizes()}if(ft){if(d3.isElm(ft)){bD("#modal-title").html(ft)}else{bD("#modal-title").text(ft)}bD("#modal-title").show();fm=bD("#modal-title").text();eG("Modal.show:",fm)}else{bD("#modal-title").hide();eG("Modal.show")}V.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=fu;bD("#modal").find("input").filter(":visible:first").focus();if(this.in_viewport()){this.scroll_locked=true;C.scroll_lock_document()}bD(document).trigger("modalOpened",[1]);return false},in_viewport:function(){var T,i,j,fl,fk;T=bD("#modal");i=T.height();fk=T.width();j=C.viewport_dimensions();fl=C.viewport_offset(T);return fl.left>0&&fl.top>0&&fl.left+fk<j.width&&fl.top+i<j.height},fix_position:function(T){var j,i;i=document.viewport.getScrollOffsets().top+this.vertical_offset;j=parseInt($("modal").getStyle("height"),10);if(j+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(j+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:i+"px"});return $("modal-behind").setStyle({position:"absolute",height:(j+20)+"px",top:(i-10)+"px"})}},keydown:function(fk){var fl,i,T,j;T=fk.keyCode||fk.which||fk.charCode;if(T===27||(T===8&&!C.focus_in_input())){fk.preventDefault();this.hide(null,false,true)}if(T===9&&!C.focus_in_input()){i=$("modal").down("input[type=text], input[type=email]");j=$("modal").down(".modal-tabs");fl=j;while(fl&&fl.next()){fl=fl.next();if(fl.visible()){i=fl.down("input[type=text], input[type=email]");break}}if(i){fk.preventDefault();return i.focus()}}},shown:function(){return $("modal").visible()},hide:function(T,i,j){if(T){Event.stop(T)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(j);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!i&&!aq.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(aq.uploading){cZ.show()}}fa._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return eG("Modal.hide")},_cleanup:function(){bD(document).trigger("modalClosed",[1]);if(this.scroll_locked){return C.scroll_unlock_document()}},should_prevent_hide:function(){return this.prevent_hide_if_loading&&bv.some(bD("#modal form"),function(i){return i.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var i;i=$("modal").getHeight();if(this.old_height!==i||$("modal-behind").getHeight()<i){this.old_height=i;return this.fix_position()}},vars:{}};var ch;ch=E.SickInput={init:function(){var fm,fk,j,fl,T;fl=$$(".sick-input");T=[];for(fk=0,j=fl.length;fk<j;fk++){fm=fl[fk];if(!fm.hasClassName("sickified")){T.push(this._create(fm))}}return T},_create:function(fk){var j,T,i;if(fk==null){return}T=fk.identify();i=fk.down("input")||fk.down("textarea")||fk.down("select");i.observe("focus",function(){return fk.addClassName("focused")});i.observe("blur",function(){return fk.removeClassName("focused")});j=function(){if(fk.hasClassName("populated")&&i.getValue()===""){fk.removeClassName("populated")}else{if(!fk.hasClassName("populated")&&i.getValue()!==""){fk.addClassName("populated")}}if(T in ch._handler_map){return ch._handler_map[T]()}};bR.show_errors();j();return setInterval(j,100)},_handler_map:{},add_interval_handler:function(j,i){var T;T=j.identify();return this._handler_map[T]=i},remove_interval_handler:function(j,i){var T;T=j.identify();if(this._handler_map[T]===i){return delete this._handler_map[T]}}};var c3;c3=E.SuggestionInput={register:function(j){var i;j=$(j);i=j.up("form");if(c3.defaulted(j)||j.getValue()===""){j.setValue(j.title)}else{j.addClassName("suggestion-input-unfaded")}j.observe("blur",this.blur.bind(this));j.observe("focus",this.focus.bind(this));j.observe("db:value_change",this.focus.bind(this));if(i){if(!j.id){j.id="r_elm_id_"+(Math.random().toString())}return i.observe("submit",c3.blank(j.id).bind(this))}},register_all:function(){var fl,T,j,fm,fk;fm=$$(".suggestion-input");fk=[];for(fl=0,j=fm.length;fl<j;fl++){T=fm[fl];fk.push(this.register(T))}return fk},blank:function(i){return(function(j){return function(){var T;T=$(i);if(!T){return}if(j.defaulted(T)){return T.setValue("")}}})(this)},defaulted:function(i){i=$(i);return i.getValue()===i.title},do_blank:function(i){return this.blank(i)()},clear:function(i){var j;j={target:i};return this.focus(j)},focus:function(i){var j;j=$(i.target);if(!j){return}if(this.defaulted(j)){j.addClassName("suggestion-input-unfaded");return j.setValue("")}},blur_elm:function(i){if(i.getValue()===""){i.removeClassName("suggestion-input-unfaded");i.setValue(i.title)}return i.blur()},blur:function(i){var j;j=$(i.target);if(!j){return}return this.blur_elm(j)},reset:function(j){var i;i=$(j);if(!i){return}i.removeClassName("suggestion-input-unfaded");i.setValue(i.title);i.defaulted=true;return i.blur()},setValue:function(i,j){var T;T=$(i);if(!T){return}T.addClassName("suggestion-input-unfaded");T.setValue(j);return T.defaulted=false}};var bm;bm=E.TitleBubble=(function(){var T,j,fn,fk,fl,i,fm;fm=0;T=0;i=function(fo){return fm=fo};fl=function(fu){var fz,fx,fr,fv,fq,fo,fw,ft,fp,fs,fy;fv=bD(fu.currentTarget);fy=fv.attr("title");if(fy!=null?fy.length:void 0){fv.attr("data-title",fy);fv.removeAttr("title")}fr=parseInt(fv.data("title-delay"));fx="title-bubble-"+(T++);fv.data("bubble-id",fx);fz=bD("<div/>",{id:fx,"class":"title_bubble_container"});if(!fr){fz.css({opacity:0});fz.addClass("has-transition")}if(fv.hasClass("white")){fz.addClass("white")}if(fv.hasClass("black")){fz.addClass("black")}fz.text(fv.attr("data-title"));fw=fv.attr("data-title-html");fz.html(fw);fp=fv.attr("data-title-hide-tail")!=="yes";if(fp){fs=bD("<div/>",{"class":"tail"});fz.append(fs)}bD(document.body).append(fz);fo=fn(fv[0],fz[0]);fq=j(fo,fz[0],fv[0]);fz.clonePosition(fv,{setWidth:false,setHeight:false,offsetTop:fq.top-fm,offsetLeft:fq.left});fz.addClass("position-"+fo);if(fp){fs.clonePosition(fv,{setWidth:false,setHeight:false,setTop:false,offsetLeft:fq.left+fq.tail_offset_left+(bD(fz).outerWidth()/2)})}ft=function(){var fA;if(!((fz.data("pending-delay"))&&(fv.data("bubble-id")===fx))){return}fA=(parseInt(fv.data("title-fade-time")))||400;return fz.fadeIn(fA)};if(fr){fz.hide();fz.data("pending-delay",true);return setTimeout(ft,fr)}else{return fz.css({opacity:""})}};fn=function(fs,fo){var fr,fq,fp;fs=$(fs);fp=fs.getAttribute("data-title-position");fr=document.viewport.getDimensions();fq=fs.viewportOffset();if(!(fp==="above"||fp==="below"||fp==="right"||fp==="left")){fp="above"}if(fp==="left"){if(fq.left<fo.width){return"right"}}else{if(fp==="right"){if(fr.width-(fq.left+fs.getWidth())<fo.width){return"left"}}else{if(fp==="below"){if(fr.height-(fq.top+fs.getHeight())<fo.height){return"above"}}else{if(fp==="above"){if(fq.top<fo.height){return"below"}}}}}return fp};j=function(fq,fx,ft){var fv,fr,fy,fu,fw,fs,fo,fA,fz,fp;fx=$(fx);ft=$(ft);fy=document.viewport.getDimensions();fv=fx.getDimensions();fu=ft.viewportOffset();fr=6;fw=0;fs=0;fz=0;fp=0;if(fq==="below"||fq==="above"){if(fq==="below"){fs=ft.getHeight()+fr}else{fs=(-1*fv.height)-fr}fo=ft.getWidth()/2-fv.width/2;if(fu.left+fo+fv.width>fy.width){fw=fy.width-fu.left-fv.width;fz=fo-fw-5}else{fw=fo;fz=-5}}if(fq==="left"||fq==="right"){if(fq==="right"){fw=ft.getWidth()+fr}else{fw=(-1*fv.width)-fr}fA=ft.getHeight()/2-fv.height/2;if(fu.top+fA+fv.height>fy.height){fs=fy.height-fu.top-fv.height;fp=fA-fs-5}else{fs=fA;fp=-5}}return{left:fw,top:fs,tail_offset_left:fz,tail_offset_top:fp}};fk=function(fp){var fo,fq,fr;fr=bD(fp!=null?fp.currentTarget:void 0);fo=bD("#"+fr.data("bubble-id"));if(fo.data("pending-delay")){fo.removeData("pending-delay");fq=(parseInt(fr.data("title-fade-time")))||400;return fo.fadeOut(fq,function(){return fo.remove()})}else{return fo.remove()}};return{init:function(){bD(document).on("mouseenter",".title_bubble",fl);bD(document).on("mouseleave",".title_bubble",fk).on("mouseup",".title_bubble",fk);bD(document).on("mouseenter",".title_bubble_sticky",fl);return bD(document).on("mouseleave",".title_bubble_sticky",fk)},set_vertical_space:i,hide_all:function(){return bD(".title_bubble_container").remove()}}})();var eg;eg=INLINE_JS.Tooltip=E.Tooltip={attach:function(fm,T,i,j){var fl,fk;if(j==null){j={}}fm=$(fm);i=(i?$(i):null);fl=ek.make(T,fm.tail_position,j.tail_position,j.width,j);fl.setStyle({display:"none",position:"absolute"});$("floaters").__sert(fl);if(fm.match("#modal-content *")||fm.match(".db-modal-content *")){fl.style.zIndex="13001"}else{fl.style.zIndex=""}if(fm.tail_position==="right"){fk=(d3.ie?32:12);fl.style.marginLeft=-(fl.getWidth()+fm.getWidth()+fk)+"px"}fm.tooltip=fl;fm.out_target=(i?true:false);fm.observe("mouseout",this.mouseout("target",fm));fm.observe("mouseover",this.mouseover("target",fm));fm.out_trigger=(i?false:true);if(i){i.observe("mouseout",this.mouseout("trigger",fm));i.observe("mouseover",this.mouseover("trigger",fm))}fm.out_tooltip=true;fl.observe("mouseout",this.mouseout("tooltip",fm));return fl.observe("mouseover",this.mouseover("tooltip",fm))},update:function(j,i){if(j.tooltip){return $(j.tooltip).update(i)}},mouseover:function(i,j){return function(){return j["out_"+i]=false}},mouseout:function(i,j){return function(){j["out_"+i]=true;return eg.hide_if_out.defer(j)}},show_by:function(j){var T,i;T=bD(j.tooltip);j=bD(j);T.show();i=Math.floor(T[0].offsetHeight/2);return T.clonePosition(j,{setWidth:false,setHeight:false,offsetTop:Math.floor(j[0].offsetHeight/2)-i,offsetLeft:j[0].offsetWidth+1})},hide_if_out:function(i){var j;if(!i.out_target||!i.out_trigger||!i.out_tooltip){return}j=$(i.tooltip);return j.hide()},show:function(fl,fk,j,i,T){if(i==null){i="left"}fl=$(fl);if(!fl.tail_position){fl.tail_position=i}j=(j?$(j):null);if(!fl.tooltip){this.attach(fl,fk,j,T)}return this.show_by(fl)}};var b0;b0=INLINE_JS.TreeView=E.TreeView={tv:{},loaded:false,user:null,role_icon:"",set_params:function(i){return this.ajax_params=i},init:function(T,i,fk){var j;if(fk==null){fk="treeview"}this.tv[fk]={};j=this.tv[fk];j.autohide=(i===null?true:i);j.handler=T;j.viewdiv=$(fk);j.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(bC.ADD,(function(fl){return function(fm){return fl.schedule_reset()}})(this));document.observe(bC.REMOVE,(function(fl){return function(fm){return fl.schedule_reset()}})(this));return document.observe(bC.MOVE,(function(fl){return function(fm){return fl.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(fm){var T,fn,fk,j,fo,i,fl;T={url:"/ajax_subtreeview",type:"post",data:bD.extend({},this.ajax_params),success:(function(fp){return function(fq){var fr,fs;fr=[];for(fs in fp.tv){if(fp.tv.hasOwnProperty(fs)){fp.tv[fs].viewdiv.down(".treeview-folders").update(fq);if(fm&&fm.onSuccess){fr.push(fm.onSuccess(fq))}else{fr.push(void 0)}}else{fr.push(void 0)}}return fr}})(this)};if(fm!=null?fm.user:void 0){if(fm.user.id!==((fn=this.user)!=null?fn.id:void 0)){fo=bD("<p />",{id:"treeview-loading"});i=bD("<img />",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});fo.append(i);fl=" "+ey("Loading your folders");fo.append(fl);bD("#dest-treeview .treeview-folders").html(fo);this.user=fm.user}T.subject_user=fm.user;j=cK.get_role_title(fm.user);if(cK.get_viewer().is_paired){if(fm.user.is_team){fk="s_briefcase"}else{fk="s_house"}}else{fk="dropbox"}if(!j){j=ey("Dropbox")}bD("#first-treeview-link span").text(j);cv.replace(bD("#root-img")[0],"web",this.role_icon,fk);this.role_icon=fk}else{bD("#first-treeview-link span").text(ey("Dropbox"))}return bD.ajax(T)},toggle:function(T,j){var i;Event.stop(T);i=this.tv[j||"treeview"];if(i.shown){i.shown=false;this.hide(T,j)}else{i.shown=true;this.show(T.target,j)}return false},hide:function(T,j){var i;i=this.tv[j||"treeview"];if(!T||!$(T.target).descendantOf(i.viewdiv)){i.viewdiv.hide();Event.stopObserving(window,"click",i.hidefunc);return i.shown=false}},show:function(T,j){var fk,i;i=this.tv[j||"treeview"];T=$(T);T.blur();fk=T.cumulativeOffset();i.viewdiv.setStyle({top:(fk.top+T.getHeight())+"px",left:(fk.left-4)+"px"});i.viewdiv.show();return Event.observe(window,"click",i.hidefunc)},toggleNode:function(j){var i;j=$(j);i=j.down("img");if(i.className.match("bullet_plus")){cv.replace(i,"web","bullet_plus","bullet_minus")}else{cv.replace(i,"web","bullet_minus","bullet_plus")}j.up().next("div").toggle();j.blur();return false},toggleNodeAjax:function(fk,i,j){var T,fl;if(fk.fetched_children){return this.toggleNode(fk)}fk=$(fk);T=fk.down("img");fl=cv._get(T);T.src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif";bD.ajax({url:"/ajax_subtreeview"+i,type:"post",data:bD.extend({},this.ajax_params),subject_user:j,success:(function(fm){return function(fn){var fo;fo=new Element("div",{style:"display: none;"}).update(fn);fk.up().__sert({after:fo});fk.fetched_children=true;cv._set(T,fl);return fm.toggleNode(fk)}})(this),complete:function(){if(/loading/.match(T.src)){return cv._set(T,fl)}}});return false},handle:function(T,j){var fk,i;fk=$H(this.tv).keys();i=$(j).ancestors().find(function(fl){return fk.include(fl.id)});if(!i){return}i=this.tv[i.id];bD(document).trigger("db:treeview_selected",[T]);if(i.handler){i.handler(T,j)}if(i.autohide){this.hide(i.id)}return false},move:function(T,fk,j){var i;i=$(T);if(!this.loaded){this.reset({onSuccess:(function(fl){return function(){fl.loaded=1;return fl.move(T,fk,j)}})(this),user:j!=null?j.user:void 0})}else{if(j&&j.onSuccess){j.onSuccess()}}cJ(i,"Couldn't find tree_id");cJ($(fk),"Couldn't find location_id");$(fk).appendChild(i);return i.show()}};var aR;aR=E.ULSelectMenu=(function(){var fk,fo,T,fp,fq,fl,fn,i,fm,j,fr;fk=function(fs){return fs.removeClassName("shown")};fr=function(fs){return fs.toggleClassName("shown")};fn=function(){return this.removeClassName("hover")};fl=function(){return this.addClassName("hover")};i=function(fx,fw){var fv,ft,fu,fs;fu=[];for(fv=0,ft=fw.length;fv<ft;fv++){fs=fw[fv];fu.push(fx.insert(fs))}return fu};fp=function(fu,fs,ft){i(fu,ft);if(fu.firstChild!==fs){return fu.__sert({top:fs})}};fm=function(ft,fu){var fs;fs="selected";bD(ft).find("."+fs).removeClass(fs);return bD(fu).addClass(fs)};j=function(fv,fx){var fy,fu,fs,fw,ft;fw=fv.select("li");ft=[];for(fu=0,fs=fw.length;fu<fs;fu++){fy=fw[fu];if(fy.getAttribute("data-value")===fx){ft.push(fm(fv,fy))}else{ft.push(void 0)}}return ft};fq=function(fs,fu,ft){return function(fv){if(!fs.hasClassName("selected")){fm(fu,fs);fu.fire("db:change",fs.getAttribute("data-value"));return fk(fu)}else{fp(fu,fs,ft);return fr(fu)}}};fo=function(fu){var fy,fw,fx,fA,fv,ft,fz,fs;fA=fu.select("li");cJ(fA.length,"Empty list of options "+fu.identify());fv=void 0;if(fA.length===1){fu.addClassName("one")}else{for(fw=0,fx=fA.length;fw<fx;fw++){fy=fA[fw];fz=fy.getAttribute("data-value");cJ(fz,fy.identify()+" missing data value");fy.observe("click",fq(fy,fu,fA));fy.observe("mouseenter",fl);fy.observe("mouseleave",fn);if(fy.hasClassName("selected")){fv=fy}}$(document.body).observe("click",function(fB){if($(fB.target).up(".ul_select_menu")===fu){return}return fk(fu)})}if(!fv){fv=fA[0]}fv.addClassName("selected");fs=new Element("span");ft=fv.getDimensions();fs.setStyle({width:ft.width+"px",height:ft.height+"px",position:"relative",display:"inline-block"});return fu.wrap(fs)};T=function(){var fw,fu,fs,fv,ft;fv=$$(".ul_select_menu");ft=[];for(fu=0,fs=fv.length;fu<fs;fu++){fw=fv[fu];ft.push(fo(fw))}return ft};bD(T);return{init:function(fs){return fo(fs)},set_selected_by_value:j}})();var I;I=E.DBCalendar=Class.create({initialize:function(j,i){this.options=i||{};this.container=$(j);cJ(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=d3.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=d3.start_of_day(this.options.first_day||this.today)}this.view_date=d3.start_of_day(this.options.selected_date||this.today);this.selected_date=d3.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(j,i){Event.stop(j);this.view_date.setMonth(i);return this.render()},is_valid_date:function(fk,fm,fl,T,i){var j;fk=parseInt(fk,10);fm=parseInt(fm,10);fl=parseInt(fl,10);T=parseInt(T,10);i=parseInt(i,10);T=T||1970;i=i||(new Date()).getFullYear()+1;fm+=1;if(fl<T){return false}if(fl>i){return false}if(fm<1||fm>12){return false}if(fk<=0){return false}if(fm===2){j=((fl%4)===0)&&(((fl%100)!==0)||((fl%400)===0));if(j){return fk<=29}else{return fk<=28}}else{if(fm===4||fm===6||fm===9||fm===11){return fk<=30}else{return fk<=31}}},change_date:function(i,fk,j){var T;if(!this.is_valid_date(i,fk,j)){return}T=j!==this.view_date.getFullYear()||fk!==this.view_date.getMonth();this.selected_date=new Date(j,fk,i);if(T){this.view_date.setMonth(fk);this.view_date.setFullYear(j);this.render()}else{bD(this.container).find(".selected").removeClass("selected");bD(this.container).find("a#day"+i+"-"+fk).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var fk,fq,fo,fm,fl,j,fn,T,fp,i;fq=this.render_days();fm=bD(".current-month",fq);fn=fm.first().data("date");j=fm.last().data("date");i=fn<=this.options.first_day;fp=j>=this.options.last_day;fk=new Element("div");fk.addClassName("calendar clearfix");if(!fp){this._next_month=(function(fr){return this._change_month(fr,this.view_date.getMonth()+1)}).bind(this);fl=new Element("a");fl.addClassName("changemonth next");fl.update(cv.make("web","arrowright",{}));Event.observe(fl,"click",this._next_month);fk.__sert(fl)}if(!i){this._prev_month=(function(fr){return this._change_month(fr,this.view_date.getMonth()-1)}).bind(this);T=new Element("a");T.addClassName("changemonth prev");T.update(cv.make("web","arrowleft",{}));Event.observe(T,"click",this._prev_month);fk.__sert(T)}fo=new Element("h5");fo.update(ey("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:b4.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));fk.__sert(fo);fk.__sert(fq);return this.container.__date(fk)},render_days:function(){var fq,fm,fp,fk,fn,fo,fr,T,fl;fm=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);T=fm.getDay();fq=new Element("div");fq.addClassName("days");for(fp=fn=fl=T;fl<=0?fn<0:fn>0;fp=fl<=0?++fn:--fn){fr=new Date(fm.getFullYear(),fm.getMonth(),fm.getDate());fr.setDate(fr.getDate()-fp);fq.__sert(this.render_day(fr,true))}fk=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(fk.getMonth()===this.view_date.getMonth()){fq.__sert(this.render_day(fk));fk=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),fk.getDate()+1)}fo=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(fo.getDay()!==6){fo=new Date(fo.getFullYear(),fo.getMonth(),fo.getDate()+1);fq.__sert(this.render_day(fo,true))}return fq},render_day:function(j,fk){var i,T;T=!fk;if(this.options.last_day){fk=fk||j>this.options.last_day}if(this.options.first_day){fk=fk||j<this.options.first_day}i=new Element(fk?"span":"a");bD(i).data("date",j);if(T){i.addClassName("current-month")}i.update(j.getDate());i.addClassName("date");i.writeAttribute("id","day"+j.getDate()+"-"+j.getMonth());if(this.selected_date.getDate()===j.getDate()&&this.selected_date.getMonth()===j.getMonth()&&this.selected_date.getFullYear()===j.getFullYear()){i.addClassName("selected")}if(fk){i.addClassName("inactive")}else{this._handler=(function(fm){var fl;fl=fm.target.identify().substr(3).split("-");return this.change_date(fl[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(i,"click",this._handler)}return i}});var aT;aT=E.DatePickerInput=Class.create({initialize:function(i,T){var fm,fk,fl,j;this.container=i;this.options={};Object.extend(this.options,T||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");j=(this.input.value?d3.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){fl=d3.from_mysql_date(this.container.getAttribute("data-first"))}fm=this.options.disable_future!=null?this.options.disable_future:true;fk=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new I(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:fl,disable_future:fm,disable_past:fk,selected_date:j});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(j)},show_cal:function(j){var i;if(j){Event.stop(j)}i=$(j.target);if(i.match(".cal-container")||i.up(".cal-container")){return}bD(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(i){this.input.value=d3.to_mysql_date(i,false);this.display.update(N.localize(i));return this.hide_cal()}});var fg;fg=E.TextInputDatePicker=Class.create({initialize:function(fk,T){var fm,fl,j,i;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,T||{});this.input=$(fk);cJ(this.input,"Couldn't find the element "+fk.toString());j=new Date();i=(this.input.value?d3.from_mysql_date(this.input.value):false);fl=new Date(j.getUTCFullYear(),j.getUTCMonth(),j.getUTCDate());this.cal_icon=cv.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+fk,style:"display: none; position: absolute; z-index: 1"});this.calendar=new I(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:fl,selected_date:i});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));fm=bD(this.input);bD(this.cal_container).clonePosition(fm,{setWidth:false,setHeight:false,offsetTop:fm[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(i){if(i){Event.stop(i)}return this.cal_container.toggle()},hide_cal:function(i){if(i){Event.stop(i)}return this.cal_container.hide()},onDateChange:function(i){if(this.options.choose_eod){i.setTime(d3.start_of_day(i).getTime()+86399999)}this.input.value=d3.to_mysql_date(i,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});an.window_load(V.register.bind(V));bD(ch.init.bind(ch));bD(c3.register_all.bind(c3));Event.observe(window,"scroll",function(){return bm.hide_all()});bD(function(){ac.interval=setInterval(ac.check.bind(ac),500);dM.init();return bm.init()});var be,fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty;be=INLINE_JS.ChangeNameModal=E.ChangeNameModal=(function(i){fb(j,i);function j(){j.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(T){return function(fn){var fm,fk,fl;fn.preventDefault();fm=bD(fn.target);fk=fm.closest("form");fl=function(){T.hide();return location.reload()};return bR.ajax_submit(fk[0],false,fl,null,fm[0])}})(this)}return j})(d5);var bU,eq,b1=function(i,j){return function(){return i.apply(j,arguments)}},fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty;eq=E.ManageAliasModal=(function(j){fb(i,j);function i(T){this.options=T;this._poll_until_verified=b1(this._poll_until_verified,this);this._get_params_from_target=b1(this._get_params_from_target,this);this._on_load=b1(this._on_load,this);this._show_action_panel=b1(this._show_action_panel,this);this._input_enter_handler=b1(this._input_enter_handler,this);this.resend_verify=b1(this.resend_verify,this);this.remove_alias=b1(this.remove_alias,this);this.add_alias=b1(this.add_alias,this);this.refresh_alias=b1(this.refresh_alias,this);this.on_show=b1(this.on_show,this);i.__super__.constructor.call(this,this.options)}i.prototype.before_show=function(T){i.__super__.before_show.call(this,T);this.polling=0;T.find(".alias-action").on("click",this._show_action_panel);T.find(".alias-action-submit").on("click",this.add_alias);T.find("form").submit(function(){return false});return T.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};i.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};i.prototype.refresh_alias=function(fk,T){if(fk==null){fk=true}if(fk){bR.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(fl){return function(fm){fl.$modal_window.find(".dynamic-content").html(fm.responseText);fl._on_load(fm);if(typeof T==="function"){return T()}}})(this),onFailure:(function(fl){return function(fm){return fl.hide()}})(this)})};i.prototype.add_alias=function(fm){var fl,T,fk,fn;fm.preventDefault();T=bD(fm.currentTarget).closest("form");fl=T.find(".alias-action-submit");fn={};fn[Constants.UID_PARAM_NAME]=this.options.subject_user.id;fk=(function(fo){return function(){var fp;fo.$modal_window.find(".alias-action-inputs input").val("");fo.polling=0;fp=fo.polling?null:fo._poll_until_verified;return fo.refresh_alias(true,fp)}})(this);return bR.ajax_submit(T[0],false,fk,false,fl[0],fn,"before")};i.prototype.remove_alias=function(T){var fk;T.preventDefault();fk=this._get_params_from_target(T.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:fk,onSuccess:(function(fl){return function(fm){return fl.refresh_alias()}})(this)})};i.prototype.resend_verify=function(T){var fk;T.preventDefault();fk=this._get_params_from_target(T.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:fk,onSuccess:(function(fl){return function(fm){return fl.refresh_alias()}})(this)})};i.prototype._input_enter_handler=function(T){T.preventDefault();T.stopPropagation();if(T.which===13){return this.add_alias(T)}};i.prototype._show_action_panel=function(fl){var fk,T;fl.preventDefault();T=bD(fl.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();fk=this.$modal_window.find("#"+T).show();return fk.find("input:visible:enabled:first").focus()};i.prototype._on_load=function(T){bd.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(fk){return function(fl){return fk.remove_alias(fl)}})(this));return this.$dynamic.on("click",".alias-verify",(function(fk){return function(fl){return fk.resend_verify(fl)}})(this))};i.prototype._get_params_from_target=function(fl){var T,fk,fm;T=bD(fl);fm=T.data("alias-type");fk=T.closest(".alias-row").find(".alias-text").text();return{alias:fk,alias_type:fm}};i.prototype._poll_until_verified=function(){var fl,fm,fk,T;fm=5;fl=60;fk=(function(fn){return function(){return fn.refresh_alias(false,fn._poll_until_verified)}})(this);T=this.$dynamic.find(".alias-verify").length;if(T&&this.polling<fl){this.polling++;return setTimeout(fk,fm*1000)}else{return this.polling=0}};return i})(d5);bU=INLINE_JS.AliasManager=E.AliasManager={show:function(fl){var T,fk,j,i;i=cK.get_viewer().get_user_by_role(fl);if(i==null){return}if(!i.is_email_verified){if(fl===Constants.ROLE_PERSONAL){personal_email_verification.verified_or_show()}else{work_email_verification.verified_or_show()}return}j=cK.get_viewer().is_paired?fl:"";fk=ey("Manage your %(role_show)s contact methods").format({role_show:j});T=new eq({element_id:"manage-alias",title:fk,subject_user:i,role:i.role});T.show()}};var dw;dw=INLINE_JS.BonusTable=E.BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(i){this.user_id=i;if(dw._inited){return}dw._inited=true;$("bonus-loading").show();dw._tmpl=ff.tmpl("bonus_row_tmpl");dw.listen();return dw.get_next_page()},_render:function(fl){var fk,T,j,fm;fk=[];for(T=0,j=fl.length;T<j;T++){fm=fl[T];fk.push(dw._tmpl({row:fm,Sprite:cv}))}return $("bonus-table").__sert(fk)},get_next_page:function(){if(dw._fetching_page){return}dw._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+dw._next_page,{onSuccess:function(j){var fk,i,T;fk=j.responseText.evalJSON();T=fk.rows;i=fk.has_more;dw._render(T);$("bonus-loading").hide();if(i){dw._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return dw._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(j){var i,fk,T;fk=bD(j.currentTarget);T=ey("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");i=bD(ek.make(T,"right","middle"));Element.absolutize(i[0]);fk.append(i);i.clonePosition(fk,{setWidth:false,setHeight:false});return i.css({width:"200px",left:(parseInt(i.css("left"),10)-210)+"px",top:(parseInt(i.css("top"),10)-55)+"px"})},_max_referral_out:function(fn){var T,fl,j,fm,fk;fm=bD(".reached-max-referral-bonus .bubble");fk=[];for(fl=0,j=fm.length;fl<j;fl++){T=fm[fl];fk.push(T.remove())}return fk},listen:function(){bD("#load-more-bonus").on("click",dw.get_next_page.bind(dw));bD(document).on("mouseenter",".reached-max-referral-bonus",dw._max_referral_over);return bD(document).on("mouseleave",".reached-max-referral-bonus",dw._max_referral_out)},toggle:function(){if(bD("#bonus-list").is(":visible")){this.hide();return bD("#space-earned-link").text(ey("View all space earned"))}else{this.show();return bD("#space-earned-link").text(ey("Hide space earned"))}},show:function(){return bD("#bonus-list").slideDown(150)},hide:function(){return bD("#bonus-list").slideUp(150)}};var D,v,c;D=INLINE_JS.DowngradeReasons=E.DowngradeReasons={reasons:{},addReason:function(i){return this.reasons[i]=true},addReasons:function(T){var fm,fk,j,fl;fl=[];for(fm=0,j=T.length;fm<j;fm++){fk=T[fm];fl.push(this.addReason(fk))}return fl},change:function(fm,T,j){var fn,fp,fo,fk,fl,i;fm=parseInt(fm,10);fp=$(T);cJ(fp,"Couldn't find container for DowngradeReason");fn=false;fl=this.reasons;for(fk in fl){fo=fl[fk];i=$(j+fk);cJ(i,"Couldn't find container for ",j+fk);if(fo&&parseInt(fk,10)===fm){i.show();fn=true}else{i.hide()}}if(fn){return fp.show()}else{return fp.hide()}}};v=E.DowngradeReasons2={init:function(){var fk,j,T,fl;fl=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(fk=0,j=fl.length;fk<j;fk++){T=fl[fk];bD(T).change(function(fm){var i;i=fm.target.id.indexOf("other")>=0;return v.change(i,fm.target.getValue())})}return bD(".shared-additional-info").attr("name","shared_additional_info")},change:function(T,i){var j;bD(".downgrade-other-reason .error-message").hide();if(T){return}j="#downgrade-info-"+i;bD(".downgrade-info").hide();bD(j).show();bD(".downgrade-info textarea").removeAttr("name");bD(j+" textarea").attr("name","additional_info");return bD("input[name=other_reason_id]").removeAttr("checked")}};c=E.DowngradeSurvey={init:function(){var i;i="#downgrade-survey-form";return bD(""+i).on("submit",(function(j){return function(fl){var fk,T;T=bD(i+" input[name=other_reason_id]:checked").length;fk=bD(i+" input[id=downgrade-radio-8]");if(fk.is(":checked")&&T===0){bD(".downgrade-other-reason .error-message").show();return fl.preventDefault()}}})(this))}};var ca;ca=INLINE_JS.GetSpace=E.GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(T,j,fk){var i;ca._current_space=T;ca._why_msg=j;ca._twitter_url=fk;$("space-actions").on("click",".space-action",ca.perform_action);i=G.parse(window.location.href).fragment;if(i){return ca.highlight_offer(i)}},highlight_offer:function(j){var i,T;i=bD("#"+j);T=i.css("background-color");return i.css("background-color",ca.offer_highlight_color).delay(2000).animate({"background-color":T}).queue(function(){return i.css("background-color","")})},perform_action:function(j){var T,i;i={contact_sales:ca._contact_sales,contact_support:ca._contact_support,teams:ca._teams,upgrade:ca._upgrade,plans:ca._plans,refer:ca._refer,get_started:ca._get_started,fb_link:ca._fb_link,twitter_link:ca._twitter_link,twitter_follow:ca._twitter_follow,why_like:ca._why_like,mailbox_link:ca._mailbox_link};T=$(j.target);if(!T.hasClassName("space-action")){T=T.up(".space-action")}return i[T.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return eo.do_auth(function(){ca._refresh_link_bonuses();return ca._completed($("fb_link"))},cK.get_viewer().personal_user.id)},_twitter_link:function(){return cE.do_auth(function(){ca._refresh_link_bonuses();cE.set_is_authed(cK.get_viewer().personal_user.id,true);return ca._completed($("twitter_link"))},cK.get_viewer().personal_user.id)},_twitter_follow:function(){if(cE.is_authed(cK.get_viewer().personal_user.id)){return ca.follow_dropbox()}else{return cE.do_auth(ca.follow_dropbox,cK.get_viewer().personal_user.id)}},_why_like:function(){fa.show(ey("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return d3._track_twitter_chars_left("why-i-like-input",90)},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!cE.is_authed(cK.get_viewer().personal_user.id)){ca._refresh_link_bonuses();cE.set_is_authed(cK.get_viewer().personal_user.id,true)}return cE.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(ey("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(ey("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){ca._completed($("twitter_link"))}return ca._completed($("twitter_follow"))}},cK.get_viewer().personal_user.id)},submit_why:function(){ca._why_msg=$F("why-i-like-input");return bR.ajax_submit($("why-i-like-form"),false,(function(){fa.hide();return ca._completed($("why_like"))}),false,$("why-i-like-submit"))},_completed:function(j){var i;j.addClassName("completed");j.down(".icon-col").__date(Element("img",{src:"/static/images/check_36-vflimxFPn.png"}));bD(j).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return bD(j).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);i=parseInt(j.down(".space").readAttribute("data-space"),10);ca._current_space+=i;$("current-space").__date(aF.format_bytes(ca._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var bx;bx=E.Help={toggle_more_help:false,show_os:function(j,T,i){T=$(T);$$(".os-filter").invoke("removeClassName","selected");T.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+i).invoke("show");return Event.stop(j)},vote:function(i,j){new Ajax.DBRequest("/help/"+i+"/vote/"+j);bD("#help-vote-cont").fadeOut();return ah.success(ey("Thanks for your feedback!"))}};var et,dT,ag,u,b1=function(i,j){return function(){return i.apply(j,arguments)}},fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty;dT=INLINE_JS.Hosts=E.Hosts={attach_host_listener:function(fl,T){var j,fk,fm,i;j=bD("#"+fl);fm=j.data("host-ids");fk=j.data("display-name");i=function(){return new ag(fm,fk,T,null,null).show()};bD(".unlink-host-link",j).on("click",i);return j.on("dblclick",(function(){return dT.edit(fm,fl)}))},edit:function(fn,fk){var T,fo,fp,fm,fl,j;fp=bD("#"+fk+" .host-item .sprite-text");if(fp.data("editing")==="true"){return false}fp.data("editing","true");fo=fp.text();fp.data("previous",fo);fn=bv.values(fn);fm=bD('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" />').val(fo);j=bD('<input type="button" class="button">').val(ey("Save"));j.on("click",function(){return dT.doneEditing(fn,fk)});T=bD('<input type="button" class="button grayed">').val(ey("Cancel"));T.on("click",function(){return dT.cancelEditing(fk)});fp.empty();fp.append(fm,"&nbsp;",j,"&nbsp;",T);fl=bD("input",fp);fl.on("keydown",function(){return dT.checkKey(fn,fk)});fl.focus();return false},doneEditing:function(T,j){var fk,i;fk=bD("#"+j+" .host-item .sprite-text");i=bD("input",fk).val();return bD.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(T),name:i},type:"POST"}).success(function(fl){return dT.unedit(fk,JSON.parse(fl).display_name)})},cancelEditing:function(i){var j;j=bD("#"+i+" .host-item .sprite-text");return dT.unedit(j,j.data("previous"))},unedit:function(j,i){j.data("editing","false");return j.text(i)},dismiss:function(T,j,fk,i,fl){new bD.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:T,user_id:j,team_id:fk},subject_user:fl,success:function(fm){return i.remove()}});return false},checkKey:function(j,i){return function(T){T=T||window.event;if(T.keyCode===Event.KEY_RETURN){dT.doneEditing(j,i)}if(T.keyCode===Event.KEY_ESC){return dT.cancelEditing(i)}}},show_device_unlink_modal:function(j,T,i,fo,fl,fk){var fn,fm;fn=bD("#unlink-device-modal-"+fl);fm={both:bv.values(fo),personal:[fo[Constants.ROLE_PERSONAL]],work:[fo[Constants.ROLE_WORK]]};fa.show(i,fn[0]);if(bv.values(fo).length>1){fn.addClass("show-selector")}return bD("form input[type=submit]",fn).on("click",function(fp){fp.preventDefault();fo=fm[bD(".unlink-select select",fn).val()];bR.add_vars(bD("form",fn)[0],{user_ids:JSON.stringify(fo),app_id:T,device_id:JSON.stringify(j),device_name:fk});return bD("form",fn).submit()})}};et=E.DeleteFailuresModal=(function(i){fb(j,i);function j(){this.on_show=b1(this.on_show,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(T){T.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};j.prototype.on_show=function(fk){var T;T=bb("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(T)};return j})(d5);u=INLINE_JS.show_delete_failures_modal=E.show_delete_failures_modal=function(T,j,i){var fk;fk=new et({element_id:"delete-failures-modal"});fk.host_id=T;fk.name=j;fk.num_failures=i;fk.show();return false};ag=INLINE_JS.UnlinkHostModal=E.UnlinkHostModal=(function(j){fb(i,j);function i(T,fn,fl,fk,fm){this.host_ids=T;this.name=fn;this.delete_support_type=fl;this.owner_id=fk;this.team_id=fm;this.on_show=b1(this.on_show,this);this._set_delete_text=b1(this._set_delete_text,this);this.fail_callback=b1(this.fail_callback,this);this.success_callback=b1(this.success_callback,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);i.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=bv(this.host_ids).values().length>1}i.prototype.on_confirm_button_click=function(fm){var fk,fl,T;fm.preventDefault();fl=this.$modal_window.find(".unlink_host_form")[0];fk=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");T={host_ids:JSON.stringify(this.get_selected_hosts())};return bR.ajax_submit(fl,false,this.success_callback,this.fail_callback,fk,T)};i.prototype.success_callback=function(){return window.location.reload()};i.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};i.prototype._set_delete_text=function(T){return this.$modal_window.find(".delete_data_label").text(T)};i.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};i.prototype._clear_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",false)};i.prototype.on_show=function(fk){var T;this._clear_delete_checkbox();if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this.$modal_window.find(".unlink-choice").change((function(fl){return function(fm){if(fl._get_unlink_select()===Constants.ROLE_PERSONAL){return fl.$modal_window.find(".new_client").hide()}else{return fl.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(ey("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cK.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this.$modal_window.find(".unlink-choice").change((function(fl){return function(fm){if(fl._get_unlink_select()===Constants.ROLE_WORK){return fl.$modal_window.find(".new_client").hide()}else{return fl.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(ey("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_text(ey("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(fl){return function(fm){if(fl._get_unlink_select()===Constants.ROLE_PERSONAL){return fl._set_delete_text(ey("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(fl._get_unlink_select()===Constants.ROLE_WORK){return fl._set_delete_text(ey("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cK.get_viewer().team_name}))}else{return fl._set_delete_text(ey("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){T="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(ey("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:T}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};i.prototype.get_selected_hosts=function(){var T;if(bv.values(this.host_ids).length===1){return bv.values(this.host_ids)}T=bD(".unlink-choice").val();if(T==="both"){return bv.values(this.host_ids)}else{return[this.host_ids[T]]}};return i})(d5);var eJ;eJ=E.News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(j,T){var i;if(T.hasAttribute("data-div")){j.preventDefault();i=T.readAttribute("data-div");return eB.push_state("/news/"+i)}});return eB.add_callback("/news",eJ.history_change)},change_tab:function(i){var j;j=$$("#nav a[data-div="+i+"]").first();if($(j)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(j).addClassName("selected");return $(i).addClassName("selected")}},history_change:function(i){i=i||eJ.DEFAULT_TAB;return eJ.change_tab(i)}};var dF;dF=E.Recover={init:function(){var i;i=$("recover-form");return i.observe("submit",this.form_submit.bind(this))},form_submit:function(i){this.clear_error();i.preventDefault();return bR.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(j){var i;i=JSON.parse(j.responseText);if(i.status==="error"){this.show_error(i.msg)}if(i.status==="ok"){this.show_hosts(i)}if(i.status==="redirect"){return window.location.href=i.url}},show_hosts:function(fp){var fo,fl,fk,fm,T,j,fn;bR.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(fp.filename);fl=$("trusted-hosts");fl.update();fn=fp.hosts;for(fk=0,T=fn.length;fk<T;fk++){fo=fn[fk];j=new Element("li");fm="lnx";if(fo.platform==="mac"){fm="osx"}if(fo.platform==="win"){fm="win"}j.__sert(cv.make("web",fm));j.__sert(new ff(fo.display_name.escapeHTML()));fl.appendChild(j)}$("login-step").hide();return $("hosts-step").show()},show_error:function(i){$("error-messages").update(i);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var dn;dn=E.Restore={next:function(i,fk){var T,j;j=bD("ul.selected");T=j.next("ul");T.addClass("selected");j.removeClass("selected");if(T.next("ul").length){bD("#next-page").show()}else{bD("#next-page").hide()}bD("#prev-page").show();return dn.inc_page(1)},prev:function(i,fk){var T,j;j=bD("ul.selected");T=j.prev("ul");T.addClass("selected");j.removeClass("selected");if(T.prev("ul").length){bD("#prev-page").show()}else{bD("#prev-page").hide()}bD("#next-page").show();return dn.inc_page(-1)},inc_page:function(T){var j,i;j=parseInt(bD("#page_num").text(),10);i=j+T;return bD("#page_num").text(i)},init:function(fk,i,j){var T;T=cK.get_viewer().get_user_by_id(j);bD("#next-page").on("click",function(fl){dn.next(fl);return false});bD("#prev-page").on("click",function(fl){dn.prev(fl);return false});bD("#restore-submit-button").on("click",function(fl){dB.do_folder_restore(fk,T);return false});bD("#restore-cancel-button").on("click",function(fl){return bZ.redirect(i)});return bD("#restore-back-button").on("click",function(fl){return bZ.redirect(i)})}};var ce,dx,cG,aS,b1=function(i,j){return function(){return i.apply(j,arguments)}},fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty;ce=E.SelectRoleModal=(function(i){fb(j,i);function j(){this.on_show=b1(this.on_show,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=null;j.prototype.on_show=function(){return bD(".role-options li").click((function(T){return function(fl){var fk,fm;fk=bD(fl.target).closest("li");fm=fk.data("role");cJ(T.on_select_role,"missing on_select_role implementation");T.on_select_role(fm);return T.hide()}})(this))};return j})(d5);cG=E.SharedFolderSelectRoleModal=(function(i){fb(j,i);function j(){return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(fk){var T;T=function(){bX.role_picker.ensure_role_is_visible(fk);return s.start_wizard_for_user(cK.get_viewer().get_user_by_role(fk))};if(fk===bM.logged_out_role){return bM.show_modal({role:fk,on_success:T})}else{return T()}};return j})(ce);aS=E.ShmodelC2DSelectRoleModal=(function(i){fb(j,i);function j(){return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(fk){var T;T=function(){return am.show_c2d_modal(fk)};if(!cK.get_viewer().is_role_signed_in(fk)){return bM.show_modal({role:fk,on_success:T})}else{return T()}};return j})(ce);dx=E.ShareShmodelSelectRoleModal=(function(i){fb(j,i);function j(){this.on_select_role=b1(this.on_select_role,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_select_role=function(T){return am.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,T)};return j})(ce);var cO;cO=E.TabController=Class.create({initialize:function(T,j){var i;i=$(T);cJ(i,T+" is missing.");this.container=i;this.options={killEvent:true};Object.extend(this.options,j);return this.listen()},listen:function(){var fn,fk,j,fm,T,fl;fl=this;fm=this.container.select("a");T=[];for(fk=0,j=fm.length;fk<j;fk++){fn=fm[fk];cJ(fn.id&&fn.id.length>0,"Element is missing an id");T.push(fn.observe("click",(function(i){return this.click(i)}).bindAsEventListener(fl)))}return T},click:function(i){if(this.options.killEvent){Event.stop(i)}return this.toggle($(i.target))},toggle:function(j){var fl,i,fk,fm,T;T=this.container.down("a.selected");if(T){fm=$(T.id+"-content");if(fm){fm.hide()}}this.container.select(".selected").invoke("removeClassName","selected");i=false;if(!j){j=this.container.down("a");i=true}j.addClassName("selected");fl=$(j.id+"-content");if(fl){fl.show()}if(this.options.onTabChange){this.options.onTabChange(j,T)}if(this.options.url_prefix){fk=this.options.url_prefix;if(!i){fk+="/"+j.id}return eB.push_state(fk)}}});var dO;dO=E.InviteForm={initialized:false,init:function(){if(this.initialized){return}return bD((function(i){return function(){i.add_auto_completer=new Autocompleter.ContactsTokenizer(cK.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(j){return j.excludeTeamMembers().excludeFacebook().excludeNewStyleGroups().excludeMe()}});i.add_auto_completer.clearTokens();i.tokenAdd=bD.proxy(i._tokenAdd,i);i.tokenRemove=bD.proxy(i._tokenRemove,i);bD("#team-invite-new-collab-input")[0].on("token:add",i.tokenAdd);bD("#team-invite-new-collab-input")[0].on("token:remove",i.tokenRemove);i.reset_licenses();i.update_free_licenses_message();i.initialized=true;i.setup_tab_support(bD);return ch.init()}})(this))},set_emails:function(i){if(i==null){return}return bD((function(j){return function(){var fk,fn,fm,T,fl;j.init();fl=[];for(fm=0,T=i.length;fm<T;fm++){fk=i[fm];fn=j.add_auto_completer.createTokenInfo(null,fk,W.EMAIL);fl.push(j.add_auto_completer.addContact(fn))}return fl}})(this))},rebind_modal_submit_autocompleter:function(){var i,j;i=this.invite_modal.$modal_window;j=i.find(".tokenizer-submit-button");j.on("mousedown",(function(T){return function(){return T.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(i)},setup_tab_support:function(i){return i.find("#team-invite-new-collab-input").first().on("keyup change",function(){var j;j=i.find(".new-collab-input").first();if(j.val()!==""){return j.attr("tabindex",-1)}else{return j.removeAttr("tabindex")}})},reset_modal_licenses:function(){var T,j,i;i=__CIRCULAR_DEPENDENCY__.Dashboard!=null?__CIRCULAR_DEPENDENCY__.Dashboard.get_licensed_members():__CIRCULAR_DEPENDENCY__.MembersReact!=null?__CIRCULAR_DEPENDENCY__.MembersReact.get_licensed_members():window.active_team_member_table.get_licensed_members();this.total_licenses=(T=(j=__CIRCULAR_DEPENDENCY__.MembersReact)!=null?typeof j.get_total_licenses==="function"?j.get_total_licenses():void 0:void 0)!=null?T:this.total_licenses;this.update_used_licenses(i);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(i){this.available_licenses--;bD(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(i){this.available_licenses++;bD(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(j){var fk,T,i;if(window.active_team_member_table){fk=window.active_team_member_table.data.users;for(i in fk){T=fk[i];if(T.email===j){return true}}}},update_license_count:function(){var i,j;i=bD("#license-count-message");if(this.available_licenses<0){j=ey("You need more licenses for this invitation.");i.addClass("over")}else{if(this.available_licenses===0){j=ey("You have no remaining licenses.");i.removeClass("over")}else{if(this.available_licenses>0){j=bb("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});i.removeClass("over")}else{j="You have \u00a0 remaining licenses."}}}return i.text(j)},init_modal_licenses:function(T,j,i){if(!this.invite_modal){this.invite_modal=new w(i)}this.total_licenses=T;this.is_trial=j;return bD("body").trigger("invite-modal-initialized")},update_used_licenses:function(i){this.used_licenses=i;return this.reset_licenses()},init_form_licenses:function(T,i,j){this.total_licenses=T;this.used_licenses=i;this.is_trial=j;return dO.reset_licenses()},add_total_licenses:function(i){i=i||0;if(i>0){this.total_licenses+=i;this.available_licenses+=i;this.update_license_count();if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){return __CIRCULAR_DEPENDENCY__.Dashboard.add_licenses(i)}}},on_add_licenses_exit:function(T,i){var j;if((j=this.invite_modal)!=null?j.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(i)},reset_modal:function(){var i;i=this.invite_modal.$modal_window;c3.reset(i.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens();this.add_auto_completer.update.hide()}this.reset_modal_licenses();return i.find(".new-collab-input").val("")},on_add_licenses_click:function(j){var i;j.preventDefault();if(this.is_trial){if((i=this.invite_modal)!=null){i.hide()}return __CIRCULAR_DEPENDENCY__.add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){dY.unregister(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=bD.proxy(this.on_add_licenses_exit,this);dY.register(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return dY.push(new __CIRCULAR_DEPENDENCY__.AddLicensesModal())}},update_free_licenses_message:function(){var i;i=this.invite_as_limited();bD(".team-invite-add-licenses").toggle(!i);bD("#license-count-message").toggle(!i);return bD("#license-free-message").toggle(i)},invite_as_limited:function(){var i;i=bD('input[name="membership_type"]');return i&&i.is(":checked")}};var w,b1=function(i,j){return function(){return i.apply(j,arguments)}},fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty;w=E.InviteModal=(function(j){fb(i,j);function i(T){this.transition_view_model=T;this._reset=b1(this._reset,this);this._update_form_pricing_information=b1(this._update_form_pricing_information,this);this._update_remaining_licenses_message=b1(this._update_remaining_licenses_message,this);this._make_transition_info_request=b1(this._make_transition_info_request,this);this._handle_token_change=b1(this._handle_token_change,this);this._licenses_total=b1(this._licenses_total,this);this.is_making_transition_info_request=b1(this.is_making_transition_info_request,this);this.on_hide=b1(this.on_hide,this);this.on_show=b1(this.on_show,this);i.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input",title:ey("Invite team members")});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new fe([this.transition_view_model]);this.probability=Math.random()}this.skip_reset=false;this.making_transition_info_request=false;this.transition_info_callback=null}i.prototype.on_confirm_button_click=function(fk){var T;if(dO.invite_as_limited()){T=0}else{T=this.add_qty}return dS.add_users(fk,T)};i.prototype.on_show=function(){var fk,T;this._reset();T=bD('input[name="membership_type"]');if(T!=null){T.attr("checked",false)}if(T!=null){T.click((function(fl){return function(){dO.update_free_licenses_message();return fl._updated_charges_messages(dO.invite_as_limited())}})(this))}fk=bD("#team-invite-wizard .team-invite-add-licenses");fk.on("click",bD.proxy(dO.on_add_licenses_click,dO));bD(window).on("token:changed",this._handle_token_change);if(dO.initialized){dO.update_license_count();dO.update_free_licenses_message()}return dY.register(dY.CLEAR,function(){return dO.reset_modal()})};i.prototype.on_hide=function(){return bD(window).off("token:changed",this._handle_token_change)};i.prototype.is_making_transition_info_request=function(){return this.making_transition_info_request};i.prototype._licenses_to_add=function(){return -1*dO.available_licenses};i.prototype._licenses_total=function(){return dO.total_licenses+this._licenses_to_add()};i.prototype._getInvitesCount=function(){return dO.total_licenses-dO.used_licenses-dO.available_licenses};i.prototype._handle_token_change=function(fk,T){this._updateConfirmButton();this._update_remaining_licenses_message(T.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(fl){return function(){fl._make_transition_info_request();return fl.fetch_transition_timeout_id=null}})(this),100)}};i.prototype._make_transition_info_request=function(){var fl,fk,T,fm;this.making_transition_info_request=true;fk=Math.floor(Math.random()*1000000);this.current_callback_token=fk;fl=this._licenses_to_add();T=this._licenses_total();fm=(function(fn){return function(fo){return fn._update_form_pricing_information(fk,fl,T,fo!=null?fo[0]:void 0)}})(this);if(fl>0){return this.transition_info_fetcher.get(fm,{total_users:this._licenses_total()})}else{return fm(null)}};i.prototype._update_remaining_licenses_message=function(T){var fk;this.remaining_licenses=T;fk=this._get_remaining_licenses_message(this.remaining_licenses);return this.$modal_window.find("#license-count-message").text(fk)};i.prototype._get_remaining_licenses_message=function(T){var fk;if(T<0){fk=ey("You need more licenses for this invitation.")}else{if(T===0){fk=ey("After this invitation, you'll have no remaining licenses.")}else{fk=bb("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",T).format({count:T})}}return fk};i.prototype._update_form_pricing_information=function(fm,fn,T,fq){var fk,fp,fo,fl;if(fm!==this.current_callback_token){return}if(fq&&fn>0){this.add_qty=fn;fk=this.transition_view_model.state.currency;fo=fq.current_total.amount;fp=fd.formatCurrency(fo,fk);fl=fd.formatCurrency(fq.recurring_total.amount,fk);bD(".new-amount").text(fp);bD(".add-qty").text(fn);bD(".recurring-amount").text(fl);bD(".total-qty").text(T);bD("#expected_price").val(fo);this._updated_charges_messages(dO.invite_as_limited())}else{this._reset()}return this.making_transition_info_request=false};i.prototype._updateConfirmButton=function(){var T;T=bb("Send invite","Send invites",this._getInvitesCount());return bD(".team-invite-buttons .confirm-button").val(T)};i.prototype._reset=function(){this.add_qty=0;bD(".charges-section").hide();bD("#expected_price").val(0);return this._updateConfirmButton()};i.prototype._updated_charges_messages=function(T){if(this.inline_add_license&&this.add_qty>0&&!T){bD(".charges-section").show();return bD(".team-invite-buttons .confirm-button").val(ey("Invite and buy"))}else{bD(".charges-section").hide();return this._updateConfirmButton()}};return i})(d5);var bH,aw,aB,U,ec,eY,bs,eH,dS,e9,bf,cq,q,b1=function(i,j){return function(){return i.apply(j,arguments)}},fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty;dS=INLINE_JS.Team=E.Team={_use_async_reset:false,team_id:cK.get_viewer().team_id,set_team_id:function(i){this.team_id=i},setup_beta_modal_listeners:function(){var fo,fr,fp,T,fn,fk,fq,fl,fm;fr=bD(".feature-list .enroll-button");T=bD(".feature-list .feedback-button");for(fn=0,fq=fr.length;fn<fq;fn++){fo=fr[fn];fp=bD(fo).data("feature");bD(fo).click((function(i){return function(){return new aw(i).show()}})(fp));fo.disabled=false}fm=[];for(fk=0,fl=T.length;fk<fl;fk++){fo=T[fk];fp=bD(fo).data("feature");fm.push(bD(fo).click((function(i){return function(){return new aB(i).show()}})(fp)))}return fm},invite_modal_show:function(i){if(!dO.invite_modal){return bD("body").one("invite-modal-initialized",(function(j){return function(){return j.invite_modal_show(i)}})(this))}if(!this.invite_modal_already_initialized){dO.invite_modal.show();dO.init();this.invite_modal_already_initialized=true}else{dO.invite_modal.show();dO.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){dO.update_used_licenses(window.active_team_member_table.get_licensed_members())}return dO.set_emails(i)},init_admin:function(){bm.set_vertical_space(2);return bD("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return bD(".team_name_change_notice .hide_link").click((function(i){return function(j){return i.hide_team_name_change_banner()}})(this))},add_users:function(fk,j){var fl,T,i;Event.stop(fk);T=$("team-invite-form");cJ(T,"Couldn't find the team invite form.");fl=bD(T).find("input[name='emails']");if(fl.length===0){ah.error(ey("You haven't included anyone to invite! Please invite at least one person."));return}i=(function(fm){return function(){var fn;fn=bR.collect_form_vars(T);bD.extend(fn,{team_id:fm.team_id});bR.add_loading(fk.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:fn,subject_user:cK.get_viewer().work_user,progress_text:ey("Inviting members..."),noAutonotify:true,onSuccess:function(ft){var fr,fq,fp,fs,fo;bR.remove_loading();dO.reset_modal();dO.add_total_licenses(j);dO.invite_modal.hide();fs=bD(".team_admin_members_table");fp=JSON.parse(ft.responseText);if(fp){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.add_users(fp!=null?fp.users:void 0)}else{if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){__CIRCULAR_DEPENDENCY__.Dashboard.set_num_invited(fp!=null?fp.num_invited:void 0)}}}fr=(function(){var fv,fu;fv=fp!=null?fp.users:void 0;fu=[];for(fq in fv){fo=fv[fq];fu.push(fo)}return fu})();if(fr.length===1){return ah.success(ey("Invited %(user_email)s.").format({user_email:fr[0].email}))}else{if(fr.length>1){return ah.success(ey("Invited %(user_count)d people.").format({user_count:fr.length}))}else{return ah.error(bb("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",fl.length).format({num_skipped:fl.length}))}}}else{return ah.error()}},onFailure:function(fq){var fo,fp;if(fq){if(fq.responseText.indexOf("err:")===0){fo=fq.responseText.substr(4);if(fo.indexOf("{")===0){fp=fo.evalJSON(true);bR.fill_errors(T,fp)}else{fo=new ff(fo);ah.error(fo)}}else{ah.error()}}bR.remove_loading();return bD("input[type='submit']").prop("disabled",false)},cleanUp:function(){bR.remove_loading();dO.reset_modal();return dO.invite_modal.hide()}})}})(this);return setTimeout(function(){if(!dO.invite_modal.is_making_transition_info_request()){return i()}},100)},show_demo_signup_modal:function(T,fk,fl,j,fm){var i,fp,fo,fn;this.webinar_key=T;this.webinar_iso_datetime=fk;this.webinar_date=fl;this.webinar_title=j;this.tab_url=fm;fn=ey("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});fp=new U({element_id:"demo-signup-modal",title:fn});fp.show();fp.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);fp.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);fp.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);fp.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);fo=fp.$modal_window.find("input[name=retURL]");fo.attr("value",fo.val()+"#"+this.tab_url);i=fp.$modal_window.find("#demo-signup-form")[0];return i.on("submit",fp.on_confirm_button_click)},show_unsuspend_modal:function(fk,i,j,T){var fl;fl=new bs({element_id:"dfe-unsuspend-modal",focus:"confirm"});fl.user_name=fk||j;fl.email=j;fl.user_id=i;fl.team_id=this.team_id;fl.refresh_cb=T;fl.show();return false},show_remove_or_deactivate_modal:function(T,fn,i,j,fo,fl,fm){var fk;fk=new ec({element_id:"dfe-remove-or-deactivate-user-modal",focus:".new-collab-input"});fk.user_name=fn||j;fk.email=j;fk.user_id=i;fk.team_id=this.team_id;fk.invited=fo;fk.hide_transfer_wipe=fl;fk.refresh_cb=fm;fk.show();return false},show_remove_modal:function(T,fk,fp,fl,fm,i,j,fn){var fo;fo=new eY({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});fo.user_name=fk||fl;fo.email=fl;fo.user_id=fp;fo.team_id=this.team_id;fo.invited=fm;fo.num_api_apps=i;fo.hide_transfer_wipe=j;fo.refresh_cb=fn;fo.show();return false},remove_user:function(fk,fl){var T,j,i;alert("in remove_user");Event.stop(fk);j=bD("input[type=submit]","#remove-user-modal");j.attr("disabled",1);i=fa.vars.user_id;if(fl){T=true}else{T=bD("input[name=should_disable]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:this.team_id,user_id:i,should_disable:T},onSuccess:(function(fm){return function(fq){var fp,fo,fn;fn=JSON.parse(fq.responseText);if((fp=window.active_team_member_table)!=null){fp.remove_user(fa.vars.user_id)}if((fo=window.removed_team_member_table)!=null){fo.add_users(fn)}fm.decrement_used_licenses();return ah.success(ey("User removed."))}})(this),cleanUp:function(){fa.hide();return j.removeAttr("disabled")}})},show_reinvite_modal:function(T,fk,i,j){var fl;dt.fillVal(j,"reinvite-user-email");dt.fillVal(fk,"reinvite-user-team");fl=ey("Resend invite to '%(email_address)s'").format({email_address:bS.em_snippet(j,18)});return fa.show(fl,$("reinvite-user-modal"),{user_id:i,button:T})},email_verification:this.email_verification=new d1("work"),show_email_verification_modal:function(){return this.email_verification.show_verify_modal(null,ep.NEW_DFB_TEAM)},reinvite_user:function(j){var i;Event.stop(j);i=fa.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(fn){var fk,fm,fl,T;ah.success(ey("Invite sent."));if((fm=$("team-member-info"))!=null){fm.update(fn.responseText)}fk=window.active_team_member_table;if(fk){T=fk.data.users[i];T.invite_expired=false;fl={};fl[i]=T;return fk.update_user_data(fl)}},cleanUp:function(){return fa.hide()}})},show_request_license_modal:function(j,i){var T;T=ey("Send upgrade request?");return fa.show(T,$("request-license-modal"),{user_id:i,button:j})},request_license:function(j){var i;Event.stop(j);i=fa.vars.user_id;return new Ajax.DBRequest("/team/request_license",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(T){bD("#request_license_text").hide();bD("#request-license-section").hide();return ah.success(ey("Request sent."))},cleanUp:function(){return fa.hide()}})},show_user_activity_log_modal:function(i,T,fk){var j;j=bD("#activity-log-modal");j.find(".activity-log-email").text(T);j.find(".activity-log-name").text(fk);j.find("#activity-log-user-message").show();return fa.show(ey("Create activity report"),j[0],{user_id:i})},show_team_activity_log_modal:function(j,T){var i;i=bD("#activity-log-modal");i.find(".activity-log-email").text(j);i.find(".activity-log-name").text(T);i.find("#activity-log-team-message").show();return fa.show(ey("Create full activity report"),i[0])},generate_activity_log:function(fo){var fm,fk,fn,fl,i,T,j;Event.stop(fo);fk=bD("#activity-log-modal");fn=fk.find("input[name='from_date']").val();i=fk.find("input[name='to_date']").val();if(fn>i){ah.error(ey("Your start date is after your end date."));return}fl=this.team_id;j=fa.vars.user_id;T=new Date().getTimezoneOffset().toString();fm=bD(".activity-report-generator .freshbutton-blue");fm.prop("disabled",true);return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:fn,to_date:i,team_id:fl,user_id:j,tzoffset:T},onSuccess:function(fp){return ah.success(ey("Report started. We'll email you when it's ready."))},cleanUp:function(){fa.hide();return fm.prop("disabled",false)}})},show_reset_password_modal:function(j,T,i){var fk;bD("#reset-password-modal .member-name").text(T);fk=ey("Reset password for '%(user_name)s'").format({user_name:T});return fa.show(fk,$("reset-password-modal"),{user_id:i,button:j})},reset_password:function(j){var i;Event.stop(j);i=fa.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:this.team_id,user_id:i},onSuccess:function(T){return ah.success(ey("User's password reset."))},cleanUp:function(){return fa.hide()}})},show_reset_all_passwords_modal:function(){return fa.show(ey("Reset all passwords"),$("reset-all-passwords-modal"))},set_async_password_reset:function(i){return this._use_async_reset=i},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:this.team_id},job:this._use_async_reset,subject_user:cK.get_viewer().work_user,progress_text:ey("Resetting all passwords..."),onSuccess:function(i){return ah.success(ey("All passwords reset."))},cleanUp:function(){return fa.hide()}})},show_admin_status_modal:function(T,fo,fq,fl,fp,fm){var j,i,fk,fn;i=fp.strip()||fl;fk=void 0;j=void 0;fn=void 0;if(fm){fn=ey("Add admin permissions for '%(person_name)s'").format({person_name:i.escapeHTML()});fk=ey("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:i.escapeHTML()});j=ey("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"})}else{fn=ey("Remove admin privileges from '%(person_name)s'").format({person_name:i.escapeHTML()});fk=ey("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:i.escapeHTML()});j=ey("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"})}dt.fillVal(fl,"admin-status-email");dt.fillVal(fk,"admin-status-action");dt.fillVal(j,"admin-status-button-action");fa.show(fn,$("admin-status-modal"),{user_id:fq,button:T,admin_on:fm});return false},set_admin_status:function(j){var i;Event.stop(j);i=fa.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:this.team_id,user_id:i,on:(fa.vars.admin_on?"yes":"no")},onSuccess:function(fk){var fl,T;fl=(fa.vars.admin_on?ey("User's admin status granted."):ey("User's admin status removed."));if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){return __CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){T=JSON.parse(fk.responseText);window.active_team_member_table.update_user_data(T);return ah.success(fl)}else{if(fa.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(fa.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(fa.vars.user_id)}}}},cleanUp:function(){return fa.hide()}})},show_disable_2fa_modal:function(T,i,j){bD("#disable-2fa-modal .member-name").text(j);return fa.show(ey("Disable two-step verification"),$("disable-2fa-modal"),{user_id:i,elm:T})},show_reset_2fa_modal:function(T,i,j){bD("#reset-2fa-modal .member-name").text(j);return fa.show(ey("Reset two-step verification"),$("reset-2fa-modal"),{user_id:i,user_name:j,elm:T})},reset_2fa:function(){return new Ajax.DBRequest("/account/team/reset_2fa",{parameters:{team_id:this.team_id,user_id:fa.vars.user_id},onSuccess:function(j){var i;bD(".tfa_enabled").replaceWith(ey("Disabled"));i=JSON.parse(j.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(i)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",i)}}}ah.success(ey("Two-step verification reset for %(user_name)s").format({user_name:fa.vars.user_name}));return fa.hide()}})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:this.team_id,user_id:fa.vars.user_id},onSuccess:function(j){var i;bD(".tfa_enabled").replaceWith(ey("Disabled"));i=JSON.parse(j.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(i)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",i)}}}ah.success(ey("Two-step verification disabled."));return fa.hide()}})},show_sso_preview_email:function(i){return fa.show(ey("Email preview"),$(i))},show_sso_sample_email:function(i){return fa.show(ey("Sample email"),$(i))},show_user_message_modal:function(T,j,i){var fk;dt.fillVal(i,"user-message-email");fk=ey("Send email to '%(user_name)s'").format({user_name:T});$("user-message").value="";fa.show(fk,$("user-message-modal"),{user_name:T,user_id:j});return d3.focus.defer("user-message")},send_user_message:function(){var j,i;i=fa.vars.user_id;j=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:i,team_id:this.team_id,message:j},onSuccess:function(){var T;T=fa.vars.user_name;ah.success(ey("Message successfully sent to %(user_name)s.").format({user_name:T}));return fa.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:this.team_id}});bD(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return bD(".pin_notice").hide()},hide_pin_banner_with_user_id:function(i,j){var T;T=function(fk){return bD(j).closest("span").removeClass("on").addClass("off")};if(i===null){return new Ajax.DBRequest("/team/invalidate_pin",{onSuccess:T})}else{return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:i},onSuccess:T})}},get_pin_with_user_id:function(i,T,j){var fk;if(j==null){j=null}if(j===null){j=function(fm,fl){bD(fl).closest("span").find(".pin-value").text(fm.pin+" -");return bD(fl).closest("span").removeClass("off").addClass("on")}}fk=function(fm){var fl;fl=JSON.parse(fm.responseText);return j(fl,T)};if(i===null){return new Ajax.DBRequest("/team/generate_pin",{onSuccess:fk})}else{return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:i},onSuccess:fk})}},send_team_message:function(j){var i;Event.stop(j);i=$F("team-message").strip();if(i){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:this.team_id,message:i},onSuccess:function(T){ah.success(ey("Message successfully sent to team."));return fa.hide()}})}},show_security_message_modal:function(){return new e9().show()},send_team_security_message:function(T){var j,i;Event.stop(T);i=$F("team-security-message").strip();j=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:j.serialize(true),onSuccess:function(fk){ah.success(ey("Message successfully sent."));return fa.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(i,j){this.used_licenses=i;return this.total_licenses=j},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(i,j){$("migration-url").value=j;fa.show(ey("Migration link for '%(email)s'").format({email:bS.em_snippet(i,18)}),$("migrate-url-modal"));return $("migration-url").select()},show_end_session_modal:function(j,i,T){bm.hide_all();bD("#end-session-modal .member-name").text(bD("#member-name").text());return fa.show(ey("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:j,user_id:i,elm:T})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:fa.vars.login_id,team_id:this.team_id,user_id:fa.vars.user_id},onSuccess:function(){fa.hide();dS.remove_closest_row(fa.vars.elm);return ah.success(ey("Web session closed."))}})},unlink_device:function(i,fk,fo,j,fp,T,fl){var fn,fm;bm.hide_all();fn=$("unlink-device-modal-"+T);fm=ey("Unlink %(device_name)s").format({device_name:fo});return fa.show(fm,fn,{app_id:fk,user_id:fp,elm:fl,device_id:i,display_name:fo})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:fa.vars.app_id,team_id:this.team_id,user_id:fa.vars.user_id,device_id:JSON.stringify(fa.vars.device_id)},subject_user:cK.get_viewer().work_user,onSuccess:function(){fa.hide();dS.remove_closest_row(fa.vars.elm);return ah.success(ey("%(device_name)s unlinked.").format({device_name:fa.vars.display_name}))}})},disable_app:function(j,T,i,fk){bm.hide_all();bD("#disable-app-modal .app-name").text(T);bD("#disable-app-modal .member-name").text(bD("#member-name").text());return fa.show(ey("Disable '%(app_name)s'?").format({app_name:T}),$("disable-app-modal"),{app_id:j,user_id:i,elm:fk})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fa.vars.app_id,keep_sandbox_files:true,team_id:this.team_id,user_id:fa.vars.user_id},subject_user:cK.get_viewer().work_user,onSuccess:function(i){fa.hide();dS.remove_closest_row(fa.vars.elm);return ah.success(i.responseText)}})},remove_closest_row:function(fk){var T,j,i;T=bD(fk).closest(".team_admin_table_row");j=bD(T).closest(".team_admin_table");if(j.find(".team_admin_table_row").length===1){i=j.prev(".team_admin_table_title");if(!i.length){i=bD(".team_apps_table_panel")}i.remove();return j.remove()}else{return T.remove()}},submit_report_form:function(i){bD(i.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};aw=E.BetaEnrollConfirmationModal=(function(j){fb(i,j);function i(T){this.feature_name=T;this.on_confirm_button_click=b1(this.on_confirm_button_click,this);i.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}i.prototype.on_confirm_button_click=function(T){bD("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return i})(d5);aB=E.BetaFeedbackModal=(function(j){fb(i,j);function i(T){this.feature_name=T;this.success=b1(this.success,this);i.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(fk){return function(fo){var fn,fm,fl;fo.preventDefault();fn=bD(fo.target);fm=fn.closest("form");fl={feature_name:fk.feature_name};return bR.ajax_submit(fm[0],false,fk.success,fk.error,fn[0],fl)}})(this)}i.prototype.success=function(T){ah.success(ey("Thank you for your feedback."));return this.$modal_window.hide()};i.prototype.error=function(T){if(T.status!==200){return ah.error(ey("Failed to submit feedback. Please try again."))}};return i})(d5);U=E.DemoSignupModal=(function(i){fb(j,i);function j(){this.on_show=b1(this.on_show,this);this.on_confirm_button_click=b1(this.on_confirm_button_click,this);return j.__super__.constructor.apply(this,arguments)}j.prototype.on_confirm_button_click=function(fn){var fv,fs,fo,T,fq,fl,fu,ft,fk,fr,fp,fm;fn.preventDefault();fp=$("demo-signup-form");ft=$("1210");fl=bD(fp).find("input[name='first_name']").val();bD(ft).find("input[name='FirstName']").attr("value",fl);fu=bD(fp).find("input[name='last_name']").val();bD(ft).find("input[name='LastName']").attr("value",fu);fq=bD(fp).find("input[name='email']").val();bD(ft).find("input[name='Email']").attr("value",fq);fr=bD(fp).find("input[name='phone_number']").val();bD(ft).find("input[name='Phone']").attr("value",fr);fv=bD(fp).find("input[name='company_name']").val();bD(ft).find("input[name='Company']").attr("value",fv);fo=bD(fp).find("select[name='company_size']");fs=fo.find("option:selected").val();bD(ft).find("input[name='Company_size__c']").attr("value",fs);T=$(this.$modal_window.find(".confirm-button")[0]);fm=(function(fw){return function(fx){fw.$modal_window.hide();return ft.submit()}})(this);fk=bR.collect_form_vars(fp,true);return bR.ajax_submit(fp,false,fm,false,T,fk,true)};j.prototype.on_show=function(T){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return ch.init()};return j})(d5);bH=E.AccountTransferBaseModal=(function(j){fb(i,j);function i(T,fl,fk){this.file_action_selector=fl;this.transfer_choice_selector=fk;this._clearInput=b1(this._clearInput,this);this._markInputInvalid=b1(this._markInputInvalid,this);this._markInputValid=b1(this._markInputValid,this);this._tokenRemove=b1(this._tokenRemove,this);this._tokenAdd=b1(this._tokenAdd,this);this._selectChange=b1(this._selectChange,this);this._isTransferSelected=b1(this._isTransferSelected,this);this.checkAndApproveMemberRemoval=b1(this.checkAndApproveMemberRemoval,this);this.on_cancel_button_click=b1(this.on_cancel_button_click,this);this.execute_form=b1(this.execute_form,this);this.get_cancel_button=b1(this.get_cancel_button,this);this.get_confirm_button=b1(this.get_confirm_button,this);this.get_button_class=b1(this.get_button_class,this);this.set_modal_class=b1(this.set_modal_class,this);this.handleAjaxFailure=b1(this.handleAjaxFailure,this);this.on_show=b1(this.on_show,this);i.__super__.constructor.call(this,T,this.file_action_selector,this.transfer_choice_selector)}i.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(cK.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(T){return function(fk){return fk.excludeNonTeam().excludeNewStyleGroups().excludeByEmail(T.email?[T.email.toLowerCase()]:[])}})(this),exclude_emails:[this.email]});this.tokenAdd=bD.proxy(this._tokenAdd,this);this.tokenRemove=bD.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=bD.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};i.prototype.handleAjaxFailure=function(T){if(T.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};i.prototype.set_modal_class=function(fl){var fk,T;fk="suspending deleting approve_transfer_to_suspended";T=this.get_form();T.removeClass(fk);if(fl!=null){return T.addClass(fl)}};i.prototype.get_button_class=function(){var T;T=this.get_form();if(T.hasClass("suspending")){return".confirm_deactivate_button"}else{if(T.hasClass("deleting")){return".confirm_delete_button"}else{if(T.hasClass("approve_transfer_to_suspended")){return".confirm_transfer_to_suspended_button"}}}};i.prototype.get_confirm_button=function(){var T;T=this.get_button_class();if(T!=null){return $(this.$modal_window.find(T+" .confirm-button"))}else{return $(this.$modal_window.find(".confirm-button"))}};i.prototype.get_cancel_button=function(){var T;T=this.get_button_class();if(T!=null){return $(this.$modal_window.find(T+" .cancel-button"))}else{return $(this.$modal_window.find(".cancel-button"))}};i.prototype.execute_form=function(){var T,fk;fk=this.get_form()[0];T=this.get_confirm_button();return bR.ajax_submit(fk,false,this.success_callback,this.handleAjaxFailure,T)};i.prototype.on_cancel_button_click=function(fk){var T;fk.preventDefault();T=this.get_form();if(T.hasClass("approve_transfer_to_suspended")){this.reset_button_click(this.$confirm_button,this.on_confirm_button_click);return this.reset_button_click(this.$cancel_button,this.on_cancel_button_click)}else{return i.__super__.on_cancel_button_click.apply(this,arguments)}};i.prototype.reset_button_click=function(T,fk){T.off("click");if(fk!=null){return T.on("click",fk)}};i.prototype.checkAndApproveMemberRemoval=function(fl){var T,fk;if(!bD("#deactivate_option").is(":checked")&&bD("#transfer_files_on").is(":checked")&&!this.invited){T=bD(".tokenized_autocompleter_container .token-display-text");fk=bD(".tokenized_autocompleter_container .token-suspended");if(T.length&&fk.length){this.set_modal_class("approve_transfer_to_suspended");this.$modal_window.find(".target_user_name").text(T.text());this.$confirm_button=this.get_confirm_button();this.reset_button_click(this.$confirm_button,(function(fm){return function(fn){return fm.execute_form()}})(this));this.$cancel_button=this.get_cancel_button();this.$cancel_button.on("click",fl);return}}return this.execute_form()};i.prototype._isTransferSelected=function(){return bD(this.transfer_choice_selector).prop("checked")};i.prototype._selectChange=function(T){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};i.prototype._tokenAdd=function(T){this.$collab_input.hide();if(T.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};i.prototype._tokenRemove=function(T){this.$collab_input.show();return this._clearInput()};i.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};i.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};i.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return i})(d5);e9=E.TwoFactorMessageModal=(function(j){fb(i,j);function i(){i.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}i.prototype.on_confirm_button_click=function(T){dS.send_team_security_message(T);return this.hide()};return i})(d5);bs=E.DfeUnsuspendUserModal=(function(i){fb(j,i);function j(T){this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.success_callback=b1(this.success_callback,this);j.__super__.constructor.call(this,T)}j.prototype.before_show=function(){var T;j.__super__.before_show.call(this);T=ey("Unsuspend %(user_name)s").format({user_name:this.user_name});this.$modal_window.find(".db-modal-title-text").text(T);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=email]").attr("value",this.email);this.$modal_window.find(".unsuspended_name").text(this.user_name);return this.$modal_window.find(".unsuspended_email").text(this.email)};j.prototype.success_callback=function(fk){var T;if((T=__CIRCULAR_DEPENDENCY__.MembersReact)!=null){T.refresh_member_stats()}this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb("unsuspended"):void 0};j.prototype.on_confirm_button_click=function(fl){var T,fk;fl.preventDefault();fk=this.$modal_window.find(".dfe-unsuspend-modal")[0];T=$(this.$modal_window.find(".confirm-button")[0]);return bR.ajax_submit(fk,false,this.success_callback,false,T)};return j})(d5);ec=E.DfeRemoveOrDeactivateUserModal=(function(j){fb(i,j);function i(T){this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.success_callback=b1(this.success_callback,this);this.on_show=b1(this.on_show,this);this.handle_change_action=b1(this.handle_change_action,this);this.switch_to_uninvite_mode=b1(this.switch_to_uninvite_mode,this);this.switch_to_removal_mode=b1(this.switch_to_removal_mode,this);this.switch_to_deactivation_mode=b1(this.switch_to_deactivation_mode,this);this.show_removal_content=b1(this.show_removal_content,this);this.show_deactivation_content=b1(this.show_deactivation_content,this);i.__super__.constructor.call(this,T,"input[name=transfer_files]","#transfer_files_on")}i.prototype.get_form=function(){return this.$modal_window.find(".dfe-remove-or-deactivate-user-modal")};i.prototype.set_form_action_to_deactivate=function(){return bD(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/suspend_user")};i.prototype.set_form_action_to_remove=function(){return bD(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/remove_user")};i.prototype.show_deactivation_content=function(){return this.set_modal_class("suspending")};i.prototype.show_removal_content=function(){return this.set_modal_class("deleting")};i.prototype.switch_to_deactivation_mode=function(){this.show_deactivation_content();return this.set_form_action_to_deactivate()};i.prototype.switch_to_removal_mode=function(){this.show_removal_content();return this.set_form_action_to_remove()};i.prototype.switch_to_uninvite_mode=function(){this.set_form_action_to_remove();this.set_modal_class("invited");this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()};i.prototype.handle_change_action=function(T){T.preventDefault();if(bD("#deactivate_option").is(":checked")){return this.switch_to_deactivation_mode()}else{return this.switch_to_removal_mode()}};i.prototype.on_show=function(T){var fk;i.__super__.on_show.call(this);bD("input[name=deactivate_or_remove]").on("change",this.handle_change_action);this.$modal_window.find(".deleted_user_name").text(this.user_name);if(this.invited){fk=ey("Uninvite %(user_name)s").format({user_name:this.user_name});this.switch_to_uninvite_mode()}else{fk=ey("Suspend or delete %(user_name)s").format({user_name:this.user_name});bD("#deactivate_option").attr("checked","checked");this.switch_to_deactivation_mode()}this.$modal_window.find(".db-modal-title-text").text(fk);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.hide_transfer_wipe){this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()}};i.prototype.success_callback=function(T){var fk;if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}fk="";if(this.invited){fk="uninvited"}else{if(bD("#deactivate_option").is(":checked")){fk="suspended"}else{fk="deleted"}}this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb(fk):void 0};i.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_removal_mode)};return i})(bH);eY=E.DfeRemoveUserModal=(function(i){fb(j,i);function j(T){this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.switch_to_removal_mode=b1(this.switch_to_removal_mode,this);this.success_callback=b1(this.success_callback,this);this.on_show=b1(this.on_show,this);j.__super__.constructor.call(this,T,"input[name=transfer_files]","#transfer_files_on")}j.prototype.get_form=function(){return this.$modal_window.find(".dfe-remove-user-modal")};j.prototype.on_show=function(fk){var T,fl;j.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){fl=ey("Uninvite %(user_name)s").format({user_name:this.user_name})}else{fl=ey("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(fl);if(this.num_api_apps){T=bb("%(num)s API app","%(num)s API apps",this.num_api_apps).format({num:this.num_api_apps});this.$modal_window.find(".num_api_app").text(T)}else{this.$modal_window.find(".api_app_warning").hide()}this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".active_user_remove_setting").remove();this.get_form().addClass("invited")}if(this.hide_transfer_wipe){return this.$modal_window.find(".active_user_remove_setting").remove()}};j.prototype.success_callback=function(fm){var fn,fl,fk,T;T=JSON.parse(fm.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if((fl=window.active_team_member_table)!=null){fl.remove_user(this.user_id)}if((fk=window.removed_team_member_table)!=null){fk.add_users(T)}}fn="";if(this.invited){fn="uninvited"}else{fn="deleted"}dS.decrement_used_licenses();this.hide();return typeof this.refresh_cb==="function"?this.refresh_cb(fn):void 0};j.prototype.switch_to_removal_mode=function(){return this.set_modal_class()};j.prototype.on_confirm_button_click=function(T){T.preventDefault();return this.checkAndApproveMemberRemoval(this.switch_to_removal_mode)};return j})(bH);eH=E.ManageFilesModal=(function(j){fb(i,j);function i(fk,T,fl){this.source_user_id=fk;this.source_user_name=T;this.options=fl;this.on_confirm_button_click=b1(this.on_confirm_button_click,this);this.success_callback=b1(this.success_callback,this);i.__super__.constructor.call(this,this.options,"input[name=file_action]","#move-files")}i.prototype.get_form=function(){return this.$modal_window.find("form")[0]};i.prototype.on_show=function(){var T;i.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);T=ey("Manage %(team_member)s's files").format({team_member:this.source_user_name});this.$modal_window.find(".db-modal-title-text").text(T);return this.get_form().on("submit",this.on_confirm_button_click)};i.prototype.success_callback=function(fk){var T;T=JSON.parse(fk.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu!=null){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}if(bD("#move-files").prop("checked")){ah.success(ey("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{ah.success(ey("Permanently deleted files"))}return this.hide()};i.prototype.on_confirm_button_click=function(fl){var T,fk;fl.preventDefault();fk=this.get_form();T=$(this.$modal_window.find(".confirm-button")[0]);return bR.ajax_submit(fk,false,this.success_callback,this.handleAjaxFailure,T)};return i})(bH);cq=E.show_manage_files_modal=function(i,j){var T;T=new eH(i,j,{element_id:"manage-files-modal",focus:".new-collab-input"});return T.show()};q=function(){var i;i=function(fk,T){var j,fl;bD(T).css("display","none");j=bD(T).closest("#user_generate_liveops_pin");fl=j.find(".user_generate_liveops_pin_value");fl.text(fk.pin);bD(T).addClass("liveops_pin_elem_invisible");return j.find(".user_generate_liveops_pin_text").removeClass("liveops_pin_elem_invisible")};dS.get_pin_with_user_id(null,this,i);return false};bD("#user_generate_liveops_pin_button").click(q);bf=function(){bD("#help_callus_title").hide();bD("#help_callus_details").show();return false};bD("#help_callus_trigger").click(bf);var bC;bC=E.UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var b7;b7=E.FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5,TEAM_SHARED_FOLDER:6};var a5;a5=E.BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(j,T){var i;if(T==null){T=null}i=Object.clone(j);if(i.is_dir){i.ago="";i.ts=0}else{i.target_ns=false}i.sort_key=d3.decode_sort_key(i.sort_key);i.request_id=T!=null?T:null;return new cQ(i)},filepreview_from_selected:function(fn,fm,fl,fk){var i,T,fo,j;if(fm==null){fm=false}if(fl==null){fl=false}if(fk==null){fk=Constants.BROWSE_UNKNOWN}if(fn.bytes<0||fn.preview_type==="download"){window.open(fn.href,"_blank");return}if(az.getGandalfRule("file-viewer-react")){T=this.getIndexOfFileInArray(cr.files,fn);eZ.open(cr.files,T,cr.active_user,"react-file-viewer")}else{j=eB.get_url();fo=eB.deconstruct_url(j);i=j.indexOf("/s/")===0;n.show(fn,cr.active_user,{files:cr.files,file_view_mode:aW.FileViewModeType.BROWSE,should_focus_comment_input:fl},fk);if(!(fm||i||fo.qargs.preview===fn.filename)){n.set_preview_url()}}},profile_files:function(T){var fk,j,i,fl,fm;fl={files:0,folders:0,shared_folders:0,team_shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0,compressible_count:0,can_permanently_delete:0};for(j=0,i=T.length;j<i;j++){fk=T[j];if(fk.dir){fl.folders+=1}else{fl.files+=1}if(fk.is_sandbox()){fl.sandboxes+=1}if(fk.is_shared_folder()){fl.shared_folders+=1}if(fk.is_team_shared_folder()){fl.team_shared_folders+=1}if(fk.bytes===-1){fl.deleted+=1}if(fk.target_ns){fl.target_namespaces+=1}if(fk.fq_path.toLowerCase()==="/public"&&cr.public_folder_enabled){fl.public_folder=1}if(fk.in_root_coll){fl.in_root_coll+=1}if(fk.compressible){fl.compressible_count+=1}if(!((fm=cr.permanent_delete_is_disabled_by_ns_id)!=null?fm[fk.ns_id]:void 0)){fl.can_permanently_delete+=1}}return fl},profile_summary:function(j){var T,i;T=bb("%d file","%d files",j.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(j.files);i=bb("%d folder","%d folders",j.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(j.folders);if(j.files&&j.folders){return ey("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:T,y_folders:i})}else{if(j.files){return T}else{if(j.folders){return i}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var fo,fm,fk,T,j,i,fn,fl;fo=bD("#browse");fk=fo.find("#browse-root-actions");T=fo.find("#browse-sort");fm=fo.find("#browse-header-status");fl=this.SPECIAL_MODES;for(j=0,i=fl.length;j<i;j++){fn=fl[j];fo.removeClass(fn);fk.removeClass(fn);T.removeClass(fn);fm.removeClass(fn)}b9.reset_fulltext_search(true);fo.removeClass("fulltext_search");fk.removeClass("fulltext_search");T.removeClass("fulltext_search");fm.removeClass("fulltext_search");bD("#fulltext-search-loading").hide();return bD("#fulltext-search-all-link").hide()},set_special_mode:function(fo){var T,fl,fp,i,fk,fn,fm,j;T=bD("#browse");fp=T.find("#browse-root-actions");i=T.find("#browse-sort");fl=T.find("#browse-header-status");cJ(this.SPECIAL_MODES.indexOf(fo)!==-1,"unknown mode");j=this.SPECIAL_MODES;for(fk=0,fn=j.length;fk<fn;fk++){fm=j[fk];if(fm!==fo){T.removeClass(fm);fp.removeClass(fm);i.removeClass(fm);fl.removeClass(fm)}}T.addClass(fo);fp.addClass(fo);i.addClass(fo);fl.addClass(fo);if(fo===this.SEARCH_MODE){T.addClass("fulltext_search");fp.addClass("fulltext_search");i.addClass("fulltext_search");return fl.addClass("fulltext_search")}},get_mode:function(){var T,j,fl,fk,i;i=this.BROWSE_MODE;fk=this.SPECIAL_MODES;for(T=0,j=fk.length;T<j;T++){fl=fk[T];if(bD("#browse").hasClass(fl)){i=fl}}return i},load_visible_thumbs:function(){var fu,fw,fm,fr,fx,fy,fv,fl,fq,fo,fn,fs,fp,T,fk,ft;fl=this.get_files_in_view();fw=fl[1]-fl[0];fv=[Math.max(fl[0]-fw,0),fl[0]];fy=[Math.min(fl[1],cr.files.length),Math.min(fl[1]+fw,cr.files.length)];fu=[];fk=[fl,fy,fv];for(fo=0,fs=fk.length;fo<fs;fo++){fx=fk[fo];fr=fx[0],fq=fx[1];ft=cr.files.slice(fr,+fq+1||9000000000);for(fn=0,fp=ft.length;fn<fp;fn++){fm=ft[fn];if(fm.get_div()){fu.push(fm.get_div().down("img"))}}}T=function(i){if(!i.src.endsWith(cv.SPACER)){i.addClassName("thumbnail");return i.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return bq.batch_load_thumbs(fu,this.THUMBS_BATCH_SIZE,T)},get_files_in_view:function(){var fp,fm,fr,fn,fo,fl,T,fs,fq,fk,ft;T=[0,cr.files.length-1];fk=C.viewport_dimensions().height;ft=C.scroll_offsets().top;fl=this._get_elm_height();if(!fl){return T}fp=bD("#browse-files");fn=parseInt(fp.css("padding-top"),10);if(!fp.length||isNaN(fn)){return T}if(bD("body").hasClass("absolutize")){fm=fp.offset().top+fn;fr=fm-ft;if(fr>0){fs=0;fo=fk-fr;fq=fo/fl}else{fs=Math.abs(fr/fl);fq=Math.abs(fk-fr)/fl}}else{fs=ft/fl;fo=fk-fn;fq=(fo+ft)/fl}fs=Math.max(Math.floor(fs),0);fq=Math.min(Math.floor(fq),cr.files.length-1);return[fs,fq]},_get_elm_height:function(){var j,i;if(cr.files.length>=3&&cr.files[1].get_div()){j=bD(cr.files[1].get_div());i=j.outerHeight()+parseInt(j.css("margin-bottom"))+parseInt(j.css("margin-top"));return i}else{return null}},append_ellipsis:function(i){return ey("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:i})},getIndexOfFileInArray:function(fn,fm){var fl,fk,T,j,i;i=-1;for(fk=T=0,j=fn.length;T<j;fk=++T){fl=fn[fk];if(fl.sjid===fm.sjid){i=fk}}return i}};var bo;bo=E.Sort=(function(){var fn,i,fk,fm,fl,T,j;fk=function(fp){var fo;fo=fp?1:-1;return function(fq,fr){return fo*d3.sort_by_rank_or_key(fq,fr)}};fm=function(fp){var fo;fo=fp?1:-1;return function(fq,fr){if(fq.bytes>fr.bytes){return fo}else{if(fq.bytes<fr.bytes){return -fo}else{return fo*bo.FILES_BY_NAME(fq,fr)}}}};fn=function(fp){var fo;fo=fp?1:-1;return function(fq,fr){return fo*(fq.fq_path.toLowerCase()>fr.fq_path.toLowerCase()?1:-1)}};i=function(fp){var fo;fo=fp?1:-1;return function(fr,fs){var fq;fq=fr.ts===fs.ts?0:fr.ts>fs.ts?1:-1;return fo*fq}};T=function(fo){return function(fr){var fq,fp;fp=fo(fr);fq=fk(true);return function(fs,ft){if(fs.dir^ft.dir){return(fs.dir?1:0)-(ft.dir?1:0)}else{return fp(fs,ft)||fq(fs,ft)}}}};fl=function(fo){return function(fr){var fp,fq;if(!bo.FOLDERS_FIRST){return fo(fr)}fq=fo(fr);fp=fr?1:-1;return function(ft,fu){var fs;if(ft.dir^fu.dir){fs=(ft.dir?0:1)-(fu.dir?0:1);return fp*fs}else{return fq(ft,fu)}}}};j=function(fo){return function(fr){var fp,fq;fq=bo.FILES_BY_NAME(fr);fp=fr?1:-1;return function(ft,fu){var fs;if(ft.is_deleted^fu.is_deleted){return(ft.is_deleted?1:0)-(fu.is_deleted?1:0)}fs=0;if(fo){if(ft.get_category()!==fu.get_category()){fs=ft.get_category()<fu.get_category()?-1:1}else{if(ft.get_extension()!==fu.get_extension()){fs=ft.get_extension()<fu.get_extension()?-1:1}}}else{if(ft.get_extension()!==fu.get_extension()){fs=ft.get_extension()<fu.get_extension()?-1:1}else{if(ft.get_category()!==fu.get_category()){fs=ft.get_category()<fu.get_category()?-1:1}}}return(fp*fs)||fq(ft,fu)}}};return{FILES_BY_NAME:fl(fk),SHARED_WITH:fl(fk),FILES_BY_SIZE:T(fm),FILES_BY_LOCATION:T(fn),FILES_BY_KIND:T(j(true)),FILES_BY_EXTENSION:T(j(false)),FILES_BY_MODIFIED:T(i),FOLDERS_FIRST:!d3.is_mac(),ALL_BY_MODIFIED:i}})();var dq,cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};dq=E.FlexColumn=(function(){var fp,fn,T,fo,fm,fk,fl,j;fp=[{label:"SHARED_WITH",func:bo.FILES_BY_NAME,display:ey("Shared With"),is_asc:true},{label:"FILES_BY_KIND",func:bo.FILES_BY_KIND,display:ey("Kind"),is_asc:true},{label:"FILES_BY_EXTENSION",func:bo.FILES_BY_EXTENSION,display:ey("Extension"),is_asc:true},{label:"FILES_BY_SIZE",func:bo.FILES_BY_SIZE,display:ey("Size"),is_asc:false}];fn={};T={};fm=[];fo=[];for(fl=0,j=fp.length;fl<j;fl++){fk=fp[fl];fm.push(fk.func);fn[fk.label]=fk.display;T[fk.label]=fk.is_asc;fo.push(fk.label)}return{SORT_FUNCTIONS:fm,DISPLAY:fn,IS_ASC:T,LABELS:fo,has_label:function(i){return cR.call(this.LABELS,i)>=0},has_sort:function(i){return cR.call(this.SORT_FUNCTIONS,i)>=0},next:function(fq){var i;i=dq.LABELS.indexOf(fq)+1;if(i===dq.LABELS.length){i=0}return fp[i]}}})();var b9;b9=E.FileSearch={MAX_RESULTS:100,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},is_loaded:false,init:function(i,j){this.firefly_enabled=i;return this.fulltext_search_enabled=j},get_state:function(){var i;i={};i.query_unnormalized=this.get_basic_query();i.query=i.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ");i.last_fq_path=this.last_fq_path!=null?this.last_fq_path:"";return i},set_state:function(i){this.last_fq_path=i.last_fq_path!=null?i.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";cr.inside_dir=this.scoped_search;this.set_basic_query(i.query_unnormalized);return this.do_search(false,true)},state_changed:function(){var j,i;j=this.get_state();i=this.last_state;if(i===false){return !!j.query}return(j.query!==i.query)||(j.last_fq_path!==i.last_fq_path)},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(i){if(i===this.get_basic_query()){return}return this._get_browse_search_input().val(i)},set_title:function(){var i,j;i=this.get_state();j=ey("Search - Dropbox");if(i.query_unnormalized){j=i.query_unnormalized+" - "+j}return document.title=j},_set_scope_path_to_browse_location:function(){if(cr.inside_dir){return this.last_fq_path=cr.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(T,i){var fl,fm,fk,j;if(i==null){i=false}if(typeof cr.entered_search==="function"){cr.entered_search()}j=!i&&!cr.in_search_mode();if(j){this._set_scope_path_to_browse_location()}fk=this.get_state();fm=""===this.get_basic_query();if(fm){if(cr.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=fk;this._clear_on_reload=true;eV.deselect_all();cr.clear();a5.set_special_mode("search");this.scoped_search=this.last_fq_path!=="";if(!i){fl=null;eB.push_state("/search/"+cr.active_user.role,fk)}this.set_title();this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();bD("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",T,0,this.MAX_RESULTS,false);return eG("search")},search:function(i){if(i==null){i=false}if(i!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&i;if(!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var i;if(!this.end_of_results){i=this.search_pos;if(this.end_of_active_results){i=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,i,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},update_empty:function(){var i;i=ey("No results found");if(this.scoped_search){i=ey("No results found in '%(path)s'").format({path:aA.filename(this.last_fq_path)})}bD("#noresults-header").text(i);bD("#fulltext-search-all-link").hide();bD("#noresults-directions").toggle(!this.scoped_search);return bD("#noresults-search-all-link").toggle(this.scoped_search)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(i){eV.deselect_all();cr.clear();cr.reset_state();cr.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=i;return bD("#fulltext-search-all-link").hide()},exit_search:function(){var i;if(cr.in_search_mode()){i=[cr.inside_deleted_dir,cr.inside_deleted_sandbox,cr.inside_deleted_shared_folder];if(!bv.any(i)){cr.deleted_shown=false}}$("browse").removeClassName("pending-search");this.hide_empty();return a3.set_path_url(null,this.last_fq_path,cr.deleted_shown)},force_reload:function(){return this.search()},ask_server:function(j,fn,T,fo,fl){var fm,fr,fp,fk,fq,i;i=this.get_state();fq=null;fk=new Date();if(fl){fq=eA.DELETED}else{if(fn){fq=eA.COMPLETION}else{fq=eA.FULLTEXT}}fm={firefly:this.firefly_enabled,infinite_scroll:T>0?true:false,path_scoped:false,search_type:fq,query_string:i.query};a9.SearchClientActivityLogger.log("query_started",cr.active_user.id,fm);if(!T){bD("#web-search-results").html(ey("Searching..."))}bD("#browse").addClass("pending-search");fr={query:i.query};if(T){fr.start=T}if(fo){fr.max_results=fo}if(fl){fr.deleted=fl}if(this.scoped_search){fr.fq_path=this.last_fq_path}if(!fn){this.last_fulltext_query=i.query}if(fn){fr.filename_only=true}fp=false;return new Ajax.DBRequest(j,{no_watch:true,evalJSON:false,parameters:fr,log_timing:true,onSuccess:(function(fs){return function(fv){var fw,ft,fu,fy,fx;if(!cr.in_search_mode()){return}fy=fv.request.parameters.parent_request_id;fw=JSON.parse(fv.responseText);fx=fw.file_info.length;if(i.query===fs.last_fulltext_query&&fk>=fs.last_new_search_ts){fs.search_pos=fs.search_pos+fx;if(fs.end_of_active_results){fs.deleted_search_pos=fs.deleted_search_pos+fx}if(fx<fs.MAX_RESULTS){fs.end_of_results=true&&fs.end_of_active_results;fs.end_of_active_results=true;if(!fs.end_of_results){fp=true}else{bD("#fulltext-search-loading").hide()}}fs.update_results(fw,fp,fy)}if(fw.file_info.length>0){ft=fw.file_info[0]}else{ft=null}fm=a9.SearchClientActivityLogger.create_completion_log_dict(fm,fy,fv.request.start_time,i.query,i.query===((fu=fs.last_state)!=null?fu.query:void 0),fx,null,ft);return a9.SearchClientActivityLogger.log("query_completed",cr.active_user.id,fm)}})(this),onFailure:(function(fs){return function(fu){var ft;fm=a9.SearchClientActivityLogger.create_completion_log_dict(fm,fu.request.parameters.parent_request_id,fu.request.start_time,i.query,i.query===((ft=fs.last_state)!=null?ft.query:void 0),null,fu.status);return a9.SearchClientActivityLogger.log("query_failed",cr.active_user.id,fm)}})(this),cleanUp:(function(fs){return function(){if(fp){return fs.load_more_results()}else{return bD("#browse").removeClass("pending-search")}}})(this),subject_user:cr.active_user})},update_results:function(j,i,fk){var T;if(i==null){i=false}if(fk==null){fk=null}T=this.get_state();cr.update(j,fk);cr.set_selection_from_fq_paths_or_index(b9);if(!i){this._update_number_results(this.search_pos);if(cr.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(j){var i,T;if(j===0){i=""}else{if(this.end_of_results){i=this.fulltext_search_enabled?bb("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",j).format({num_results:j}):bb("%(num_results)s result in files and folders.","%(num_results)s results in files and folders.",j).format({num_results:j})}else{i=this.fulltext_search_enabled?bb("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",j).format({num_results:j}):bb("Over %(num_results)s result in files and folders.","Over %(num_results)s results in files and folders.",j).format({num_results:j})}}T=ey("Search")+" - "+i;cr.update_header_status(i);T=ey("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){T=ey("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:aA.filename(this.last_fq_path+"'")})}bD("#web-search-results").text(T);if(this.scoped_search){return bD("#fulltext-search-all-link").show()}},history_change_handler:function(i,fk){var fl,j,T;j=typeof this._get_browse_search_input().find("input").attr("value")==="string";T=j&&!this.is_loaded;if(fk){this.last_state=fk}if(!this.last_state){a3.set_path_url(Constants.root_ns,"");return}if(this.state_changed()||T){this.set_state(this.last_state)}if(!n.shown()){key.setScope(cr.KEY_SCOPE)}if(eV.get_selected_files().length){fl=eV.get_selected_files()[0].get_div();cr.scrollToWithPadding(fl,fl.getHeight()*2)}return this.is_loaded=true},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){return bD("#browse-search-input")}};var el;el=E.BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var T,i,j;j=this.advanced_dict;for(i in j){T=j[i];key(T.key,cr.KEY_SCOPE,T.onPress)}this.customize_chart();if(d3.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(fk){return function(fl){if(fl.charCode===63&&!C.focus_in_input()){return fk.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var fl,j,fk,T;fl=(d3.is_mac()?".key-windows":".key-macos");fk=0;j=void 0;T=[];while(true){j=$("keys-chart").down(fl,fk++);if(!j){break}T.push(j.hide())}return T},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var i,j;i=$("keys-chart");i.style.position="fixed";j=$("browse-sort");if(cr.in_search_mode()){j=$("browse-header-wrapper")}else{if(j.getStyle("display")==="none"){j=$("browse-root-actions")}}bD(i).clonePosition(bD(j),{setHeight:false});i.style.top=j.cumulativeOffset()[1]+j.getHeight()+"px";i.setOpacity(0.9);return i.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:ey("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(j,T){var i;i=eV.get_selected_files();if(i.length){return i.first().edit()}}},"delete":{title:ey("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(fk,fl){var i,T,j;Event.stop(fk);if(cr.inside_read_only_shared_folder){ah.warning(ey("You don't have permission to delete files in this folder."))}j=eV.get_selected_files();if(j.length===1){i=j.first();if(i.is_deleted){return dB.show_purge(i.fq_path,i.dir)}else{return dB.show_delete(cr.active_user,i.fq_path,i.dir)}}else{if(j.length>1){T=a5.profile_files(j);if(T.deleted===j.length){return dB.show_bulk_purge(j)}else{if(T.deleted===0){return dB.show_bulk_delete(cr.active_user,j)}}}}}},help:{title:ey("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return el.toggle_chart()}},close_help:{title:ey("Hide keyboard shorcuts"),key:"escape",onPress:function(){return el.hide_chart()}},up_dir:{title:ey("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var i,j;cr.keyboard_nav=true;if(!cr.reloading){if(cr.inside_dir){if(!cr.containing_ns_path()&&cr.containing_ns_id()!==Constants.root_ns){j=Constants.root_ns;i=aA.normalize(aA.parent_dir(cr.containing_fq_path()))}else{j=cr.containing_ns_id();i=aA.normalize(aA.parent_dir(cr.containing_ns_path()))}if(cr.containing_ns_path()!==i||cr.containing_ns_id()!==j){cr.select_fq_paths=[cr.containing_fq_path()];return a3.set_path_url(j,i)}else{return eV.flicker_selected()}}else{return eV.flicker_selected()}}}},open_file:{title:ey("Open highlighted file"),key:"enter",onPress:function(){var i,j;j=eV.get_selected_files();if(j.length===1){i=j[0];cr.open_file(i,false,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN)}return false}},open_dir:{title:ey("Open highlighted folder"),key:"right",onPress:function(){var i,j;cr.keyboard_nav=true;j=eV.get_selected_files();if(j.length===1){i=j[0];if(i.dir){cr.select_index=0;cr.open_folder(i)}else{eV.flicker_selected()}}return false}},undo:{title:ey("Undo recent move/copy/rename/delete"),key:(key.main_modifier())+"+z",onPress:function(){X.perform_undo();return false}},search:{title:ey("Search"),key:"/",onPress:function(){bD(document).trigger("db:searchbar:focus");return false}}}};var af;af=E.BrowseSharedLink={store_shared_link_info:function(T,i,j){if(T.charAt(0)==="/"){T=T.substring(1)}this._shared_link_fq_dir=T;this._shared_link_file=j;return this._shared_link_url=i},shared_link_handler:function(i,j){if(af._shared_link_url==="/s/"+i||(af._shared_link_url==="/member_link/"+i&&i.indexOf("fi")===0)){a3.load_browse_view(void 0,encodeURIComponent(af._shared_link_fq_dir));cr.open_preview(af._shared_link_file)}else{if(af._shared_link_url==="/sh/"+i||(af._shared_link_url==="/member_link/"+i&&i.indexOf("fo")===0)){a3.load_browse_view(void 0,encodeURIComponent(af._shared_link_fq_dir));if(af._shared_link_file){cr.open_preview(af._shared_link_file)}}else{location.reload()}}return af.highlight_user()},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return a3.set_path_url(null,"/"+this._shared_link_fq_dir)}},highlight_user:function(){if(cr.active_user.role===Constants.ROLE_WORK){bD("#work-nav-item").addClass("selected");return bD("#personal-nav-item").removeClass("selected")}else{bD("#personal-nav-item").addClass("selected");return bD("#work-nav-item").removeClass("selected")}}};var a3;a3=E.BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(i){var j;j=eB.deconstruct_url().qargs;if(i in j){return !!j[i]}else{cJ(i in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[i]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(i,T){var j;if(i!==cr.active_user.root_ns&&(!(i in cr.ns_id_to_mount_point))){i=cr.active_user.root_ns}if(i===cr.active_user.root_ns){return T}else{j=cr.ns_id_to_mount_point[i];return j+T}},_make_url:function(i,fm,fn){var fo,fl,j,fk,T;if(fn==null){fn={}}if(!i){i=cr.active_user.root_ns}cJ(typeof i==="number","expected ns_id as a number");cJ(typeof fm==="string","expected explicit ns_path string");fo=this.ns_to_fq_path(i,fm);fk=G({path:fh.get_browse_root(cr.active_user)+fo});j=eB.deconstruct_url().qargs;for(fl in fn){T=fn[fl];if(fl in this._DEFAULTS&&!!T!==this._DEFAULTS[fl]){j[fl]=T}}for(fl in j){if(!(fl in this._DEFAULTS)){delete j[fl]}}return eB.construct_url(String(fk),j)},set_path_url:function(i,fm,fk){var fl,T,j;if(!i){i=cr.active_user.root_ns}else{T=parseInt(i,10);i=!isNaN(T)?T:Constants.root_ns}fm=aA.normalize(fm);j=fk!=null?this._make_url(i,fm,{d:fk?1:0}):this._make_url(i,fm);fl=eB.deconstruct_url(j);return eB.push_state(fl.path,fl.qargs)},set_del_url:function(i){var T,fk,j;j=eB.deconstruct_url();T=j.path;fk=j.qargs;if(i){fk.d="1"}else{delete fk.d}return eB.push_state(T,fk)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(i,fk,j){var fl,fm,T;if(j==null){j=false}key.setScope(cr.KEY_SCOPE);fk=aA.normalize(fk);T=false;if(!this._first_load){T=(!cr.inside_dir)||(fk!==this._last_ns_dir)||(i!==this._last_ns_id)||cr.in_search_mode()}fl=j!==cr.deleted_shown;cr.deleted_shown=j;if(this._first_load||T||fl){cr.reload(i,fk,true)}this._first_load=false;this._last_ns_dir=fk;this._last_ns_id=i;if(eV.get_selected_files().length){fm=eV.get_selected_files()[0].get_div();if(fm){return cr.scrollToWithPadding(fm,fm.getHeight()*2)}}},history_change_handler:function(fm,fn){var fk,fl,T,i,j;i=fn.ns;j=fn.d==="1";this.load_browse_view(i,fm,j);if(fn.preview!=null){fl="/"+G.encode(fn.preview);if(!!fm){fl="/"+fm+fl}fk=cr.find_file(G.decode(fl));if(fk!=null){if(az.getGandalfRule("file-viewer-react")){T=a5.getIndexOfFileInArray(cr.files,fk);return eZ.open(cr.files,T,cr.active_user,"react-file-viewer")}else{if(!(n.shown()&&n.file===fk)){return cr.open_preview(fk,Constants.OREF_CONSTANTS.BROWSE_UNKNOWN,true)}}}else{a9.UserActivityLogger.log("web","browse_preview_does_not_exist");return eB.replace_state(fh.get_browse_root(cr.active_user))}}else{if(!az.getGandalfRule("file-viewer-react")&&n.shown()){return n.hide()}else{if(az.getGandalfRule("file-viewer-react")&&eZ.isShown()){return eZ.close()}}}},parse_b2_hash:function(fl){var T,j,fk,i,fm;i=fl.split(":");if(i.length!==4){return false}fk=i[0];T=i[2]==="1";j=i[3];fm=!j||d3.isNumber(j);if(!fm){return false}j=parseInt(j,10)||Constants.root_ns;return{ns_id:j,ns_path:fk,deleted:T}}};var cQ;cQ=E.BrowseFile=Class.create({initialize:function(fk){var T,fl,j,i;T=aA.filename(fk.fq_path);this.allows_nesting=fk.allows_nesting;this.icon=fk.icon;this.filename=T;this.filename_highlights=(fl=fk.filename_highlights)!=null?fl:[];this.unresolved_comment_count=fk.unresolved_comment_count;this.unseen_comment_count=fk.unseen_comment_count;this.update_caption();this.ns_id=fk.ns_id;this.ns_path=fk.ns_path;this.fq_path=fk.fq_path;this.mount_point=fk.mount_point;this.hash=fk.hash;this.href=fk.href;this.size=fk.size!=="None"?fk.size:"";this.bytes=fk.bytes;this.is_deleted=this.bytes===-1;this.ago=fk.ago;this.ts=fk.ts;this.dir=fk.is_dir?1:0;this.target_ns=fk.target_ns;this.sort_rank=fk.sort_rank;this.sort_key=fk.sort_key||[""];this.sjid=fk.sjid;this.tkey=void 0;this.thumbnail_url_tmpl=fk.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=fk.large_thumbnail_url_tmpl;this.type=fk.type;this.preview_type=fk.preview_type;if(fk.last_modified_fname){this.last_modified_fname=bS.em_snippet(fk.last_modified_fname,cT)}this.htmlified_link=fk.htmlified_link;this.linkfile_link=fk.linkfile_link;this.direct_blockserver_link=fk.direct_blockserver_link;this.doc_preview_status=fk.doc_preview_status;this.in_root_coll=fk.in_root_coll;this.compressible=fk.compressible;this.user_id=fk.user_id;this.sf_perm_role=fk.sf_perm_role;this.fulltext_search=fk.fulltext_search;this.read_only=fk.read_only?true:false;this.is_read_only_mount=fk.is_read_only_mount?true:false;this.request_id=(j=fk.request_id)!=null?j:null;return this.match_type=(i=fk.match_type)!=null?i:"UNKNOWN_MATCH"},track_in_browse:function(){if(!(this.to_key() in cQ._file_index)){cr.add_file(this);return cQ._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===b7.SHARED_FOLDER||this.type===b7.TEAM_SHARED_FOLDER},is_team_shared_folder:function(){return this.type===b7.TEAM_SHARED_FOLDER},could_be_shared_folder:function(){var T,fk,i,j;fk=cr.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");j=cr.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";i=this.target_ns;T=this.ns_id!==Constants.root_ns;return this.type===b7.FOLDER&&!i&&!fk&&!j&&!this.is_sandbox()&&(!T||(cr.golden_gate_aware&&this.allows_nesting&&!cr.inside_read_only_shared_folder))},is_shared_single_file:function(){var i;i=this.ns_id!==Constants.root_ns;return this.type===b7.FILE&&i},could_be_shared_single_file:function(){var j,T,i;T=cr.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");i=cr.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";j=this.ns_id!==Constants.root_ns;return this.type===b7.FILE&&!(j||T||i)},is_sandbox:function(){return this.type===b7.SANDBOX},video_transcode_url:function(){return br.video_transcode_url(this.fq_path,this.hash,cr.active_user)},get_div:function(){return $("f_"+(this.to_key()))},rename:function(fl,fn,T,fk,fm,fo){var fp,i,j;i=this.fq_path;cr.pre_action_selection=[i];fp=cr.find_file(fl);if(fp){cr.remove_file(fp)}this.filename=aA.filename(fl);this.update_caption();this.fq_path=fl;this.ns_path=fn;this.htmlified_link=fo;this.hash=T;this.sort_key=fk;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){j=this.href.split("/");j[j.length-1]=d3.urlquote(this.filename)+("?w="+T);this.href=j.join("/");this.icon=fm}else{this.href="/home"+d3.urlquote(fl);if(this.target_ns){cr.ns_id_to_mount_point[this.target_ns]=fl}}if(cr.in_search_mode()){this.filename_highlights=[]}cQ._file_index[this.to_key()]=this;cr.update_file_pos(this);return bD(document).trigger(aH.RENAME,{old_fq_path:i,file:this})},edit:function(){var T,i,fk,j,fl;this.editing=true;cr.selectable();fl=(function(fm){return function(fu){var fo,fn,fr,fw,ft,fq,fx,fv,fs,fp;fp=fu.responseText.evalJSON(true);cJ(fp.new_browse_files.length===1,"No new file data returned.");fr=fp.new_browse_files.first();fw=fr.fq_path;ft=fr.hash;fs=d3.decode_sort_key(fr.sort_key);fx=fr.icon;fv=fr.ns_path;fq=fr.htmlified_link;fo=fp.changesets;fn=ey("Rename complete.");X.notifyWithUndo(fn,fo,dB.do_rollback);fm.rename(fw,fv,ft,fs,fx,fq);eV.set_selected_files([fm]);fm.get_div().smoothScrollIntoView();a5.load_visible_thumbs();return cr.fire_visible_change_callbacks()}})(this);i=G({path:"/cmd/rename"+this.fq_path}).updateQuery(Constants.UID_PARAM_NAME,cr.active_user).toString();fk=cr.in_search_mode()?".filename-col":".filename-col a";T=new Ajax.InPlaceEditor(this.get_div().down(fk),i,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(fm){return function(){return fm.editing=false}})(this),onFailure:function(){},savingText:ey("Saving..."),ajaxOptions:{job:true,subject_user:cr.active_user,html_in_error_msg:true,progress_text:ey("Renaming..."),method:"POST",onCreate:ah.clear,onSuccess:fl,onUninitialized:cr.unselectable},callback:(function(fm){return function(fn,fo){return{to_path:fo||"",folder:(fm.dir?"yes":"")}}})(this)});T.enterEditMode();j=this.get_div().down(".editor_field");if("selectionEnd" in j&&this.filename.lastIndexOf(".")>-1){return j.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return this.ns_id+"_"+this.sjid},get_category:function(){var j,i;if(this.dir){if(cr.inside_dir&&cr.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&cr.public_folder_enabled){j="PUBLIC_FOLDER"}}if(j==null){if(this.type===b7.FOLDER){j="FOLDER"}else{if(this.type===b7.PACKAGE){j="FOLDER"}else{if(this.type===b7.TEAM_SHARED_FOLDER){j="TEAM_SHARED_FOLDER"}else{if(this.type===b7.SHARED_FOLDER){j="SHARED_FOLDER"}else{if(this.type===b7.SANDBOX){j="SANDBOX"}else{if(this.target_ns){j="SHARED_FOLDER"}else{j="FOLDER"}}}}}}}}if(j==null){j=cQ.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}i=this.is_deleted?cQ.CATEGORY_TO_DELETED_TRANSLATION[j]:cQ.CATEGORY_TO_TRANSLATION[j];cJ(i,"CATEGORY MISSING FOR "+j);return i},get_icon_alt:function(){if(this.dir){if(this.is_shared_folder()){if(this.is_team_shared_folder()){if(this.is_read_only_mount){return ey("Read-only team folder")}else{return ey("Team folder")}}else{if(this.is_read_only_mount){return ey("Read-only shared folder")}else{return ey("Shared folder")}}}else{if(this.is_read_only_mount){return ey("Read-only folder")}else{return ey("Folder")}}}else{return""}},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return aA.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&cr.is_shmodelable_path(this.fq_path)},update_caption:function(){var i;i=cr.inside_dir?dm:ck;if(this.unresolved_comment_count>0){i-=aK}return this.caption=bS.em_snippet(this.filename,i)}});cQ._CATEGORIES={IMAGE:"bmp cr2 gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"ai cdr csv dbxlink doc docx docm eps fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};cQ.EXTENSION_TO_CATEGORY={};cQ.CATEGORY_TO_TRANSLATION={FILE:ey("file"),FOLDER:ey("folder"),SHARED_FOLDER:ey("shared folder"),TEAM_SHARED_FOLDER:ey("team folder"),PUBLIC_FOLDER:ey("folder"),IMAGE:ey("image"),VIDEO:ey("video"),AUDIO:ey("audio"),DOCUMENT:ey("document"),COMPRESSED_FILE:ey("archive"),CODE:ey("code"),DISK_IMAGE:ey("disk image"),EXECUTABLE:ey("executable"),SHORTCUT:ey("shortcut"),LINK:ey("link"),FONT:ey("font"),SANDBOX:ey("app folder")};cQ.CATEGORY_TO_DELETED_TRANSLATION={FILE:ey("deleted file"),FOLDER:ey("deleted folder"),SHARED_FOLDER:ey("deleted shared folder"),TEAM_SHARED_FOLDER:ey("deleted team folder"),PUBLIC_FOLDER:ey("deleted folder"),IMAGE:ey("deleted image"),VIDEO:ey("deleted video"),AUDIO:ey("deleted audio"),DOCUMENT:ey("deleted document"),COMPRESSED_FILE:ey("deleted archive"),CODE:ey("deleted code"),DISK_IMAGE:ey("deleted disk image"),EXECUTABLE:ey("deleted executable"),SHORTCUT:ey("deleted shortcut"),LINK:ey("deleted link"),FONT:ey("deleted font"),SANDBOX:ey("deleted app folder")};(function(){var fk,fl,j,T,i;T=cQ._CATEGORIES;i=[];for(fk in T){j=T[fk];i.push((function(){var fp,fo,fm,fn;fm=j.trim().split(" ");fn=[];for(fp=0,fo=fm.length;fp<fo;fp++){fl=fm[fp];fn.push(cQ.EXTENSION_TO_CATEGORY[fl]=fk)}return fn})())}return i})();cQ._file_index={};cQ.from_key=function(i){return cQ._file_index[i]};cQ.from_elem=function(j){var i;if(!j){return}i=j.readAttribute("data-identity");if(i){return cQ.from_key(i)}else{return cQ.from_elem(j.up("[data-identity]"))}};var a,eF,aj,e7,bL,dE,cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};a=INLINE_JS.BrowseActions=E.BrowseActions=Class.create({initialize:function(i){return this._set_files(i)},firefly_logging_helper:function(i){if(cr.in_search_mode()&&i){this._firefly_log_values.action_type=i;return a9.SearchClientActivityLogger.log("result_action",cr.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var i;i=this.get_files();if(i.length<2){return this._get_actions_single(i.first())}else{return this._get_actions_multi(i)}},get_files:function(){return this._files},get_action_by_name:function(i){return this.evaluate_action(a.option_dict[i],i)},evaluate_action:function(T,j){var fk,fl,i;fk=(function(fm){return function(fo,fn){if((fn!=null)&&(fo==null)){return fn}if(bD.isFunction(fo)){return fo.call(fm)}else{if(fo!=null){return fo}else{return fn}}}})(this);i={icon_href:T.icon_href,target:T.target,click_handler:T.click_handler,type:T.type,name:j||T.name,is_dropdown:!!T.is_dropdown,icon:fk(T.icon),text:fk(T.text),detail_text:fk(T.detail_text),href:fk(T.href,""),kind:fk(T.kind,"icon"),button_label:fk(T.button_label,T.text)};if(bD.isFunction(T.subactions)){i.subactions=T.subactions.call(this)}else{if(bD.isArray(T.subactions)){i.subactions=(function(){var fn,fm,fp,fo;fp=T.subactions;fo=[];for(fn=0,fm=fp.length;fn<fm;fn++){fl=fp[fn];fo.push(this.get_action_by_name(fl))}return fo}).call(this)}else{if(T.subactions){cJ(0,"subactions must be a function or an array of actions")}}}return i},_set_files:function(j){var i;this._files=$A(j);this._log_extras={};if(this.get_files().length>0){i=j.first();this._log_extras={path:i.fq_path,ns_id:i.ns_id};return this._firefly_log_values={file_nsid:i.ns_id,file_sjid:i.sjid,firefly:b9.firefly_enabled,match_type:i.match_type,position:i.sort_rank,request_id:i.request_id,viewport:"full-view"}}},_get_actions_single:function(fB){var fn,fq,fr,fw,T,fp,fk,fC,fo,fv,fl,fm,fx,fy,fz,i,fu,fs,fA,ft;fq=[];if(!fB){return[]}fw=cr.public_folder_enabled&&fB.fq_path.toLowerCase().startsWith("/public/");fv=cr.public_folder_enabled&&fB.fq_path.toLowerCase()==="/public";fC=fB.target_ns;fr=fB.ns_id!==Constants.root_ns;fm=fB.type===b7.SHARED_FOLDER;fl=fB.type===b7.SANDBOX;fo=fB.type===b7.PACKAGE;fk=fB.in_root_coll;fp=fB.compressible;if(fB.is_deleted){fq=fq.concat(["restore"]);if(!((i=cr.permanent_delete_is_disabled_by_ns_id)!=null?i[fB.ns_id]:void 0)){fq.push("purge")}}else{ft=(__CONDITIONAL_JS__.UnityFeatures!=null)&&((fu=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fu.is_cached_and_locally_available(fB.ns_id,fB.ns_path):void 0);fz=ft?"open":"download";if(fB.dir){if(fl){fq.push("app_info")}else{if(cr.simple_sharing_enabled){fq.push("share_folder_and_token")}else{if(fm){fq.push("sharing_options")}else{if(!(fr||fC||fw||fv)){fq.push("share")}}}}if(fB.is_shmodelable()&&!cr.simple_sharing_enabled){fq.push("token_share")}fq.push(fz);if(!fv){fq=fq.concat(["delete","rename","move"]);if(!(fo||fC)){fq.push("copy")}}if(cr.can_use_photos_features){if(cr.can_use_photos_features){fq.push("album_from_folder")}}}else{if(fw||cr.public_app_token){fq.push("copy_url")}else{if(cr.simple_sharing_react_member_list_enabled){fq.push("share_folder_and_token")}else{if(fB.is_shmodelable()){fq.push("token_share")}}}fq.push(fz);if(cr.can_show_preview(fB)&&cr.browser_supports_comments){fq.push("comment")}fq=fq.concat(["delete","rename","move","copy","revisions"]);if(fk&&cr.can_use_photos_features){if(cr.photos_experience==="carousel"){fq.push("view_in_carousel")}else{fq.push("view_in_photos")}}if(fp){fq.push("compress")}}if(!cr.simple_sharing_enabled){fA=false;fs=["sharing_options","share","token_share"];for(fx=0,fy=fs.length;fx<fy;fx++){fn=fs[fx];T=fq.indexOf(fn);if(T>-1){fq.splice(T,1);fA=true}}if(fB.is_shared_folder()||fB.could_be_shared_folder()){fq.unshift("single_entry_share_dropdown_variant_menu")}else{fq.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return fq},_get_actions_multi:function(fk){var i,j,T;if(Constants.send_a_copy_enabled){i=["send_copy","download"]}else{i=["download"]}i=i.concat(["delete","move","copy","restore","purge"]);if(cr.photos_experience==="carousel"){i.push("view_in_carousel")}else{i.push("view_in_photos")}j=a5.profile_files(fk);if(j.deleted>0||j.public_folder>0){i.removeItem("move");i.removeItem("copy");i.removeItem("delete")}if(j.shared_folders>0){i.removeItem("copy")}if(j.deleted>0){i.removeItem("send_copy");i.removeItem("delete");i.removeItem("download")}if(!cr.inside_dir){i.removeItem("download")}if(!(j.deleted===fk.length&&(j.shared_folders===0||((j.shared_folders===(T=fk.length)&&T===1))))){i.removeItem("restore")}if(!(j.deleted===fk.length&&j.can_permanently_delete===fk.length)){i.removeItem("purge")}if(j.in_root_coll!==fk.length||!cr.can_use_photos_features){i.removeItem("view_in_photos");i.removeItem("view_in_carousel")}return i},_show_appropriate_sharing_modals:function(j,i){var T;if((cr.simple_sharing_enabled&&j.dir)||cr.simple_sharing_react_member_list_enabled){if(d1.get_for_user(cr.active_user).verified_or_show()){eD.createAndShowInbandModalFromBrowseFile(cr.active_user,j)}return}if(j.is_shared_folder()){a9.ShmodelUILogger.log_with_target_file("sf_options",i,j);return s.show_shared_folder_options_modal(j.fq_path,cr.active_user)}else{if(j.could_be_shared_folder()){a9.ShmodelUILogger.log_with_target_file("sf_invite",i,j);return s.show_share_existing_modal(j.fq_path,cr.active_user)}else{a9.ShmodelUILogger.log_with_target_file("token_share",i,j);T=j.fq_path;cJ(T,"token_share: expected non-root fq_path");return dv.shmodel(T,i+"_token_share")}}},get_disabled_action_names:function(){var T,fl,fk,i,fm;T=false;fm=this.get_files();for(fk=0,i=fm.length;fk<i;fk++){fl=fm[fk];T=true;if(!fl.read_only){T=false;break}}if(cr.inside_read_only_shared_folder||T){return["move","rename","delete","restore","purge","upload","new_folder","compress"]}else{return[]}},show_disabled_action_warning:function(i){if(cr.inside_read_only_shared_folder){if(i==="move"){return ah.warning(ey("You don't have permission to move files in this folder."))}else{if(i==="rename"){return ah.warning(ey("You don't have permission to rename files in this folder."))}else{if(i==="delete"){return ah.warning(ey("You don't have permission to delete files in this folder."))}else{if(i==="restore"){return ah.warning(ey("You don't have permission to restore files in this folder."))}else{if(i==="purge"){return ah.warning(ey("You don't have permission to permanently delete files in this folder."))}else{if(i==="upload"){return ah.warning(ey("You don't have permission to upload files into this folder."))}else{if(i==="new_folder"){return ah.warning(ey("You don't have permission to create a new folder in this folder."))}else{if(i==="compress"){return ah.warning(ey("You don't have permision to create a compressed file in this folder."))}else{return ah.warning(ey("You only have permission to view this folder."))}}}}}}}}}else{return ah.warning(ey("You do not have permission to perform the requested action."))}}});Object.extend(a,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(j){var i,T;fa.show(a5.append_ellipsis(ey("Copy public link")),dt.fromElm("copy-public-url"),{wit_group:"copy_public_link"});fa.onHide=function(){$("flash_copy_container").remove();delete fa.onHide;return fa.hide()};i=t.clipboard_overlay(j,bD("#real_copy"),function(){ah.success(ey("Link copied to clipboard!"));return fa.hide()});i.css({zIndex:1001});T=$("modal-content").down("#public_url");cJ(T,"Text element not found for copy pulic link");T.setValue(j);return T.select()},shortenPublicLink:function(){var i;d3.shorten_url($F("public_url"),a.updatePublicLink);i=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif",className:"right"});return $("modal-content").down("a").__date(i)},updatePublicLink:function(j){var i;$("public_url").setValue(j);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();i=t.clipboard_overlay(j,bD("#real_copy"),function(){ah.success(ey("Link copied to clipboard!"));return fa.hide()});return i.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:ey("New folder"),click_handler:function(i){return cr.new_folder()}},global_restore:{icon:"restore",text:function(){cJ(cr.inside_deleted_dir,"Global restore from not a deleted dir");if(cr.inside_deleted_shared_folder){return a5.append_ellipsis(ey("Rejoin shared folder"))}else{if(cr.inside_deleted_sandbox){return ey("Restore app folder")}else{return ey("Restore folder")}}},click_handler:function(){var fk,fl,j,i,T;fk=cr.containing_fq_path();j=fk.toLowerCase();if(cr.inside_deleted_sandbox){cJ(cr.old_path_to_ns_id[j],"Deleted sandbox missing nsid");return bg.restore_sandbox(cr.active_user,fk,cr.old_path_to_ns_id[j])}else{if(cr.inside_deleted_shared_folder){cJ(cr.old_path_to_ns_id[j],"Deleted shared folder missing nsid");return s.show_rejoin_modal(cr.active_user,fk,cr.old_path_to_ns_id[j])}else{fl=G.parse(location.href).setFragment("").toString();i={prev:fl};i[Constants.UID_PARAM_NAME]=cr.active_user;T=G({path:"/restore"+fk}).updateQuery(i);return window.location.href=String(T)}}}},restore:{icon:"restore",text:function(){var j,i;j=this.get_files();i=a5.profile_files(j);if(i.shared_folders===j.length){return a5.append_ellipsis(bb("Rejoin shared folder","Rejoin shared folders",j.length,{comment:"BUTTON"}))}else{return a5.append_ellipsis(ey("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var T,fn,j,fo,fm,i,fl,fk;fn=this.get_files();if(fn.length===0){}else{if(fn.length===1){T=fn.first();if(!T.is_deleted){return}fo=T.fq_path;j=fo.toLowerCase();if(T.type===b7.SANDBOX){cJ(cr.old_path_to_ns_id[j],"Restore missing ns");bg.restore_sandbox(cr.active_user,fo,cr.old_path_to_ns_id[j])}else{if((fl=T.type)===b7.SHARED_FOLDER||fl===b7.TEAM_SHARED_FOLDER){cJ(cr.old_path_to_ns_id[j],"Rejoin missing ns");s.show_rejoin_modal(cr.active_user,fo,cr.old_path_to_ns_id[j])}else{if(T.dir){fm=G.parse(location.href).updateQuery({select:T.filename});i={prev:String(fm)};i[Constants.UID_PARAM_NAME]=cr.active_user;fk=G({path:"/restore"+T.fq_path}).updateQuery(i);window.location=String(fk)}else{dB.show_undelete(T)}}}}else{return dB.show_bulk_restore(fn,cr.active_user)}}}},global_share:{icon:"rainbow_16",text:function(){if(cr.inside_shared_folder){return a5.append_ellipsis(ey("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(cr.containing_fq_path()===""){return a5.append_ellipsis(ey("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return a5.append_ellipsis(ey("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}},click_handler:function(T){var j,i;T.preventDefault();if(cr.containing_fq_path()===""){return s.start_wizard_for_user(cr.active_user)}else{if(cr.simple_sharing_enabled){if(d1.get_for_user(cr.active_user).verified_or_show()){j=cr.inside_shared_folder&&!cr.containing_ns_path();i=j?cr.containing_ns_id():void 0;return eD.createAndShowInbandModal(cr.active_user,cr.containing_fq_path(),true,i,j,!cr.inside_shared_folder,cr.containing_sf_perm_role())}}else{if(cr.inside_shared_folder){return s.show_shared_folder_options_modal(cr.containing_mount_point(),cr.active_user)}else{return s.show_share_existing_modal(cr.containing_fq_path(),cr.active_user)}}}}},sharing_options:{icon:"rainbow_16",text:a5.append_ellipsis(ey("Shared folder options",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();a9.ShmodelUILogger.log_with_target_file("sf_options",i,j);return s.show_shared_folder_options_modal(j.fq_path,cr.active_user)}},share:{icon:"rainbow_16",text:a5.append_ellipsis(ey("Invite to folder",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();a9.ShmodelUILogger.log_with_target_file("sf_invite",i,j);return s.show_share_existing_modal(j.fq_path,cr.active_user)}},share_folder_and_token:{icon:"rainbow_16",text:a5.append_ellipsis(ey("Share",{comment:"BUTTON"})),click_handler:function(T,i){var j;j=this.get_files().first();return this._show_appropriate_sharing_modals(j,i)}},revisions:{icon:"previous_versions",click_handler:function(){return window.location.href=dB.build_revisions_uri(this.get_files().first().fq_path,cr.active_user)},text:ey("Previous versions",{comment:"BUTTON"})},token_share:{icon:"s_link",text:a5.append_ellipsis(ey("Share link",{comment:"BUTTON"})),click_handler:function(fk,i){var j,T;j=this.get_files().first();a9.ShmodelUILogger.log_with_target_file("token_share",i,j);T=j.fq_path;cJ(T,"token_share: expected non-root fq_path");return dv.shmodel(T,i+"_token_share")}},global_token_share:{icon:"s_link",text:a5.append_ellipsis(ey("Share link",{comment:"BUTTON"})),click_handler:function(j,i){a9.ShmodelUILogger.log("via-global-toolbar");return dv.shmodel(cr.containing_fq_path(),i+"_global_token_share")}},copy_url:{icon:"world_link",text:a5.append_ellipsis(ey("Copy public link",{comment:"BUTTON"})),click_handler:function(T){var j,i;j=this.get_files().first();if(cr.public_app_token){i="/spa/"+cr.public_app_token+j.ns_path}else{i="/u/"+cr.active_user.id+j.fq_path.substring(a.PUBLIC_FOLDER_PATH_LENGTH)}return a.showCopyPublicUrlModal(String(new G({scheme:"https",authority:Constants.PUBSERVER,path:i})))}},download:{icon:"download",text:function(){return ey("Download",{comment:"BUTTON"})},click_handler:function(){var fl,fk,i,fn,fp,fo,fm,T,j;i=this.get_files();if(i.length===1&&!i[0].dir){fk=i.first();T=[Constants.protocol,Constants.BLOCK_CLUSTER,fk.fq_path,fk.hash],fo=T[0],fl=T[1],fp=T[2],fn=T[3];fm={w:fn,dl:1};j=G({scheme:fo,authority:fl,path:"/get"+fp,query:fm});return window.location=String(j.updateQuery(Constants.UID_PARAM_NAME,cr.active_user))}else{return dB.do_bulk_download(i)}}},view:{href:function(){var fm,i,fk,T,fl,j;i=this.get_files().first();j=[Constants.protocol,Constants.BLOCK_CLUSTER,d3.urlquote(i.fq_path),i.hash],fl=j[0],fm=j[1],T=j[2],fk=j[3];return fl+"://"+fm+"/get"+T+"?w="+fk},icon:"page_white_magnify",text:ey("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return s.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:ey("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(i){return cr.toggle_deleted()},icon:"trash-can",text:ey("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(i){return cr.toggle_deleted()},icon:"trash-can-open",text:ey("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:a5.append_ellipsis(ey("Copy",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dB.show_copy(i.fq_path,i.dir)}else{if(j.length>1){return dB.show_copy_bulk(j)}}}},move:{icon:"move_16",text:a5.append_ellipsis(ey("Move",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dB.show_move(i.fq_path,i.dir)}else{if(j.length>1){return dB.show_move_bulk(j)}}}},rename:{icon:"rename",text:ey("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:a5.append_ellipsis(ey("Delete",{comment:"BUTTON"})),click_handler:function(fq){var fn,fm,T,fp,fo,fl,fr,fk;T=this.get_files();fr=T.length;if(fr>=1){fl=T[0].mount_point;if(fl){for(fp=fo=1,fk=fr;1<=fk?fo<fk:fo>fk;fp=1<=fk?++fo:--fo){if(T[fp].mount_point!==fl){fl="";break}}}if(fl){fn=aA.filename(fl)}else{fn=null}if(fr>1){return dB.show_bulk_delete(cr.active_user,T,fn)}else{if(fr===1){fm=T[0];return dB.show_delete(cr.active_user,fm.fq_path,fm.dir,void 0,fn)}}}}},global_purge:{icon:"cancel",text:a5.append_ellipsis(ey("Permanently delete folder")),click_handler:function(){return dB.show_purge(cr.containing_fq_path(),true)}},purge:{icon:"cancel",text:a5.append_ellipsis(ey("Permanently delete",{comment:"BUTTON"})),click_handler:function(T){var i,j;j=this.get_files();if(j.length===1){i=j.first();return dB.show_purge(i.fq_path,i.dir)}else{return dB.show_bulk_purge(j)}}},upload:{icon:"upload_16",text:a5.append_ellipsis(ey("Upload")),click_handler:function(i){return dB.show_upload()}},app_info:{icon:"application_double",text:a5.append_ellipsis(ey("Application info")),click_handler:function(i){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:ey("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:ey("More actions"),click_handler:function(){bL.show_secondary();return document.body.observe("click",bL.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return ey("View in Photos")},click_handler:function(){var i;i=this.get_files();return dB.do_bulk_photo_view(i,cr.photos_experience)}},compress:{icon:"s_photo",text:function(){return ey("Compress (experimental)")},click_handler:function(){var i;i=this.get_files();return dB.show_compress_bulk(cr.active_user,i)}},view_in_carousel:{icon:"s_carousel",text:function(){return ey("View in Timeline")},click_handler:function(){var i;i=this.get_files();return dB.do_bulk_photo_view(i,"carousel")}},album_from_folder:{icon:"create-album",text:function(){return ey("Create album")},click_handler:function(){var j,i;j=this.get_files();i=j.first();return dB.create_album_from_folder(i.fq_path,i.filename)}},open:{icon:"open",text:function(){return ey("Open")},click_handler:function(){var i;i=this.get_files().first();return __CONDITIONAL_JS__.UnityFeatures.open_file(i.ns_id,i.ns_path,i.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(j){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}},comment:{icon:"s_file_comment",text:function(){return ey("Comment",{comment:"BUTTON"})},click_handler:function(i){var j;j=this.get_files().first();return cr.open_preview(j,i,false,true)}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:a5.append_ellipsis(ey("Share")),click_handler:function(T,i){var j;j=this.get_files().first();a9.ShmodelUILogger.log_with_target_file("single_entry_share_click",i,j);return dv.shmodel(j.fq_path,i)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:a5.append_ellipsis(ey("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(T,i){var j;j=this.get_files().first();return a9.ShmodelUILogger.log_with_target_file("single_entry_share_hover",i,j)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:a5.append_ellipsis(ey("Invite people to collaborate")),click_handler:function(fm,i){var T,fk,fl,j;T=this.get_files().first();if(T.is_shared_folder()){if(d1.get_for_user(cr.active_user).verified_or_show()){a9.ShmodelUILogger.log_with_target_file("sf_options",i,T);fk=new de(cr.active_user,T.fq_path);return fk.show()}}else{j=cr.verify_email_after_share_experiment_variant;fl=j&&j==="VERIFY_LAST";if(fl){a9.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(j){a9.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fl||d1.get_for_user(cr.active_user).verified_or_show()){a9.ShmodelUILogger.log_with_target_file("sf_invite",i,T);fk=new cn(cr.active_user,{folder_name:T.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+cr.active_user.id,must_check_verified:fl});return fk.show()}}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:a5.append_ellipsis(ey("Send link")),click_handler:function(T,i){var j;j=this.get_files().first();a9.ShmodelUILogger.log_with_target_file("token_share",i,j);return dv.shmodel(j.fq_path,i)}}}});aj=E.BrowseActionsContext=Class.create(a,{initialize:function($super,i){$super(i);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");bD("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));bD("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));bD("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return bD("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(fk,j){var T,i;T=j.readAttribute("data-value");if(cR.call(this.get_disabled_action_names(),T)>=0){this.show_disabled_action_warning(T);return false}a9.TimeToFirstActionLogger.log(cr.active_user.id,T);this.firefly_logging_helper(T);i=a.option_dict[T];a9.BrowseActionsContextMenuLogger.log(this.get_files(),T);if(!i.is_dropdown||j.hasAttribute("submenu-index")){bl.hide()}fk.preventDefault();i.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_CONTEXTMENU,fk,"browse_actions_context");if(T==="sharing_options"){a9.SharedFolderActivityLogger.log("web","browse_view_options",cr.active_user,this._log_extra,true)}if(T==="share"){return a9.SharedFolderActivityLogger.log("web","browse_view_share_existing",cr.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return bD("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(i){return bD(i).removeClass("hover")},_enter:function(fk){var T,i,j;T=bD(fk.currentTarget).data("value");cJ(T);i=a.option_dict[T];cJ(i,"Action info is missing for "+T);return(j=i.hover_handler)!=null?j.call(this,fk,"browse_actions_context"):void 0},_over:function(i){if(bD(i.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return bD(i.currentTarget).addClass("hover")}},_out:function(i){if(bD(i.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(j){return function(){return j._reset_submenu(i.currentTarget)}})(this),300)}}});eF=E.BrowseActionsBasic=Class.create(a,{initialize:function($super){var i;i=eV.get_selected_files();$super(i);this._render();return this._listen()},_listen:function(){var i;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(eV.UPDATED_EVT,this.bound_update);document.observe(bl.SHOW_EVT,this.bound_disable);document.observe(bl.HIDE_EVT,this.bound_enable);i=$("browse-root-actions");i.stopObserving("click");return i.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(eV.UPDATED_EVT,this.bound_update);document.stopObserving(bl.SHOW_EVT,this.bound_disable);document.stopObserving(bl.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(eV.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(T){var j,i;i="#browse-root-actions #"+T+"_action_button";j=bD(i);j.addClass("disabled");return j.click((function(fk){return function(fl){fk.show_disabled_action_warning(T);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var fK,fC,fF,fs,fJ,fL,fM,fB,fE,fv,i,fm,fn,fq,fo,fG,fD,fz,fH,fr,fp,fI,fl,fN,fy,T,fw,fu,ft,fx,fA,fk;fm=this.get_files();fF=this.get_action_names();if(!cr.simple_sharing_enabled){ft=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(fG=0,fH=ft.length;fG<fH;fG++){fC=ft[fG];fo=fF.indexOf(fC);if(fo>-1){fF.splice(fo,1);break}}}fK=13.5;fE="";fn="";if(fm.length===1){fE=bS.em_snippet(fm[0].filename,fK);if(!fm[0].dir&&fm[0].bytes>=0){fn=fm[0].size}}else{if(1<fm.length){T=a5.profile_files(fm);fI=[];if(T.files){fl=bb("%d file","%d files",T.files).format(T.files);fI.push(fl)}if(T.folders){fl=bb("%d folder","%d folders",T.folders).format(T.folders);fI.push(fl)}fE=d3.nice_list(fI)}}fL=$("browse-root-actions");fJ=fL.getLayout().get("width");fq=fL.getStyle("font-size");cJ(fq.endsWith("px"),"Invalid font size "+fq);fq=parseInt(fq,10);fv=new bS(fE).length*fq;fx=new bS(fn).length*fq;fJ-=fv+fx;fA=[];fu=[];fJ-=30;for(fD=0,fr=fF.length;fD<fr;fD++){fN=fF[fD];fC=this.get_action_by_name(fN);fk=new bS(fC.text).length*fq;fM=fk+16+8+10+9;if(fJ>fM){fA.push(fN)}else{if(fu.length===0){fy=fA.pop();fu.push(fy)}fu.push(fN)}fJ-=fM}if(fu.length){fA.push("more_actions")}fs=(function(){var j,fO,fP;fP=[];for(j=0,fO=fA.length;j<fO;j++){fN=fA[j];fP.push(this.get_action_by_name(fN))}return fP}).call(this);if(fu.length){fs[fs.length-1].subactions=(function(){var j,fO,fP;fP=[];for(j=0,fO=fu.length;j<fO;j++){fN=fu[j];fP.push(this.get_action_by_name(fN))}return fP}).call(this)}fB=ff.tmpl("actions_bar_tmpl",{context:this,description:fE,filesize:fn,has_actions:!!fF.length,actions:fs,_:ey,Sprite:cv});$("browse-root-actions").__date(fB);i=this.get_disabled_action_names();fw=[];for(fz=0,fp=i.length;fz<fp;fz++){fC=i[fz];fw.push(this._disable_action(fC))}return fw},_click:function(fk,j){var T,i;T=j.readAttribute("data-value");cJ(T);this.firefly_logging_helper(T);i=a.option_dict[T];cJ(i,"Action info is missing for "+T);fk.preventDefault();a9.TimeToFirstActionLogger.log(cr.active_user.id,T);i.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_BUTTON,fk,"browse_actions_basic");if(T==="sharing_options"){a9.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",cr.active_user,this._log_extras,true)}if(T==="share"){return a9.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",cr.active_user,this._log_extras,true)}}});Object.extend(eF,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos","view_in_carousel","compress"]});e7=E.GlobalActions=Class.create(a,{initialize:function($super){return $super()},get_action_names:function(){var i;if(!cr.inside_dir){return[]}i=[];if(!cr.inside_deleted_dir){i=i.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){i.push("global_share")}if(this._should_show_share_link()){i.push("global_token_share")}if(!Constants.can_see_trash){i.push((cr.deleted_shown?"hide_del":"show_del"))}}else{i=i.concat(["global_restore"])}return i},_should_show_shared_folder_options:function(){return !cr.is_in_subfolder_of_shared_folder()&&!cr.inside_sandbox},_should_show_share_link:function(){return cr.is_shmodelable_path(cr.containing_fq_path())}});bL=E.GlobalActionsBasic=Class.create(e7,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(bl.SHOW_EVT,this._disable.bind(this));return document.observe(bl.HIDE_EVT,this._enable.bind(this))},_render:function(){var fk,fl,fp,ft,fu,fm,fq,i,T,fo,fn,fs,fr;fl=this.get_action_names();fr=fl.intersect(bL.STANDARD_ACTIONS);fn=fl.without.apply(fl,bL.STANDARD_ACTIONS);if(fn.length===1){fr=fl;fn=[]}if(fn.length){fr.push("more_global_actions")}fs=(function(){var fw,fv,fx;fx=[];for(fw=0,fv=fr.length;fw<fv;fw++){i=fr[fw];fx.push(this.get_action_by_name(i))}return fx}).call(this);fp=(function(){var fw,fv,fx;fx=[];for(fw=0,fv=fs.length;fw<fv;fw++){fk=fs[fw];if(fk.kind==="button"){fx.push(fk)}}return fx})();T=(function(){var fw,fv,fx;fx=[];for(fw=0,fv=fs.length;fw<fv;fw++){fk=fs[fw];if(fk.kind!=="button"){fx.push(fk)}}return fx})();ft=ff.tmpl("global_actions_tmpl",{context:this,standard_actions:fp.concat(T),secondary_actions:(function(){var fw,fv,fx;fx=[];for(fw=0,fv=fn.length;fw<fv;fw++){i=fn[fw];fx.push(this.get_action_by_name(i))}return fx}).call(this),Sprite:cv});$("global-actions").__date(ft);bD(document).trigger(dL.GA_RENDERED);fu=this.get_disabled_action_names();fo=[];for(fm=0,fq=fu.length;fm<fq;fm++){fk=fu[fm];fo.push(this._disable_action(fk))}return fo},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(T){var j,i;i="#global-actions #"+T+"_button";j=bD(i);j.addClass("disabled");return j.click((function(fk){return function(fl){fk.show_disabled_action_warning(T);return false}})(this))},_enable:function(){var fl,fm,T,i,fk;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");fm=this.get_disabled_action_names();fk=[];for(T=0,i=fm.length;T<i;T++){fl=fm[T];fk.push(this._disable_action(fl))}return fk},_click:function(fk,j){var T,i;T=j.readAttribute("data-value");cJ(T);i=a.option_dict[T];cJ(i,"Action info is missing for "+T);bL.hide_secondary();eV.deselect_all();fk.preventDefault();i.click_handler.call(this,fk,"global_actions_basic");if(T==="global_share"){if(this._log_extras.path===""){return a9.SharedFolderActivityLogger.log("web","browse_view_share_button",cr.active_user,this._log_extras,true)}else{return a9.SharedFolderActivityLogger.log("web","folder_view_share_button",cr.active_user,this._log_extras,true)}}}});Object.extend(bL,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge"],show_secondary:function(){var i,j;j=$("secondary-actions");i=$("more_global_actions_button");j.show();return i.addClassName("down")},hide_secondary:function(){var i,j;j=$("secondary-actions");if(!j){return}i=$("more_global_actions_button");j.hide();return i.removeClassName("down")}});dE=E.GlobalActionsContext=Class.create(e7,{initialize:function($super,i){$super(i);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fk,j){var T,i;T=j.readAttribute("data-value");if(cR.call(this.get_disabled_action_names(),T)>=0){this.show_disabled_action_warning(T);return false}this.firefly_logging_helper(T);i=a.option_dict[T];eV.deselect_all();if(!i.is_dropdown){bl.hide()}fk.preventDefault();i.click_handler.call(this,fk,"global_actions_context");if(T==="global_share"){if(this._log_extras.path===""){return a9.SharedFolderActivityLogger.log("web","browse_view_right_click_share",cr.active_user,this._log_extras,true)}else{if(cr.inside_shared_folder){return a9.SharedFolderActivityLogger.log("web","folder_view_right_click_options",cr.active_user,this._log_extras,true)}else{return a9.SharedFolderActivityLogger.log("web","folder_view_right_click_share",cr.active_user,this._log_extras,true)}}}}});var y;y=E.BrowseClipboard=(function(){var fp,fm,T,fn,fl,fr,ft,fo,j,i,fq,fk,fs;fp=0;fm=1;fl=[];T=null;fs=function(){var fx,fy,fw,fv,fu,fz;if(C.focus_in_input()){return}fw=eV.get_selected_files();if(fw&&fw.length){for(fv=0,fu=fw.length;fv<fu;fv++){fy=fw[fv];if(fy.bytes<0){ah.error(ey("Deleted files cannot be added to the clipboard"));return false}else{if(fy.target_ns){fz=ey("'%(filename)s' cannot be added to the clipboard");fz=fz.format({filename:fy.filename});ah.error(fz);return false}}}fl=fw;fx=fw.length;fz=bb("Added %d item to clipboard","Added %d items to clipboard",fx).format(fx);ah.success(fz);return true}};fr=function(){if(fs()){T=fp;return false}};ft=function(){if(fs()){T=fm;return false}};fo=function(fu){var fv;cJ(typeof fu!=="undefined","BrowseClipboard _paste got an undefined path");if(fl.length){fv=T===fp?dB.do_bulk_copy:dB.do_bulk_move;fv(fl,fu);return true}};fk=function(fu){var fv;if(C.focus_in_input()||cr.in_search_mode()||cr.inside_deleted_dir){return}fv=fo(cr.containing_fq_path());if(fv){return false}};fn=function(){return fl=[]};i=function(fB){var fA,fy,fz,fx,fw,fu,fv;fz=fB.memo.files;for(fx=0,fu=fz.length;fx<fu;fx++){fy=fz[fx];for(fw=0,fv=fl.length;fw<fv;fw++){fA=fl[fw];if(fA.fq_path===fy.fq_path||fA.fq_path.startsWith(fy.fq_path+"/")){fn();return}}}};j=function(fu){cJ((fu.memo.file!=null)&&(fu.memo.files==null));fu.memo.files=[fu.memo.file];return i(fu)};fq=function(){var fy,fw,fv,fu,fx;bD(document).on(aH.RENAME,(function(fz){return function(fA,fB){fA.memo=fB;return j(fA)}})(this));fx=[aH.DELETE,aH.MOVE];for(fw=0,fv=fx.length;fw<fv;fw++){fy=fx[fw];document.observe(fy,i)}fu=key.main_modifier();key(fu+"+c",cr.KEY_SCOPE,fr);key(fu+"+x",cr.KEY_SCOPE,ft);return key(fu+"+v",cr.KEY_SCOPE,fk)};return{init:function(){return fq()}}})();var eV,aE;eV=E.BrowseSelection=(function(){var fH,fN,fK,fG,fn,fm,fD,fI,fv,fl,fM,fF,fz,fy,fp,fB,j,i,fu,fA,fO,ft,fr,fw,fq,fk,fo,fE,fC,T,fL,fJ,fs,fx;fo=[];fG=null;fl=null;fI=null;fm=[];fJ=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");eV.get_selected_files().invoke("get_div").findAll(function(fP){return fP}).invoke("addClassName","file-select");if(eV.get_selected_files().length===1){return eV.get_selected_files().invoke("get_div").findAll(function(fP){return fP}).invoke("addClassName","file-select-one")}};fs=function(){if(fI){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(cr.in_search_mode()){return}return eV.get_selected_files().filter(function(fP){return !fP.editing}).invoke("get_div").findAll(function(fP){return fP}).invoke("writeAttribute","draggable","true")};fx=function(fP){fP.apply(null,$A(arguments).slice(1));return document.fire(eV.UPDATED_EVT)};fE=function(fR,fQ){var fS,fP;fP=fo.length;fo=(fR instanceof cQ?[fR]:$A(fR));if(fo.length!==fP){eG("Selected",fo.length,"files")}fS=fQ||fo.last();cJ(!fS||fS instanceof cQ,"Invalid anchor type"+fS);return fG=fS};fE=fE.wrap(fx);fH=function(fQ,fP){if(fQ){fo.push(fQ)}return fG=fP||fQ};fH=fH.wrap(fx);fr=function(fP){var fQ;fQ=fo.indexOf(fP);if(fQ===-1){return}return fo.splice(fQ,1)};fr=fr.wrap(fx);fw=function(){return fo=[]};fw=fw.wrap(fx);fC=function(fP){fm=fP;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return fP.invoke("get_div").findAll(function(fQ){return fQ}).invoke("addClassName","context-select")};j=function(fY){var fV,fT,fS,fU,f1,fR,f0,f2,fP,fX,fZ,fW,fQ;fW=$(fY.target);f2=fW.match("li.browse-file")?fW:fW.up("li.browse-file");fV=fW.match("a")?fW:fW.up("a");fS=cQ.from_elem(f2);if(fY.isRightClick()||!f2||fV||f2.hasClassName("unselectable")){return}cr.keyboard_nav=false;if(fm.length){return}fR=d3.is_mac();if((fR&&fY.metaKey)||(!fR&&fY.ctrlKey)){if(fo.indexOf(fS)===-1){return fH(fS)}else{return fr(fS)}}else{if(fY.shiftKey){fT=cr.files.indexOf(fG);fQ=cr.files.indexOf(fS);f0=cr.files.indexOf(fo.last());fX=fo.slice(0);f1=f0<fT?-1:1;fU=fT;while(fU!==f0){fU+=f1;fZ=fX.indexOf(cr.files[fU]);if(fZ!==-1){fX.splice(fZ,1)}}f1=fQ<fT?-1:1;fU=fT;while(fU!==fQ){fU+=f1;fP=fX.indexOf(cr.files[fU]);if(fP!==-1){fX.splice(fP,1)}fX.push(cr.files[fU])}return fE(fX,fG)}else{return fE(fS)}}};i=function(fV){var fY,fR,fS,fU,fX,fW,fQ,fP,fT;if(fV.isRightClick()||fm.length||d3.in_scrollbar(fV.pointerX())){return}fW=$(fV.target);if(Element.match(fW,"object")){fW=fW.parentNode}fT=["browse-box","context-menu-container","modal","modal-overlay"];fQ=false;for(fS=0,fU=fT.length;fS<fU;fS++){fP=fT[fS];if(fW.descendantOf(fP)||fW.match("#"+fP)){fQ=true;break}}if(!fQ){fE();return}fX=fW.match("li.browse-file")?fW:fW.up("li.browse-file");fR=cQ.from_elem(fX);fY=fW.match("[draggable]")||fW.up("[draggable]");if(fR&&!fY){fl=fG;if(!fV.shiftKey){if(fR){fl=fR}else{if(fW.match("#browse-files")){fl=cr.files.last()}}}fI=[];if(fV.metaKey||fV.ctrlKey){return fI=eV.get_selected_files()}}};T=function(fR){var fQ,fP;fQ=cQ.from_elem(fB(fR));fR.preventDefault();if(!fQ){return}fP="browse_file_row";a9.ShmodelUILogger.log_with_target_file("token_share",fP,fQ);return dv.shmodel(fQ.fq_path,fP)};fB=function(fQ){var fP;fP=$(fQ.target);if(fP.match("li.browse-file")){return fP}else{return fP.up("li.browse-file")}};fp=(function(fP){return function(fY){var f1,fS,fQ,fT,f0,fZ,fR,fW,f2,fX,fU,fV;fX=cr.sharing_single_file_collaboration&&cr.sharing_single_file_collaboration==="SINGLE_FILE_SHARING";f0=fB(fY);fS=cQ.from_elem(f0);fY.preventDefault();if(!fS){return}fZ="browse_file_row";fV=a9.ShmodelUILogger.get_target_item(fS);a9.ShmodelUILogger.log("single_entry_share",fZ,fV);fT=cr.simple_sharing_enabled;fW=bD(f0).find(".inline-share-button")[0];if(!cr.in_search_mode()){fW=bD(f0).find(".sharing .inline-share-button")[0]}fU=fS.dir&&(fS.is_shared_folder()||fS.could_be_shared_folder());f1=d1.get_for_user(cr.active_user).verified_or_show();if(cr.simple_sharing_react_member_list_enabled&&f1){return eD.createAndShowInbandModalFromBrowseFile(cr.active_user,fS)}else{if(cr.simple_sharing_individual_files_enabled&&!fS.dir&&f1){return eD.createAndShowInbandModalFromBrowseFile(cr.active_user,fS)}else{if(fU){if(fT){if(f1){return eD.createAndShowInbandModalFromBrowseFile(cr.active_user,fS)}}else{return aE.open(fS.fq_path,fS.is_shared_folder(),fW,cr.active_user,fV)}}else{if(cr.simple_sharing_to_file_enabled&&((fR=__CONDITIONAL_JS__.OpenWith)!=null?fR.file_supported(fS):void 0)){if(f1){return eD.createAndShowInbandModalFromBrowseFile(cr.active_user,fS)}}else{if(fX&&(fS.is_shared_single_file()||fS.could_be_shared_single_file())&&!fT){return aE.open(fS.fq_path,fS.is_shared_single_file(),fW,cr.active_user,fV,fQ=true,fS.mount_point)}else{f2=function(){return dv.shmodel(fS.fq_path,fZ)};eV.firefly_logging_helper(fS,"single_entry_share_button_file_link");return cw.show_modal(fY,cr.active_user.id,f2)}}}}}}})(this);fn=function(fS){var fQ,fP,fR;fR=$(fS.target);fP=fR.match("li.browse-file")?fR:fR.up("li.browse-file");fQ=cQ.from_elem(fP);if(fQ){return j(fS)}};fy=null;fM=function(){var fP;clearInterval(fy);fP=function(){cr.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return fy=setTimeout(fP,100)};fD=function(){if(!cr.keyboard_nav){cr.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};fu=function(fW){var fS,fR,fQ,fU,fX,fT,fV,fP;fM();if(!eV.is_selecting()){return}fS=cr.files.indexOf(fl);fP=cr.files.indexOf(cQ.from_elem(fW.target));cJ(fS<cr.files.length&&fS>=0,"anchor_index: "+fS+" "+fl);cJ(fP<cr.files.length&&fP>=0,"target_index: "+fP);fR=cr.files.slice(Math.min(fS,fP),Math.max(fS,fP)+1);fQ=fI.slice(0);for(fT=0,fV=fR.length;fT<fV;fT++){fX=fR[fT];fU=fQ.indexOf(fX);if(fU===-1){fQ.push(fX)}else{fQ.splice(fU,1)}}return fE(fQ)};fv=function(fP){fl=null;return fI=null};ft=function(fR){var fP,fQ;if(typeof P!=="undefined"&&P!==null){P.reset()}fD();if(fR){Event.extend(fR).preventDefault()}fQ=fo.length?fo.last()===cr.files.first()?cr.files.first():(fP=cr.files.indexOf(fo.last())-1,cr.files[fP]):cr.files.last();fE(fQ);if(fQ){return cr.scrollTo(fQ.get_div())}};fA=function(fR){var fP,fQ;if(typeof P!=="undefined"&&P!==null){P.reset()}fD();if(fR){Event.extend(fR).preventDefault()}fQ=fo.length?fo.last()===cr.files.last()?cr.files.last():(fP=cr.files.indexOf(fo.last())+1,cr.files[fP]):cr.files.first();fE(fQ);if(fQ){return cr.scrollTo(fQ.get_div())}};fK=function(fX){var fQ,fR,fV,fT,fW,fS,fP,fU;if(typeof P!=="undefined"&&P!==null){P.reset()}fD();if(fX){Event.extend(fX).preventDefault()}if(fo.length>0){fW=cr.files.indexOf(fo.last());fQ=cr.files.indexOf(fG);if(fG===fo.last()||fQ>fW){if(fW>0){fU=[];for(fV=fT=fP=fW-1;fP<=0?fT<=0:fT>=0;fV=fP<=0?++fT:--fT){fR=cr.files[fV];fS=fo.indexOf(fR);fH(fR,fG);if(fS!==-1){fU.push(fo.splice(fS,1))}else{cr.scrollTo(fR.get_div());break}}return fU}}else{fr(fo.last());return cr.scrollTo(fo.last().get_div())}}else{return ft()}};fN=function(fY){var fQ,fR,fV,fT,fW,fS,fP,fX,fU;if(typeof P!=="undefined"&&P!==null){P.reset()}fD();if(fY){Event.extend(fY).preventDefault()}if(fo.length>0){fW=cr.files.indexOf(fo.last());fQ=cr.files.indexOf(fG);if(fG===fo.last()||fQ<fW){fU=[];for(fV=fT=fP=fW+1,fX=cr.files.length;fP<=fX?fT<fX:fT>fX;fV=fP<=fX?++fT:--fT){fR=cr.files[fV];fS=fo.indexOf(fR);fH(fR,fG);if(fS!==-1){fU.push(fo.splice(fS,1))}else{cr.scrollTo(fR.get_div());break}}return fU}else{fr(fo.last());return cr.scrollTo(fo.last().get_div())}}else{return fA()}};fq=function(){if(typeof P!=="undefined"&&P!==null){P.reset()}fE(cr.files);return false};fk=function(){if(typeof P!=="undefined"&&P!==null){P.reset()}return fE(null,null,null)};fz=function(){$$(".file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");return setTimeout(fJ,100)};fO=function(fP){return fP.memo.files.each(function(fQ){var fR;fR=fo.indexOf(fQ[0]);if(fR!==-1){fo.splice(fR,1);return fH(fQ[1])}})};fF=function(fP,fQ){var fR;if(cr.in_search_mode()&&fP&&fQ){fR={file_nsid:fP.ns_id,file_sjid:fP.file_sjid,firefly:b9.firefly_enabled,match_type:fP.match_type,position:fP.sort_rank,request_id:fP.request_id,viewport:"full-view",action_type:fQ};return a9.SearchClientActivityLogger.log("result_action",cr.active_user.id,fR)}};fL=function(fQ,fP,fR,fT,fX){var fW,fV,fU,fS;fV="file_row_sharing_menu";if(fP){if(d1.get_for_user(fQ).verified_or_show()){a9.ShmodelUILogger.log("sf_options",fV,fR);fF("single_entry_share_button_folder_options");fW=new de(fQ,fT);if(typeof fX==="function"){fX()}return fW.show()}}else{fS=cr.verify_email_after_share_experiment_variant;fU=fS&&fS==="VERIFY_LAST";if(fU){a9.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(fS){a9.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fU||d1.get_for_user(fQ).verified_or_show()){a9.ShmodelUILogger.log("sf_invite",fV,fR);fF("single_entry_share_button_folder_invite");fW=new cn(fQ,{folder_name:fT,element_id:"invite-to-new-sf-wizard-modal-"+fQ.id,must_check_verified:fU});if(typeof fX==="function"){fX()}return fW.show()}}};document.observe(bC.REMOVE,function(fP){return fP.memo.files.each(fr)});document.observe(bC.MOVE,fO);return{UPDATED_EVT:"db:select:updated",init:function(){var fP;document.observe("click",fn);document.observe("mousedown",i);document.observe("mouseup",fv);document.observe("dragend",fv);document.observe("mouseup",fs);$("browse-files").on("mouseover","li.browse-file",fu);$("browse-files").on("click",".shmodel-file",T);$("browse-files").on("click",".inline-share-button",fp);document.observe(eV.UPDATED_EVT,fJ);document.observe(eV.UPDATED_EVT,fs);document.observe(dL.RENDER,fJ);document.observe(dL.RENDER,fs);document.observe(dL.UPDATE,fE.bind(null,null,null));fP=key.main_modifier();key("up",cr.KEY_SCOPE,ft);key("down",cr.KEY_SCOPE,fA);key(fP+"+a",cr.KEY_SCOPE,fq);key("escape",cr.KEY_SCOPE,fk);key("shift+up",cr.KEY_SCOPE,fK);return key("shift+down",cr.KEY_SCOPE,fN)},set_selected_files:function(fP){return fE(fP)},get_selected_files:function(){return fo.slice(0)},get_selected_fq_paths:function(){return fo.map(function(fP){return fP.fq_path})},has_selected_files:function(){return fo.length},is_selected:function(fP){return fo.indexOf(fP)!==-1},is_selecting:function(){return !!fl},deselect_all:fw,set_context_selected:function(fP){return fC(fP)},flicker_selected:fz,firefly_logging_helper:function(fP,fQ){return fF(fP,fQ)},show_share_modal_if_email_verified:fL}})();aE=E.SharingGrowthExperimentsDropdown={open:function(fn,T,fk,fo,fm,j,fl){var i;this.fq_path=fn;this.existing_sf=T;this.button=fk;this.user=fo;this.target_item=fm;this.is_file=j;this.mount_point=fl;this.$menu=bD("#sharing-growth-experiments-dropdown-menu");i=this.$button&&this.$button.length;if(i){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var i;this.$menu.show();this.$button=bD(this.button);this.$button.addClass("pressed");i={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};C.clone_position(this.$menu,this.$button,i);bD("#browse-box").addClass("dropdown-menu-open");if(this.is_file){this._add_share_file_logging("single_file_shared_entry_button_displayed","single_file_unshared_entry_button_displayed")}return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(i){return i.stopPropagation()});bD(document).on("mousedown",bD.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",bD.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",bD.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");bD(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",bD.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",bD.proxy(this._share_link_click,this))},_add_share_file_logging:function(T,fk){var j,i;i={path:this.fq_path};j=this.existing_sf?T:fk;return a9.SharedFolderActivityLogger.log("web",j,this.user,i)},_sf_click:function(j){var i;i=(function(T){return function(){var fk;if(T.is_file){if(d1.get_for_user(T.user).verified_or_show()){T._add_share_file_logging("single_file_shared_collaboration_clicked","single_file_unshared_collaboration_clicked");if(T.existing_sf){fk=new d4(T.user,{folder_name:aA.filename(T.mount_point),folder_path:T.mount_point,element_id:"confirm-share-existing-file-wizard-modal"})}else{fk=new cn(T.user,{folder_name:T.fq_path,is_file:true,element_id:"invite-to-new-share-file-wizard-modal-"+T.user.id})}return fk.show()}}else{return eV.show_share_modal_if_email_verified(T.user,T.existing_sf,T.target_item,T.fq_path)}}})(this);this._hide();return cw.show_modal(j,this.user.id,i)},_share_link_click:function(j){var i;i=(function(T){return function(){var fk;fk="file_row_sharing_menu";a9.ShmodelUILogger.log("token_share",fk,T.target_item);T._firefly_logging_helper("single_entry_share_button_folder_link");dv.shmodel(T.fq_path,fk);if(T.is_file){return T._add_share_file_logging("single_file_shared_link_clicked","single_file_unshared_link_clicked")}}})(this);this._hide();return cw.show_modal(j,cr.active_user.id,i)},_firefly_logging_helper:function(i){return eV.firefly_logging_helper(cr.find_file(this.fq_path),i)},_clicked:function(i,j){return i.is(j.target)||i.has(j.target).length},_click_outside_menu_callback:function(i){if(!(this._clicked(this.$menu,i)||this._clicked(this.$button,i))){return this._hide()}},_hide:function(i){this._unlisten();bD("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");return this.$button=null}};var A;A=E.DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(i,j){this._exclude_move_event=i;if(j!=null){return this._scroll_window=j}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(j){var i;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(j):void 0){return this._mouse_y=0}else{i=j.pointerY();return this._mouse_y=i-C.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var i;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}i=0;if(this._mouse_y<this._scroll_window){i=-1*this._scroll_amount}else{if(this._mouse_y>C.viewport_dimensions().height-this._scroll_window){i=this._scroll_amount}}if(i){return C.scroll_to(C.scroll_offsets().left,C.scroll_offsets().top+i)}}};var bP;bP=E.BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var i;if(!Modernizr.draganddrop){return}this.listen();i=function(T){var j;j=bD(T.target);return j.closest("#browse-location").length||j.attr("id")==="browse-location"};return A.init(i,bD("#browse-header").height())},listen:function(){var i;i=$(document.body);document.observe(dL.UPDATE,this._update_body_data.bind(this));i.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));i.on("dragend",this._body_dragend.bind(this));i.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){i.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));i.on("mousedown",this._ie_start_drags.bind(this));i.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}i.observe("dragover",this._body_dragover.bind(this));i.observe("dragleave",this._body_dragleave.bind(this));i.observe("dragstart",this._body_dragstart.bind(this));i.observe("mousemove",this._body_mousemove.bind(this));i.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(eV.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(dL.RENDER,this._build_selected_drag_icon.bind(this));i.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return i.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(j){var i;if(!window.event||window.event.button!==1){return}i=j.findElement("[draggable]");if(i&&i!==document&&i.dragDrop){i.dragDrop();return bP._ie_end_drags()}},_ie_start_drags:function(i,j){if(j.tagName!=="OBJECT"&&$(j).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var j,i;j=cr.inside_dir?"copy move":false;i=cr.inside_dir?cr.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",j);return $(document.documentElement).writeAttribute("data-fq_path",i)},_body_dragover:function(j){var i;i=this._get_event_browse_files();if(i.length){return this._update_status_position(j,i)}else{if(!this._drag_from_window&&this._can_drop_transfer(j.dataTransfer)){return bn.show_drop_indicators(j)}}},_body_dragleave:function(T){var j,i,fk;i=T.x||T.clientX;fk=T.y||T.clientY;j=C.viewport_dimensions();if(!((0<i&&i<j.width)&&(0<fk&&fk<j.height))){return bn.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();bn.hide_drop_indicators();A.end();return this._drag_from_window=false},_body_mousemove:function(){return bn.hide_drop_indicators()},_ie_mouseover:function(j,i){if(!C.focus_in_input()){return i.focus()}},_dropzone_dragover:function(fm,i){var j,T,fk,fl;if(!cL.isFileDragEnabled()){return true}fm.preventDefault();fk=this._get_event_browse_files();fl=this._target_fq_path(i);if(!fk.pluck("fq_path").indexOf(fl===-1)){return}if(!this._can_drop(fm,i)){i.addClassName("drag_nodrop");return}try{T=fm.dataTransfer.effectAllowed}catch(fn){}if(T==="move"||T==="copyMove"||T==="linkMove"||T==="all"){fm.dataTransfer.dropEffect="move"}else{fm.dataTransfer.dropEffect="copy"}fm.preventDefault();j=$$(".dragover");j.removeItem(i);j.invoke("removeClassName","dragover");if(!dR.disabled){i.addClassName("dragover")}return bn.folder_dragover(fl)},_dropzone_dragleave:function(j,i){return this._clear_hover_state(i)},_file_dragstart:function(fo,fr){var fs,i,ft,fq,j,fn,fl,fk,fp,T;d3.clear_selected();if(eV.is_selecting()){return fo.preventDefault()}fo.dataTransfer.effectAllowed="copyMove";fo.dataTransfer.setData("URL","about:blank");fn=cQ.from_elem(fr);this._set_event_browse_files(fn);fl=this._get_event_browse_files();if(fl.length<=1&&!fn.dir){T=fn.href;fk=(fn.filename||ey("file")).replace(/:/g,"-");fp="application/octet-stream";try{fo.dataTransfer.setData("DownloadURL",[fp,fk,T].join(":"))}catch(fm){}}ft=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif",width:1,height:1});fs=true;try{fo.dataTransfer.setDragImage(ft,150,150)}catch(fq){j=fq;fs=d3.ie8}this._add_drop_indicators(fo);A.start();if(fs){this._update_status_position(fo,fl);i=$("drag-status");i.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(fl.length>1){i.addClassName("rotatein")}if(this._is_dragging_selection()){i.addClassName("selection")}return i.addClassName("fadein")}},_add_drop_indicators:function(fm){var fn,T,i,fl,fk;$(document.body).addClassName(this._STATUS_CLASS);if(!dR.disabled){fl=$$('[dropzone="copy move"]');fk=[];for(T=0,i=fl.length;T<i;T++){fn=fl[T];if(this._can_drop(fm,fn)){fk.push(fn.addClassName("can_drop"))}else{fk.push(void 0)}}return fk}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var T,fn,fs,fm,fp,ft,fo,fr,fq,fl,fk;fk=eV.get_selected_files();fs=new Element("div",{id:"drag-selection-status"});fl=fk.slice(0,4);for(fp=fo=0,fr=fl.length;fo<fr;fp=++fo){fn=fl[fp];T=fn.get_div();if(!T){continue}fq=T.down(".icon");fq.stopObserving("load");fq.observe.bind(fq).defer("load",bP._build_selected_drag_icon);ft=fq.cloneNode(false);Element.addClassName(ft,"icon icon"+fp);fs.__sert(ft)}fm=new Element("span",{className:"badge"});fm.__date(fk.length);fs.appendChild(fm);return $("drag-selection-status").replace(fs)},_build_file_drag_icon:function(fl,i){var j,fm,fk,T;j=cQ.from_elem(i);T=j.get_div().down(".icon").cloneNode(false);Element.addClassName(T,"icon icon0");fk=new Element("span",{className:"badge"});fk.__date("1");fm=new Element("div",{id:"drag-file-status"});fm.__date(T).__sert(fk);return $("drag-file-status").replace(fm)},_drop:function(fr,fu){var fs,fm,fx,fv,fy,fp,fw,fo,fl,fn,fq,T,ft,i,fk;fm=this._get_event_browse_files();if(this._linkfile_drop_enabled()){fp=cL.getDraggedLink(fr.dataTransfer)}if(fp!=null){i=cL.buildUrlLinkfileContents(fp);ft=new Blob([i],{type:"text/plain"});T=G.parse(fp).getAuthority();ft.name=cr.unused_filename(T+".url");ft.overwrite=false;fw=[ft];a9.LinkfileActivityLogger.log("droplink","url",T,true,"browse",{})}else{fw=fr.dataTransfer.files;fo=fr.dataTransfer.items}fr.preventDefault();if(fu.readAttribute("quicksend")){if(fw&&fw.length){fx=function(){return bn.upload(Z.DEST_FOLDER,fw,fo)};Z.get_folder_name(fx)}else{if(fm.length){for(fn=0,fq=fm.length;fn<fq;fn++){fl=fm[fn];fl.id=p.guid();Z.add_dropbox_file(fl)}}}return}if(this._is_read_only(fu)){fk=ey("You don't have permission to add to this folder.");ah.error(fk);return}fv=null;fy=cQ.from_elem(fu);fs=fu.readAttribute("data-fq_path");if(fy){fv=fy.fq_path}else{if(fs||fs===""){fv=fs}}if(fw&&fw.length){if(!bn.supported()){ah.error(ey("Drag and drop not supported. Please try the simple uploader."))}else{if(!bn.browse_indicators_enabled()&&!bn.modal_indicators_enabled()){if(cA.choose_button_id.startsWith("wizard-")){ah.error(ey("You'll be able to drag and drop files once you finish this tutorial. For now, choose a file to upload."))}else{ah.error(ey("You can't drag and drop upload right now."))}}else{bn.upload(fv,fw,fo)}}}else{if(fm.length){if((fr.dataTransfer.dropEffect==="copy")||(fr.dataTransfer.effectAllowed==="copy")){dB.do_bulk_copy(fm,fv)}else{if(!cr.inside_dir||cr.containing_fq_path()!==fv){dB.do_bulk_move(fm,fv)}}}}this._remove_drop_indicators();return bn.hide_drop_indicators()},_set_event_browse_files:function(i){var j;j=eV.is_selected(i);return this._current_item_key=j?this._SELECTION_CONST:i.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var i,fk,T,j;try{j=this._current_item_key;if(this._is_dragging_selection()){return eV.get_selected_files()}else{if(j){T=cQ.from_key(j);return(T?[T]:[])}}}catch(i){fk=i;console.log(fk)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(i){if(i.readAttribute("read_only")){return true}if(i.readAttribute("is_read_only_mount")){return true}return false},_linkfile_drop_enabled:function(){return az.getGandalfRule("docpreview-linkfile-drop")&&(typeof Blob!=="undefined"&&Blob!==null)},_can_drop_transfer:function(j){var i;i=["Files"];if(this._linkfile_drop_enabled()){i.push.apply(i,["text/x-moz-url","text/uri-list","Url"])}return bv.intersection(j!=null?j.types:void 0,i).length>0},_can_drop:function(fk,j){var i,T;if(j.readAttribute("quicksend")){return true}if(this._is_read_only(j)){return false}i=this._target_fq_path(j);T=this._get_event_browse_files();if(T.length){return !dB.bulk_move_error(T,i)}else{if(this._can_drop_transfer(fk.dataTransfer)){bn.supported();return true}else{return false}}},_target_fq_path:function(i){var j;j=cQ.from_elem(i);if(j){return j.fq_path}else{return i.readAttribute("data-fq_path")}},_clear_hover_state:function(fl){var fm,T,i,fk;fk=$$("#browse .dragover");for(T=0,i=fk.length;T<i;T++){fm=fk[T];if(fm!==fl){fm.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(i){i=Event.extend(i);return d3.scry("drag-status").setStyle({left:(i.pointerX()-C.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(i.pointerY()-C.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var P;P=E.BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(i){return i.charCodeAt(0)}),update:function(){var fl,fn,fk,T,i,fm;if(!P._listening){P.listen();P._listening=true}fl=[];fm=cr.files;for(T=0,i=fm.length;T<i;T++){fk=fm[T];fn=P.to_codepoint_list(fk.filename);fl.push([fn,fk])}fl.sort(function(fo,j){return P.cmp_codepoints(fo[0],j[0])});return P._CODEPOINTS=fl},reset:function(){return P._active=""},is_active:function(){return P._active},jump:function(i){if(i){eV.set_selected_files([i]);return cr.scrollTo(i.get_div())}},listen:function(){var fm,T,i,fl,fk;document.observe("keypress",function(fn){var j;if(key.getScope()!==cr.KEY_SCOPE){return}if(C.focus_in_input()||fn.metaKey||fn.altKey||fn.altGraphKey||fn.ctrlKey){return}j=fn.charCode||fn.keyCode;if(j<32){return}if((33<=j&&j<=40)){return}if(j===32){if(P._active){fn.preventDefault()}else{return}}if(P._BLACKLIST.indexOf(j)!==-1){return}clearTimeout(P._RESET_TIMER_ID);P._active+=String.fromCharCode(j).toLowerCase();P.jump(P.nearest_file(P._active));return P._RESET_TIMER_ID=setTimeout(P.reset,P._RESET_WAIT)});fl=[aH.DELETE,aH.COPY,aH.MOVE,aH.RENAME,aH.PURGE,aH.RESTORE,aH.UPLOAD,aH.SF_NEW,aH.SF_LEAVE,aH.SF_UNSHARE,aH.SF_REJOIN,aH.SF_IGNORE,aH.LINKS_REMOVE,bC.ADD,bC.REMOVE,bC.MOVE];fk=[];for(T=0,i=fl.length;T<i;T++){fm=fl[T];document.observe(fm,function(j){return P.update()});fk.push(bD(document).on(fm,function(j){return P.update()}))}return fk},nearest_file:function(fq){var fm,fk,i,fl,fo,T,fp,fn;if((T=P._CODEPOINTS)!=null?T.length:void 0){fm=P.to_codepoint_list(fq);fp=P._CODEPOINTS;for(fl=0,fo=fp.length;fl<fo;fl++){fn=fp[fl],i=fn[0],fk=fn[1];if(P.cmp_codepoints(fm,i)<1){return fk}}P._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(fn,fm){var fk,T,fl;cJ(fn.length>0&&fm.length>0,"bad input to cmp_codepoints");for(fk=T=0,fl=fn.length;0<=fl?T<fl:T>fl;fk=0<=fl?++T:--T){if(fm[fk]==null){return 1}if(fn[fk]!==fm[fk]){return(fn[fk]<fm[fk]?-1:1)}}if(fm.length>fn.length){return -1}else{return 0}},to_codepoint_list:function(fk){var fm,fl,fn,T;fk=fk.toLowerCase();T=[];for(fm=fl=0,fn=fk.length;0<=fn?fl<fn:fl>fn;fm=0<=fn?++fl:--fl){T.push(fk.charCodeAt(fm))}return T}};var bl;bl=E.ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){bD(document).click(this.hide_on_click);bD(document).on(dL.UPDATE,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(i){return function(j){return bl.hide()}})(this))},unlisten:function(){bD(document).off("click",this.hide_on_click);return bD(document).off(dL.UPDATE,this.hide_on_click)},hide_on_click:function(i){if(!(i.which===3||bD(i.target).parents("#context-menu").length)){return bl.hide()}},show_for_file:function(i,fk,T){var fl,j;cr.keyboard_nav=false;this.hide();fl=cQ.from_elem(T);j=eV.is_selected(fl)?eV.get_selected_files():(eV.deselect_all(),[fl]);eV.set_context_selected(j);return this._show(fk,new i(j))},show_global:function(i,j){this.hide();return this._show(j,new i())},show_shmodel:function(fn){var fm,j,i,T,fk,fl;fm=["get_original"];fk=fn.findElement("img");if((fk.readAttribute("enable-download"))==="true"){T=fk.readAttribute("data-original-href");j=[]}else{T="";j=["get_original"]}this.hide();fl={get_original:{icon:"download",text:ey("Download original"),href:T}};i=Class.create({get_action_names:function(){return fm},get_disabled_action_names:function(){return j},get_action_by_name:function(fo){var fp;fp=fl[fo];fp.name=fo;return fp}});return this._show(fn,new i())},show_for_lightbox:function(fo){var fn,j,i,fl,T,fm,fk;fn=["download","view_original"];this.hide();T=fo.findElement("img");if((T.readAttribute("enable-download"))==="false"){j=["download","view_original"];fl="";fk=""}else{j=[];fl=G.parse(T.readAttribute("data-original-href")).updateQuery({dl:1}).toString();fk=T.readAttribute("data-original-href")}fm={download:{icon:"download",text:ey("Download"),href:fl},view_original:{icon:"view_original",text:a5.append_ellipsis(ey("View original")),href:fk,target:"_blank"}};i=Class.create({initialize:function(){return this._listen()},_listen:function(){var fp;fp=$("context-menu-container");fp.stopObserving("click");fp.stopObserving("contextmenu");fp.on("click",".action button",this._click.bind(this));return fp.on("contextmenu",".action button",this._click.bind(this))},_click:function(ft,fq){var fs,fp,fr;fs=fq.readAttribute("data-value");fp=fm[fs];bl.hide();ft.preventDefault();return(fr=fp.click_handler)!=null?fr.call(this,ft):void 0},get_action_names:function(){return fn},get_disabled_action_names:function(){return j},get_action_by_name:function(fp){var fq;fq=fm[fp];fq.name=fp;return fq}});return this._show(fo,new i())},show_photos:function(fp,ft){var fs,j,fm,fl,fr,fq,i,T,fk,fo,fn;this.hide();fl={divider:{type:"divider"},choose_album:{icon:"album_16",text:a5.append_ellipsis(ey("Add %(num_photos)s to album").format({num_photos:ft.length})),click_handler:function(fu){cH.show_add_to_album_modal(fu,ft);return g.log_interaction(ej.ADD_TO_OTHER_ALBUM,da.PCM,{num_photos:ft.length})}},remove:{icon:"album_delete_16",text:ey("Remove %(num_photos)s from album").format({num_photos:ft.length}),click_handler:function(){cH.show_remove_photos_modal(bO.get_current_collection(),ft);return g.log_interaction(ej.REMOVE,da.PCM,{num_photos:ft.length})}},set_cover:{icon:"album_16",text:ey("Set as cover"),click_handler:function(){bO.get_current_collection().set_cover(ft[0]);return g.log_interaction(ej.SET_AS_COVER,da.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return bO.show_timestamps_modal(ft)}}};if(bO.in_single_collection_view()){fs=["share","choose_album","remove"];if(ft.length===1){fs.unshift("divider");fs.unshift("set_cover")}}else{fs=["share","choose_album"];fs.push("divider");fs.push("delete");if(bO.timestamp_edit_enabled){fr=(function(){var fw,fu,fv;fv=[];for(fw=0,fu=ft.length;fw<fu;fw++){T=ft[fw];if(T.time_taken==null){fv.push(T)}}return fv})();if(fr.length===0){fs.push("edit_timestamp")}else{if(fr.length===ft.length){fl.edit_timestamp.text="Set timestamp";fs.push("edit_timestamp")}}}}if(ft.length===1){fk=c7.categorize_files(ft),fq=fk[0],i=fk[1];if(fq){fn=a5.append_ellipsis(ey("Share photo"))}else{fn=a5.append_ellipsis(ey("Share video"))}Object.extend(fl,{share:{icon:"s_link",text:fn,click_handler:function(fu){ex.show(ft,false);return g.log_interaction(ej.SHARE,da.PCM,{num_photos:1})}},"delete":{text:a5.append_ellipsis(ey("Delete")),click_handler:function(){bO.show_delete_photos_modal(ft);return g.log_interaction(ej.DELETE,da.PCM,{num_photos:1})}},show_in_folder:{text:a5.append_ellipsis(ey("Show in folder")),click_handler:function(){bO.show_in_folder(ft[0]);return g.log_interaction(ej.SHOW_IN_FOLDER,da.PCM,{num_photos:1})}}});if(bO.in_single_collection_view()){fs.push("divider")}fs.push("show_in_folder")}else{fo=c7.categorize_files(ft),fq=fo[0],i=fo[1];if(fq&&i){fn=bb("Share %(file_count)s item","Share %(file_count)s items",ft.length);fm=bb("Delete %(file_count)s item","Delete %(file_count)s items",ft.length)}else{if(fq){fn=bb("Share %(file_count)s photo","Share %(file_count)s photos",ft.length);fm=bb("Delete %(file_count)s photo","Delete %(file_count)s photos",ft.length)}else{fn=bb("Share %(file_count)s video","Share %(file_count)s videos",ft.length);fm=bb("Delete %(file_count)s video","Delete %(file_count)s videos",ft.length)}}fn=fn.format({file_count:ft.length});fm=fm.format({file_count:ft.length});Object.extend(fl,{share:{icon:"s_link",text:fn,click_handler:function(fu){bO._share_selected();return g.log_interaction(ej.SHARE,da.PCM,{num_photos:ft.length})}},"delete":{text:fm,click_handler:function(fu){bO.show_delete_photos_modal(ft);return g.log_interaction(ej.DELETE,da.PCM,{num_photos:ft.length})}}})}j=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fy,fw){var fx,fv,fu;fx=fw.readAttribute("data-value");fv=fl[fx];if(fy.clientX===0&&fy.clientY===0){return}bl.hide();return(fu=fv.click_handler)!=null?fu.call(this,fy):void 0},get_action_names:function(){return fs},get_disabled_action_names:function(){return[]},get_action_by_name:function(fu){var fv;fv=fl[fu];fv.name=fu;return fv}});return this._show(fp,new j())},show_photo_collection:function(fk,fl,fm){var T,i,j;this.hide();if(fl.is_anonymous){T=["go_to_link","unshare"]}else{if(fl.is_creator){T=["share","rename"];if(fl.share_tkey!=null){T.push("unshare")}T.push("delete")}else{T=["share"]}}j={share:{icon:"s_link",text:a5.append_ellipsis(ey("Share album")),click_handler:function(fn){if(fl.num_items===0){ah.error(ey("This album is empty. Add some photos before you share it!"));return}ex.show(fl,true);return g.log_interaction(ej.SHARE_ALBUM,da.CCM,{num_photos:fl.num_photos})}},unshare:{icon:"lock",text:a5.append_ellipsis(fl.is_anonymous?ey("Unshare"):ey("Unshare album")),click_handler:function(fn){cH.show_unshare_modal(fl);return g.log_interaction(ej.UNSHARE_ALBUM,da.CCM,{num_photos:fl.num_photos})}},rename:{icon:"pencil",text:ey("Rename album"),click_handler:function(fn){fl.rename(fm.down(".collection-name"));return g.log_interaction(ej.RENAME_ALBUM,da.CCM,{num_photos:fl.num_photos})}},"delete":{icon:"album_delete_16",text:a5.append_ellipsis(ey("Delete album")),click_handler:function(fn){cH.show_delete_modal(fl);return g.log_interaction(ej.DELETE_ALBUM,da.CCM,{num_photos:fl.num_photos})}},go_to_link:{icon:"s_link",text:ey("Go to link"),click_handler:function(fn){cH.go_to_link(fl);return g.log_interaction(ej.GO_TO_ALBUM_LINK,da.CCM,{num_photos:fl.num_photos})}}};i=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fr,fo){var fq,fn,fp;fq=fo.readAttribute("data-value");fn=j[fq];bl.hide();return(fp=fn.click_handler)!=null?fp.call(this):void 0},get_action_names:function(){return T},get_disabled_action_names:function(){return[]},get_action_by_name:function(fn){var fo;fo=j[fn];fo.name=fn;return fo}});return this._show(fk,new i())},_show:function(fy,fn,fw){var ft,fv,fk,fz,T,fs,fu,fx,fm,fr,fl,fp,fo,fA,fq;if(fw==null){fw=false}fq=((fy!=null?(fl=fy.target)!=null?fl.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((fy!=null?(fp=fy.target)!=null?fp.type.toUpperCase():void 0:void 0)==="TEXT")||((fy!=null?(fo=fy.target)!=null?fo.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");fs=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#react-file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button","#wizard-overlay","#react-bubble-dropdown-root",".preview-sf-members-box",".db-modal",".db-modal-overlay",".waiting_for_items"];fA=$(fy.target);if(bD(fA).parents("#context-menu").length){return}ft=bD("#file-preview-modal");if(!(ft.find(fA).length&&bD(fA).is("img"))){for(fv=0,fx=fs.length;fv<fx;fv++){T=fs[fv];fz=$$(T);if(fz){for(fu=0,fm=fz.length;fu<fm;fu++){fk=fz[fu];if(fA.descendantOf(fk)||fA.match(T)){return}}}}}if((fy!=null?fy.shiftKey:void 0)||fq){return}else{Event.stop(fy)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=ff.tmpl("context_menu_tmpl")}if(!fn.get_action_names().length){return}eR.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:fn,actions:(function(){var fB,j,i,fC;i=fn.get_action_names();fC=[];for(fB=0,j=i.length;fB<j;fB++){fr=i[fB];fC.push(fn.get_action_by_name(fr))}return fC})(),disabled_actions:fn.get_disabled_action_names(),big:fw,Sprite:cv}));this.position_at(fy.clientX,fy.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(T,fm){var j,i,fk,fl;fl=C.viewport_dimensions();i=parseInt($("context-menu").getStyle("width"),10);j=parseInt($("context-menu").getStyle("height"),10);fk=15;if(T+i>fl.width-fk){$("context-menu").setStyle({left:(fl.width-i-fk)+"px"})}else{$("context-menu").setStyle({left:T+"px"})}if(fm+j>fl.height-fk){return $("context-menu").setStyle({top:(fl.height-j-fk)+"px"})}else{return $("context-menu").setStyle({top:fm+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();eV.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}}};var dm,cr,k,aK,ay,cT,ck,cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};dm=E.BROWSE_SNIPPET_LEN=25;ck=E.SEARCH_SNIPPET_LEN=20;aK=E.COMMENT_COUNT_SNIPPET_LEN=3;cT=E.LAST_MODIFIED_FNAME_SNIPPET=4;ay=[bo.FILES_BY_NAME,true,"FILES_BY_NAME"];cr=INLINE_JS.Browse=E.Browse={KEY_SCOPE:"browse",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:ay,folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,paginating:false,is_initialized:false,init:function(j,fn,fk,fm,i,fl,T){this.browse_actions_ctor=fn;this.global_actions_ctor=fk;this.browse_actions_context_ctor=fm;this.global_actions_context_ctor=i;this.ns_id_to_mount_point=fl;cJ(typeof T==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=cK.get_viewer().get_user_by_id(T);__CIRCULAR_DEPENDENCY__.active_user_loaded=true;cJ(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();C.viewport_dimensions();if(bZ.chrome){this.browser_supports_previews=j&&d3.pdf_plugins().length}else{this.browser_supports_previews=j}this.compiled_search_tmpl=ff.tmpl("search_list_item_tmpl");cC.AuthenticatedRequest({url:G({path:"/flash_detect_log"}),data:{installed:FlashDetect.installed,major:FlashDetect.major,minor:FlashDetect.minor,revision:FlashDetect.revision,revisionStr:FlashDetect.revisionStr,raw:FlashDetect.raw}});return this.is_initialized=true},setup:function(fk,fo){var fn,fm,T,i,fl;if(fo==null){fo=null}this.ns_id_to_mount_point=fk.ns_id_to_mount_point;this.old_path_to_ns_id=fk.old_path_to_ns_id;this.compiled_tmpl=ff.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_root_folder=fk.containing_fq_path==="";this.inside_dir=fk.inside_dir;this.inside_deleted_dir=fk.inside_deleted_dir;this.inside_shared_folder=fk.inside_shared_folder;this.is_nested_shared_folder=fk.is_nested_shared_folder;this.is_nested_in_team_folder=fk.is_nested_in_team_folder;this.inside_read_only_shared_folder=fk.inside_read_only_shared_folder;this.inside_sandbox=fk.inside_sandbox;this.public_app_token=fk.public_app_token;this.public_folder_enabled=fk.public_folder_enabled;this.inside_deleted_sandbox=fk.inside_deleted_sandbox;this.inside_deleted_shared_folder=fk.inside_deleted_shared_folder;this.inside_team_folder=fk.inside_team_folder;this.golden_gate_aware=fk.golden_gate_aware;this.is_read_only=fk.is_read_only;this.ns_map=fk.ns_map;this.permanent_delete_is_disabled_by_ns_id=fk.permanent_delete_is_disabled_by_ns_id;this.contents_cache_key=fk.contents_cache_key;fm="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(fm)}else{$("browse").removeClassName(fm)}this.block_hash=fk.block_hash;this.block_hash_param=fk.block_hash_param;if(this.inside_dir){this._containing_ns_id=fk.containing_ns_id;this._containing_ns_path=fk.containing_ns_path;this._containing_fq_path=fk.containing_fq_path;this._containing_mount_point=fk.containing_mount_point;this._containing_sf_perm_role=fk.containing_sf_perm_role;this.breadcrumb();fl=[this.browse_actions,this.global_actions];for(T=0,i=fl.length;T<i;T++){fn=fl[T];if(fn!=null){fn.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!(fk.file_info||fk.paginated)){this.show_message(ey('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}if(fk.paginated){return this._start_pagination(fk.first_page)}else{return this._push_files(fk.file_info,fo)}},entered_search:function(){return this._stop_pagination()},_start_pagination:function(j){var i;if(j.unsupported_sort!=null){this.reset_sort()}this.paginating=true;i=cr.active_user.id;this.pagination_manager=new fj();this.pagination_manager.initialize(j,"sjid","/browse_get_next",i,(function(T){return function(fk,fl){return T._new_data_available(fk,fl)}})(this));this.pagination_manager.startAutoFetching();bD("#more-loading").show();return this.disable_sorting()},_stop_pagination:function(){if(!this.paginating){return}this.paginating=false;this.pagination_manager.stopAutoFetching();this.pagination_manager=null;bD("#more-loading").hide();this.enable_sorting();return this._stop_waiting_for_items()},_new_data_available:function(fk,j){var T,i;if(!this.paginating){return}i=this._push_files(j);if(az.getGandalfRule("file-viewer-react")){eZ.updateFiles(this.files)}if(!this.in_search_mode()){this.smartfill();a5.load_visible_thumbs();this.fire_visible_change_callbacks()}T=fk.loadedPageCount()===1;if(!T){if(this._is_item_selection_needed()){if(this._are_all_selected_items_fetched()||fk.areAllItemsReady()){this._stop_waiting_for_items();this.set_selection_from_fq_paths_or_index(cr)}}document.fire(dL.NEW_PAGE,{page_files:i});bD(document).trigger(dL.NEW_PAGE,{page_files:i})}if(fk.areAllItemsReady()){return this._stop_pagination()}},_is_item_selection_needed:function(){return(this.select_fq_paths&&this.select_fq_paths.length>0)||(this.select_index>-1)},_are_all_selected_items_fetched:function(i){var fq,fr,fo,fm,fl,fp,fn,fk,T;if(i==null){i=this.files}if(this.select_fq_paths&&this.select_fq_paths.length>0){T=this.select_fq_paths;for(fm=0,fp=T.length;fm<fp;fm++){fq=T[fm];fo=false;fk=fq.toLowerCase();for(fl=0,fn=i.length;fl<fn;fl++){fr=i[fl];if(fr.fq_path.toLowerCase()===fk){fo=true;break}}if(!fo){return false}}return true}else{if(this.select_index>-1){return this.select_index<i.length}}return cJ(0,"Expected something to select (@select_index or @select_fq_paths)")},_wait_for_items:function(){bD("#waiting-for-items").show();bD("#global-actions").addClass("disabled");return bD("body").addClass("waiting_for_items")},_stop_waiting_for_items:function(){bD("body").removeClass("waiting_for_items");bD("#global-actions").removeClass("disabled");return bD("#waiting-for-items").hide()},_push_files:function(fl,fo){var fn,T,fm,fk,i;if(fo==null){fo=null}T=[];for(fk=0,i=fl.length;fk<i;fk++){fm=fl[fk];fn=a5.make_browsefile(fm,fo);fn.track_in_browse();T.push(fn)}P.update();return T},_get_helper:function(i){cJ(this.inside_dir,"accessed "+i+", but not inside a directory");return cr[i]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},containing_fq_path:function(){if(!this.inside_dir){return""}return this._get_helper("_containing_fq_path")},containing_sf_perm_role:function(){return this._get_helper("_containing_sf_perm_role")},listen:function(){var fx,fv,T,fm,fq,fp,ft,fr,fo,fl,fk,fu,fs,fn,fw,i;bD("#fulltext-search-all-link").click(this.unscoped_search);bD("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",bl.show_for_file.bind(bl,this.browse_actions_context_ctor));this.enable_sorting();fn="#browse-sort a.sortable-column-header";d3.add_sort_arrow_mouseover($("name-sorter"),true,fn,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",bl.show_global.bind(bl,this.global_actions_context_ctor));document.observe(eV.UPDATED_EVT,this.selection_handler.bind(this));document.observe(aH.COPY,(function(j){return function(fy){if(j.inside_dir&&fy.memo.to_fq_path===j.containing_fq_path()){return j.force_reload()}}})(this));fk=[aH.MOVE,aH.RESTORE,aH.UPLOAD,aH.SF_NEW,aH.SF_REJOIN,aH.SF_IGNORE,aH.LINKS_REMOVE,aH.LINKS_ADD];for(fq=0,ft=fk.length;fq<ft;fq++){T=fk[fq];fm=(function(j){return function(fy){if(j.inside_dir&&!cr.in_search_mode()){return j.force_reload()}}})(this);document.observe(T,fm);bD(document).on(T,fm)}fu=[aH.SF_LEAVE,aH.SF_UNSHARE];for(fp=0,fr=fu.length;fp<fr;fp++){T=fu[fp];document.observe(T,(function(j){return function(fy){if(j.inside_dir){if(fy.memo.target_ns_id===j.containing_ns_id()){if(fy.memo.folder_deleted){return j.reload_fqpath("")}else{return j.reload_fqpath(j.containing_fq_path())}}else{return j.force_reload()}}}})(this))}fs=[aH.DELETE,aH.PURGE];for(fl=0,fo=fs.length;fl<fo;fl++){T=fs[fl];document.observe(T,(function(j){return function(fG){var fB,fD,fC,fA,fy,fz,fF,fE;if(j.inside_dir){if(fG.eventName===aH.PURGE||(fG.eventName===aH.DELETE&&!a3.get_del())){for(fD=fA=fF=j.files.length-1;fF<=0?fA<=0:fA>=0;fD=fF<=0?++fA:--fA){if(fG.memo.files.indexOf(j.files[fD])===-1){fy=j.files[fD]}else{break}}eV.deselect_all();fE=fG.memo.files;for(fz=0,fC=fE.length;fz<fC;fz++){fB=fE[fz];fB.get_div().remove();j.files.removeItem(fB)}if(j.files.length){if(fy!=null){return eV.set_selected_files(fy)}else{return eV.set_selected_files(j.files.last())}}else{return j.show_empty()}}else{if(j.keyboard_nav){j.select_fq_paths=[j.containing_fq_path()+"/"+fG.memo.files.last().filename]}return j.force_reload()}}}})(this))}document.observe(bl.SHOW_EVT,this.disable_sorting.bind(this));document.observe(bl.HIDE_EVT,this.enable_sorting.bind(this));fx=function(){var fy,j;fy=$("browse-header");j=fy.cumulativeOffset().top+fy.getHeight();return C.viewport_dimensions().height-j};key("pagedown",this.KEY_SCOPE,function(j){Event.extend(j).preventDefault();return window.scrollBy(0,fx())});key("pageup",this.KEY_SCOPE,function(j){Event.extend(j).preventDefault();return window.scrollBy(0,-1*fx())});fw=function(){var j;j=cr.in_search_mode()?b9:cr;if(cr.files.length===0){return j.show_empty()}else{return j.hide_empty()}};document.observe(bC.ADD,(function(j){return function(fB){var fA,fz,fC,fy;fy=fB.memo.files;for(fC=0,fz=fy.length;fC<fz;fC++){fA=fy[fC];j.insert_file(fA,true)}return fw()}})(this));document.observe(bC.REMOVE,(function(j){return function(fB){var fA,fz,fC,fy;fy=fB.memo.files;for(fC=0,fz=fy.length;fC<fz;fC++){fA=fy[fC];j.remove_file(fA)}return fw()}})(this));document.observe(bC.MOVE,(function(j){return function(fE){var fH,fy,fB,fz,fF,fD,fC,fA,fG;fy=j.in_search_mode();fD=fE.memo.files;fA=[];for(fz=0,fB=fD.length;fz<fB;fz++){fC=fD[fz],fH=fC[0],fG=fC[1];if(fy){if(fH!=null){fF=j.get_file_pos(fH)}else{continue}}j.remove_file(fH);j.insert_file(fG);if(fy&&fF>=0){fA.push(j.update_file_pos(fG,fF))}else{fA.push(void 0)}}return fA}})(this));bD(document).on(aH.COMPRESS,(function(j){return function(fA,fz){var fy;j.force_reload();if(fz.compressed_files.length===1&&fz.original_files.length===1){fy=a5.make_browsefile(fz.compressed_files.first());return j.preview_compressed(fy,fz.original_files.first())}}})(this));fv=this.fire_visible_change_callbacks.bind(this);bD(window).on("resize",fv);this._last_visible_change_timeout_id=null;i=(function(j){return function(fy){clearTimeout(j._last_visible_change_timeout_id);return j._last_visible_change_timeout_id=setTimeout(fv,250)}})(this);return bD(window).on("scroll",i)},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(T,fl){var i,j,fk;i=bD(T.target);if(i.is("img.icon")||i.closest("a.filename-link").length>0||i.closest(".filename-col__comment-count-bubble").length>0){this._click(T,fl)}if(i.is("a.parent-dir")){j=cQ.from_elem(fl);if(j){fk={file_nsid:j.ns_id,file_sjid:j.sjid,firefly:b9.firefly_enabled,match_type:j.match_type,position:j.sort_rank,request_id:j.request_id,viewport:"full-view",action_type:"click_path_link"};return a9.SearchClientActivityLogger.log("result_action",cr.active_user.id,fk)}}},dblclick:function(i,j){if($(i.target).match("a")){return}return this._click(i,j)},open_file:function(fk,i,T,j){var fl,fm;if(T==null){T=false}if(j==null){j=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}fl={user_id:cr.active_user.id,context:aW.FileViewContextType.PRIVATE,platform:aW.FileViewPlatformType.WEB,ns_id:fk.ns_id,sjid:fk.sjid,ns_path:fk.ns_path,shared_link_url:null,extra:{mode:aW.FileViewModeType.BROWSE,file_ext:aA.file_extension_for_logging(fk.filename),file_bytes:fk.bytes,file_mtime:fk.ts}};fm={file_nsid:fk.ns_id,file_sjid:fk.sjid,firefly:b9.firefly_enabled,match_type:fk.match_type,position:fk.sort_rank,request_id:fk.request_id,viewport:T?"dropdown-view":"full-view"};if(fk.dir){if(this.in_search_mode()||T){fm.action_type="folder_open";a9.SearchClientActivityLogger.log("result_action",cr.active_user.id,fm)}if(i){this.open_folder_in_new_window(fk)}else{this.open_folder(fk)}return a9.TimeToFirstActionLogger.log(cr.active_user.id,"folder_open")}else{if(!i&&this.can_show_preview(fk)){if(this.in_search_mode()||T){fm.action_type="file_view";a9.SearchClientActivityLogger.log("result_action",cr.active_user.id,fm)}a9.TimeToFirstActionLogger.log(cr.active_user.id,"file_view");return this.open_preview(fk,j,T)}else{if(this.in_search_mode()||T){fm.action_type="file_view";a9.SearchClientActivityLogger.log("result_action",cr.active_user.id,fm)}a9.FileViewLogger.log(fl);a9.TimeToFirstActionLogger.log(cr.active_user.id,"file_view");return window.open(fk.href,"_blank")}}},close_preview_callback:function(){bD(document).off("db:filepreview:close",this.close_preview_callback);af.close_shared_link_view();return cr.set_title()},preview_compressed:function(j,i){return n.show(j,cr.active_user,{files:[j,i],file_view_mode:aW.FileViewModeType.BROWSE,hide_comments:true})},open_preview:function(T,i,fk,j){if(i==null){i=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}if(fk==null){fk=false}if(j==null){j=false}if(this.can_show_preview(T)){a5.filepreview_from_selected(T,fk,j,i);return bD(document).on("db:filepreview:close",this.close_preview_callback)}},_click:function(T,fk){var j,i;this.keyboard_nav=false;j=cQ.from_elem(fk);if(j.editing){return}i=(T.which===2)||(d3.is_mac()&&T.metaKey);cr.open_file(j,i,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN);T.preventDefault()},crumb_click:function(fk,i){var T,j;this.keyboard_nav=false;fk.preventDefault();j=i.readAttribute("data-fq_path");T=this.details_from_fq_path(j);return a3.set_path_url(T.ns_id,T.ns_path)},parent_click:function(fl,fk){var T,fm,i,j;this.keyboard_nav=false;fl.preventDefault();j=fk.readAttribute("data-parent_ns_path");i=parseInt(fk.readAttribute("data-parent_ns_id"),10);a3.set_path_url(i,j);T=cQ.from_elem(fk);if(T){fm={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:b9.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view",action_type:"click_path_link"};return a9.SearchClientActivityLogger.log("result_action",cr.active_user.id,fm)}},selection_handler:function(){if(eV.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var i,T,j,fk;if(this.in_search_mode()&&!b9.end_of_results){j=a5.get_files_in_view(),fk=j[0],T=j[1];i=this.files.length-(fk+T);if(i<=50&&!$("browse").hasClassName("pending-search")){b9.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(a5.load_visible_thumbs.bind(a5),this.POST_SCROLL_WAIT)},unscoped_search:function(){return b9.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var j,i;this.last_sort=ay;i="#browse-sort a.sortable-column-header";j=$$(i)[0];d3.add_sort_arrow_mouseover(j,true,i,false);$("kind-sorter-label").__date(dq.DISPLAY.FILES_BY_KIND);return cv.src(j.down("img"),"web","arrow-up-gray")},sort_handler:function(fn,T,fm){var fl,fk,i,j;T=$(T);T.blur();j=T.readAttribute("data-sort");if(fm!=null){}else{if(this.last_sort[0]===bo[j]){fm=T.readAttribute("data-ascending")==="false"}else{fm=j!=="FILES_BY_MODIFIED"}}if(dq.has_label(j)){fk=dq.next(j);$("sharing-sorter-label").__date(fk.display);j=fk.label;T.writeAttribute("data-sort",j);fm=dq.IS_ASC[j]}else{T.writeAttribute("data-ascending",(fm?"true":"false"))}i="#browse-sort a.sortable-column-header";d3.add_sort_arrow_mouseover(T,fm,i,true);fl=bo[j];this.sort(fl,fm,j);if(fn){return fn.stop()}},toggle_deleted:function(){var i;i=!a3.get_del();return a3.set_del_url(i)},unused_filename:function(ft,fy){var T,fz,fk,fr,fs,fm,fv,fl,fu,fw,fp,fn,fo,fq,fA,fx;if(fy==null){fy=false}fx=aA.filename_without_extension(ft);fA=aA.file_extension(ft,T=true);fr=[];fo=cr.files;for(fu=0,fw=fo.length;fu<fw;fu++){fz=fo[fu];fn=aA.filename_without_extension(fz.filename);fp=aA.file_extension(fz.filename,T=true);fm=fn.toLowerCase().indexOf(fx.toLowerCase())===0;fs=fA.toLowerCase()===fp.toLowerCase();fl=!fy||fz.dir;if(fm&&fs&&fl){fr.push(fz.filename.toLowerCase())}}if(fA){fA="."+fA}else{fA=""}fk=fx+fA;fv=1;while(true){if(fq=fk.toLowerCase(),cR.call(fr,fq)<0){break}fk=fx+" ("+fv+")"+fA;fv++}return fk},new_folder:function(){var fs,fk,T,fl,fp,i,j,fn,fq,fr,fm,fo;if(this.reloading||this.creating_folder){return}if(cr.sharing_create_and_share_new_folder_enabled&&!this.inside_shared_folder){fp=new a1(cr.active_user,{element_id:"create-and-share-new-folder-modal-"+cr.active_user.id,destination_dir:this.containing_fq_path()});fp.show();return}this.hide_empty();this.selectable();T=this.unused_filename(ey("New folder"),fq=true);fo=ff.tmpl("new_folder_tmpl",{name:T,Sprite:cv,_:ey});fl=-1;if(this.files.length){fm=C.scroll_offsets();if(fm.top>0){fr=this.files[0].get_div().getLayout().get("margin-box-height");fl=Math.floor(fm.top/fr)}}if(fl>0){this.files[fl].get_div().__sert({after:fo})}else{$("browse-files").__sert({top:fo})}i=$$("#browse-files .browse-new-folder .name").first();cJ(i!=null,"expected new_folder_name to be defined");fs=this.containing_fq_path();fn=(function(ft){return function(fw){var fv,fu,fx;fx=fw.responseText.evalJSON(true);cJ(fx.new_browse_files.length===1,"No new file data returned.");fv=aA.filename(fx.new_browse_files.first().fq_path);fu=ey("Created folder '%(folder_name)s'");fu=fu.format({folder_name:bS.em_snippet(fv,25)});ah.success(fu);ft.select_fq_paths=[fx.new_browse_files.first().fq_path];return ft.force_reload()}})(this);j=(function(ft){return function(fv){var fu;fu=$$("#browse-files li.browse-new-folder").first();if(fu){fu.remove()}return ft.creating_folder=false}})(this);fk=new Ajax.InPlaceEditor(i,"/cmd/new"+(d3.urlquote(fs)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:j,savingText:ey("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:fn,subject_user:cr.active_user},callback:(function(ft){return function(fu,fv){ft.creating_folder=true;return{to_path:fv||"",folder:"yes"}}})(this)});return fk.enterEditMode()},open_folder:function(j){var fk,i,T;cJ(j.dir,"Only open directories, not files");if(cr.inside_dir&&cr.containing_ns_path()===j.ns_path&&!this.in_search_mode()){return}if(!(eV.get_selected_files().length===1&&eV.get_selected_files().indexOf(j)===0)){eV.deselect_all();fk=typeof j.get_div==="function"?j.get_div():void 0;if(fk){fk.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(fl){return function(){var fm;if(!fl.reloading){return}fm=ey("Loading %(filename)s...");fm=fm.format({filename:bS.em_snippet(j.filename,50)});return fl.folder_loading_notification=ah.success(fm,60,true)}})(this),1000);if(j.target_ns){i=j.target_ns;T=""}else{i=j.ns_id;T=j.ns_path}if(j.is_deleted){return a3.set_path_url(i,T,true)}else{return a3.set_path_url(i,T)}},open_folder_in_new_window:function(i){return window.open(a3._make_url(i.ns_id,i.ns_path),"_blank")},show_message:function(T){var j,i;if((typeof T)!==(typeof"string")){i=$("browse-files").down(".browse-message");if(i){i.show()}return}this.msg=T;j=new Element("div",{"class":"browse-message"});j.__date(T);return $("browse-files").__sert(j)},sort:function(j,fl,i,fk){var T;if(!fk&&j===this.last_sort[0]&&fl===this.last_sort[1]){return}this.last_sort=[j,fl,i];T=j(fl);this.files.sort(T);this.smartfill();a5.load_visible_thumbs();return this.fire_visible_change_callbacks()},resort:function(){var fk,i,T,j;i=this.last_sort;T=i[0];fk=i[1];j=i[2];return this.sort(T,fk,j,true)},in_search_mode:function(){return bD("#browse").hasClass("search")},flex_column:function(){return $("sharing-sorter").readAttribute("data-sort")},smartfill:function(){var T,fn,fl,fo,fk,i,fp,fm;T=$("browse-files");fm=[];fo=this.in_search_mode();fp=this.files;for(fk=0,i=fp.length;fk<i;fk++){fn=fp[fk];fl=this.flex_column();fm.push(this.compiled_tmpl({file:fn,in_search_mode:fo,flex_column:fl,Browse:cr,Sprite:cv,Constants:Constants,FilePath:aA,Emstring:bS,GandalfUtil:az,_:ey}))}T.__date(fm);document.fire(dL.RENDER);return bD(document).trigger(dL.RENDER)},search_smartfill:function(fq,fk){var i,fp,fn,T,fl,fo,fm;if(fk==null){fk=null}fm=[];for(fl=0,fo=fq.length;fl<fo;fl++){fp=fq[fl];T=a5.make_browsefile(fp,fk);T.track_in_browse();fn=this.compiled_search_tmpl({file:T,BrowseInterface:fh,Browse:cr,Sprite:cv,Constants:Constants,_:ey,searchHelpers:ap,HTML:ff,FilePath:aA,Emstring:bS,Util:d3});i=bD(fn.toHTML());fm.push(i)}bD("#browse-files").append(fm);document.fire(dL.RENDER);bD(document).trigger(dL.RENDER);a5.load_visible_thumbs();return this.fire_visible_change_callbacks()},add_file:function(i){this.files.push(i);if(i.target_ns){cr.ns_id_to_mount_point[i.target_ns]=i.fq_path}if(i.bytes<0){return this.deleted_shown=true}},insert_file:function(T,j){var i;if(!T){return}j=j||0;i=this.find_file(T.fq_path);if(i&&i!==T){this.remove_file(i)}cQ._file_index[T.to_key()]=T;this.update_file_pos(T);if(j){T.get_div().setStyle({display:"none"})}document.fire(dL.RENDER);return bD(document).trigger(dL.RENDER)},add_files:function(i){return cr._push_files(i.file_info)},get_file_pos:function(i){var j;j=this.files.indexOf(i);cJ(j!==-1,"file not present in @files");cJ(i.to_key() in cQ._file_index,"file not present in BrowseFile._file_index");return j},remove_file:function(i){var T,j;if(!i){return}T=this.files.indexOf(i);if(T!==-1){this.files.splice(T,1);delete cQ._file_index[i.to_key()];return(j=i.get_div())!=null?j.remove():void 0}},update_file_pos:function(fm,fo){var i,fq,fk,fl,fn,T,j,fp;if(fo==null){fo=-1}fp=this.files.indexOf(fm);if(fp!==-1){this.files.splice(fp,1)}delete fm.sort_rank;T=this.last_sort[0];fn=this.last_sort[1];if(fo>=0){fp=fo}fl=this.in_search_mode()?fp:d3.bsearch(this.files,fm,T(fn),true);this.files.splice(fl,0,fm);fk=fm.get_div();i=$("browse-files");if(fk){fk.remove()}if(this.in_search_mode()){j=this.compiled_search_tmpl({file:fm,Browse:cr,BrowseInterface:fh,Constants:Constants,Emstring:bS,FilePath:aA,HTML:ff,searchHelpers:ap,Sprite:cv,Util:d3,_:ey})}else{j=this.compiled_tmpl({file:fm,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),Browse:cr,Constants:Constants,Emstring:bS,FilePath:aA,Sprite:cv,GandalfUtil:az,_:ey})}fq=i.childElements();if(fl<fq.length){return i.childElements()[fl].__sert({before:j})}else{return i.__sert(j)}},find_file:function(i){return this.files.find(function(j){return j.fq_path.toLowerCase()===i.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];cQ._file_index={};return bP._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return b9.hide_empty()},show_empty:function(){var i;this.hide_empty();if(bD("#browse-empty-team-folder").length&&this.inside_team_folder&&!this.is_in_subfolder_of_team_folder()){i="#browse-empty-team-folder"}else{i="#browse-empty"}bD(i+" .drag-prompt").toggle(!this.is_read_only);if(!cr.in_search_mode()){return bD(i).show()}},hide_empty:function(){return bD("#browse-empty, #browse-empty-team-folder").hide()},update:function(i,j){if(j==null){j=null}$("browse-box").show();if(this.in_search_mode()){return this.search_smartfill(i.file_info,j)}else{this.clear();if(typeof i==="string"){i=JSON.parse(i)}this.setup(i,j);this.resort();document.fire(dL.UPDATE);return bD(document).trigger(dL.UPDATE)}},reload_fqpath:function(j,i){return this.reload(null,d3.urlquote(j),i)},force_reload:function(){return this.reload(this.containing_ns_id(),d3.urlquote(this.containing_ns_path()),true)},set_title:function(){var i;if(cr.in_search_mode()){b9.set_title();return}if(!cr.inside_dir){return}i=this.containing_fq_path();return document.title=i?aA.filename(i)+" - Dropbox":cK.get_viewer().is_paired&&cr.active_user.role===Constants.ROLE_WORK?cK.get_viewer().team_name+" - Dropbox":cK.get_viewer().is_paired&&cr.active_user.role===Constants.ROLE_PERSONAL?ey("Personal")+" - Dropbox":ey("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(fq){var fk,T,fp,fn,fo,fm,i,fl;i=fq.select_fq_paths;fl=fq.select_index;if(i||fl>-1){T=[];if(i){for(fn=0,fo=i.length;fn<fo;fn++){fp=i[fn];fm=this.find_file(fp);if(fm){T.push(fm)}}}if(!T.length&&fl>-1){fk=this.files[fl];if(fk){T.push(fk)}}if(T.length){eV.set_selected_files(T);this.scrollToWithPadding(T.first().get_div(),100)}fq.select_fq_paths=false;return fq.select_index=-1}},set_selection_from_item_counters:function(){var fk,fp,fm,fn,fl,fq,fo,T,fr,fs;if(this.select_item_counters!=null){fm={};T=this.select_item_counters;for(fn=0,fq=T.length;fn<fq;fn++){fp=T[fn];fm[fp]=true}fs=[];fr=this.files;for(fl=0,fo=fr.length;fl<fo;fl++){fk=fr[fl];if(fk.root_coll_item_counter in fm){fs.push(fk)}}eV.set_selected_files(fs);return this.select_item_counters=null}},reload:function(fk,fp,j){var fr,fl,fq,T,fn,fm,fo,i;T="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+fp+")";cJ(fp.search(eB.URL_ESCAPE_REGEX)===-1,T);if(fk==null){fk=cr.active_user.root_ns}fp=aA.normalize(fp);if(a5.get_mode()!==a5.BROWSE_MODE){this.clear();a5.set_browse_mode()}if(b9._clear_on_reload){b9.clear_searchbox()}if(!aq.uploading){cZ.hide()}this._stop_pagination();if(this.reloading){return}if(this.inside_dir&&fp===this.containing_ns_path()&&fk===this.containing_ns_id()&&!j){return}fo=this.first_load?Constants.referrer:"";fq=this.deleted_shown?"?show_deleted=yes":"";fm={ns_id:fk,referrer:fo,delays_parent_request_rendering:this.first_load,sort_label:this.last_sort[2],sort_is_ascending:this.last_sort[1],sort_folders_first:bo.FOLDERS_FIRST};fm=Object.extend(fm,this.extra_reload_args);eG("Browse.reload:",fp);this.reloading=true;i="/browse"+fp+fq;fr=2;fl=["browse",fk,fp,fq,cr.active_user.id,fr];fn=(function(fs){return function(ft){fs.reset_state();fs.update(ft);(fs.files.length?fs.hide_empty.bind(fs):fs.show_empty.bind(fs))();clearTimeout(fs.folder_loading_timeout);if(ah.isShown()&&ah.current()===fs.folder_loading_notification){ah.clear()}C.scroll_clear_cache();if(fs._is_item_selection_needed()){if(fs.paginating&&!fs._are_all_selected_items_fetched()){fs._wait_for_items()}else{fs.set_selection_from_fq_paths_or_index(cr)}}if(!n.shown()){return fs.set_title()}}})(this);bD(document).trigger(dL.BEFORE_UPDATE,{ns_id:fk,ns_path:G.decode(fp)});new Ajax.DBRequest(i,{allow_retries:true,subject_user:cr.active_user,parameters:fm,log_timing:true,on304:function(fs){},onSuccess:(function(fs){return function(fz){var fw,ft,fv,fB,fx,fu,fy,fA;if(fs.in_search_mode()){return}fB=JSON.parse(fz.responseText);fA=null;fy=null;fn(fB);if(fA){fu=[];for(fv=0,fx=fA.length;fv<fx;fv++){fw=fA[fv];fu.push(cr.find_file(fw.fq_path))}eV.set_selected_files(fu);window.scrollTo(fy[0],fy[1])}else{cr.set_selection_from_item_counters()}if(cr.sharing_autoselect_first_file_enabled&&!eV.has_selected_files()){ft=fs.files[0];eV.set_selected_files([ft])}if(fs.first_load){return ee.mark_time_to_interactive()}}})(this),onFailure:(function(fs){return function(){if(fs.first_load){fs.reload.bind(fs).defer(Constants.root_ns,"")}return clearTimeout(fs.folder_loading_timeout)}})(this),cleanUp:(function(fs){return function(){fs.first_load=false;return fs.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return cr.inside_shared_folder&&cr.containing_ns_path()},is_in_subfolder_of_team_folder:function(){return cr.inside_team_folder&&cr.containing_ns_path()},is_shmodelable_path:function(i){var j;if(cr.public_app_token){return false}if(i===""){return false}if(cr.public_folder_enabled){j=i.toLowerCase();if(j.startsWith("/public/")){return false}}return true},can_show_preview:function(i){var j;return this.browser_supports_previews||((j=i.preview_type)==="photo"||j==="video")},can_get_details_from_fq_path:function(T){var j,i;j=this.containing_fq_path();i=this.containing_mount_point();return(i&&T.startsWith(i))||j.startsWith(T)},details_from_fq_path:function(fk){var fl,j,i,T;cJ(this.can_get_details_from_fq_path(fk));j=this.containing_mount_point();if(j&&fk.startsWith(j)){i=this.containing_ns_id();T=fk.slice(j.length);fl=aA.filename(fk,this._get_root_name())}else{i=Constants.root_ns;T=fk;fl=aA.filename(fk,this._get_root_name())}return{ns_id:i,ns_path:T,fq_path:fk,folder_name:fl||this._get_root_name(),url:String(fh.browse_uri_for_fq_path(cr.active_user,fk)),icon:(fk.length?"folder_32":this._get_root_icon())}},update_header_status:function(i){return bD("#browse-header-status").text(i)},update_header_height:function(){var j,fk,T,i;fk=bD("#browse-header");j=bD("#browse-files");i=0;if(fk.css("position")==="fixed"){i=bD(window).scrollTop()}if(!C.is_page_scrollable()){i=Math.abs(parseFloat(bD("html").css("top"))||0)}T=fk.offset().top+fk.height()-j.offset().top-i;return j.css("padding-top",T)},_make_breadcrumbs_data:function(){var fo,fp,fl,fk,fn,T,fm;fp=this.containing_fq_path();fo=[];T=fp.split("/");for(fl=fk=0,fm=T.length;0<=fm?fk<fm:fk>fm;fl=0<=fm?++fk:--fk){fn=aA.normalize(T.slice(0,fl+1).join("/"));fo.push(this.details_from_fq_path(fn))}return fo},_get_root_icon:function(){if(!cK.get_viewer().is_paired){return"glyph"}if(cr.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(cr.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return cK.get_root_name(cr.active_user)},_get_max_breadcrumb_width:function(fk){var j,T,i;T=fk?this._DROPDOWN_WIDTH:new bS(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){j=bD("#browse-rightmenu").width();i=bD("#browse-global-actions-bar").width();return((i-j)*this._FUDGE_FACTOR/this._PX_TO_EM)-T}else{return this._MAX_BREADCRUMB_WIDTH-T}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var fs,fk,fn,fu,fp,fo,fr,T,ft,fl,fq,fm;fk=this._make_breadcrumbs_data();fm=fk.collect(function(i){return new bS(i.fq_path?i.folder_name:"").length});fq=0;fn=0;cJ(fk.length>0,"expected at least one breadcrumb");ft=this._get_max_breadcrumb_width();for(fp=fo=fl=fk.length-1;fl<=0?fo<=0:fo>=0;fp=fl<=0?++fo:--fo){fq+=fm[fp];if(fq>ft){break}fn+=1;fq+=this._CONNECT_WIDTH}fu=fk.slice(0,fk.length-Math.max(1,fn));fk=fk.slice(fu.length,fk.length);if(!fu.length&&fk.length>1){fk.shift()}fr=fk.pop();fs=ff.tmpl("breadcrumb_tmpl",{breadcrumbs:fk,dropdown:fu,containing_fq_path:this.containing_fq_path(),url_root:fh.get_browse_root(cr.active_user),root_name:this._get_root_name(),Sprite:cv});T=fr.folder_name;if(fr.fq_path!==""){T=bS.em_snippet(T,this._get_max_breadcrumb_width(fu.length>1))}$("browse-location").__date(fs);$("browse-location").__sert(" "+T);if(fu.length>1){return this._render_breadcrumbs_dropdown(fu)}},_render_breadcrumbs_dropdown:function(fl){var fk,i,T,j;i=$("breadcrumbs-box");fl.reverse();j=ff.tmpl("breadcrumb_li_tmpl",{breadcrumbs:fl,Sprite:cv,Emstring:bS});$("browse-location").__sert(j);T=$("breadcrumb-dropdown");fk=function(fn){var fm;fn.stopPropagation();T.show();fm=bD(i);return bD(T).clonePosition(fm,{setWidth:0,setHeight:0,offsetTop:fm[0].offsetHeight,offsetLeft:parseInt(fm.css("padding-left"),10)})};i.observe("click",fk);i.observe("dragover",fk);return document.observe("click",function(){i.removeClassName("down");return T.hide()})},viewportOffset:function(){var i,T,j;if(!this.files.length){return}if(!this.div_parent){T=this.files[0].get_div().offsetParent;if(!T){return}this._viewportOffset={};this.div_parent=$(T);this._cumulativeOffset=this.div_parent.cumulativeOffset()}i=d3.scrollLeft(this.div_parent);j=d3.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==j||this.scrollLeft!==i){this._viewportOffset.top=this._cumulativeOffset.top-j;this._viewportOffset.left=this._cumulativeOffset.left-i;this.scrollLeft=i;this.scrollTop=j}return this._viewportOffset},selectable:function(){return d3.enableSelection($("browse-files"))},unselectable:function(){return d3.disableSelection($("browse-files"))},_header_offset:(function(){var i;i=$("browse-header");return i.getHeight()+i.cumulativeOffset().top}).cached(1000),scrollTo:function(i){return this.scrollToWithPadding(i,3)},scrollToWithPadding:function(fk,fm){var T,fn,j,fl,i;if(!fk){return}fl=C.viewport_dimensions();i=C.scroll_offsets();fn=fk.cumulativeOffset().top-i.top;T=fk.getHeight();j=this._header_offset();if(fn<j){C.scroll_to(0,i.top+fn-j-fm)}else{if(fn+T>fl.height){C.scroll_to(0,i.top+fn+T-fl.height+fm)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return fa.fix_position()}},_visible_change_callbacks:{},_next_visible_change_callback_id:0,add_visible_change_callback:function(i){this._visible_change_callbacks[this._next_visible_change_callback_id]=i;return this._next_visible_change_callback_id++},remove_visible_change_callback:function(i){return delete this._visible_change_callbacks[i]},fire_visible_change_callbacks:function(){var T,fn,fk,fl,i,j,fm;if(!bD.isEmptyObject(this._visible_change_callbacks)){fl=a5.get_files_in_view(),fm=fl[0],T=fl[1];i=this._visible_change_callbacks;j=[];for(fk in i){fn=i[fk];j.push(fn(this.files,this.active_user.id,fm,T))}return j}}};k=E.BrowseUpdate=(function(){var i,fo,fn,fk,fm,fl,T,j;T=function(fq){var fr,fs,fp;if(!cr.inside_dir){return}fs=fq.parent_changes;if(fs.change_to_fq_path!=null){if(fs.change_type==="moved"){if(fs.is_changing_view){fr=ey("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");fr=fr.format(fs.old_fq_path.escapeHTML(),d3.urlquote(fs.new_fq_path))}else{fr=ey("This folder has been moved")}}else{if(fs.change_type==="renamed"){if(fs.is_changing_view){fr=ey("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");fr=fr.format(fs.old_fq_path.escapeHTML(),d3.urlquote(fs.new_fq_path))}else{fr=ey("This folder has been renamed to '%s'.");fp=fs.change_to_fq_path.split("/");fr=fr.format(fp[fp.length-1].escapeHTML())}}else{fr=ey("The folder '%s' has been deleted.");fr=fr.format(fs.old_fq_path.escapeHTML())}}if(fs.is_changing_view){ah.error(new ff(fr))}else{if(fs.old_fq_path===cr.containing_fq_path()){ah.success(new ff(fr))}}cr.reload_fqpath(fs.change_to_fq_path);return}return fl(fq)};j=function(ft){var fr,fs,fv,fy,fx,fq,fz,fp,fw,fu;fy=[];fu=[];if(!cr.in_search_mode()){return}b9.clear_cache();for(fq in cr.ns_id_to_mount_point){if(!(fq in ft.mount_points)){ft.mount_points[fq]=null}}fp=ft.mount_points;for(fq in fp){fx=fp[fq];fq=parseInt(fq,10);fz=cr.ns_id_to_mount_point[fq];if(fx===fz){continue}if(fx){cr.ns_id_to_mount_point[fq]=fx}else{delete cr.ns_id_to_mount_point[fq]}fw=cr.files;for(fs=0,fv=fw.length;fs<fv;fs++){fr=fw[fs];if(fr.fq_path.indexOf(fz)===0&&fr.target_ns!==fq){if(fx){fr.fq_path=fx+fr.fq_path.slice(fz.length);fr.href=fh.get_browse_root(cr.active_user)+fx+fr.href.slice(5+fz.length);fy.push([fr,fr])}else{fu.push(fr)}}}}return fl(ft,[],fu,fy)};fl=function(fM,ft,fJ,fs){var fA,fp,fK,fB,fF,fq,fH,fG,fI,fv,fu,fE,fr,fz,fy,fx,fD,fC,fL,fw;if(ft==null){ft=[]}if(fJ==null){fJ=[]}if(fs==null){fs=[]}fr=fM.added;for(fH=0,fI=fr.length;fH<fI;fH++){fK=fr[fH];fp=aA.normalize(aA.parent_dir(fK.ns_path));if(cr.in_search_mode()||(fK.ns_id===cr.containing_ns_id()&&fp===cr.containing_ns_path())){fA=a5.make_browsefile(fK);fA.track_in_browse();ft.push(fA)}}fz=fM.removed;for(fG=0,fv=fz.length;fG<fv;fG++){fB=fz[fG];fJ.push(cr.find_file(fB))}fy=fM.moved;for(fE=0,fu=fy.length;fE<fu;fE++){fx=fy[fE],fF=fx[0],fw=fx[1];fL=aA.normalize(aA.parent_dir(fw.ns_path));fC=null;fD=cr.in_search_mode()||(fw.ns_id===cr.containing_ns_id()&&fL===cr.containing_ns_path());fq=cr.in_search_mode();if(fD&&!(fq&&cr.find_file(fw.ns_path))){fC=a5.make_browsefile(fw);fC.track_in_browse()}fs.push([cr.find_file(fF),fC])}document.fire(bC.ADD,{files:ft});bD(document).trigger(bC.ADD,{files:ft});document.fire(bC.MOVE,{files:fs});a5.load_visible_thumbs();cr.fire_visible_change_callbacks();return fm(ft,fJ,fs)};i=function(fs,fq,fr,fp){fs.css("background","");bD(document).trigger(dL.UPDATE_RENDERED);return document.fire(bC.REMOVE,{files:fr})};fm=function(fA,fy,fB){var fs,fD,fx,fu,fz,fw,ft,fr,fp,fq,fv,fC;fv=(fA.length+fy.length)<=10;for(fx=0,fz=fA.length;fx<fz;fx++){fs=fA[fx];if(!(fs&&fs.get_div())){continue}fo(fs,fv,fA,fy,fB)}for(fu=0,fw=fy.length;fu<fw;fu++){fs=fy[fu];if(!(fs&&fs.get_div())){continue}fk(fs,fv,fA,fy,fB)}fq=[];for(fr=0,ft=fB.length;fr<ft;fr++){fp=fB[fr],fD=fp[0],fC=fp[1];if(fD){fk(fD,fv,fA,fy,fB)}if(fC){fq.push(fo(fC,fv,fA,fy,fB))}else{fq.push(void 0)}}return fq};fn=function(fp){var fq;fq=eV.is_selected(fp)?"#83B8DC":"#CCEAFF";return bD(fp.get_div()).css("background-color",fq)};fk=function(fp,fs,fr,ft,fq){var fu;fn(fp);fu=bD(fp.get_div());if(fs){return fu.show().slideUp("normal",function(){return i(fu,fr,ft,fq)})}else{fu.hide();return i(fu,fr,ft,fq)}};fo=function(fp,fs,fr,ft,fq){var fu;fn(fp);fu=bD(fp.get_div());if(fs){return fu.hide().slideDown("normal",function(){return i(fu,fr,ft,fq)})}else{fu.show();return i(fu,fr,ft,fq)}};return{init:function(){var fq,fp;fp=d6[cr.active_user.id];return fq=fp.subscribe_sfj({name:"BrowseUpdater",handler:function(){var fx,fu,fw,ft,fr,fv,fs;ft=cr.in_search_mode();fx=ft?j:T;fs=ft?"/update/list_search":"/update/list_dir";if(!(cr.inside_dir||ft)){fp.handler_failure(fq);return}if(ft){fv=b9.get_state();fw={all_terms:fv.query}}else{fw={fq_dir:cr.containing_fq_path(),show_deleted:cr.deleted_shown}}fw.ns_map=((function(){var fz,fy;fz=fp.get_ns_map();fy=[];for(fu in fz){fr=fz[fu];fy.push(fu+"_"+fr)}return fy})()).join(",");cJ(cr.active_user,"No active_user was set before calling "+fs+". Active user loaded? "+(__CIRCULAR_DEPENDENCY__.active_user_loaded||false)+". Error before loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading||false)+". Error after loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading||false)+".",true,[],false);return new bD.ajax(fs,{data:fw,dataType:"json",type:"POST",subject_user:cr.active_user,success:function(fy){fx(fy);return fp.handler_success(fq,{ns_map:fy.ns_map})},error:function(){return fp.handler_failure(fq)}})}})}}})();var ea;ea=E.ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(j,fl){var fk,T,i;if(j.async_task_id){if(!j.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}T=j.async_task_id}else{T=j.job_id}ea.job_info[T]={};fk=ea.job_info[T];fk.subject_user=j.subject_user||((i=j.parameters)!=null?i[Constants.UID_PARAM_NAME]:void 0);fk.req=j;fk.is_async_task=!!j.async_task_id;fk.poll_int=ea.INIT_POLL_INT;fk.poll_count=0;fk.int_id=setInterval(ea.update_for(T),fk.poll_int);fk.failures=0;fk.start_time=b4.time();return fk.dont_hide=fl},update_for:function(i){return function(){return ea.update(i)}},backoff:function(j){var i;i=ea.job_info[j];clearInterval(i.int_id);i.poll_int=Math.min(Math.floor(i.poll_int*1.5),30000);return i.int_id=setInterval(ea.update_for(j),i.poll_int)},update:function(T){var i,j;j=ea.job_info[T];if(dj.peek(T)){return ea.done(T)}j.poll_count++;if(j.poll_count%10===0){ea.backoff(T)}if(!j.modaled&&b4.time()-j.start_time>ea.MODAL_WAIT_MS){i=j.req.options;ez.show(i.progress_text);i.onProgress=ez.update;if(i.on_modal_shown!=null){i.on_modal_shown()}j.modaled=true}if(j.is_async_task){return ea.get_async_task_status(T)}else{return ea.get_job_status(T)}},get_job_status:function(i){return new Ajax.DBRequest("/job_status/"+i,{method:"post",subject_user:ea.job_info[i].subject_user,onSuccess:function(T){var fk,j;fk=ea.job_info[i];j=T.responseText;if(j.indexOf("err")===0){ea.done(i);if(fk.req.options.onFailure&&!dj.handled(i)){fk.req.options.onFailure(T)}return}if(j.indexOf("done")===0){fk.req.options.job=false;if(!dj.peek(i)){new Ajax.Request("/job_results/"+i,{method:"post",parameters:{t:bu.read(Constants.JS_CSRF_COOKIE)},onSuccess:function(fm){if(dj.handled(i)){return}ar.clearWorkingMessage();if(fk.req.options.onSuccess){return fk.req.options.onSuccess(fm)}},onFailure:function(fm){if(dj.handled(i)){return}ar.clearWorkingMessage();if(fk.req.options.onFailure){return fk.req.options.onFailure(fm)}}})}return ea.done(i)}else{try{if(fk.req.options.onProgress){return fk.req.options.onProgress(T.responseText)}}catch(fl){}}},onFailure:function(j){var T;T=ea.job_info[i];T.failures++;if(T.failures>=ea.FAILS_MEAN_FAIL){if(T.req.options.onFailure){T.req.options.onFailure(j,true)}ar.remove(T.req);return ea.done(i)}}})},get_async_task_status:function(i){return new Ajax.DBRequest("/async_task_status/"+i,{method:"post",subject_user:ea.job_info[i].subject_user,onSuccess:function(T){var fk,j;fk=ea.job_info[i];j=T.responseText;if(j.indexOf("done:")===0||j.indexOf("err:")===0){dj.handled(i);ar.clearWorkingMessage();if(j.indexOf("done:")===0){T.responseText=j.substr(5)}if(fk.req.options.onSuccess){fk.req.options.onSuccess(T)}if(fk.req.options.onComplete){fk.req.options.onComplete(T)}return ea.done(i)}else{if(j.indexOf("async_task_err:")===0){ah.error(new ff(j.substr(15)));dj.handled(i);ar.clearWorkingMessage();ea.done(i);return cr.force_reload()}else{try{if(fk.req.options.onProgress){return fk.req.options.onProgress(T.responseText)}}catch(fl){}}}},onFailure:function(j){var T;T=ea.job_info[i];T.failures++;if(T.failures>=ea.FAILS_MEAN_FAIL){try{if(T.req.options.onFailure){T.req.options.onFailure(j,true)}}catch(fk){}ar.remove(T.req);return ea.done(i)}}})},done:function(j){var i;i=ea.job_info[j];clearInterval(i.int_id);if(!i.dont_hide){delete ea.job_info[j];if(!(i.req.async_task_id&&i.req.async_task_id!==j)){return ez.hide(j)}}else{return ez.update("1/1")}}};var ds,bW,bA,cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};bA=E.NamespaceEvents=(function(){function i(j){this.ns_id=j;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return i})();ds=E.EventDatePicker=(function(){function i(T){var j,fk,fl;this.on_change=T;bD(document.body).on("click",(function(fm){return function(fn){return fm.hide_calendar(fn)}})(this));fl=new Element("div",{id:"cal_container"});bD(fl).bind("click",function(fm){return fm.preventDefault()});bD(document.body).append(fl);this.calendar=new I("cal_container",{onDateChange:(function(fm){return function(fn){return fm.on_change(fn)}})(this),disable_future:true});bD(fl).css("position","fixed");fk=bD("#cal_date");j=bD("#cal_container");j.clonePosition(fk,{setWidth:false,setHeight:false,offsetTop:fk.height(),offsetLeft:fk.width()-j.children().first()[0].offsetWidth});this.hide_calendar()}i.prototype.show_calendar=function(j){if(this.shown){bD("#cal_container").hide();this.shown=false;return}bD("#cal_container").show();return this.shown=true};i.prototype.hide_calendar=function(j){if(j&&bD(j.target).closest("#cal_date").length>0){return}bD("#cal_container").hide();this.shown=false;return true};return i})();bW=INLINE_JS.Events=E.Events={ns:null,role:"all",now:Number(new Date()),timestamp:d3.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(i,fm,fo,T,fn){var fk,fl,j;if(fn==null){fn=false}this.awaitingFirstRender=true;j=eB.deconstruct_url();this.first_event_map=i;this.roles=fm;this.rss_data=fo;this.role_has_events=T;this.deletions_only=fn;this.role_picker=C.controller(bD("#role-selector"));if(this.roles.length===1){this.role=this.roles[0].role}else{if(j.qargs.role){this.role=j.qargs.role;this.role_picker.set_state(this.role)}else{if(this.deletions_only){this.role=this.roles[this.roles.length-1].role}}}this.date_picker=new ds((function(fp){return function(fq){fp.change_date(fq);fp.set_url();return a9.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(fp){return function(){fp.role=fp.role_picker.get_state();if(fp.ns&&!bv(fp.valid_roles()).any(function(fq){return fq.ns_ids.contains(fp.ns.ns_id)})){fp.ns=null;aR.set_selected_by_value(bD("#namespace-list")[0],"false")}fp.set_url();return fp.get_more(true)}})(this);bM.set_during_login_callback((function(fp){return function(fr,fq){return window.location.reload()}})(this));bD(window).bind("beforeunload",(function(fp){return function(){fp.user_navigated_away=true;return void 0}})(this));if(bD("#namespace-list-container")[0]){bD("#namespace-list-container")[0].observe("db:change",(function(fp){return function(fq){fp.ns=fp.namespaces[JSON.parse(fq.memo)];fp.set_url();fp.get_more(true);return a9.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}bD(window).on("scroll",(function(fp){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-C.viewport_dimensions().height-10);return fp.get_more()}})(this));if(j.qargs.ns){aR.set_selected_by_value(bD("#namespace-list")[0],j.qargs.ns);this.ns=this.namespaces[j.qargs.ns]}if(j.qargs.date){fl=j.qargs.date.split("-").map(Number);fk=new Date(fl[2],fl[1]-1,fl[0]);this.date_picker.calendar.selected_date=fk;this.change_date(fk)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var fp,fo,fk,fn,T,fq,fm,fl;this.namespaces={};fq=bv(this.roles).values();for(fp=0,fk=fq.length;fp<fk;fp++){fl=fq[fp];fm=fl.ns_ids;for(fo=0,fn=fm.length;fo<fn;fo++){T=fm[fo];this.namespaces[T]=new bA(T)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(i){this.timestamp=Number(i)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}bD("#cur_date_text").text(N.localize(i));return this.get_more(true)},is_scrolled_down:function(){var i,T,j;j=C.scroll_offsets().top;T=C.viewport_dimensions().height;i=bD("#events").height();return j+T+50>=i},get_more:function(fk){var i,j,T;if(this.request_in_flight){return}if(bv(this.valid_nss()).all(function(fl){return fl.done})){this.render();return}if(!(fk||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();j=(function(fl){return function(){return bv(fl.valid_nss()).map(function(fm){return fm.ns_id}).join(",")}})(this);i=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));T={page_size:25,ns_ids:j(),timestamp:i};if(this.deletions_only){T.deletions_only=true}return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:T,onSuccess:(function(fl){return function(fA){var ft,fm,fu,fr,fq,fw,fs,fp,fz,fo,fy,fn,fx,fv;ft=JSON.parse(fA.responseText);fl.request_in_flight=false;fn=ft.events;for(fu=0,fw=fn.length;fu<fw;fu++){fm=fn[fu];fm.html=bD(fm.html)[0];fy=fm.pkey+" "+(fm.html.textContent||fm.html.innerText);fz=fl.namespaces[fm.ns_id];if(!fz.seen[fy]){fz.events.push(fm);fz.seen[fy]=true;fz.earliest=fm.timestamp}}if(ft.events.length>0){fx=ft.ns_ids;for(fr=0,fs=fx.length;fr<fs;fr++){fo=fx[fr];fl.namespaces[fo].earliest=bv(ft.events).map(function(fB){return fB.timestamp}).min()}}fl.render();if(ft.events.last()){fl.get_more()}else{if(bv(ft.ns_ids).join(",")!==j()){fl.get_more()}else{fv=ft.ns_ids;for(fq=0,fp=fv.length;fq<fp;fq++){fo=fv[fq];fl.namespaces[fo].done=true}}}return at.configureAllLinks("#event-table",".inline-restore","events")}})(this),onError:(function(fl){return function(){fl.request_in_flight=false;if(!fl.user_navigated_away){return ah.error(ey("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return bv(this.roles).filter((function(i){return function(j){return j.role===i.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return bv(this.valid_roles()).map((function(i){return function(j){return j.ns_ids}})(this)).flatten().map((function(i){return function(j){return i.namespaces[j]}})(this)).uniq()}},earliest:function(){return bv(this.valid_nss()).map((function(i){return function(j){return j.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=d3.start_of_day(new Date(bv(this.valid_nss()).map((function(i){return function(j){return i.first_event_map[j.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=d3.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var T,fk,j,i;j=new Date(this.timestamp-this.one_day);fk=this.now-this.timestamp>0;T={};if(this.ns){T.ns=this.ns.ns_id}if(this.role!=="all"){T.role=this.role}if(fk){T.date=(j.getDate())+"-"+(j.getMonth()+1)+"-"+(j.getFullYear())}i=this.deletions_only?"/deleted_files":"/events";return eB.push_state(i,T)},on_preview_open:function(j){var i;i=cK.get_viewer().get_user_by_id(j.user_id);bD(document).on("db:filepreview:close",this.on_preview_close);n.show(j,i);return false},on_preview_close:function(){bD(document).off("db:filepreview:close",this.on_preview_close);return document.title=ey("Recent events - Dropbox")},render:function(){var fk,fz,fD,fC,fr,fA,fE,fy,fB,fs,fq,fo,fu,fF,fw,fl,fp,ft,fn,fv,fx,T,fm;if(this.role_has_events[this.role]){this.update_calendar_first_day()}fk=bv(this.valid_nss()).map((function(i){return function(j){return j.events}})(this)).flatten();fz=this.earliest();T=bv(fk).sortBy(function(i){return -i.timestamp});fr=bv(T).filter((function(i){return function(j){return j.timestamp>=fz&&j.timestamp<i.timestamp/1000&&(i.ns!==null||!j.is_dup)}})(this));if(this.role_has_events[this.role]){bD("#event-table").empty();for(fA=0,fB=fr.length;fA<fB;fA++){fp=fr[fA];fD=bD(fp.html);ft=bv(this.valid_roles()).filter((function(i){return function(j){return j.ns_ids.contains(fp.ns_id)}})(this)).map((function(i){return function(j){return j.name}})(this)).join(" & ");if(this.deletions_only){fD.find("span.role-path").text(ft)}else{fD.find("span.role-label > span").text(ft)}bD("#event-table").append(fD);if(fp.preview_jsinfo!=null){fC=fp.preview_jsinfo;fq=fD.find("#prev_link");fq.on("click",this.on_preview_open.bind(this,fC));fx=fD.find(".inline-button");fx.on("click",this._inline_share_button.bind(this,fC))}}bD("#events-container").show();bD("#events-sub-header").show();bD("#events-sub-header").css("visibility","visible");bD("#events-empty-state").hide();bD(".empty-explanation").hide()}else{if(!this.request_in_flight){bD("#events-container").hide();bD("#events-sub-header").hide();bD("#events-empty-state").show();bD(".empty-explanation").show()}}if(!this.request_in_flight){if(this.awaitingFirstRender){this.awaitingFirstRender=false;a9.WebMiscActivityLogger.log("events-first-load",{time:Number(new Date())-this.now})}bD("#more-loading").hide()}else{bD("#more-loading").show()}bD("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");fo=bD("#namespace-list > li");for(fy=0,fs=fo.length;fy<fs;fy++){fE=fo[fy];fl=bv(this.valid_roles()).map((function(i){return function(j){return j.ns_ids}})(this)).flatten().any((function(i){return function(j){return j===bD(fE).data("value")}})(this));fw=bD(fE).data("value")===false;fm=fw||fl;bD(fE).css("display",fm?"":"none")}fv=cR.call((function(){var fG,j,i,fH;i=this.valid_roles();fH=[];for(fG=0,j=i.length;fG<j;fG++){fF=i[fG];fH.push(fF.ns_ids.length>1)}return fH}).call(this),true)>=0;if(!this.request_in_flight){if(fv){bD("#namespace-list-container").css("visibility","visible");bD("#namespace-list-container").show()}else{bD("#namespace-list-container").hide()}fn=this.rss_data[(fu=this.ns)!=null?fu.ns_id:void 0]||this.rss_data[this.role];if(fn&&this.role_has_events[this.role]){bD("#rss-feed a").attr("data-title",fn.title);bD("#rss_url").val(fn.url);bD("#reset-rss-link").on("click",(function(i){return function(j){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:fn.ns_id},onSuccess:function(){ah.success(ey("RSS feed url successfully reset."));return bZ.redirect("/events")}});return false}})(this));bD("#rss_url").focus();bD("#rss-feed").show();return bD("#rss-feed").css("visibility","visible")}else{return bD("#rss-feed").hide()}}},show_rss_modal:function(){var i,j;fa.show(ey("Subscribe to this RSS feed"),bD("#rss-modal")[0]);j=bD("#rss_url").val();i=t.clipboard_overlay(j,bD("#real_copy"),function(){ah.success(ey("Link copied to clipboard!"));return fa.hide()},bD(".modal-buttons"));return i.css({zIndex:1001})},_inline_share_button:function(j,fk){var i,T;fk.preventDefault();i="events_table_row";T=a9.ShmodelUILogger.get_target_item(j);a9.ShmodelUILogger.log("single_entry_share",i,T);return new df(j.user_id,j.fq_path,i).show()}};var N;N=E.DateUtil={fromSecondsSinceEpochUTC:function(i){var j;j=new Date(1970,0,1);j.setSeconds(i);return j},applyTimezoneOffset:function(j,fk){var i,T;i=parseInt(fk,10);T=60*(fk-i);j.setHours(j.getHours()+i);return j.setMinutes(j.getMinutes()+T)},contextualFormat:function(j){var fk,fm,i,T,fl;i=new Date(Date.now());T=(i.getTime()-j.getTime())/1000;fk=0;if(T<8*3600){return b4.ago(j)}this.applyTimezoneOffset(i,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(j,Constants.TIMEZONE_OFFSET);fl=new Date(Date.now());this.applyTimezoneOffset(fl,Constants.TIMEZONE_OFFSET);fl.setDate(fl.getDate()-1);if(j.getYear()===i.getYear()&&j.getMonth()===i.getMonth()&&j.getDate()===i.getDate()){fm=ey("Today %(time)s");return fm.format({time:N.format(j,Constants.time_format)})}else{if(j.getYear()===fl.getYear()&&j.getMonth()===fl.getMonth()&&j.getDate()===fl.getDate()){fm=ey("Yesterday %(time)s");return fm.format({time:N.format(j,Constants.time_format)})}else{return N.format(j,Constants.datetime_format)}}},toUTCDate:function(i){return new Date(i.getUTCFullYear(),i.getUTCMonth(),i.getUTCDate(),i.getUTCHours(),i.getUTCMinutes(),i.getUTCSeconds(),i.getUTCMilliseconds())},differenceStr:function(fk,fn){var fp,fo,j,T,fl,i,fm;fl=(fk.getTime()-fn.getTime())/1000;if(fl<60){return bb("%d sec","%d secs",fl).format(fl)}else{if(fl<3600){j=parseInt(fl/60,10);return bb("%d min","%d mins",j).format(j)}else{if(fl<86400){fo=parseInt(fl/3600,10);return bb("%d hour","%d hours",fo).format(fo)}else{if(fl<2592000){fp=parseInt(fl/(60*60*24),10);return bb("%d day","%d days",fp).format(fp)}else{if(fl<4838400){i=parseInt(fl/(60*60*24*7),10);return bb("%d week","%d weeks",i).format(i)}else{if(fl<31536000){T=parseInt(fl/(60*60*24*30),10);return bb("%d month","%d months",T).format(T)}else{fm=parseInt(fl/(60*60*24*365),10);return bb("%d year","%d years",fm).format(fm)}}}}}}},localize:function(i){cJ(Constants.date_format!=null,"Date format missing.");return N.format(i,Constants.date_format)},format:function(i,j){var T;cJ(typeof j==="string","Date format requires a format string");T={yy:(function(fk){return function(){return i.getFullYear().toString().substring(2)}})(this),yyyy:(function(fk){return function(){return i.getFullYear().toString()}})(this),M:(function(fk){return function(){return(i.getMonth()+1).toString()}})(this),MM:(function(fk){return function(){return(i.getMonth()+1).toString().lpad(2)}})(this),d:(function(fk){return function(){return i.getDate().toString()}})(this),dd:(function(fk){return function(){return i.getDate().toString().lpad(2)}})(this),h:(function(fk){return function(){return(i.getHours()%12||12).toString()}})(this),H:(function(fk){return function(){return i.getHours().toString()}})(this),HH:(function(fk){return function(){return i.getHours().toString().lpad(2)}})(this),m:(function(fk){return function(){return i.getMinutes().toString()}})(this),mm:(function(fk){return function(){return i.getMinutes().toString().lpad(2)}})(this),a:(function(fk){return function(){if(i.getHours()>11){return ey("PM",{comment:"PM as in evening"})}else{return ey("AM",{comment:"AM as in morning"})}}})(this)};return j.replace(/([a-zA-Z]+)/g,function(fk){if(T[fk]!=null){return T[fk]()}else{return fk}})}};var eO;eO=INLINE_JS.Timezone=E.Timezone={check_timezone:function(){var i;if(!cK.get_viewer().is_signed_in){return}i=eO.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==i){return eO.update(i)}},get_current_timezone:function(){var fk,T,i,j;T=new Date();T.setSeconds(0);T.setMilliseconds(0);j=T.toGMTString();fk=new Date(j.substring(0,j.lastIndexOf(" ")));i=(T-fk)/(1000*60*60);return i},update:function(i){cJ(typeof i==="number","Timezone offset was not a number: "+i);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:i},noAutonotify:true})},update_timezones_dropdown:function(j,fk){var T,i;if(fk==null){fk=null}i=eO.timezones_by_country[j];bD("#timezone_id").empty();return bD("#timezone_id").append((function(){var fn,fl,fm;fm=[];for(fn=0,fl=i.length;fn<fl;fn++){T=i[fn];fm.push(bD('<option value="'+T.id+'">'+T.name+"</option>").prop("selected",T.id===fk))}return fm})())},auto:function(){var i;i=$F("timezone_auto");if(i){return bD("#tz").hide()}else{if(eO.default_country){bD("#timezone_country").val(eO.default_country);eO.update_timezones_dropdown(eO.default_country)}return bD("#tz").show()}},load_data:function(j,i){eO.timezones_by_country=j;return eO.default_country=i}};var bg,bI;bI=E.CreateApp={init:function(fk,j){var T,fl,i;this.accepted_tos_by_uid=fk;this.form=T=bD("#create-app-form");this.email_verification=null;if(!cK.get_viewer().is_paired){i=cK.get_viewer().get_users()[0];this.select_user(i.id)}fl=(function(fm){return function(fn){var fo;fo=fn.target.name;return T.find("input[name="+fo+"]").each(function(){bD(this).parents("label").removeClass("active");return T.removeClass(bD(this).data("next"))})}})(this);T.find("input[type=radio]").change(function(fm){fl(fm);bD(fm.target).parents("label").addClass("active");return T.addClass(bD(this).data("next"))});T.find("input[type=checkbox]").change(function(fm){var fn;if(bD(this).filter("#accept-tos").length){return}bD(fm.target).parents("label").toggleClass("active");fn=T.find("input[name="+(bD(this).attr("name"))+"]:checked");T.toggleClass(bD(this).data("next"),fn.length!==0)});T.find(".role-choice input").change((function(fm){return function(fo){var fn,fp;fn=T.find(".role-choice input:checked");fp=fn.val();if(!cK.get_viewer().is_uid_signed_in(fp)){fn.prop("checked",false);fl(fo);bM.show_modal({user_id:fp,on_success:function(){return fn.prop("checked",true).trigger("change")}});return false}else{return fm.select_user(fp)}}})(this));T.find("input:checked").trigger("change");T.find("input[name=tos_accept]").change((function(fm){return function(fn){return fm.update_submit_enabled()}})(this));T.find("#send-verify-email, #resend-verify-email").click((function(fm){return function(fn){fm.email_verification.send_email(j,function(){T.addClass("verify-email-sent");fm.email_verification.flash_email_sent_notification();return fm.email_verification.ensure_polling(function(){if(!fm.email_verification.user.is_email_verified){return}T.addClass("email-verified");T.removeClass("verifiy-email-sent");T.removeClass("email-unverified");return fm.update_submit_enabled()})});return false}})(this));return T.submit(function(fm){T=bD(fm.target);bR.ajax_submit(T[0],false,(function(fn){return window.location.href=fn.responseText}));return false})},select_user:function(i){this.email_verification=d1.get_for_user(cK.get_viewer().get_user_by_id(i));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[i]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var j,i;i=this.email_verification.user;j=this.accepted_tos_by_uid[i.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!j)}};bg=INLINE_JS.Apps=E.Apps={init_apps:function(){return bD("#show-disabled-apps").click(function(){bD(this).parent().hide();bD("#disabled-apps").show();return false})},init_app_info:function(j,T,i){this.user_email=i;bD("#app-info .icon-container").each(function(fl,fm){var fk;fk=bD(fm);return fk.append(Dropbox.createChooseButton({success:function(fn){fk.find(".icon").attr("src",fn[0].thumbnailLink);return fk.find("input[type=hidden]").val(fn[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=ff.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=ff.tmpl("webhook_info_row_tmpl");bD("#domain-list").on("click",".img-container",function(fk){bg.remove_domain(fk.currentTarget.parentNode,j)});bD("#oauth-uri-list").on("click",".img-container",function(fk){bg.remove_oauth_uri(fk.currentTarget.parentNode,j)});bD("#webhook-list").on("click",".img-container",function(fk){bg.remove_webhook(fk.currentTarget.parentNode,j)});bD("#webhook-list").on("click",".webhook-actions.enabled .webhook_disable",function(fk){bg.update_webhook_url(fk.currentTarget,j,false)});bD("#webhook-list").on("click",".webhook-actions.disabled .webhook_enable",function(fk){bg.update_webhook_url(fk.currentTarget,j,true)});bD("#generate-token-button").on("click",function(fk){bg.generate_access_token(j)});bD("#delete-app-button").on("click",function(fk){bg.confirm_disable(T,j,0)});bD("#webhook_url").on("click change paste focus",function(fk){bD("#webhook-form").removeClass("error")});this.init_app_info_add_redirect_uri();return bD("#oauth2-allow-implicit-grant").on("change",function(fk){return bg.set_oauth2_allow_implicit_grant(fk.currentTarget,j)})},init_app_info_add_redirect_uri:function(){var i,j,T,fk;j=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!j){return}fk=window.decodeURIComponent(j[1]);i=bD("#oauth-add-uri-form");bD("input[name=oauth_uri]",i).val(fk);T=bD("#add-redirect-uri-modal")[0];bD("#add-redirect-uri-modal-uri").text(fk);fa.show(ey("Add OAuth redirect URI"),T,{doit:function(){var fl;if(window.history&&window.history.replaceState){fl=window.location.href;fl=fl.substring(0,fl.indexOf("#"));window.history.replaceState({},document.title,fl)}else{window.location.hash=""}fa.hide();return bg.submit_new_oauth_uri(bD("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(i){this.ds_info=i;if(cK.get_viewer().is_paired){this.role_picker=C.controller(bD("#role-selector"));this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return bM.set_during_login_callback((function(j){return function(fk,T){return j.app_datastores_browse_reload_info(function(){return T()},function(){T("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(j,i){bD.ajax({url:"/developers/apps/datastores/info",success:(function(T){return function(fk){T.ds_info=fk;T.app_datastores_browse_render();return typeof j==="function"?j():void 0}})(this),error:(function(T){return function(fk){return typeof i==="function"?i(fk):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var fk,T,j,i;T=bD("#no_apps_container").empty();if(bD("#apps_developed_container").children().length!==0||bD("#apps_used_container").children().length!==0){return}fk=bD("<div class='empty-state'></div>").appendTo(T);switch((j=this.role_picker)!=null?j.get_state():void 0){case dZ.PERSONAL:case dZ.WORK:i=cK.get_viewer().get_user_by_role(this.role_picker.get_state());return fk.append("You don't have any datastores in your "+cK.get_role_title(i)+" Dropbox.");default:return fk.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(fp){var fk,fo,fl,fn,T,i,fm;fn=this.app_datastores_browse_get_id_info(fp);fo=bD(fp);fo.empty();fk="";for(T=0,i=fn.length;T<i;T++){fl=fn[T];if(this.app_datastores_should_render(fl.uid)){fk+=fl.html}}if(fk){fo.append(this.app_datastores_browse_get_id_header(fp));fm=bD("<div class='app-list clearfix'/>").appendTo(fo);return fm.html(fk)}},app_datastores_should_render:function(j){var i;if(this.role_picker!=null){i=cK.get_viewer().get_user_by_id(j);return this.role_picker.is_role_visible(i.role)}else{return true}},app_datastores_browse_get_id_info:function(i){switch(i){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return cJ(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(i){switch(i){case"#apps_developed_container":return bD("<h2>Apps you develop</h2>");case"#apps_used_container":return bD("<h2>Apps you use</h2>");default:return cJ(false,"invalid ds group id")}},generate_access_token:function(j){var fk,T,i;i=this;fk=bD("#generate-token-button");T=bD("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fk.replaceWith(T);return bD.ajax({url:"/developers/apps/generate_access_token",type:"POST",data:{app_id:j},dataType:"json",success:function(fm){var fl;if(fm.status==="ok"){fl=bD("<div>").append(bD("<input>").attr("id","generated-token").attr("type","text").attr("value",fm.token).prop("readonly",true).click(function(){return bD(this).select()}));fl.append(bD("<div>").addClass("detail-text").text(fm.warning))}else{if(fm.status==="error"){fl=bD("<div>").addClass("detail-text").addClass("error").text(fm.msg)}}return T.replaceWith(fl)},error:function(){return ah.error("Unable to complete your request.")}})},confirm_disable:function(fk,T,j){var fl,i;fl=(j?ey("Are you sure you want to disable '%(app_name)s'?"):ey("Are you sure you want to delete '%(app_name)s'?"));dt.fillVal(fl.format({app_name:fk.escapeHTML()}),"app-disable-text");fa.show((j?ey("Confirm disable"):ey("Confirm delete")),$("app-disable-modal"));i="/developers/disable_app/"+T;$("app-disable-modal").down("form").action=i;return $("disable-app-button").setValue((j?ey("Disable"):ey("Delete")))},enable_app:function(j){var i;i="/developers/enable_app/"+j;return window.location.href=i},show_uninstall:function(fm,fl,T,j,fk,i){var fn;if(fm){Event.stop(fm)}fa.vars={app_id:T,user_id:i};fn=bD("#delete-"+j+"-app-confirm");if(j==="sandbox"){if(!fk){bg.do_uninstall();return}bD(".app_folder",fn).text(fk)}bD(".app_name",fn).text(fl);fa.show(ey("Remove %(app_name)s?").format({app_name:bS.em_snippet(fl,22)}),fn[0],fa.vars);return null},do_uninstall:function(){var i;i=fa.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:fa.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(j){var T;ah.success(j.responseText);T=bD(".apps-"+i);bD("#inst-app-"+fa.vars.app_id+"-row",T).hide().removeClass("active_app");if(bD(".active_app",T).length===0){T.hide()}if(bD(".active_app").length===0){bD("#empty-explanation").text(ey("You have no apps linked to your Dropbox."));return bD("#applications-explanation",T).remove()}},subject_user:i});return fa.hide()},enable_users_in_dev:function(i,j){new Ajax.DBRequest("/developers/enable_users_in_dev/"+i,{onSuccess:function(T){fa.show(ey("Limit raised to %d users").format(j),$("increased-dev-user-limit-modal"));bD("#users-in-dev-none, #users-in-dev-some").hide();return bD("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(i){fa.show(ey("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+i,{onSuccess:function(j){bD("#current-app-users-1, #current-app-users-2").text("0");return fa.hide()}})}});return false},unlink_all_teams_in_dev:function(i){fa.show(ey("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return bD.ajax({url:"/developers/unlink_all_teams/"+i,type:"POST",success:function(j){bD("#current-app-teams").text("0");return fa.hide()}})}});return false},restore_sandbox:function(j,fk,i){var fm,T,fl;fm=bD("#restore-sandbox")[0];fa.show(ey("Restore app folder '%(filename)s'").format({filename:bS.em_snippet(aA.filename(fk),17)}),fm);fl=bD("#restore-sandbox-form")[0];T={ns_id:i};T[Constants.UID_PARAM_NAME]=j.id;return bR.add_vars(fl,T)},submit_restore_sandbox:function(j){var i;i=$("restore-sandbox-form");bR.ajax_submit(i,false,(function(T){fa.hide();ah.success(ey("Restored app folder"));if(T.responseText.length){return cr.reload_fqpath(T.responseText)}else{return cr.reload("","",true)}}),false,j.target);return false},submit_app_info:function(i){var j;j=bD(i).find("input[name=name]").val();bR.clear_errors(i);return bR.ajax_submit(i,false,(function(){ah.success("App info updated.");if(j){return bD("#app-info h1").text(j)}}))},submit_folder_name:function(i){var j;j=bD(i).find("input[name=folder]").val();bR.clear_errors(i);return bR.ajax_submit(i,false,(function(){ah.success("App folder name updated.");bD("#folder-name .text").text(j);return bg.hide_folder_input()}))},submit_new_webhook:function(j){var T,ft,fr,fm,fo,fn,fs,fq,fl,fp,fk,i;ft=bD(j);fo=bD("#webhook-list");fm=bD("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fr=ft.find("input[name=webhook_url]");fk=function(fv,fu){if(fu){fu.remove()}if(fo.find(".hoverable-url").length===0){fo.addClass("hide-status")}bD("#webhook-form-error").text(fv);return bD("#webhook-form").addClass("error")};fs=fr.val();if(fs===""){fk("Empty URI");return}fq=G.parse(fs);if((fl=fq.scheme)!=="http"&&fl!=="https"){fk("URI scheme must be http or https");return}if(!fq.authority){fk("Improperly formatted URI (typo maybe?)");return}if(((fp=fq.authority)==="localhost"||fp==="127.0.0.1")||fq.authority.indexOf("[::1]")===0){fk("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(fo.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){fk("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}T=bD(this._webhook_info_row_tmpl({url:fs,status:"Verifying"}).toHTML());T.find(".status").append(fm);T.find(".webhook-actions").removeClass("disabled").addClass("enabled");fo.append(T);fo.removeClass("hide-status");bD("#webhook-form").removeClass("error");fn=bR.collect_form_vars(j);fr.val("");i=new Date().getTime();return bD.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:fn,success:function(fw){var fu,fv;if(fw.status==="invalid"){fk(fw.failure_text,T);return fr.val(fs)}else{fv=new Date().getTime()-i;fu=Math.max(0,1000-fv);return setTimeout((function(){if(fw.status==="ok"){return T.find(".status").text("Enabled")}else{if(fw.status==="error"){T.find("textarea").text(fw.failure_text);T.find(".status").text(fw.status_text).addClass("error");T.find(".timestamp").text("Just now");return T.find(".webhook-failure-info").css("display","")}}}),fu)}},error:function(){ah.error("Unable to complete your request.");T.remove();return fr.val(fs)}})},remove_webhook:function(T,j){var fk,i;bD("#webhook-form").removeClass("error");i=bD(T).find(".value").text();fk=bD("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");bD(T).find(".status").text("Removing").removeClass("error").append(fk);return bD.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:j,webhook_url:i},dataType:"json",success:function(fn){var fl,fm;fl=T.parentNode;fm=fl.parentNode;fm.removeChild(fl);if(fm.getElementsByClassName("hoverable-url").length===0){bD(fm).addClass("hide-status")}if(!bD("#webhook_url").val()){return bD("#webhook_url").val(i)}},error:function(){return ah.error("Unable to complete your request.")}})},update_webhook_url:function(fm,fk,T){var fn,i,fl,fo,j;j=bD(fm.parentNode.parentNode).find(".value").text();bD("#webhook-form").removeClass("error");fl=fm.parentNode.parentNode.parentNode;fn=bD("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");i=bD(fl).find(".status").text();T=i==="Disabled";fo=T?"Enabling":"Disabling";bD(fl).find(".status").text(fo).removeClass("error").append(fn);return bD.ajax({url:"/developers/apps/update/update_webhook_url",type:"POST",data:{app_id:fk,webhook_url:j,enable:T},dataType:"json",success:function(fq){var fp;i=bD(fl).find(".status").text();fp=i==="Disabling"?"Disabled":"Enabled";bD(fl).find(".status").text(fp).removeClass("error").removeClass("img");if(i==="Disabling"){return bD(fl).find(".webhook-actions").removeClass("enabled").addClass("disabled")}else{return bD(fl).find(".webhook-actions").removeClass("disabled").addClass("enabled")}},error:function(fp){return ah.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(j,i){return bD.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:i,allow:bD(j).val()},dataType:"json",success:function(T){return ah.success("OAuth 2 allow implicit grant updated.")},error:function(){return ah.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(j){var i;i=bD(j).find("input[name=oauth_uri]").val();bR.clear_errors(j);return bR.ajax_submit(j,false,(function(){ah.success("OAuth URI added.");bg.add_oauth_uri(i);return bD(j).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(j){var i;i=bD("#oauth-uri-list");i.append(this._hoverable_tmpl({value:j}).toHTML());return i.show()},remove_oauth_uri:function(j,i){var T,fk;fk=bD(j).find(".value").text();T=function(fm){var fl;ah.success("OAuth URI removed.");fl=j.parentNode;fl.removeChild(j);if(fl.getElementsByTagName("div").length===0){return fl.hide()}};return bD.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:i,oauth_uri:fk},dataType:"json",success:T,error:function(){return ah.error("Unable to complete your request.")}})},submit_new_domain:function(i){var j;j=bD(i).find("input[name=domain_name]").val();bR.clear_errors(i);return bR.ajax_submit(i,false,(function(){ah.success("Domain added.");bg.add_domain(j);return bD(i).find("input[name=domain_name]").val("")}))},add_domain:function(j){var i;i=bD("#domain-list");i.append(this._hoverable_tmpl({value:j}).toHTML());return i.show()},remove_domain:function(j,i){var T,fk;fk=bD(j).find(".value").text();T=function(fm){var fl;ah.success("Domain removed.");fl=j.parentNode;fl.removeChild(j);if(fl.getElementsByTagName("div").length===0){return fl.hide()}};return bD.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:i,domain_name:fk},dataType:"json",success:T,error:function(){return ah.error("Unable to complete your request.")}})},show_need_users_modal:function(i){fa.show(ey("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(i){return fa.show(ey("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(i){fa.show(ey("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},show_need_icon_modal:function(i){fa.show(ey("Please add an icon for this app",{comment:"Error message"}),$("app-need-icon-modal"));return false},hide_folder_input:function(){bD("#folder-name").show();return bD("#folder-input").hide()},show_folder_input:function(){bD("#folder-name").hide();bD("#folder-input").show();return bD("#folder-input input[name=folder]").focus()}};var cE,dD;dD=INLINE_JS.twitter_auth_complete=function(i){cJ(i!=null,"user_id must be provided");if(cE.onLoginSuccessCallback){cE.onLoginSuccessCallback(i)}else{window.location.reload()}return false};cE=E.Twitter={is_authed:function(i){i=parseInt(i);if(cE._authed_users==null){cE._authed_users={}}return cE._authed_users[i]},set_is_authed:function(i,j){i=parseInt(i);if(cE._authed_users==null){cE._authed_users={}}return cE._authed_users[i]=j},get_progress_container:function(){var i;cJ(cE.progress_container,"Twitter is missing progress_container");i=$(cE.progress_container);cJ(i,"Missing progress_container elm");return i},follow_dropbox:function(j,i){var T;cJ(i!=null,"user_id must be provided");if(j.showWorking){j.showWorking()}T=function(){if(j.onFailure){return j.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(fk){if(!fk.responseText.startsWith("ok")){return T()}else{if(j.onSuccess){return j.onSuccess()}}},onFailure:function(){return T()},subject_user:i})},do_auth:function(fk,i){var T,j;cJ(i!=null,"user_id must be provided");j=G({path:"/twitter/request_token"}).updateQuery(Constants.UID_PARAM_NAME,i).toString();window.open(j,"twitter_auth","width=800,height=400");T=function(fl){cE.set_is_authed(fl,true);return typeof fk==="function"?fk(fl):void 0};return cE.onLoginSuccessCallback=T},show_auth:function(i){if(i){cE.onLoginSuccessCallback=i}return dt.updateFromElm(cE.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(cE.should_hide_modal()){fa.hide()}return cE.get_progress_container().update(dt.fromElm("sharing-progress"))},show_complete:function(j){var i;i=cE.get_progress_container();i.update(dt.fromElm("sharing-posted"));return cE.show_complete_into(j,i)},show_complete_into:function(fn,i){var fk,fl,T,fm,j;fk="twitter";fm=ey("View tweet");j=void 0;if(fn.startsWith("ok")){j="http://www.twitter.com/"}else{j=fn}fl=i.down("#view-post");fl.href=j;fl.update(fm);T=cv.make("web",fk);return fl.__sert({top:T})},post:function(fk,fm,T,i){var fl,j;cJ(i!=null,"user_id must be provided");cJ(fk,"Twitter message is empty");fl={message:fk,from_referrals:cE.from_referrals,from_getspace:cE.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:fl,onSuccess:function(fn){var fo,fp;if(fn.responseText==="login"){cE.onLoginSuccessCallback=function(){return cE.post(fk,null,null,i)};fo=cE.custom_show_auth||cE.show_auth;return fo()}else{if(cE.should_hide_modal()){fa.hide()}fp=cE.onPostSuccessCallback||cE.show_complete;return fp(fn.responseText)}},subject_user:i});j=cE.custom_show_posting||cE.show_posting;return j()},custom_post:function(j,T,i){cJ(i!=null,"user_id must be provided");if(T){cE.onPostSuccessCallback=T}if(!j){return}cJ(j,"Twitter message doesn't exist");if(!cK.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(j))}else{return cE.post(j,null,null,i)}},get_user_info:function(j,i){cJ(i!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(T){return j(JSON.parse(T.responseText))},subject_user:i})},should_hide_modal:function(){if(typeof cE.hide_modal==="undefined"){return true}else{return cE.hide_modal}}};var dr,e1,dC,Y,eQ,au,bF,ao,e0,bB,fb=function(fk,j){for(var i in j){if(di.call(j,i)){fk[i]=j[i]}}function T(){this.constructor=fk}T.prototype=j.prototype;fk.prototype=new T();fk.__super__=j.prototype;return fk},di={}.hasOwnProperty,b1=function(i,j){return function(){return i.apply(j,arguments)}};dC=E.LightboxPreviewBase=(function(){function i(j){this.link_hash=j.link_hash;this.filename=j.filename;this.fq_path=j.fq_path;this.thumbnail_url_tmpl=j.thumbnail_url_tmpl;this.dl_url=j.dl_url;this.ns_id=j.ns_id;this.ns_path=j.ns_path;this.display_time=j.display_time||null;this.more_actions_item_tmpl=ff.tmpl("lightbox_more_actions_item_tmpl")}i.prototype.shutdown=function(){};i.prototype.preload=function(){};i.prototype.render=function(){};i.prototype.image_size=function(){var j;j=document.viewport.getDimensions();return aG(j.width,j.height)};i.prototype.get_more_actions_above_divider=function(T){var fk,j;j=[];fk=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,_ns_id:this.ns_id,_ns_path:this.ns_path,sprite_name:"lightbox_download",item_text:ey("Download"),more_classes:"more-actions-item",Sprite:cv});j.push(fk);return j};i.prototype.get_more_actions_below_divider=function(j){return[]};i.prototype.is_a_timeline_preview=function(){return this instanceof eQ||this instanceof dr||this instanceof au||this instanceof e1};i.prototype.is_an_album_preview=function(){return this instanceof eQ||this instanceof au};i.prototype.is_a_photo_preview=function(){return this instanceof Y};i.prototype.is_a_video_preview=function(){return this instanceof bF};i.prototype.get_actions=function(fk){var fm,fo,fp,T,fl,j,fn;j=[];if(!this.is_a_timeline_preview()&&fk.enable_sublinks){if(fk.share_button_experiment_variant==="WHITE_BUTTON"){fp=bD("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){fl=(function(fq){return function(fr){a9.ShmodelUILogger.log("via-shmodel-lightbox");return window.open(G.parse(fq.shmodel_link).updateQuery("m","1"))}})(this)}else{fl=(function(fq){return function(fr){fr.preventDefault();a9.ShmodelUILogger.log("via-browse-lightbox");return dv.shmodel(fq.fq_path,"browse_lightbox")}})(this)}}else{fp=bD("<a />",{id:"lightbox_share_link","class":"title_bubble black"});fp.html(cv.make("web","link_white"));if(this.is_a_photo_preview()){fp.attr("title",ey("Share link to photo"))}else{if(this.is_a_video_preview()){fp.attr("title",ey("Share link to video"))}else{cJ(false,"preview needs to be a photo or video")}}if(this.shmodel_link){fp.attr("href",G.parse(this.shmodel_link).updateQuery("m","1"));fp.attr("target","_blank");fl=(function(fq){return function(fr){return a9.ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{fp.attr("href","#");fl=(function(fq){return function(fr){fr.preventDefault();a9.ShmodelUILogger.log("via-browse-lightbox");return dv.shmodel(fq.fq_path,"browse_lightbox")}})(this)}}fp.on("click",fl);j.push(fp[0])}if(fk.include_delete){fn=bO.in_single_collection_view()?ey("Remove"):ey("Delete");if(fk.share_button_experiment_variant==="WHITE_BUTTON"){fm=bD("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");fm.find(".sprite-text-inner").text(fn);fm.on("click",(function(fq){fq.preventDefault();return aL.delete_current()}))}else{fm=bD("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:fn});fm.html(cv.make("web","lightbox_delete_16"));fm.on("click",(function(fq){fq.preventDefault();return aL.toggle_delete()}))}j.push(fm[0])}if(fk.share_button_experiment_variant==="WHITE_BUTTON"){T=(function(fq){return function(fr){fr.preventDefault();return aL.toggle_more_actions_menu()}})(this);fo=bD("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",T);j.push(fo[0])}else{cJ(aL.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");j.push(aL.more_actions_button)}return j};i.prototype.delete_pressed=function(){var j;j=ey("Deleting...");if(this.is_a_timeline_preview()){if(bO.in_single_collection_view()){j=ey("Removing...");bO.get_current_collection().remove_photos([this.photo])}else{bO._delete_photos([this.photo])}}else{document.fire(aL.PHOTO_DELETE_EVT,this)}return ah.success(j)};i.prototype.set_more_actions_event_handlers=function(j){};i.prototype.replace_dl_action_with_open_action_if_file_available=function(){var T,fl,fk,j;if(__CONDITIONAL_JS__.UnityFeatures==null){return}j=cr.active_user.id;fk=(function(fm){return function(fn,fq,fo){var fr,fp;fr=bD("#lightbox_download_link");if(!(fr.data("ns-id")===fn&&fr.data("ns-path")===fq)){return}fp=bD(fm.more_actions_item_tmpl({_id:"unity_open_action",_href:"#",_ns_id:fn,_ns_path:fq,sprite_name:"lightbox_open",item_text:ey("Open"),more_classes:"more-actions-item",Sprite:cv}).toHTML());fr.replaceWith(fp);return fp.on("click",function(fs){return __CONDITIONAL_JS__.UnityFeatures.open_file(fn,fq,fo,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(ft){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})})}})(this);if((fl=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fl.is_cached_and_locally_available(this.ns_id,this.ns_path):void 0){return fk(this.ns_id,this.ns_path,j)}else{T=(function(fm){return function(fn){if(fn.is_locally_available){return fk(fm.ns_id,fm.ns_path,j)}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.ns_id,this.ns_path,j,T)}};return i})();Y=INLINE_JS.PhotoPreview=E.PhotoPreview=(function(j){fb(i,j);function i(T){i.__super__.constructor.call(this,T);this.original_url=String(G.parse(T.original_url).updateQuery(Constants.UID_PARAM_NAME,cr.active_user));this.shmodel_link=T.shmodel_link;this.fail_image_src="/static/images/preview_fail-vflc3IDxf.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false;this.enable_download=T.enable_download}i.prototype.show_fail=function(fk){var T;return T=bD(fk).find(".lightbox_fail_text").text(ey("Unable to preview this item."))};i.prototype.fallback=function(fk){var T,fl;T=$(fk.target);T.writeAttribute({src:this.fail_image_src,width:128,height:128});fl=T.up("div.content-item");if(fl){return this.show_fail(fl)}};i.prototype.is_gif=function(){return"gif"===aA.file_extension(this.filename).toLowerCase()};i.prototype.preload=function(fl){var fk,fm,T;T=G.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){T=this.thumbnail_url_tmpl}fm=(function(fn){return function(){if(typeof fl==="function"){fl()}return fn.loaded=true}})(this);d3.preload_image(T,this.fallback.bind(this),fm);fk=$(d3.preloaded_images[T]);fk.writeAttribute("data-original-href",this.original_url);fk.setAttribute("enable-download",this.enable_download);fk.writeAttribute("class","thumbnail");return fk};i.prototype.render=function(fo,fl){var fm,fk,fn,T,fp;if(this.loaded){fl()}fk=this.preload(fl);fp=bD("<div />",{"class":"content-item"}).append(fk);fm=bD("<div />",{"class":"lightbox_fail_text"});fp.append(fm);fn=fk.getAttribute("src").length;T=fk.getAttribute("src").substring(fn-this.fail_image_src.length,fn);if(T===this.fail_image_src){this.show_fail(fp)}fo.appendChild(fp[0]);return fp[0]};i.prototype.advance_on_click=true;i.prototype.get_more_actions_above_divider=function(fl){var fk,T;T=i.__super__.get_more_actions_above_divider.call(this,fl);fk=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:ey("View original"),more_classes:"more-actions-item",Sprite:cv});T.push(fk);return T};return i})(dC);bF=E.VideoPreview=(function(i){fb(j,i);function j(T){this._player_error=b1(this._player_error,this);this._player_ready=b1(this._player_ready,this);j.__super__.constructor.call(this,T);this.preview_url=T.preview_url;this.shmodel_link=T.shmodel_link;this.thumbnail_div=null;this.metadata_link=T.metadata_link!=null?T.metadata_link:void 0;this.metadata=null;this.player=null}j.prototype.render_error=function(fm){var fo,fk,T,fl,fn;fk=bD("<div/>");T=bD("<img/>",{src:"/static/images/preview_fail-vflc3IDxf.png","class":"video-preview-fail"});fl=bD("<div/>",{"class":"video-preview-fail"});if(fm==="needflash"){fl.html(ey('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{fl.text(ey("Unable to preview this item.",fn="web",fo="preview means showing the item in the same browser window without downloading a copy."))}fk.append(T,fl);return fk[0]};j.prototype._player_ready=function(){var T;T=function(){bD(".vjs-poster").show();bD(".vjs-big-play-button").show();return bD(".vjs-big-play-button").focus()};return T.defer()};j.prototype._onPlay=function(){bD(".vjs-poster").hide();return bD(".vjs-big-play-button").hide()};j.prototype._onEnded=function(){bD(".vjs-poster").show();bD(".vjs-big-play-button").show();return bD(".vjs-loading-spinner").hide()};j.prototype._player_error=function(T){this.shutdown();this.div=this.render_error(T);return bD("#file-preview-modal .content-item").html(this.div)};j.prototype.preload=function(){};j.prototype.render=function(fk,T){this.div=this.render_video(fk);return this.div};j.prototype.render_video=function(fp){var T,fn,fl,fk,fo,fm;fm=new Element("div",{"class":"video-player content-item"});fo=this.image_size().split("x")[0]*0.8;fk=parseInt(fo*0.55,10);fn=false;fl=G.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();T=(function(fq){return function(fr){return fq.metadata=fr}})(this);this.player=br.embed(fm,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:fo,height:fk,controls:true,preload:"auto",poster:fl,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:T});fp.appendChild(fm);bD(".vjs-poster").hide();bD(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return fm};j.prototype.shutdown=function(){var fk,fl,T;bD(".vjs-big-play-button").blur();if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((T=this.player.tech.sourceBuffer)!=null){T.abort()}}this.player.dispose()}catch(fl){fk=fl}return this.player=null}};return j})(dC);ao=function(T){var i,j;i=(function(fl){fb(fk,fl);function fk(fm){fm.ns_id=fm.photo.ns_id;fm.ns_path=fm.photo.ns_path;fk.__super__.constructor.call(this,fm);this.photo=fm.photo;bm.set_vertical_space(3);if(bO.in_single_collection_view()){bD("#lightbox-delete-photo").val(ey("Remove"))}else{bD("#lightbox-delete-photo").val(ey("Delete"))}}fk.prototype.get_more_actions_above_divider=function(fo){var fn,fm;fm=fk.__super__.get_more_actions_above_divider.call(this,fo);fn=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:ey("Add to album"),more_classes:"more-actions-item",Sprite:cv});fm.push(fn);return fm};fk.prototype.toggle_select_button_off=function(fm){if(this.is_a_photo_preview()){fm.attr("title",ey("Select photo"))}else{if(this.is_a_video_preview()){fm.attr("title",ey("Select video"))}}fm.html(cv.make("web","lightbox_unselected"));fm.removeClass("selected");fm.addClass("elbboggiw");return setTimeout((function(){return fm.removeClass("elbboggiw")}),540)};fk.prototype.toggle_select_button_on=function(fm){if(this.is_a_photo_preview()){fm.attr("title",ey("Un-select photo"))}else{if(this.is_a_video_preview()){fm.attr("title",ey("Un-select video"))}}fm.html(cv.make("web","lightbox_selected"));fm.addClass("selected");fm.addClass("wiggobble");return setTimeout((function(){return fm.removeClass("wiggobble")}),540)};fk.prototype.toggle_select=function(fn){var fm;fn.preventDefault();fm=bD("#lightbox-select-button");bm.hide_all();if(eT.contains(this.photo)){eT._remove(this.photo);return this.toggle_select_button_off(fm)}else{eT._add(this.photo);return this.toggle_select_button_on(fm)}};fk.prototype.get_actions=function(fo){var fn,fm,fp;fn=[];fp=bD("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});aL.update_share_button_text(null,bD(fp));fp.on("click",((function(fq){return function(fs){var fr;fs.preventDefault();fr=eT.get();if(fr.length===0){return ex.show([fq.photo],false)}else{return ex.show(eT.get(),false)}}})(this)));fm=bD("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:ey("Select this photo")});if(eT.contains(this.photo)){fm.html(cv.make("web","lightbox_selected"))}else{fm.html(cv.make("web","lightbox_unselected"))}fm.on("click",this.toggle_select.bind(this));fn.push(fp[0]);fn.push(fm[0]);return fn.concat(fk.__super__.get_actions.call(this,fo))};fk.prototype.set_more_actions_event_handlers=function(fm){$("lightbox_add_to_album").observe("click",((function(fn){return function(fo){fo.preventDefault();return cH.show_add_to_album_modal(fo,[fn.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(fn){return function(fo){fo.preventDefault();return bO.show_in_folder(fn.photo)}})(this)));return fk.__super__.set_more_actions_event_handlers.call(this,fm)};fk.prototype.get_more_actions_below_divider=function(fo){var fn,fm;fn=[];fm=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:ey("Show in folder"),more_classes:"more-actions-item",Sprite:cv});fn.push(fm);fn=fn.concat(fk.__super__.get_more_actions_below_divider.call(this,fo));return fn};return fk})(T);j=(function(fl){fb(fk,fl);function fk(){return fk.__super__.constructor.apply(this,arguments)}fk.prototype.get_more_actions_below_divider=function(fo){var fm,fn;fn=[];fm=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:ey("Remove from album"),more_classes:"more-actions-item",Sprite:cv});fn.push(fm);fn=fn.concat(fk.__super__.get_more_actions_below_divider.call(this,fo));return fn};fk.prototype.set_more_actions_event_handlers=function(fm){$("lightbox_remove_from_album").observe("click",((function(fn){return function(fo){fo.preventDefault();return cH.show_remove_photos_modal(bO.get_current_collection(),[fn.photo])}})(this)));return fk.__super__.set_more_actions_event_handlers.call(this,fm)};return fk})(i);return[i,j]};e0=ao(Y),dr=e0[0],eQ=e0[1];bB=ao(bF),e1=bB[0],au=bB[1];var aL;aL=INLINE_JS.Lightbox=E.Lightbox=(function(){var i,fH,fQ,gc,fk,f6,fp,fP,f1,fx,f0,fM,fV,gb,fw,fN,fu,fZ,f3,fo,f2,fn,fF,f5,fz,fO,fr,fI,fW,fJ,fS,fl,fB,j,fR,f4,ga,fY,fy,fE,fm,fD,fU,T,fs,fX,fK,fL,fv,fG,ft,f9,fC,fA,f8,f7,fT,fq;f7=[];fC=0;fT=false;f8=true;fK=void 0;i=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;fq=false;f5=void 0;f1=void 0;fU=-1;T=null;fV=null;fN=false;j=false;fo=false;fu=null;fw=function(gd){return gd.complete!==false};fm=function(){var gd;if($$("#file-preview-modal .loading-image").length){return}gd=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black-vflweQQeE.gif"});return $$("#file-preview-modal .preview-content").first().__sert(gd)};fM=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};fJ=function(){var gj,gi,gf,gd,gh,gg,ge;gi=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!gi||!fw(gi)){return}gd=$$("#file-preview-modal .preview").first().getDimensions();gj=void 0;if(!gi.naturalHeight){gj=gi.getDimensions();gi.naturalHeight=gj.height;gi.naturalWidth=gj.width}else{gj={width:gi.naturalWidth,height:gi.naturalHeight}}gf=gj.width/gd.width;ge=gj.height/gd.height;gg=Math.max(gf,ge);gi.style.visibility="";if(gg<1){gi.style.width="";gi.style.height=""}else{gi.style.width=Math.floor(gj.width/gg)+"px";gi.style.height=Math.floor(gj.height/gg)+"px"}gh=bD("#file-preview-modal .paging-block").position().left-16;return bD("#file-preview-modal .filename").css("max-width",gh)};fP=void 0;f2=function(){var gk,gf,gj,ge,gd,gi,gh,gg;gf=$("file-preview-modal");gi=gf.down(".menu");gj=gf.down(".header");gh=$$(".lightbox-not-important");gg=[];for(ge=0,gd=gh.length;ge<gd;ge++){gk=gh[ge];gg.push(gk.addClassName("opacity-zero"))}return gg};fD=function(){var gh,ge,gd,gg,gf;if(fP){clearTimeout(fP)}gg=$$(".lightbox-not-important");gf=[];for(ge=0,gd=gg.length;ge<gd;ge++){gh=gg[ge];gf.push(gh.removeClassName("opacity-zero"))}return gf};fS=function(ge){var gd;fD();gd=ge&&$(ge.target).descendantOf("file-preview-menu");if(fP!=null){clearTimeout(fP)}if(f8){if(!fq&&!gd){return fP=setTimeout(f2,3112)}}};fX=function(){if(fP!=null){clearTimeout(fP)}return f8=false};fs=function(){f8=true;return fS()};gb=function(ge){var gd;gd=f7.length;return(gd+(fC+ge)%gd)%gd};fO=function(ge){var gf,gd;if(f5.no_preload){return}gd=fy.bind(null,ge);return typeof(gf=f7[ge]).preload==="function"?gf.preload(gd):void 0};fr=function(){var gf,ge,gd,gh,gg;gh=[1,2,3,4,5,6,-1,-2];gg=[];for(gf=0,ge=gh.length;gf<ge;gf++){gd=gh[gf];if(Math.abs(gd)<f7.length){gg.push(fO(gb(gd)))}else{gg.push(void 0)}}return gg};fB=function(gd){if(!f5.filename_in_url){return}if(gd!=null){a2.replace_hash("lh",gd)}else{a2.replace_hash("")}return fu=gd};fW=function(){var gd,ge;gd=bD("#file-preview-modal");ge=(f5!=null?f5.num_previews:void 0)||f7.length;if(fN&&j&&fo){gd.find(".lightbox-index-text-container").text(ey("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(fN){if(j){gd.find(".lightbox-index-text-container").text(ey("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{gd.find(".lightbox-index-text-container").text("")}}else{gd.find(".lightbox-index-text-container").text(ey("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:fC+1,num_total_files:ge}))}}if(f7.length===1){gd.find(".prev").addClass("opacity-zero");return gd.find(".next").addClass("opacity-zero")}else{if(fC===0&&f5.no_wrap){gd.find(".prev").addClass("opacity-zero");return gd.find(".next").removeClass("opacity-zero")}else{if(fC===f7.length-1&&f5.no_wrap){gd.find(".prev").removeClass("opacity-zero");return gd.find(".next").addClass("opacity-zero")}else{gd.find(".prev").removeClass("opacity-zero");return gd.find(".next").removeClass("opacity-zero")}}}};fk=function(gh,ge,gg,gd,gf){var gi;gi={user_id:null,context:ge,platform:aW.FileViewPlatformType.WEB,ns_id:gh.ns_id,sjid:null,ns_path:gh.ns_path,shared_link_url:gg,extra:{mode:gd,file_ext:gf}};return gi};fR=function(ge,gC){var gp,gq,gs,gx,gl,gf,gn,gg,gh,gt,gd,gy,go,gi,gB,gA,gw,gm,gv,gk,gu,gz,gj,gr;fU=b4.time();cJ(fC<f7.length,"Invalid index "+fC);gu=f7[fC];if(typeof gu!=="object"){if(T){clearTimeout(T)}T=setTimeout((function(){if((aL.shown!=null)&&aL.shown){return fR(ge,gC)}}),100);return}bD("#file-preview-modal").trigger(aL.LIGHTBOX_SHOW_EVT,{preview:gu});gf=aA.file_extension_for_logging(gu.filename);gg=aW.FileViewModeType.PHOTOS_LIGHTBOX;gn=aW.FileViewContextType.PRIVATE;gh=null;gi="lightbox";if(gu.fq_path!=null){gg=aW.FileViewModeType.BROWSE_LIGHTBOX;gn=aW.FileViewContextType.PRIVATE;gi="browse_lightbox"}else{if(gu.shmodel_link!=null){gg=aW.FileViewModeType.SHARED_LINK_LIGHTBOX;gn=aW.FileViewContextType.SHARED_LINK;gh=gu.shmodel_link;gi="shmodel_lightbox"}}gt=fk(gu,gn,gh,gg,gf);a9.FileViewLogger.log(gt);a9.WebLightboxLogger.log(a9.WebLightboxLogger.VIEW,{context:gi,file_ext:gf});gA=bD("#file-preview-modal");gz=gA.find(".preview-content");gk=ge?fY:fy;gz.empty();gl=gu.render(gz[0],gk);gA=gA[0];if(!fV){fV=gA.on("contextmenu","img.thumbnail",bl.show_for_lightbox.bind(bl))}fB(gu.link_hash);fW();if(gu.display_time){if(gu.filename.match(i)){gA.down(".filename").__date(gu.display_time)}else{gA.down(".filename").__date(gu.display_time+" - "+gu.filename)}}else{gA.down(".filename").__date(gu.filename)}gA.down(".filename").writeAttribute("title",gu.filename);if(bO.in_single_collection_view()&&((gj=bO.get_current_collection().member_fnames)!=null?gj.length:void 0)>1&&(((gr=gu.photo)!=null?gr.item_owner_fname:void 0)!=null)){gx="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";gx+=ey("Added by %(fname)s").format({fname:bS.em_snippet(gu.photo.item_owner_fname,7)});gA.down(".added-by").__date(new ff(gx));gA.down(".added-by").show()}else{gA.down(".added-by").hide()}gm=ff.tmpl("lightbox_more_actions_item_tmpl");gw=gu.get_more_actions_above_divider(f5);gs=gu.get_more_actions_below_divider(f5);if(gs.length){gw.push(gm({divider:true,Sprite:cv}));gw=gw.concat(gs)}$("lightbox-more-actions-list").__date(gw);gu.set_more_actions_event_handlers(f5);if(bD(gA).data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)){gu.replace_dl_action_with_open_action_if_file_available()}gq=gu.get_actions(f5);gd=document.createDocumentFragment();for(gy=0,go=gq.length;gy<go;gy++){gp=gq[gy];gd.appendChild(gp)}gA.down(".actions").__date();gA.down(".actions").appendChild(gd);if(f5.share_button_experiment_variant==="WHITE_BUTTON"){gv=bD("#lightbox-more-actions-button .sprite-div").width();bD("#lightbox-more-actions-menu").css("right",gv/2)}document.fire(aL.ACTIONS_ADDED);if(bO.in_single_collection_view()){gA.down(".album-name").show().__date(bS.em_snippet(bO.get_current_collection().name,15,1));gA.down(".filename").addClassName("faded")}else{gA.down(".album-name").hide();gA.down(".filename").removeClassName("faded")}gl=gl.down("img.thumbnail");if(gl){if(!fw(gl)){gl.hide();fm();gl.observe("load",function(){fM();gl.style.visibility="hidden";gl.show();return fJ()})}else{gl.show();fJ()}}gB={preview_obj:gu,index:fC,direction:gC};return document.fire(aL.PHOTO_CHANGE_EVT,gB)};ga=function(gi){var ge,gf,gd,gg,gh;if(fU===-1){return}gh=b4.time()-fU;if(typeof g!=="undefined"&&g!==null){ge=g.get_current_view()}else{if(typeof am!=="undefined"&&am!==null?am.is_album:void 0){ge="album_shmodel"}else{ge="not_photos"}}gf={current_view:ge};gd=bD("#file-preview-modal .content-item img.thumbnail")[0];if((gd!=null)&&(gd.src!=null)){gg=G.parse(gd.src).getQuery();if("size" in gg){gf.size=gg.size}}ee.log_ajax_transition(gh,gi,gf);fU=-1;return fr()};fY=function(){return ga("file-preview-lightbox-load-initial")};fy=function(gd){var ge;if(typeof gd==="number"){if((ge=f7[gd])!=null){ge.loaded=true}if(gd===fC){return ga("file-preview-lightbox-load")}}else{return ga("file-preview-lightbox-load")}};f4=function(gd){var ge;ge=bD("#lightbox-click-catcher");if(!ge.length){ge=bD("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});ge.appendTo("#file-preview-modal .modal-preview-content");if(bZ.msie_version_at_most(10)){ge.css("background","black");ge.fadeTo(0,0)}}ge.off("click");ge.on("click",(function(gf){gf.preventDefault();return gd()}));return ge.show()};fx=function(){return bD("#lightbox-click-catcher").hide()};gc=function(){var gd;gd=bD("#lightbox-more-actions-button");if(gd.hasClass("toggled")){fx();gd.removeClass("toggled");$("lightbox-more-actions-menu").hide();bD(document).trigger("dropdownClosed",[1]);fs();return true}return false};fF=function(){var gd;gd=bD("#lightbox-more-actions-button");if(!gd.hasClass("toggled")){f0();gd.addClass("toggled");bm.hide_all();bD("#lightbox-more-actions-menu").show();bD(document).trigger("dropdownOpened",[1]);fX();return f4(aL.close_more_actions_menu)}};fv=function(){if(bD("#lightbox-more-actions-button").hasClass("toggled")){return gc()}else{return fF()}};fn=function(ge){var gd;if(fN){j=true;fW()}gc();if(ge){ge.preventDefault()}if(fC===f7.length-1&&f5.no_wrap){return}if((gd=f7[fC])!=null){gd.shutdown()}fC=gb(1);if(fC===0){fS()}return fR(null,aL.NEXT)};fI=function(ge){var gd;if(fN){j=true;fW()}gc();if(ge){ge.preventDefault()}if(fC===0&&f5.no_wrap){return}if((gd=f7[fC])!=null){gd.shutdown()}fC=gb(-1);return fR(null,aL.PREV)};fQ=function(gd){if(gd){gd.preventDefault()}if(f7[fC].advance_on_click){if(gd.clientX<bD(window).width()/10){return fI()}else{return fn()}}};f6=function(gj){var gg,gd,gi,gk,gf,ge,gh;gg=f7.dict_by("fq_path");gk=void 0;if(gj.memo.files){gk=gj.memo.files.collect(function(gl){return gl.fq_path})}else{gk=gj.memo.fq_paths}gh=[];for(gf=0,ge=gk.length;gf<ge;gf++){gi=gk[gf];if(gg[gi]){gd=f7.indexOf(gg[gi]);f7.splice(gd,1);if(f5.num_previews){f5.num_previews--}if(!f5.num_previews&&!f7.length){gh.push(f1())}else{if(gd===f7.length){gh.push(fI())}else{gh.push(fR())}}}else{gh.push(void 0)}}return gh};fl=function(gd){if(f7[fC].is_a_timeline_preview()){return f7[fC].toggle_select(gd)}};fG=function(){Event.stopObserving(document,"mousemove",fS);Event.stopObserving(document,"click",fS);document.stopObserving(aL.PHOTO_DELETE_EVT,fz);document.stopObserving(aH.DELETE,f6);document.stopObserving(eT.CHANGE_EVT,ft);return clearInterval(fK)};f1=function(gh){var gg,gf,ge,gd;if(gh){gh.preventDefault()}if(!aL.shown){return}if((gf=f7[fC])!=null){gf.shutdown()}gg=$("file-preview-modal");gg.hide();gg.down(".preview-content").__date();C.scroll_unlock_document();fG();fB();aL.shown=0;gg.stopObserving("click",aL.back);if((ge=$$(".preview-content"))!=null){if((gd=ge.first())!=null){gd.stopObserving("click")}}return bD("#file-preview-modal").trigger(aL.LIGHTBOX_HIDE_EVT)};fA="db:filepreview:exitselect";fH=function(ge){var gd;if(f5.keep_url){f1()}else{if((gd=f7[fC])!=null){gd.shutdown()}window.history.go(-1)}if(ge!=null){if(ge.originalEvent){ge=ge.originalEvent}Event.extend(ge).stop()}return document.fire(fA,f7[fC])};fz=function(gd){return dB.do_delete(cr.active_user,gd.memo.fq_path)};f3=function(){var gd;if(!fT){gd=bD("#file-preview-modal");gd.on("click",".close",fH);key("esc",aL.KEY_SCOPE,(function(ge){if(bD("#lightbox-more-actions-button").hasClass("toggled")){return gc()}else{if(fq){return f0()}else{return fH(ge)}}}));gd.on("click",".next",fn);gd.on("click",".prev",fI);gd.on("click",".preview-container",fQ);key("left, k",aL.KEY_SCOPE,function(ge){return fI()});key("right, j",aL.KEY_SCOPE,function(ge){fn();return false});key("up, down",aL.KEY_SCOPE,function(ge){return false});key("x, s, space",aL.KEY_SCOPE,function(ge){fl(ge);return false});if(f5.include_delete&&f5.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",aL.KEY_SCOPE,function(ge){Event.extend(ge).preventDefault();return aL.toggle_delete()});bD("#lightbox-delete-photo").on("click",(function(ge){fL();return f7[fC].delete_pressed()}));bD("#lightbox-delete-cancel").on("click",f0)}eB.add_exit_callback("/lightbox",function(){return f1()});d3.disableSelection(gd.find(".preview-container")[0]);d3.disableSelection(gd.find(".header")[0]);fT=true}Event.observe(document,"mousemove",fS);Event.observe(document,"click",fS);document.observe(aH.DELETE,f6);document.observe(aL.PHOTO_DELETE_EVT,fz);document.observe(eT.CHANGE_EVT,ft);key.setScope(aL.KEY_SCOPE);return fK=setInterval(fJ,500)};fZ=function(){var gg,ge,gd,gh,gf;if(!fu){return}gf=[];for(gg=ge=0,gd=f7.length;ge<gd;gg=++ge){gh=f7[gg];if(gh.link_hash&&gh.link_hash.toLowerCase()===fu.toLowerCase()){fC=gg;if(!aL.shown){gf.push(aL.show())}else{gf.push(fR())}}else{gf.push(void 0)}}return gf};f9=function(){return on_script_loaded(function(){a2.watch("lh",function(gd){fu=gd;return fZ()});return a2.watch("f",function(gd){var gh,gf,ge,gi,gg;gg=[];for(gh=gf=0,ge=f7.length;gf<ge;gh=++gf){gi=f7[gh];if(gi.filename.toLowerCase()===gd.toLowerCase()){fC=gh;if(!aL.shown){gg.push(aL.show())}else{gg.push(fR())}}else{gg.push(void 0)}}return gg})})};ft=function(gh,gj){var gf,gi,gg,gd,ge;if(gj==null){gj=bD("#lightbox_share")}ge=eT.get();gg=c7.categorize_files(ge),gf=gg[0],gi=gg[1];if(ge.length===0){gj.text(ey("Share"));return(gd=f7[fC])!=null?gd.toggle_select_button_off(bD("#lightbox-select-button")):void 0}else{if(ge.length===1){if(gf){return gj.text(ey("Share 1 photo"))}else{return gj.text(ey("Share 1 video"))}}else{if(gf&&gi){return gj.text(ey("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:ge.length}))}else{if(gf){return gj.text(ey("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:ge.length}))}else{return gj.text(ey("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:ge.length}))}}}}};fE=function(){bm.hide_all();bD("#file-preview-modal .delete-file-prompt").show();bD(document).trigger("dropdownOpened",[1]);fD();fq=true;f4(aL.toggle_delete);return bD("#lightbox-delete-photo").focus()};f0=function(){var ge,gd;if(fq){ge=bD("#file-preview-modal .delete-file-prompt");ge.hide();bD(document).trigger("dropdownClosed",[1]);if((gd=ge.find(":focus")[0])!=null){gd.blur()}fS();fq=false;return fx()}};fL=function(){gc();if(fq){return f0()}else{return fE()}};fp=function(){return f7[fC].delete_pressed()};return{init_from_preview_objs:function(gh,gk,ge){var gj,gg,gf,gi,gd;if(ge==null){ge=true}gd=[];for(gg=0,gf=gh.length;gg<gf;gg++){gj=gh[gg];if(gj.is_video){gi=new bF({filename:gj.filename,fq_path:gj.path,thumbnail_url_tmpl:gj.thumbnail_url,preview_url:gj.preview_url,dl_url:gj.dl_url,shmodel_link:gj.shmodel_link,ns_id:gj.ns_id,ns_path:gj.path,link_hash:gj.item_id+"-"+gj.filename,metadata_link:gj.metadata_link})}else{gi=new Y({filename:gj.filename,fq_path:gj.path,thumbnail_url_tmpl:gj.thumbnail_url,dl_url:gj.dl_url,original_url:gj.orig_url,shmodel_link:gj.shmodel_link,ns_id:gj.ns_id,ns_path:gj.ns_path,link_hash:gj.item_id+"-"+gj.filename,enable_download:gj.enable_download})}gd.push(gi)}aL.init(gd,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:ge});return document.on(aL.EXIT_SELECT_EVT,function(gm){var gl;key.setScope("all");gl=bD(gk)[gd.indexOf(gm.memo)];d3.scroll_to_thumb(gl);bD(gl).addClass("wiggobble");return setTimeout((function(){return bD(gl).removeClass("wiggobble")}),1000)})},init:function(gd,ge){if(aL.shown){return}aL.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:ey("More actions")});aL.more_actions_button.observe("click",(function(gf){gf.preventDefault();return aL.toggle_more_actions_menu()}));aL.more_actions_button.__date(cv.make("web","lightbox_more"));ge=ge||{};f5={include_delete:ge.include_delete||false,keep_url:ge.keep_url||false,num_previews:ge.num_previews||null,filename_in_url:ge.filename_in_url||false,no_wrap:(ge.no_wrap||false)||true,no_preload:ge.no_preload||false,enable_sublinks:ge.enable_sublinks!=null?ge.enable_sublinks:true,share_button_experiment_variant:ge.share_button_experiment_variant||false};fN=ge.is_loading||false;cJ(!f5.filename_in_url||f5.keep_url,"filename_in_url cannot be used with keep_url off");f7=gd;if(ge.start_index!=null){aL.show(ge.start_index)}if(f5.filename_in_url){f9()}return $(document.body).on("click",".more-actions-item",function(gf,gg){if(gg.down("a").getAttribute("href").length<2){gf.preventDefault()}return aL.close_more_actions_menu()})},update_previews:function(gd){return f7=gd},show:function(gd){var ge,gf;if(aL.shown){return}cJ(f7&&f7.length,"Lightbox.show() requires file preview objects to show");f3();if(gd!=null){fC=gd}bD("#file-preview-modal").trigger("lightbox-init-show",{preview:f7[fC]});if((gf=f7[fC])!=null?gf.enable_download:void 0){aL.more_actions_button.show()}else{aL.more_actions_button.hide()}cJ(!aL.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();C.scroll_lock_document();fR(true);aL.shown=1;if(!f5.keep_url){ge=eB.deconstruct_url(eB.get_url());if(ge.path.indexOf("/lightbox/")!==0){eB.push_state("/lightbox"+ge.path,ge.qargs)}}return fS()},jump_to:function(gd){cJ(aL.shown,"Lightbox should be showing");fC=gd;fR();return fS()},set_no_wrap:function(gd){return f5.no_wrap=gd},update_with_error:function(){fo=true;return fW()},num_previews:function(){return f5.num_previews||f7.length},get_previews:function(){return f7},current_index:function(){return fC},close_more_actions_menu:gc,toggle_more_actions_menu:fv,update_share_button_text:ft,toggle_delete:fL,delete_current:fp,back:fH,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:fA,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var bE;bE=E.Tour=(function(){var fk,T,fm,fn,fr,fp,fq,fo,fl,fs,j,i;T=6;fk=0;j=function(ft){var fE,fC,fB,fA,fy,fv,fu,fw,fD,fx,fz;$$(".page-end").each(Element.remove);fu=ft;fz=T-ft-1;fE=document.createDocumentFragment();for(fC=fA=0,fw=fu;0<=fw?fA<fw:fA>fw;fC=0<=fw?++fA:--fA){fv=new Element("img",{src:"/static/images/page-left-vflvWgvOr.png","class":"page-end-left page-end"});fv.style.left=(28-fC*5)+"px";fv.style.zIndex=T-fC;fE.appendChild(fv)}for(fB=fy=0,fD=fz;0<=fD?fy<fD:fy>fD;fB=0<=fD?++fy:--fy){fx=new Element("img",{src:"/static/images/page-right-vflnAeb-6.png","class":"page-end-right page-end"});fx.style.right=(31-fB*5)+"px";fx.style.zIndex=T-fB;fE.appendChild(fx)}return $("book").appendChild(fE)};i=function(ft){(ft>0?Element.show:Element.hide)("tour-page-back");return(ft+1<T?Element.show:Element.hide)("tour-page-forward")};fl=function(ft){$$(".pages").invoke("hide");return $("page-"+ft).show()};fm=function(ft){i(ft);j(ft);fl(ft);return fk=ft};fo=function(fu){var ft;Event.extend(fu).preventDefault();ft=fk-1;if(ft<0){return}fm(ft);return eB.push_state("/tour/"+ft)};fp=function(fu){var ft;Event.extend(fu).preventDefault();ft=fk+1;if(ft>=T){return}fm(ft);return eB.push_state("/tour/"+ft)};fs=function(fu,fv){var ft;fu.preventDefault();ft=parseInt(fv.href.split("/").last(),10);fm(ft);return eB.push_state("/tour/"+ft)};fr=function(){$("tour-page-back").observe("click",fo);$("tour-page-forward").observe("click",fp);key("right",fp);key("left",fo);return $("toc").on("click","a",fs)};fn=function(fu,fv){var ft;ft=parseInt(fu,10)||0;if(ft<0||ft>=T){ft=0}return fm(ft)};fq=function(){var fx,fu,ft,fw,fv;fw=$$(".page-right img");fv=[];for(fu=0,ft=fw.length;fu<ft;fu++){fx=fw[fu];fv.push(d3.preload_image(fx.src))}return fv};return{setup:function(){return bD(function(){eB.add_callback("/tour",fn);fr();return fq()})}}})();var bO,cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};bO=INLINE_JS.Photos=E.Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(fo,T,fl,fs,fp,fk,j,fq,fu,i){var fn,fr,ft,fm;this.event_metadata_cache=j;this._root_collection_gid=i;this.initialized=true;this.disable_selection();d3.disable_ie_image_dragging();this._tmpl=ff.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=ff.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=fp!=null?fp.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=fq.include_shared_folders;this.show_hidden=fq.show_hidden;this.timestamp_edit_enabled=fu.timestamp_edit_enabled;this.undo_enabled=fu.undo_enabled;this.local_storage_enabled=fu.local_storage_enabled;fr=eB.deconstruct_url();fm="share" in fr.qargs;for(ft in fs){if(fs.hasOwnProperty(ft)){eT.inc_num_loading_events_before_select(fm)}}this._init_timeline(fo,T,fl,fs);this._init_lightbox();fn=[];if(fp!=null){fn.push(new ad(fp,false))}cH.init(fn,fk);eT.drag_select_enabled=fu.drag_select_enabled;if(fq.show_photos_tour){aN.next()}delete fr.qargs.selr;delete fr.qargs.user_email;delete fr.qargs.uid;delete fr.qargs.share;delete fr.qargs.m;if("uuid" in fr.qargs){delete fr.qargs.uuid;delete fr.qargs.id}if(dJ){eB.replace_state(fr.path,fr.qargs)}else{if(!G.parse(window.location.href).fragment){eB.push_state("/photos",fr.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(aL.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(aL.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(aL.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(aL.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(bl.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));eB.add_callback("/photos",this._history_change_handler.bind(this));document.observe(db.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(db.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(ci.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(ci.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));bD("#photos-nav-item").on("click",this.show_all_photos.bind(this));bD("#back-to-photos").on("click",this._back_to_photos.bind(this));bD("#back-to-albums").on("click",this._back_to_albums.bind(this));bD("#share-selected").on("click",this._share_selected.bind(this));bD("#clear-selected").on("click",this._clear_selected.bind(this));bD("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){bD("#do-include-shared-folders").prop("checked",true)}else{bD("#dont-include-shared-folders").prop("checked",true)}cH.listen();eT.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return bD(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(fp){var fn,fo,fk,i,T,fm,fl;fo=$(fp.target).up(".cu-month-header").identify().slice(2);fn=this.get_timeline().events.valueFromKey(fo);fm=fn.photos;fl=[];for(fk=0,i=fm.length;fk<i;fk++){T=fm[fk];fl.push(eT._add(T))}return fl},_share_event:function(fo){var fm,fn,fk,i,T,fl;fn=$(fo.target).up(".cu-month-header").identify().slice(2);fm=this.get_timeline().events.valueFromKey(fn);fl=fm.photos;for(fk=0,i=fl.length;fk<i;fk++){T=fl[fk];eT._add(T)}return this._share_selected()},_add_event_to_album:function(fo){var fm,fn,fk,i,T,fl;fn=$(fo.target).up(".cu-month-header").identify().slice(2);fm=this.get_timeline().events.valueFromKey(fn);fl=fm.photos;for(fk=0,i=fl.length;fk<i;fk++){T=fl[fk];eT._add(T)}return cH.show_add_to_album_modal(fo,eT.get())},_init_timeline:function(fn,T,fl,fq){var j,fr,fo,i,fk,fp,fs,fm;if(!fn.length){this.show_empty_state();return}j=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");fm=$("cu-view").cumulativeOffset().top+j.getLayout().get("margin-top")+j.getLayout().get("padding-top");if(bD("#carousel-promo-banner").outerHeight()){fm+=bD("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}fo=$("cu-view").cumulativeOffset().left+j.getLayout().get("margin-left")+j.getLayout().get("padding-left");fr={top_offset:fm,left_offset:fo,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};i={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};fs=new ci(j,null,fn,T,fl,fq,this._tmpl,fr,i);if(this.in_single_collection_view()){if((fk=this._single_collection_timeline)!=null){fk.unlisten()}this._single_collection_timeline=fs}else{if((fp=this._all_photos_timeline)!=null){fp.unlisten()}this._all_photos_timeline=fs}return this.get_timeline().render()},_init_lightbox:function(){var j,i;if(this.get_timeline()==null){return}if(aL.shown){i=this.get_timeline().get_preview_objs();if(i.length){aL.update_previews(i);j=Math.min(aL.current_index(),i.length-1);return aL.jump_to(j)}else{return aL.back()}}else{return aL.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(j){var i;if((i=this.get_timeline())!=null){i.unlisten()}eT.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(j);return window.scrollTo(0,0)},_refresh_photo_events:function(i){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(j){return function(T){var fk;fk=JSON.parse(T.responseText);if(fk==="deleted_collection"){j._current_collection_gid=null;cH.reload();j.show_all_collections();ah.error(ey("This album has been deleted!"));return}j._init_timeline(fk.header_ids,fk.header_id_to_name,fk.header_id_to_num_photos,{});j._init_lightbox();return typeof i==="function"?i():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(i){if(i.duplicates_info!=null){return this._show_duplicates_modal(i,false)}else{return window.open(this._get_browse_link(i),"_blank")}},_get_browse_link:function(j){var i;i=fh.get_browse_root(cK.get_viewer().photos_user);return String(G({path:""+i+(aA.normalize(aA.parent_dir(j.fq_path))),query:{select:j.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return cH.get(this._current_collection_gid)}else{return null}},get_current_collection_gid:function(){return this._current_collection_gid||this._root_collection_gid},enable_selection:function(){return d3.enableSelection($(document.body))},disable_selection:function(){return d3.disableSelection($(document.body))},show_collection:function(T){var j,i;g.log_transition_to(cl.SINGLE_COLLECTION_VIEW);i=eB.deconstruct_url();j="/lightbox";if(i.path.indexOf(j)===0){i.path=i.path.slice(j.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(cR.call(i.path,"/album/")<0){if(i.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(T!=null){i.path=cH.get(T).url}return eB.push_state(i.path,i.qargs)},show_all_collections:function(){g.log_transition_to(cl.ALBUMS_VIEW);return eB.push_state("/photos/all_albums")},show_all_photos:function(j){var i;j.preventDefault();g.log_transition_to(cl.PHOTOS_VIEW);i=eB.deconstruct_url();if(i.path==="/photos"){return this._refresh_view()}else{eT.clear();return eB.push_state("/photos")}},_back_to_photos:function(i){eT.clear();return this.show_all_photos(i)},_back_to_albums:function(i){eT.clear();return this.show_all_collections()},get_thumb_click_event_data:function(T,i){var j;j=T.event;return{timeline_photo_index:i,event_photo_index:j.photos.indexOf(T),num_photos_in_event:j.photos.length,event_index:this.get_timeline().events.list.indexOf(j.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(j){var i;i=this.get_timeline().get_photo_for_thumb_elm($(j.target));if(eT._drag_drop.ignore_next_click){return eT._drag_drop.ignore_next_click=false}else{return eT.photo_click(j,i)}},_thumb_double_click:function(fk){var T,j,i;j=this.get_timeline().get_photo_for_thumb_elm($(fk.target));i=this.get_timeline().index_of_photo(j);this._preview(i);T=this.get_thumb_click_event_data(j,i);return g.log_interaction(ej.OPEN_LIGHTBOX,da.DBL_CLICK,T)},_thumb_context_menu:function(fn){var fk,i,T,fo,fm,fl;T=this.get_timeline().get_photo_for_thumb_elm($(fn.target));if(fn.shiftKey){eT.photo_click(fn,T);return}if(eT.contains(T)){fo=eT.get()}else{fo=[T]}bl.show_photos(fn,fo);fl=[];for(fk=0,i=fo.length;fk<i;fk++){T=fo[fk];fl.push((fm=this.get_timeline().get_thumb_elm_for_photo(T))!=null?fm.addClassName("context-selected"):void 0)}return fl},_context_menu_hide:function(i){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(j){var i;i=eT.get();if(!i.length){return}ex.show(i,false);return g.log_interaction(ej.SHARE,da.SAH,{num_photos:i.length})},_clear_selected:function(j){var i;i=eT.get().length;eT.clear();return g.log_interaction(ej.CLEAR_SELECTED,da.SAH,{num_photos:i})},_share_collection:function(j){var i;cJ(this.in_single_collection_view(),"_share_collection can only happen in single collection view");i=this.get_current_collection();if(i.num_items===0){ah.error(ey("This album is empty. Add some photos before you share it!"));return}ex.show(this.get_current_collection(),true);return g.log_interaction(ej.SHARE_ALBUM,da.SCA)},toggle_mem_lane_settings:function(i){var T,j;if(i){Event.extend(i).preventDefault()}if(!bD("#memory-lane-settings-menu").visible()){j=bD("#memory-lane-settings-menu");eR.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));T=function(fk){return fk.stopPropagation()};j.off("mousedown");j.off("click");j.on("mousedown",T);return j.on("click",T)}},show_delete_photos_modal:function(fq){var fr,fo,fm,fn,fl,fp,i,T,fk;if(fq.length===1){T=fq[0];if(T.duplicates_info!=null){this._show_duplicates_modal(T,true);return}}else{fr=[];for(fm=0,fn=fq.length;fm<fn;fm++){T=fq[fm];if(T.duplicates_info!=null){fo=T.duplicates_info.slice(0);fo.push(T);fo.sort(function(fs,j){return j.mtime-fs.mtime});fr=fr.concat(fo)}}if(fr.length){this._show_delete_multiple_duplicates_modal(fq,fr);return}}fk=c7.categorize_files(fq),fp=fk[0],i=fk[1];if(fp&&i){fl=bb("Delete %(file_count)s item?","Delete %(file_count)s items?",fq.length)}else{if(fp){fl=bb("Delete %(file_count)s photo?","Delete %(file_count)s photos?",fq.length)}else{fl=bb("Delete %(file_count)s video?","Delete %(file_count)s videos?",fq.length)}}return dK.show({title_text:fl.format({file_count:fq.length}),body_html:ey("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:c7.file_desc(fq)}),confirm_text:ey("Delete"),cancel_text:ey("Cancel"),confirm_callback:(function(j){return function(){return j._delete_photos(fq)}})(this)})},_delete_photos:function(fx){var fp,fr,ft,fq,fk,fo,fm,fs,fn,fv,i,T,fw,fl,fu;fx=fx.slice(0);fw=[];for(fo=0,fs=fx.length;fo<fs;fo++){T=fx[fo];fw.push(T.fq_path);if(T.duplicates_info!=null){fl=T.duplicates_info;for(fm=0,fn=fl.length;fm<fn;fm++){fk=fl[fm];fw.push(fk.fq_path)}}}fu=c7.categorize_files(fx),fv=fu[0],i=fu[1];if(fv&&i){fq=bb("Deleting file","Deleting files",fw.length);ft=bb("Deleted file.","Deleted files.",fw.length)}else{if(fv){fq=bb("Deleting photo","Deleting photos",fw.length);ft=bb("Deleted photo.","Deleted photos.",fw.length)}else{fq=bb("Deleting video","Deleting videos",fw.length);ft=bb("Deleted video.","Deleted videos.",fw.length)}}fr=function(j){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(j)},html_in_error_msg:true,progress_text:ey("Undoing..."),onSuccess:function(fy){var fz;fz=ey("Undo complete");ah.success(fz);return bO._all_photos_timeline.restore_removed_photos()},subject_user:cK.get_viewer().photos_user})};fp=(function(j){return function(fy){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:fw},job:fw.length>bO.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:cK.get_viewer().photos_user,progress_text:fq,onSuccess:function(fB){var fz,fC,fA;fC=fB.responseText.evalJSON();fA=bO.undo_enabled&&(bO._all_photos_timeline!=null);fz=fA?fC.changesets:null;X.notifyWithUndo(fq,fz,fr);bO.get_timeline().remove_photos(fx);if(fy.length>0){return cH.refresh_album_views(fy)}},subject_user:cK.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(fw)},onSuccess:(function(j){return function(fA){var fz,fy,fB,fC;fy=JSON.parse(fA.responseText);fB=[];for(fC in fy){fz=fy[fC];fB=fB.concat(fz)}return fp(fB)}})(this)})},_preview:function(i){return aL.show(i)},_lightbox_delete:function(i){var j;j=i.memo.photo;g.log_interaction(ej.DELETE,da.LIGHTBOX);return this.show_delete_photos_modal([j])},_lightbox_remove:function(j){var i;i=j.memo.photo;this.get_current_collection().remove_photos([i]);return g.log_interaction(ej.REMOVE,da.LIGHTBOX)},_show_duplicates_modal:function(T,fy){var fr,fx,fo,ft,fs,fm,fv,fn,fq,fl,fp,fu,i,fk,fw;fs=T.duplicates_info.slice(0);fs.push(T);fs.sort(function(fz,j){return j.mtime-fz.mtime});ft=$("cu-duplicate-files");fm=[];for(fn=0,fq=fs.length;fn<fq;fn++){fo=fs[fn];fx="Dropbox"+aA.normalize(aA.parent_dir(fo.fq_path));fm.push(this._cu_duplicate_tmpl({thumbnail_url:fo.thumbnail_url,filename_snippet:bS.em_snippet(fo.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bS.em_snippet(fx,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fo)}))}ft.__date(fm);if(fs.length>=5){ft.addClassName("scroll")}else{ft.removeClassName("scroll")}fk=c7.categorize_files([T]),fu=fk[0],i=fk[1];if(fu){fl=ey("There are multiple copies of this photo.");fp=ey("Delete all copies of this photo?")}else{fl=ey("There are multiple copies of this video.");fp=ey("Delete all copies of this video?")}if(fy){fv="delete_32";fw=fp;fr=fl+" "+ey("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{fv="folder_32";fw=ey("Show in folder");fr=fl+" "+ey("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}dt.fillVal(fr,"cu-duplicates-desc");return fa.show(fw,$("cu-duplicates-modal"),{action:this._delete_photos.curry([T])})},_show_delete_multiple_duplicates_modal:function(fv,fr){var fu,fo,fs,fl,fm,fq,fk,fp,fn,ft,i,T;fs=$("cu-multiple-duplicate-files");fl=[];for(fm=0,fq=fr.length;fm<fq;fm++){fo=fr[fm];fu="Dropbox"+aA.normalize(aA.parent_dir(fo.fq_path));fl.push(this._cu_duplicate_tmpl({thumbnail_url:fo.thumbnail_url,filename_snippet:bS.em_snippet(fo.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bS.em_snippet(fu,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fo)}))}fs.__date(fl);if(fr.length>=5){fs.addClassName("scroll")}else{fs.removeClassName("scroll")}T=c7.categorize_files(fv),ft=T[0],i=T[1];if(ft&&i){fk=ey("Delete %(num_files)s files and all copies?").format({num_files:fv.length});fp=ey("There are multiple copies of these files in your Dropbox.");fn=ey("Show files with multiple copies")}else{if(ft){fk=ey("Delete %(num_photos)s photos and all copies?").format({num_photos:fv.length});fp=ey("There are multiple copies of these photos in your Dropbox.");fn=ey("Show photos with multiple copies")}else{fk=ey("Delete %(num_videos)s videos and all copies?").format({num_videos:fv.length});fp=ey("There are multiple copies of these videos in your Dropbox.");fn=ey("Show videos with multiple copies")}}dt.fillVal(fp,"cu-multiple-duplicates-desc");dt.fillVal(fn,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return fa.show(fk,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(fv)})},show_timestamps_modal:function(fm){var j,T,fk,i,fl;fm.sort_by_key((function(fn){return fn.time_taken}),true);i=(function(){var fo,fn,fp;fp=[];for(fo=0,fn=fm.length;fo<fn;fo++){fk=fm[fo];fp.push(fk.time_taken)}return fp})();j=(function(){var fo,fn,fp;fp=[];for(fo=0,fn=fm.length;fo<fn;fo++){fk=fm[fo];fp.push(fk.item_counter)}return fp})();T=(function(){var fo,fn,fp;fp=[];for(fo=0,fn=i.length;fo<fn;fo++){fl=i[fo];if(fl==null){fp.push(fl)}}return fp})();if(T.length===i.length){return this._show_add_timestamps_modal(fm,i,j)}else{if(T.length===0){return this._show_edit_timestamps_modal(fm,i,j)}else{return cJ(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(i,j){return this._refresh_photo_events((function(T){return function(){var fk,fl;fl=("m_"+(j.getFullYear()))+(""+(j.getMonth()+1)).lpad(2);fk=T.get_timeline().events.valueFromKey(fl);cJ(fk!=null,"Event is missing after a timestamp edit!");ez.update("2/3");fk.on_load_all_metadata=function(){T.get_timeline().scroll_to_photo_with_key(i.uniqueness_key);ez.hide();return ah.success("New timestamps have been saved!")};if(fk.has_loaded_metadata()){fk.on_load_all_metadata();return fk.on_load_all_metadata=null}else{return fk.load_metadata()}}})(this))},_show_add_timestamps_modal:function(fl,j,i){var fk,T;T=bD("#add-timestamp-modal");fk=new I("date_picker",{disable_future:true});return fa.show("Set Timestamps",T[0],{action:(function(fm){return function(){var fq,fr,fu,fp,fn,fs,ft,fo;fs=d3.to_iso8601_date(fk.selected_date,false,true);ft=(function(){var fv,fx,fw;fw=[];for(fq=fv=0,fx=fl.length;0<=fx?fv<fx:fv>fx;fq=0<=fx?++fv:--fv){fw.push(fs)}return fw})();fo={};for(fr=fp=0,fn=i.length;fp<fn;fr=++fp){fu=i[fr];fo[fu]=ft[fr]}ez.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fo)},onSuccess:function(fv){ez.update("1/3");return fm._scroll_to_photo_after_timestamp_edit(fl[0],fk.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(fp,fo,fk){var fm,j,i,fn,T,fl;fn=bD("#edit-timestamp-modal");i=(function(){var fr,fq,fs;fs=[];for(fr=0,fq=fo.length;fr<fq;fr++){fl=fo[fr];fs.push(N.toUTCDate(new Date(fl)))}return fs})();T={year:0,month:0,day:0,hour:0};fm=function(fq){return ey("%(date)s at %(time)s").format({date:N.localize(fq),time:N.format(fq,Constants.time_format)})};j=function(fq,fu,fv,ft){var fs,fr;if(fq==null){fq=0}if(fu==null){fu=0}if(fv==null){fv=0}if(ft==null){ft=0}T.year+=fq;T.month+=fu;T.day+=fv;T.hour+=ft;fr=b4.increment_date(new Date(i[0]),T.year,T.month,T.day,T.hour,0);fs=b4.increment_date(new Date(i[i.length-1]),T.year,T.month,T.day,T.hour,0);if(fp.length===1){return fn.find("#timestamp-new").text(fm(fr))}else{fn.find("#timestamp-new-start").text(fm(fr));return fn.find("#timestamp-new-end").text(fm(fs))}};if(fp.length===1){fn.find("#edit-timestamp-single").show();fn.find("#edit-timestamp-multi").hide();fn.find("#timestamp-current").text(fm(i[0]))}else{fn.find("#edit-timestamp-single").hide();fn.find("#edit-timestamp-multi").show();fn.find("#timestamp-current-start").text(fm(i[0]));fn.find("#timestamp-current-end").text(fm(i[i.length-1]))}j();bD("#timestamp-year-plus").on("click",j.curry(1,0,0,0));bD("#timestamp-year-minus").on("click",j.curry(-1,0,0,0));bD("#timestamp-month-plus").on("click",j.curry(0,1,0,0));bD("#timestamp-month-minus").on("click",j.curry(0,-1,0,0));bD("#timestamp-day-plus").on("click",j.curry(0,0,1,0));bD("#timestamp-day-minus").on("click",j.curry(0,0,-1,0));bD("#timestamp-hour-plus").on("click",j.curry(0,0,0,1));bD("#timestamp-hour-minus").on("click",j.curry(0,0,0,-1));fa.onHide=function(){var fr,fs,fq,ft;ft=["year","month","day","hour"];for(fs=0,fq=ft.length;fs<fq;fs++){fr=ft[fs];bD("#timestamp-"+fr+"-plus").off("click");bD("#timestamp-"+fr+"-minus").off("click")}fa.onHide=null;return fa.hide()};return fa.show("Edit Timestamps",fn[0],{action:(function(fq){return function(){var fB,fv,fr,fu,fz,fs,fw,ft,fA,fy,fC,fx;if((((T.year===(fy=T.month)&&fy===(fA=T.day))&&fA===(ft=T.hour))&&ft===0)){return}g.log_interaction(ej.EDIT_TIMESTAMP,da.PCM,{num_photos:fp.length});fs=(function(){var fE,fD,fF;fF=[];for(fE=0,fD=i.length;fE<fD;fE++){fB=i[fE];fF.push(b4.increment_date(fB,T.year,T.month,T.day,T.hour,0))}return fF})();fw=(function(){var fE,fD,fF;fF=[];for(fE=0,fD=fs.length;fE<fD;fE++){fC=fs[fE];fF.push(d3.to_iso8601_date(fC,false,true))}return fF})();fx={};for(fv=fu=0,fz=fk.length;fu<fz;fv=++fu){fr=fk[fv];fx[fr]=fw[fv]}ez.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fx)},job:fp.length>fq.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:cK.get_viewer().photos_user,onSuccess:function(fD){ez.update("1/3");return fq._scroll_to_photo_after_timestamp_edit(fp[0],fs[0])}})}})(this)})},_preload_file_previews:function(fl){var ft,fq,fn,fm,fk,fs,fo,T,fx,fw,fu,fr,fp,fv;fv=this.get_timeline().get_photos();if(fl[0]<=fl[fl.length-1]){fr=null;for(fn=0,fs=fl.length;fn<fs;fn++){fq=fl[fn];T=fv[fq];if(T.status!==K.PLACEHOLDER){continue}fx=T.event;if(fr==null){fr=fx;fu=T}if(fx===fr){continue}if(fr.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}fr.load_metadata();fr=fx;fu=T}if((fr!=null)&&!fr.has_loaded_metadata()){ft=fr.photos.indexOf(fu);fk=fr.photos.indexOf(T);if(fr.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return fr.load_metadata_range(ft,fk)}}else{fp=[];for(fm=0,fo=fl.length;fm<fo;fm++){fq=fl[fm];T=fv[fq];if(T.status!==K.PLACEHOLDER){continue}fx=T.event;fw=fx.photos.indexOf(T);fp.push(fx.load_metadata(fw))}return fp}},_lightbox_photo_change:function(fq){var fn,fm,fk,fs,fl,fr,i,fp,fo,T;this._last_lightbox_photo=fq.memo.preview_obj.photo;fk=fq.memo.index;fl=aL.num_previews();if(fk===0||fk===fl-1){return}if(fq.memo.direction===aL.NEXT||(fq.memo.direction==null)){fs=Math.min(fk+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,fl-1);return this._preload_file_previews((function(){fo=[];for(var ft=i=fk+1;i<=fs?ft<=fs:ft>=fs;i<=fs?ft++:ft--){fo.push(ft)}return fo}).apply(this))}else{if(fq.memo.direction===aL.PREV){fr=Math.max(fk-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){T=[];for(var j=fp=fk-1;fp<=fr?j<=fr:j>=fr;fp<=fr?j++:j--){T.push(j)}return T}).apply(this))}}},_lightbox_exit:function(i){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var j,fk,T,i;i=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");if(bD("#carousel-promo-banner").outerHeight()){i+=bD("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}j=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((fk=this._all_photos_timeline)!=null){fk.update_offsets(i,j)}return(T=this._single_collection_timeline)!=null?T.update_offsets(i,j):void 0},_history_change_handler:function(fv,fu){var fo,fq,ft,fl,fr,fk,i,fs,fp,fn,fm,T;if(this._init_finished){if(fa.shown()){fa.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((i=this.get_timeline())!=null){i.unlisten()}if(fv==="all_albums"){cH.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((fs=$("all-albums-sidebar"))!=null){fs.addClassName("selected")}eT.clear();document.title=ey("Albums")+" - Dropbox";cH.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(fv.startsWith("album/")){fo=cH.get_from_url("/photos/"+fv);fp=$$(".sidebar-album");for(fl=0,fr=fp.length;fl<fr;fl++){ft=fp[fl];if(ft.readAttribute("data-gid")===fo.gid){ft.addClassName("selected");break}}$("single-collection-title").__date(bS.em_snippet(fo.name,cH.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(fo.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",fo.shmodel_url);if(((fn=fo.member_fnames)!=null?fn.length:void 0)>1){fq=ey("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:c7.album_desc(fo),album_members:d3.nice_list(fo.member_fnames)});$("single-collection-share-status").__date(fq)}else{$("single-collection-share-status").__date(ey("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!fo.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=fo.name+" - Dropbox";cy.log_event("show_collection",fo.gid,fo.num_photos,fo.is_anonymous)}else{fo=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=ey("Photos")+" - Dropbox"}fk=false;if(fo!=null){if(fo.gid!==this._current_collection_gid){fk=true}}else{if(this._all_photos_timeline==null){fk=true}}this._current_collection_gid=fo!=null?fo.gid:null;if(fk){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){T=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(T);if((fm=$(T))!=null){fm.addClassName("wiggobble")}setTimeout((function(){return $(T).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var aN;aN=INLINE_JS.PhotosTour=E.PhotosTour={_frame:0,next:function(){var i;fa.show("",bD("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);i=this._frame;g.log_interaction(a7.SHOW_MODAL,"",{frame:i});bD("#modal-x").off("click");bD("#modal-x").on("click",((function(j){return function(){return g.log_interaction(a7.EXIT_MODAL,"",{frame:i})}})(this)));return this._frame=(this._frame+1)%4},hide:function(i){g.log_interaction(i,"");return fa.hide()}};var c7;c7=E.PhotosUtil={categorize_files:function(j){var T,i;T=j.filter(function(fk){return fk.preview_type==="photo"});i=j.filter(function(fk){return fk.preview_type==="video"});return[T.length,i.length]},file_desc:function(fm,fk,i){var j,fl,T;if(fk==null){fk=false}if(i==null){i=false}T=this.categorize_files(fm),j=T[0],fl=T[1];return this._photo_video_desc(j,fl,fk,i)},album_desc:function(T,j,i){if(j==null){j=false}if(i==null){i=false}return this._photo_video_desc(T.num_photos,T.num_videos,j,i)},_photo_video_desc:function(j,fn,T,i){var fk,fm,fl;fm=bb("%d photo","%d photos",j,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(j);fl=bb("%d video","%d videos",fn,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(fn);if(j&&fn){if(T){fk=j+fn;return bb("%d item","%d items",fk).format(fk)}else{if(i){return new ff(fm+"<br/>"+fl)}else{return ey("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:fm,num_videos:fl})}}}else{if(j){return fm}else{if(fn){return fl}else{return""}}}}};var eT,cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};eT=INLINE_JS.PhotosSelection=E.PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(i){return function(j){if(j.keyCode===i.SHIFT_KEY_CODE&&i._last_mouseover&&!C.focus_in_input()){return i._highlight_range(i._last_selected,i._last_mouseover)}}})(this));$(document.body).on("keyup",(function(i){return function(j){if(j.keyCode===i.SHIFT_KEY_CODE&&!i._marquee.active){return i.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",bO.KEY_SCOPE,(function(i){return function(j){j.preventDefault();if(bO.in_single_collection_view()){if(i._selected.length){return cH.show_remove_photos_modal(bO.get_current_collection(),i._selected)}}else{if(i._selected.length){return bO.show_delete_photos_modal(i._selected)}}}})(this));key("esc",bO.KEY_SCOPE,(function(i){return function(T){var j;if(typeof T.preventDefault==="function"){T.preventDefault()}if(i._drag_drop.active){i._drag_drop.active=false;if((j=$("albums-sidebar-list"))!=null){j.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{i.clear();return g.log_interaction(ej.CLEAR_SELECTED,da.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return A.init(null,bD("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(j){var T,i,fk;fk=(function(){var fm,fl,fo,fn;fo=this._selected;fn=[];for(fm=0,fl=fo.length;fm<fl;fm++){i=fo[fm];fn.push(i.uniqueness_key)}return fn}).call(this);return T=j.uniqueness_key,cR.call(fk,T)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");eR.hide_all();return document.fire(eT.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(j,i){if(j.isRightClick()&&!j.shiftKey){return}if(j.shiftKey){return this._select_highlighted()}else{if(this.contains(i)){return this._remove(i)}else{return this._add(i)}}},num_selected:function(){return this._selected.length},refresh:function(T){var fn,fl,fk,fo,fm,i,fp;fp=(function(){var fr,fq,ft,fs;ft=this._selected;fs=[];for(fr=0,fq=ft.length;fr<fq;fr++){i=ft[fr];fs.push(i.uniqueness_key)}return fs}).call(this);fm=[];for(fl=0,fk=T.length;fl<fk;fl++){fo=T[fl];fn=fp.indexOf(fo.uniqueness_key);if(fn>=0){fm.push(this._selected[fn]=fo)}else{fm.push(void 0)}}return fm},inc_num_loading_events_before_select:function(i){if(!this._show_share_after_loading_selected){ez.show(ey("Loading photos..."))}this._show_share_after_loading_selected=i;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;ez.update((this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){ez.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return bO._share_selected()}}}},_photo_mouseover:function(i){this._last_mouseover=bO.get_timeline().get_photo_for_thumb_elm($(i.target));if(i.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(i){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(fk){var i,T,j;if(bO.in_all_collections_view()||fk.isRightClick()||this._invalid_mouse_target($(fk.target))){return}bl.hide();eR.hide_all();i=(T=bO.get_timeline())!=null?T.get_photo_for_thumb_elm($(fk.target)):void 0;if(i!=null){if(this.contains(i)||!eT.drag_select_enabled){j=C.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=fk.clientX+j.left;this._drag_drop.start_y=fk.clientY+j.top;this._drag_drop.anchor=$(fk.target);this._drag_drop.single_photo=this.contains(i)?null:i;this._build_drag_status(i);this._update_drag_status_position(fk)}else{this._drag_select.active=true;this._drag_select.anchor=i}}else{j=C.scroll_offsets();if((fk.clientX+j.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=fk.clientX+j.left;this._marquee.start_y=fk.clientY+j.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return A.start()},_body_mousemove:function(fk){var T,j,i,fl;j=C.scroll_offsets();i=fk.clientX+j.left;fl=fk.clientY+j.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(i-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fl-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=i;this._marquee.end_y=fl;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(i-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fl-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(fk);$$(".sidebar-album").invoke("removeClassName","album-flash");if((T=$("albums-sidebar-list"))!=null){T.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(T){var j,i;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();j=this._highlighted.length;this._select_highlighted();if(j){g.log_interaction(ej.MARQUEE_SELECT,da.DRAG,{num_selected:j})}}if(this._drag_drop.active){if($(T.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((i=$("albums-sidebar-list"))!=null){i.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return A.end()},_body_double_click:function(i){if(bO.get_timeline().get_photo_for_thumb_elm($(i.target))||this._invalid_mouse_target($(i.target))){return}this.clear();return g.log_interaction(ej.CLEAR_SELECTED,da.DBL_CLICK)},_draw_marquee:function(){var i,fl,fk,T,j;j=Math.abs(this._marquee.start_x-this._marquee.end_x);i=Math.abs(this._marquee.start_y-this._marquee.end_y);fk=Math.min(this._marquee.start_y,this._marquee.end_y);fl=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:j+"px",height:i+"px",top:fk+"px",left:fl+"px"});$("marquee").show();T=false;if(bO.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);T=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);T=true}if(T){return this._update_marquee_highlight(fk,fl,j,i)}}},_update_marquee_highlight:function(fv,fm,T,fw){var fs,fq,fn,ft,fp,fo,fk,fu,fr,fl;this.clear_highlighted();fl=[];ft=bO.get_timeline().grid.photo_col_offsets.length;fk=bO.get_timeline().grid.photo_col_offsets.slice(0,ft-1);for(fs=fq=0,fp=fk.length;fq<fp;fs=++fq){fo=fk[fs];if(fo<=fm+T&&bO.get_timeline().grid.photo_col_offsets[fs+1]>=fm){fl.push(fs)}}fr=[];for(fs=fn=0,fu=bO.get_timeline().events.length();0<=fu?fn<fu:fn>fu;fs=0<=fu?++fn:--fn){fr.push(bO.get_timeline().events.valueAtIndex(fs).marquee_highlight(fv,fv+fw,fl))}return fr},_update_marquee_x_bounds:function(T){var fn,fl,fk,fp,fq,fo,fm;fp=$(document.body).getWidth();if(T<bO.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=bO.get_timeline().grid.photo_col_offsets.first()}else{if(T>bO.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=bO.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=fp}else{fo=bO.get_timeline().grid.photo_col_offsets;fm=[];for(fn=fl=0,fk=fo.length;fl<fk;fn=++fl){fq=fo[fn];if(fq>T){this._marquee.x_min_boundary=bO.get_timeline().grid.photo_col_offsets[fn-1];this._marquee.x_max_boundary=fq;break}else{fm.push(void 0)}}return fm}}},_update_marquee_y_bounds:function(fq){var T,fo,fl,fk,fn,fp,fm;fn=$(document.body).getHeight();if(fq<bO.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=bO.get_timeline().grid.photo_row_offsets.first()}else{if(fq>bO.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=bO.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=fn}else{fp=bO.get_timeline().grid.photo_row_offsets;fm=[];for(fo=fl=0,fk=fp.length;fl<fk;fo=++fl){T=fp[fo];if(T>fq){this._marquee.y_min_boundary=bO.get_timeline().grid.photo_row_offsets[fo-1];this._marquee.y_max_boundary=T;break}else{fm.push(void 0)}}return fm}}},_build_drag_status:function(fk){var T,i,j;i=bO.get_timeline().get_thumb_elm_for_photo(fk);j=i.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(j);T=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(c7.file_desc(T,false,true))},_update_drag_status_position:function(i){return $("photos-drag-status").setStyle({left:(i.pointerX()-C.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(i.pointerY()-C.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(fx,fw,fl){var fv,T,fn,fq,fo,ft,fr,fm,fu,fs,fp,fk;if(fl==null){fl=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=fx;this._last_highlight_to_photo=fw;fn=bO.get_timeline().index_of_photo(fx);fk=bO.get_timeline().index_of_photo(fw);fv=!fl&&this.contains(fw)&&!this.contains(fx);fp=[];for(fq=fo=fm=fn,fu=fk;fm<=fu?fo<=fu:fo>=fu;fq=fm<=fu?++fo:--fo){fr=bO.get_timeline().photo_at_index(fq);if(fr.status===K.PLACEHOLDER){if(fr.event!==ft){T=fr.event;if(!T.has_loaded_metadata()){T.on_load_all_metadata=this._highlight_range_incremental.bind(this);T.load_metadata();if(fs=T.unique_id,cR.call(this._events_highlighting,fs)<0){this._events_highlighting.push(T.unique_id)}fp.push(ft=T)}else{fp.push(void 0)}}else{fp.push(void 0)}}else{if(this.contains(fr)){if(fv){fp.push(this._dehighlight(fr))}else{fp.push(void 0)}}else{if(!fv){fp.push(this._highlight(fr))}else{fp.push(void 0)}}}}return fp},_highlight_range_incremental:function(T){var fs,fl,ft,fo,fn,fp,fm,fq,fk,fr;ft=this._last_highlight_from_photo;fr=this._last_highlight_to_photo;if(!((ft!=null)&&(fr!=null))){return}fl=bO.get_timeline().index_of_photo(ft);fk=bO.get_timeline().index_of_photo(fr);for(fo=fn=fm=fl,fq=fk;fm<=fq?fn<=fq:fn>=fq;fo=fm<=fq?++fn:--fn){fp=bO.get_timeline().photo_at_index(fo);if(fp.status!==K.PLACEHOLDER&&!this.contains(fp)&&this._highlighted.indexOf(fp)===-1){this._highlight(fp)}}fs=this._events_highlighting.indexOf(T.unique_id);if(fs>=0){this._events_highlighting.splice(fs,1)}if(this._select_highlighted_waiting){ez.update((this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(fl){var fk,T,i,fm;this.clear_highlighted();fm=[];for(fk=0,T=fl.length;fk<T;fk++){i=fl[fk];if(!this.contains(i)){fm.push(this._highlight(i))}else{fm.push(void 0)}}return fm},_select_highlighted:function(){var fn,fk,fm,T,fl,fo,i;if(this._events_highlighting.length>0){ez.show(ey("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}fo=this._highlighted;for(fn=0,fm=fo.length;fn<fm;fn++){fl=fo[fn];this._add(fl)}i=this._dehighlighted;for(fk=0,T=i.length;fk<T;fk++){fl=i[fk];this._remove(fl)}if(this._select_highlighted_waiting){ez.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(j){var i;this._highlighted.push(j);i=bO.get_timeline().get_thumb_elm_for_photo(j);return i!=null?i.addClassName("highlighted"):void 0},_dehighlight:function(j){var i;this._dehighlighted.push(j);i=bO.get_timeline().get_thumb_elm_for_photo(j);return i!=null?i.addClassName("dehighlighted"):void 0},_add:function(j){var i;cJ(j.status!==K.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);i=bO.get_timeline().get_thumb_elm_for_photo(j);if(i!=null){i.addClassName("selected")}this._selected.push(j);this._last_selected=j;dt.fillVal(c7.file_desc(this._selected,true),"selected-desc");dt.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(eT.CHANGE_EVT)},_remove:function(T){var j,i;i=bO.get_timeline().get_thumb_elm_for_photo(T);if(i!=null){i.removeClassName("selected")}j=this._selected.indexOf(T);if(j!==-1){this._selected.splice(j,1);this._last_selected=T;if(this._selected.length){dt.fillVal(c7.file_desc(this._selected,true),"selected-desc");dt.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(eT.CHANGE_EVT)},_invalid_mouse_target:function(fk){var T,i,j;j=fk.classNames().toArray().concat(fk.up().classNames().toArray());return(cR.call(j,"freshbutton")>=0)||(cR.call(j,"freshbutton-blue")>=0)||(cR.call(j,"freshbutton-lightblue")>=0)||(cR.call(j,"freshbutton-blue-on-gray")>=0)||(cR.call(j,"timeline-elm")>=0)||(fk.up(".no-marquee")!=null)||(fk.up("#context-menu")!=null)||(fk.up(".freshdropdown-menu")!=null)||fk.nodeName==="A"||((T=fk.tagName.toUpperCase())==="INPUT"||T==="TEXTAREA"||T==="SELECT")||fa.shown()||((i=$("modal-progress-content"))!=null?i.visible():void 0)||aL.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var cH,cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};cH=INLINE_JS.PhotosCollections=E.PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new ff('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(j,i){this._collections=j;this._gid_to_collection=j.dict_by("gid");this._url_to_collection=j.dict_by("url");this._collection_list_item_tmpl=ff.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=ff.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var i;i=eB.deconstruct_url();if(i.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(i){if(this._num_loading_collections!==null&&(this._num_loading_collections<i||i===null)){this._num_loading_collections=i;return cC.WebRequest({url:"/collections",data:{limit:i},subject_user:cK.get_viewer().photos_user,success:(function(j){return function(fp){var fo,fn,fl,T,fm,fk;fk=JSON.parse(fp);for(fl=0,T=fk.length;fl<T;fl++){fn=fk[fl];if(!(fn.gid in j._gid_to_collection)&&!(fm=fn.gid,cR.call(j._removed_pre_load,fm)>=0)){fo=new ad(fn,false);j._collections.push(fo);j._gid_to_collection[fo.gid]=fo;j._url_to_collection[fo.url]=fo}}if(i===null||fk.length<i){j._all_collections_loaded=true;j._sidebar_collections_loaded=true}if(i>=5){j._sidebar_collections_loaded=true}return j.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(i){return function(j){if(!bO.get_current_collection().is_creator){return}i.header_rename();return g.log_interaction(ej.RENAME_ALBUM,da.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(bl.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(ad.CREATE_EVT,this._collection_created.bind(this));document.observe(ad.ADD_EVT,this._collection_photos_added.bind(this));document.observe(ad.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(ad.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(ad.RENAME_EVT,this._collection_renamed.bind(this));document.observe(ad.DELETE_EVT,this._collection_deleted.bind(this));document.observe(ad.SHARE_EVT,this._collection_shared.bind(this));document.observe(ad.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(ad.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var fm,fk,T,i,fl;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}fk=[];fl=this._collections;for(T=0,i=fl.length;T<i;T++){fm=fl[T];fk.push(this._collection_list_item_tmpl({collection:fm,additional_class:"albums-list-item show-collection-target",Sprite:cv,Emstring:bS}))}$("albums-list").__date(fk);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var fn,fk,fm,T,i,fl;fk=[];fm={name:ey("Create new album"),thumbnail_url_256:"/static/images/new_album_big-vflQJ5xd7.png"};fk.push(this._collection_list_item_tmpl({collection:fm,additional_class:"create-album-target",hide_icons:true,Sprite:cv,Emstring:bS}));fl=this._collections;for(T=0,i=fl.length;T<i;T++){fn=fl[T];fk.push(this._collection_list_item_tmpl({collection:fn,additional_class:"add-to-album-target",Sprite:cv,Emstring:bS}))}$("add-to-album-modal-list").__date(fk);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var fp,T,fn,fq,i,fo,fm,fl,fk;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();fq=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5),_:ey,Sprite:cv,PhotosCollections:cH});if((i=$("albums-sidebar"))!=null){i.__date(fq)}if((fo=$("all-albums-sidebar"))!=null){fo.observe("click",bO.show_all_collections)}if((fm=$("all-albums-sidebar"))!=null){fm.observe("mouseup",(function(j){return function(fr){var fs;if(!eT._drag_drop.active){return}if(eT._drag_drop.single_photo!=null){fs=[eT._drag_drop.single_photo]}else{fs=eT.get()}j.show_add_to_album_modal(fr,fs);return g.log_interaction(ej.ADD_TO_OTHER_ALBUM,da.DROP_TARGET,{num_photos:eT.get().length})}})(this))}if(bO.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(bO.in_single_collection_view()){fl=$$(".sidebar-album");fk=[];for(T=0,fn=fl.length;T<fn;T++){fp=fl[T];if(fp.readAttribute("data-gid")===bO.get_current_collection().gid){fp.addClassName("selected");break}else{fk.push(void 0)}}return fk}}},refresh_album_views:function(j){var i;if(j==null){j=null}i=(function(T){return function(){T.render_all_albums_view();T.render_albums_sidebar();return T.render_add_to_album_modal()}})(this);if(j!=null?j.length:void 0){return cC.WebRequest({url:"/collections",data:{collection_gids:JSON.stringify(j.unique())},subject_user:cK.get_viewer().photos_user,success:(function(T){return function(fm){var fu,fr,fl,fq,fp,fn,fs,fo,fk,ft;fk=JSON.parse(fm);for(fp=0,fs=fk.length;fp<fs;fp++){fl=fk[fp];fr=new ad(fl,false);T._gid_to_collection[fr.gid]=fr;T._url_to_collection[fr.url]=fr;ft=T._collections;for(fq=fn=0,fo=ft.length;fn<fo;fq=++fn){fu=ft[fq];if(fu.gid===fr.gid){T._collections[fq]=fr;break}}}return i()}})(this)})}else{return i()}},show_add_to_album_modal:function(i,j){if(j!==eT.get()&&(eT._drag_drop.single_photo==null)){eT._context_selected=j}fa.onHide=function(){eT._context_selected=null;delete fa.onHide;return fa.hide()};fa.show(ey("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(T,fl,j){var i,fk;if(j==null){j=true}fk=bO.get_current_collection_gid();i=fl.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ah.success(ey("Adding to album..."));return T.add_photos(fl,fk,i,j)},show_remove_photos_modal:function(fk,fm){var T,i,fl,j;j=c7.categorize_files(fm),i=j[0],fl=j[1];if(i&&fl){T=bb("Remove %(file_count)s item?","Remove %(file_count)s items?",fm.length)}else{if(i){T=bb("Remove %(file_count)s photo?","Remove %(file_count)s photos?",fm.length)}else{T=bb("Remove %(file_count)s video?","Remove %(file_count)s videos?",fm.length)}}T=T.format({file_count:fm.length});dt.fillVal(c7.file_desc(fm),"collection-remove-files");dt.fillVal(fk.name.escapeHTML(),"collection-remove-name");return fa.show(T,dt.fromElm("collection-remove-modal"),{action:(function(fn){return function(){var fo;fm=fm.slice(0);fo=fm.length>fn.NUM_PHOTOS_LONG_RUNNING_REMOVES;return fk.remove_photos(fm,fo)}})(this)})},header_rename:function(){if(bD("#single-collection-title-container").hasClass("editing")){return}bD("#single-collection-title-container").addClass("editing");return bO.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(j){var i;dt.fillVal(j.name.escapeHTML(),"collection-delete-name");i=ey("Delete album?");return fa.show(i,dt.fromElm("collection-delete-modal"),{action:function(){if(j.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){ah.success(ey("Deleting '%(collection_name)s'...").format({collection_name:j.name}),100)}return j["delete"]()}})},show_unshare_modal:function(j){var i;dt.fillVal(j.name.escapeHTML(),"collection-unshare-name");i=ey("Unshare album?");return fa.show(i,dt.fromElm("collection-unshare-modal"),{action:function(){return j.unshare()}})},create:function(fp,fo,ft,j){var fk,fl,T,fm,fr,fs,fq,i,fn;if(j==null){j=false}if(fp){Event.extend(fp).preventDefault();fn=$(fp.target);if(fn.hasClassName("inplaceeditor-form")||(fn.up(".inplaceeditor-form")!=null)){return}if(fn.up("#context-menu")){fk=true}else{if(fn.up(".freshdropdown-menu")){T=true}}}bO.enable_selection();if(!ft){ft=eT.get()}fm=(function(){var fv,fu,fw;fw=[];for(fv=0,fu=ft.length;fv<fu;fv++){i=ft[fv];fw.push(i.item_counter)}return fw})();ft.sort_by_key(function(fu){return fu.time_taken});fr=ft.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;fq=(function(fu){return function(fw){var fz,fx,fv,fy;fx=JSON.parse(fw.responseText);fz=new ad(fx);eT.clear();eR.hide_all();bl.hide();fa.hide();bO.disable_selection();fy=ey("Created '%(collection_name)s'");fv=fz.name.escapeHTML();fy=fy.format({collection_name:"<a data-gid='"+fz.gid+"' class='show-collection-target'>"+fv+"</a>"});ah.success(new ff(fy));return fu.flash_sidebar_album(fz.gid)}})(this);fs=function(){if(!T){eR.hide_all()}if(!fk){bl.hide()}cH.render_albums_sidebar();return bO.disable_selection()};fl=new Ajax.InPlaceEditor(fo,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:j,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:fs,onFailure:function(){},savingText:ey("Creating..."),onLeaveEditMode:bO.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:fq,job:fr,job_user:cK.get_viewer().photos_user,progress_text:ey("Creating album...")},callback:function(fu,fw){var fv;ah.success(ey("Creating album..."));fv={collection_name:fw,item_counters:JSON.stringify(fm),source_collection_gid:bO.get_current_collection_gid()};return fv}});fl.enterEditMode();if(!j){return fl._controls.editor.observe("blur",fs)}},toggle_more_selected_actions:function(i){if(i){Event.extend(i).preventDefault()}if(!$("more-selected-actions-menu").visible()){return eR.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(i){var j;if(i){Event.extend(i).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(bO.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(bZ.msie_version_at_most(10)){j=bD("#more-collection-actions-menu");if(!j.parent().is("body")){bD(document.body).append(j.remove())}}return eR.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(i){var j;j=i.memo.collection;if(!j.is_anonymous){this._collections.unshift(j)}this._gid_to_collection[j.gid]=j;this._url_to_collection[j.url]=j;return this.refresh_album_views()},_collection_changed:function(i){this._collections.removeItem(i);this._collections.unshift(i);return this.refresh_album_views()},_collection_photos_added:function(fo){var fn,fm,fl,fp,fq,T,i,j,fr,fk;fn=fo.memo.collection;fr=fo.memo.photos;fp=fo.memo.num_items_added;T=fo.memo.num_photos_added;j=fo.memo.num_videos_added;if(fo.memo.promote_collection&&fp>0){this._collection_changed(fn)}else{this.refresh_album_views()}if(fr===eT.get()){eT.clear()}if(fp<1){fk=c7.categorize_files(fr),fq=fk[0],i=fk[1];if(fq&&i){fl=bb("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",fr.length)}else{if(fq){fl=bb("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",fr.length)}else{fl=bb("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",fr.length)}}}else{if(T&&j){fl=bb("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",fr.length)}else{if(T){fl=bb("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",fr.length)}else{fl=bb("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",fr.length)}}}fm=fn.name.escapeHTML();fl=fl.format({collection_name:"<a data-gid='"+fn.gid+"' class='show-collection-target'>"+fm+"</a>"});return ah.success(new ff(fl))},_collection_photos_removed:function(j){var T,fk,i;T=j.memo.collection;fk=j.memo.photos;i=bO.undo_enabled?j.memo.undo_changeset:null;bO.get_timeline().remove_photos(fk);this._collection_changed(T);return ah.success(ey("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:c7.file_desc(fk),collection_name:T.name}),null,null,i,(function(){return T.undo_remove(i)}))},_collection_undid_remove:function(i){var j;j=i.memo.collection;bO.get_timeline().restore_removed_photos();cH.refresh_album_views([j.gid]);return ah.success(ey("Undo complete"))},_collection_renamed:function(j){var T,i;T=j.memo.collection;if(((i=bO.get_current_collection())!=null?i.gid:void 0)===T.gid){bD("#single-collection-title").text(bS.em_snippet(T.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=T.name+" - Dropbox"}this._collection_changed(T);return ah.success(ey("Renamed '%(collection_name)s'").format({collection_name:T.name}))},_collection_deleted:function(j){var T,i;T=j.memo.collection;this._collections.removeItem(T);if(!this._all_collections_loaded){this._removed_pre_load.push(T.gid)}this.refresh_album_views();if(((i=bO.get_current_collection())!=null?i.gid:void 0)===T.gid){bO.show_all_collections()}delete this._gid_to_collection[T.gid];delete this._url_to_collection[T.url];return ah.success(ey("Deleted '%(collection_name)s'").format({collection_name:T.name}))},_collection_shared:function(j){var T,i;T=j.memo.collection;this._collection_changed(T);if(((i=bO.get_current_collection())!=null?i.gid:void 0)===T.gid){bD("#single-collection-share-status").text(ey("Shared"));return bD("#single-collection-share-status").attr("href",T.shmodel_url)}},_collection_unshared:function(j){var T,i;T=j.memo.collection;if(((i=bO.get_current_collection())!=null?i.gid:void 0)===T.gid){bD("#single-collection-share-status").text("")}return ah.success(ey("Unshared '%(collection_name)s'").format({collection_name:T.name}))},_collection_cover_changed:function(i){var T,j;T=i.memo.collection;this._collection_changed(T);j=ey("Changed cover photo for '%(collection_name)s'");j=j.format({collection_name:T.name.escapeHTML()});return ah.success(j)},_albums_list_item_contextmenu:function(j,i){bl.show_photo_collection(j,this.get(i.readAttribute("data-gid")),i);i.removeClassName("album-flash");return i.addClassName("context-selected")},_show_collection_click:function(T,i){var j;j=$(T.target);if(j.hasClassName("inplaceeditor-form")||(j.up(".inplaceeditor-form")!=null)){return}return bO.show_collection(i.readAttribute("data-gid"))},_collection_shmodel_click:function(j,i){return this.go_to_link(this.get(i.readAttribute("data-gid")))},_add_to_album_click:function(j,i){if(eT._context_selected){this.add_photos(this.get(i.readAttribute("data-gid")),eT._context_selected);eT._context_selected=null}else{this.add_photos(this.get(i.readAttribute("data-gid")),eT.get())}delete fa.onHide;fa.hide();return g.log_interaction(ej.ADD_TO_RECENT_ALBUM,da.SAH,{num_photos:eT.get().length})},_drop_target_mouseover:function(j,i){if(eT._drag_drop.active){i.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(j,i){if(eT._drag_drop.active){i.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(j,i){var T;if(i.hasClassName("hovered")){i.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(eT._drag_drop.single_photo!=null){T=[eT._drag_drop.single_photo]}else{T=eT.get()}if(i.readAttribute("data-gid")!=null){this.add_photos(this.get(i.readAttribute("data-gid")),T,false)}if(i.identify()==="add-to-album-sidebar-new"){return g.log_interaction(ej.ADD_TO_NEW_ALBUM,da.DROP_TARGET,{num_photos:eT.get().length})}else{if(i.identify()==="all-albums-sidebar"){return g.log_interaction(ej.ADD_TO_OTHER_ALBUM,da.DROP_TARGET,{num_photos:eT.get().length})}else{return g.log_interaction(ej.ADD_TO_RECENT_ALBUM,da.DROP_TARGET,{num_photos:eT.get().length})}}}},_create_album_click:function(i,j){if(eT._context_selected){this.create(i,j.down(".collection-name"),eT._context_selected,true);return eT._context_selected=null}else{return this.create(i,j.down(".collection-name"),eT.get(),true)}},_window_scroll:function(){if(bO.in_all_collections_view()){return this._all_albums_scroll_position=C.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(i){return this._url_to_collection[i]},get:function(i){return this._gid_to_collection[i]},go_to_link:function(i){return window.open(i.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(T,j){var i,fl,fk;i=bS.em_snippet(T,j,1);fl=i.lastIndexOf(" ");if(fl===-1){return i}else{i=i.slice(0,+fl+1||9000000000);fk=bS.em_snippet(T.slice(fl+1),j,1);return i+fk}},get_default_album_name:function(){var i;i=ey("Untitled album");return this.increment_collection_name_until_valid(i)},collection_name_in_use:function(fk){var fm,T,i,fl;fl=this.get_all();for(T=0,i=fl.length;T<i;T++){fm=fl[T];if(fm.name===fk.trim()){return true}}return false},increment_collection_name_until_valid:function(j){var T,i;T=this.collection_name_in_use(j);i=0;while(T){i++;T=this.collection_name_in_use(j+(" ("+i+")"))}return(i===0?j:j+(" ("+i+")"))},flash_sidebar_album:function(fm){var fn,T,i,fl,fk;fl=$$(".sidebar-album");fk=[];for(T=0,i=fl.length;T<i;T++){fn=fl[T];if(fn.readAttribute("data-gid")===fm){fn.removeClassName("album-flash");fn.addClassName("album-flash");break}else{fk.push(void 0)}}return fk}};var ci;ci=E.PhotoTimeline=(function(){i.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";i.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";i.prototype.THUMB_SIZE=null;i.prototype.HEADER_HEIGHT=null;i.prototype.THUMBS_PER_ROW=4;i.prototype.RENDER_SCROLL_WAIT=100;i.prototype.RENDER_SCROLL_MAX_WAIT=750;i.prototype.HIDE_TIMELINE_NAV_DELAY=1500;i.prototype.THUMBS_BATCH_SIZE=12;i.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;i.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;i.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;i.prototype.TIMELINE_NAV_ELM_HEIGHT=20;i.prototype.TIMELINE_DOT_HTML=cv.html("web","timeline_dot");i.container;i.scroll_container;i.events;i.current_event;i.key_to_photo;i.preview_objs;i.tmpl;i.last_render_scroll_timeout;i.start_render_scroll_time;i.last_scroll_position;i.hide_timeline_nav_timeout;i.grid;i._skip_scroll_update;i.header_id_to_sel_items;i.event_remove_info;i.opts;function i(T,fk,fn,fl,fm,fo,fp,fq,j){this.container=T;this.scroll_container=fk;this.tmpl=fp;this.opts=j;this.THUMB_SIZE=fq.thumb_size;this.HEADER_HEIGHT=fq.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=fo;this.event_remove_info=[];this._init_events(fn,fl,fm);this.update_offsets(fq.top_offset,fq.left_offset);this.listen();dy.start_capture(this.scroll_container)}i.prototype._init_events=function(fr,fl,fn){var fk,fp,fu,fm,fo,fq,fs,ft,T;if(fr.length<1){this.events=new aZ([],{});return}fp=[];fo={};fu=false;for(fq=0,fs=fr.length;fq<fs;fq++){fm=fr[fq];fm=String(fm);T=fm in this.header_id_to_sel_items?this.header_id_to_sel_items[fm]:[];ft=false;if(T.length&&!fu){fu=true;ft=true}fk=new db(this,fm,fl[fm],fn[fm],T,ft);fp.push(fm);fo[fm]=fk}return this.events=new aZ(fp,fo)};i.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(db.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};i.prototype.unlisten=function(){var fk,T,j;if((fk=this._body_mousemove_handler)!=null){fk.stop()}if((T=this._timeline_elm_click_handler)!=null){T.stop()}if((j=this._show_missing_timestamp_bucket_handler)!=null){j.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(db.EVENT_MISCOUNT_EVT)};i.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};i.prototype.update_offsets=function(fk,T){var fn,fl,fo,fm;cJ(this.THUMBS_PER_ROW>0,"Invalid THUMBS_PER_ROW: "+this.THUMBS_PER_ROW);this.top_offset=fk;this.refresh_row_offsets();this.left_offset=T;this.grid.photo_col_offsets=[];fm=[];for(fn=fl=0,fo=this.THUMBS_PER_ROW;0<=fo?fl<=fo:fl>=fo;fn=0<=fo?++fl:--fl){fm.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*fn))}return fm};i.prototype.refresh_row_offsets=function(){var fq,fp,fn,fm,fl,T,fo,fk;this.grid.photo_row_offsets=[];fq=this.top_offset;fo=this.events.getValues();for(fm=0,T=fo.length;fm<T;fm++){fp=fo[fm];fp.top_offset=fq;fq+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(fq);for(fn=fl=0,fk=fp.get_num_rows();0<=fk?fl<fk:fl>fk;fn=0<=fk?++fl:--fl){fq+=this.THUMB_SIZE;this.grid.photo_row_offsets.push(fq)}}};i.prototype._render_empty_grid=function(){var fm,fk,T,fn,fl;this.container.__date();fl=this.events.getValues();for(fk=0,T=fl.length;fk<T;fk++){fm=fl[fk];if(!(fm.is_missing_timestamp_bucket()&&this.events.length()>1)){fm.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){fn=bD('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(ey("Show photos with missing dates"));return bD(this.container).append(fn)}};i.prototype._render_viewport=function(fk){var T,fw,fm,fr,fp,fn,fs,fu,fq,fo,fl,fv,ft,fx;if(fk==null){fk=false}this.start_render_scroll_time=-1;fx=this.get_viewport_info();fw=[];fl=this.events.getValues();for(fr=0,fu=fl.length;fr<fu;fr++){T=fl[fr];if(!(T.has_loaded_metadata()||T.loading_metadata||(T.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(T.in_current_viewport(fx,false)){fw.unshift(T)}else{if(T.in_current_viewport(fx,true)){fw.push(T)}}}}for(fp=0,fq=fw.length;fp<fq;fp++){T=fw[fp];fv=T.get_photo_range_to_render(fx,true),fm=fv[0],fs=fv[1];T.load_metadata_range(fm,fs)}if(fk){fx=this.get_viewport_info();ft=this.events.getValues();for(fn=0,fo=ft.length;fn<fo;fn++){T=ft[fn];if(T.in_current_viewport(fx,false)){T.timing_stopped_scrolling_on_event=b4.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};i.prototype._load_metadata_for_sel_events=function(){var fl,fm,fk,T,j;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}fk=this.header_id_to_sel_items;T=[];for(fm in fk){j=fk[fm];fl=this.events.valueFromKey(fm);if(fl!=null){fl.load_metadata()}T.push(cJ(fl!=null,"Missing "+fm+" in list of events with selected photos"))}return T};i.prototype._load_visible_photos=function(){var fn,fk,T,fm,fl;fm=this.events.getValues();fl=[];for(fk=0,T=fm.length;fk<T;fk++){fn=fm[fk];if(!(fn.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){fl.push(fn.update_photo_divs())}else{fl.push(void 0)}}return fl};i.prototype._body_mousemove=function(j){if(!this.opts.uses_timeline_nav){return}if((j.clientX+C.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};i.prototype._timeline_elm_click=function(fl,fk){var j,T;T=fk.readAttribute("data-event-id");if(T){j=this.events.valueFromKey(T)}this._update_timeline_position(j);if(j.is_missing_timestamp_bucket()){g.log_interaction(cl.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(j)};i.prototype._scroll_to_event=function(fk,j){var T;if(j==null){j=false}T=fk.top_offset-this.top_offset;if(fk&&(C.scroll_offsets().top!==T)){if(j){return bD("html, body").animate({scrollTop:T},200)}else{this._skip_scroll_update=true;return window.scrollTo(C.scroll_offsets().left,T)}}};i.prototype._window_scroll=function(){var fo,fl,T,fk,fn,fm,fp;fk=b4.time();bq.clear_all_pending_batches();if(this.start_render_scroll_time===-1||fk-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=fk}fp=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),fp);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(j){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=C.scroll_offsets().top;bO.scroll_count++;fn=this.events.getValues();fm=[];for(fl=0,T=fn.length;fl<T;fl++){fo=fn[fl];fm.push(fo.logged_thumbs_arrived=false)}return fm};i.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};i.prototype.init_timeline_nav=function(){var fm,fk,T,fl;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();fl=this.events.getValues().reverse();for(fk=0,T=fl.length;fk<T;fk++){fm=fl[fk];fm.add_to_timeline_nav(fm===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};i.prototype._resize_timeline_nav=function(){var j;if(!this.opts.uses_timeline_nav){return}j=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:j+"px"})};i.prototype._update_timeline_position=function(fo){var ft,fr,T,fm,fl,fp,fn,fk,fq,fs;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(fo==null){fs=this.get_viewport_info();if(this.scroll_container==null){fs.top=document.viewport.getScrollOffsets().top}ft=fs.top+fs.height/2;fk=this.events.getValues();for(fm=0,fp=fk.length;fm<fp;fm++){T=fk[fm];if(T.top_offset>ft){break}fo=T}}if((fo==null)||fo===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");fq=$$(".timeline-elm");for(fl=0,fn=fq.length;fl<fn;fl++){fr=fq[fl];if(fr.readAttribute("data-event-id")===fo.unique_id){fr.addClassName("current");break}}return this.current_event=fo};i.prototype._show_hide_timeline_elms=function(){var fq,fp,fl,fk,T,fo,fn,fm;if(!this.opts.uses_timeline_nav){return}fl=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();fp=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();fn=$$(".timeline-elm");fm=[];for(fk=0,T=fn.length;fk<T;fk++){fq=fn[fk];fq.show();fo=fq.cumulativeOffset();if(fo.top<fp&&fo.left<fl){fm.push(fq.hide())}else{fm.push(void 0)}}return fm};i.prototype._event_miscount=function(j){this.refresh_row_offsets();return this._load_visible_photos()};i.prototype.remove_photos=function(fq){var fn,fo,fp,fm,T,fl,fk;fq=fq.slice(0);this.event_remove_info=[];fp={};for(fm=0,T=fq.length;fm<T;fm++){fl=fq[fm];fo=fl.event.unique_id;if(fo in fp){fp[fo].push(fl)}else{fp[fo]=[fl]}}for(fo in fp){fq=fp[fo];fn=this.events.valueFromKey(fo);fk=fn.remove_photos(fq);this.event_remove_info.push({event:fn,remove_info:fk})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(i.PHOTOS_REMOVED_EVT,this)};i.prototype.restore_removed_photos=function(){var T,fy,fv,fp,fo,fm,fs,fq,fn,fx,fl,ft,fr,fw,fk,fu;eT.clear();fl=this.event_remove_info.reverse();for(fp=0,fs=fl.length;fp<fs;fp++){fy=fl[fp];T=fy.event;fw=fy.remove_info;if(fw.removed_event_index!=null){this.events.insertAtIndex(fw.removed_event_index,T.unique_id,T);T.restore()}T.add_photos(fw.removed_photos_and_indexes.reverse());ft=fw.removed_photos_and_indexes;for(fo=0,fq=ft.length;fo<fq;fo++){fx=ft[fo];eT._add(fx.photo)}}fk=null;fu=null;fr=this.event_remove_info;for(fm=0,fn=fr.length;fm<fn;fm++){fy=fr[fm];T=fy.event;fw=fy.remove_info;fv=this.events.indexOfKey(T.unique_id);if((fk==null)||fk>fv){fk=fv;fu=fw.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(fu!=null){this.scroll_to_photo_with_key(fu.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(i.PHOTOS_ADDED_EVT,this)};i.prototype.get_photos=function(){var fm,fk,T,fn,fl;fn=[];fl=this.events.getValues();for(fk=0,T=fl.length;fk<T;fk++){fm=fl[fk];fn=fn.concat(fm.photos)}return fn};i.prototype.num_photos=function(){var fn,fk,T,fl,fm;fl=0;fm=this.events.getValues();for(fk=0,T=fm.length;fk<T;fk++){fn=fm[fk];fl+=fn.photos.length}return fl};i.prototype.get_preview_objs=function(){var T,fn,fm,fp,fo,fk,fq,fl,fr;fq=[];fl=this.events.getValues();for(fn=0,fp=fl.length;fn<fp;fn++){T=fl[fn];fr=T.photos;for(fm=0,fo=fr.length;fm<fo;fm++){fk=fr[fm];fq.push(fk.preview_obj)}}return fq};i.prototype.index_of_photo=function(fm){var fo,fl,fk,T,fn;fl=0;fn=this.events.getValues();for(fk=0,T=fn.length;fk<T;fk++){fo=fn[fk];if(fo===fm.event){fl+=fo.photos.indexOf(fm);break}else{fl+=fo.photos.length}}return fl};i.prototype.photo_at_index=function(fm){var fk,fo,fl,T,fn;fk=0;fn=this.events.getValues();for(fl=0,T=fn.length;fl<T;fl++){fo=fn[fl];if(fk+fo.photos.length>fm){return fo.photos[fm-fk]}else{fk+=fo.photos.length}}return null};i.prototype.get_thumb_elm_for_photo=function(j){return $(j.uniqueness_key)};i.prototype.get_photo_for_thumb_elm=function(j){if(!j.hasClassName("cu-thumb")){j=j.up(".cu-thumb")}if(j){return this.key_to_photo[j.identify()]}else{return null}};i.prototype.get_viewport_info=function(){var j,T;if(this.scroll_container!=null){T=this.scroll_container.scrollTop;j=this.scroll_container.getHeight()}else{T=C.scroll_offsets().top;j=C.viewport_dimensions().height}return{top:T,height:j,bottom:T+j}};i.prototype.scroll_to_photo_with_key=function(T){var fn,fk,j,fm,fl;C.scroll_unlock_document();fn=$(T);if(fn!=null?fn.visible():void 0){d3.scroll_to_thumb(fn)}else{j=this.key_to_photo[T];fk=j.event;if(j.event!=null){fm=Math.floor(fk.photos.indexOf(j)/this.THUMBS_PER_ROW);fl=this.get_viewport_info().height;C.scroll_to(0,fk.top_offset+this.HEADER_HEIGHT+fm*this.THUMB_SIZE-fl/2)}}return this._load_visible_photos()};i.prototype.restore_scroll_position=function(){C.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};i.prototype.visible_thumbs_loaded=function(){var fm,fk,T,fl;fl=this.events.getValues();for(fk=0,T=fl.length;fk<T;fk++){fm=fl[fk];if(!fm.visible_thumbs_loaded()){return false}}return true};i.prototype.has_missing_timestamp_bucket=function(){var j;j=this.events.getValues();return j[j.length-1].is_missing_timestamp_bucket()};i.prototype.is_missing_timestamp_bucket_shown=function(){var j,T;if(!this.has_missing_timestamp_bucket()){return false}j=this.events.getValues();T=j[j.length-1].unique_id;return bD("#p-"+T).length>0};i.prototype._show_missing_timestamp_bucket=function(j,fl){var fk,T;if(j==null){j=true}if(fl==null){fl=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}T=this.events.getValues();fk=T[T.length-1];bD("#show-missing-timestamps-button").hide();fk.add_html_elements_to(this.container);if(!fl){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(fk,j);this._render_viewport()}return this.init_timeline_nav()};return i})();var db;db=E.PhotoEvent=(function(){i.EVENT_MISCOUNT_EVT="db:photoevent:miscount";i.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";i.prototype.MONTH_PREFIX="m_";i.prototype.COLLECTION_PREFIX="c_";i.prototype.EVENT_PREFIX="e_";i.prototype.MISSING_TIMESTAMP_PREFIX="a_";i.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;i.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;i.timeline;i.unique_id;i.name;i.init_num_photos;i.photos;i.header_html;i.placeholder_html;i.top_offset;i.loading_metadata;i.cursor;i.num_photos_loaded;i.prototype.LOADING_ORDER_NOT_DECIDED=-1;i.prototype.LOADING_ORDER_TOP_DOWN=0;i.prototype.LOADING_ORDER_BOTTOM_UP=1;i.loading_order;i.num_photos_to_load;i.on_load_all_metadata;i.init_sel_items;i.scroll_to_first_sel;i.num_to_select;i.logged_thumbs_arrived;i.timing_metadata_received;i.timing_stopped_scrolling_on_event;i.scroll_count;function i(fr,fp,fk,fq,T,fo){var fm,fs,fl,fn;this.timeline=fr;this.unique_id=fp;this.name=fk;this.init_num_photos=fq;this.photos=(function(){var ft,fv,fu;fu=[];for(fm=ft=0,fv=fq;0<=fv?ft<fv:ft>fv;fm=0<=fv?++ft:--ft){fu.push(new K(this))}return fu}).call(this);this.init_sel_items={};for(fl=0,fn=T.length;fl<fn;fl++){fs=T[fl];this.init_sel_items[fs]=true}this.num_to_select=T.length;this.scroll_to_first_sel=fo;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(fq===0){$("single-album-empty").show()}}i.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};i.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};i.prototype.get_month=function(){var j;cJ(this.is_month(),"this must be a month event");j=parseInt(this.unique_id.slice(6,8),10);cJ(!isNaN(j),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return j};i.prototype.get_year=function(){var j;cJ(this.is_month(),"this must be a month event");j=parseInt(this.unique_id.slice(2,6),10);cJ(!isNaN(j),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return j};i.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};i.prototype.get_collection_gid=function(){cJ(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};i.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};i.prototype._generate_container_html=function(){var fl,T,fm,fo,fk,j,fn;fo=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(fo);fl=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});fl.__date(cv.html("web","event_add_to_album"));this.header_html.__sert(fl);fn=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});fn.__date(cv.html("web","event_share"));this.header_html.__sert(fn);j=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});j.__date(cv.html("web","event_select"));this.header_html.__sert(j)}else{this.header_html=new ff("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+fo+"</span></h1>")}T=this.get_content_height();fk=this.photos.length%this.timeline.THUMBS_PER_ROW;fm=fk===0?0:(this.timeline.THUMBS_PER_ROW-fk)*this.timeline.THUMB_SIZE;return this.placeholder_html=new ff('<div style="height: '+T+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+T+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+fm+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};i.prototype.add_html_elements_to=function(T){var j;if(this.is_event()){j=new Element("div",{"class":"photo-event"});j.__sert(this.header_html);j.__sert(this.placeholder_html);return T.__sert(j)}else{T.__sert(this.header_html);return T.__sert(this.placeholder_html)}};i.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};i.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};i.prototype.add_to_timeline_nav=function(fp){var j,fn,fq,T,fr,fm,fl,fo,fk;if(fp==null){fp=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}fk=this.timeline.get_viewport_info().height;fr=this.timeline.TIMELINE_NAV_ELM_HEIGHT;fm=$(document.body).getHeight();fl=this.top_offset/fm*100;if(this.is_event()){T=this.name}else{if(this.is_missing_timestamp_bucket()){T=ey("Missing dates")}else{T=b4.month_abbr_with_year(this.get_month()-1,this.get_year())}}fq=false;for(fo in this.timeline.grid.side_nav){j=Math.abs(this.timeline.events.valueFromKey(fo).top_offset-this.top_offset);if(j/fm*fk<fr){fq=true;if(fp){bD("#timeline-nav-"+fo).remove()}}}fn=bD("#timeline-nav-"+this.unique_id);if(!fq||fp){if(fn.length){fn.css("top",fl+"%")}else{fn=bD("<div/>");fn.addClass("timeline-elm");fn.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});fn.css("top",fl+"%");fn.text(T);bD("#timeline-nav").append(fn)}return this.timeline.grid.side_nav[this.unique_id]=fl}else{if(fn.length){return fn.remove()}}};i.prototype.marquee_highlight=function(fk,fr,fo){var fl,fs,fq,fp,ft,T,fn,fv,fu,fw,fm;if(this.top_offset>fr||this.top_offset+this.get_height()<fk){return}if(fk<this.top_offset){fr-=this.top_offset;if(fr<this.timeline.HEADER_HEIGHT){return}fm=0;fw=Math.floor((fr-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(fr>this.top_offset+this.get_height()){fk-=this.top_offset;fw=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(fk<this.timeline.HEADER_HEIGHT){fm=0}else{fm=Math.floor((fk-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{fk-=this.top_offset;fr-=this.top_offset;if(fk<this.timeline.HEADER_HEIGHT&&fr<this.timeline.HEADER_HEIGHT){return}else{if(fk<this.timeline.HEADER_HEIGHT){fm=0;fw=Math.floor((fr-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{fm=Math.floor((fk-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fw=Math.floor((fr-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(fu=fq=fn=fm,fv=fw;fn<=fv?fq<=fv:fq>=fv;fu=fn<=fv?++fq:--fq){for(fp=0,ft=fo.length;fp<ft;fp++){fl=fo[fp];fs=this.timeline.THUMBS_PER_ROW*fu+fl;if(fs<this.photos.length){T=this.photos[fs];if(T.status!==K.PLACEHOLDER&&!eT.contains(T)){eT._highlight(T)}}}}};i.prototype.add_photos=function(fn){var fm,fl,T,fk,fo;for(fl=0,T=fn.length;fl<T;fl++){fo=fn[fl];fk=fo.photo;fm=fo.index;cJ(fm<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(fm,0,fk);if(fk.status>=K.LOADED){fk.status=K.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};i.prototype.remove_photos=function(fr){var fp,fm,fo,fk,fn,fl,fq,T;fp=this.timeline.events.indexOfKey(this.unique_id);T=[];for(fm=0,fo=fr.length;fm<fo;fm++){fk=fr[fm];fn=this.photos.indexOf(fk);cJ(fn>-1,"Photo not found in the photos array!");this.photos.splice(fn,1);if(fk.status>=K.LOADED){this.num_photos_loaded--;if((fl=$(fk.uniqueness_key))!=null){fl.remove()}fk.status=K.LOADED}eT._remove(fk);T.push({photo:fk,index:fn})}this._num_photos_changed();fq={removed_photos_and_indexes:T};if(this.photos.length===0){fq.removed_event_index=fp}return fq};i.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};i.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};i.prototype._update_placeholder_container=function(){var T,j;$("p-"+this.unique_id).setStyle({height:(this.get_content_height())+"px"});j=this.photos.length%this.timeline.THUMBS_PER_ROW;T=j!==0?(this.timeline.THUMBS_PER_ROW-j)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:T+"px"})};i.prototype.load_metadata=function(fp){var fk,T,fo,j,fm,fn,fl;j=0;if((!this._is_valid_photo_index(fp))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}j=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=fp*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}j=this._is_loading_from_bottom()?this.photos.length-fp:fp+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,j);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;fm={show_hidden:bO.show_hidden};if(this.cursor!=null){fm.cursor=this.cursor}if(this._is_loading_from_bottom()){fm.chron_order=true}fm.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(fm.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){fm.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){fn=this.unique_id.split("_");fk=fn[2];T=fn[1];fm.filters=JSON.stringify({date_begin:fk,date_end:T},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){fm.filters=JSON.stringify({other:true})}else{if(this.is_month()){fl=this.get_year();fo=this.get_month();fk=d3.to_iso8601_date(new Date(fl,fo-1,1,0,0,0,0),false,true);T=d3.to_iso8601_date(new Date(fl,fo,1,0,0,0),false,true);fm.filters=JSON.stringify({date_begin:fk,date_end:T},{year:fl,month:fo})}else{if(this.is_collection()){fm.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{cJ(false,"invalid photo event id: "+this.unique_id)}}}}return new cC.WebRequest({url:"/photos_event_metadata",data:fm,dataType:"json",success:(function(fq){return function(fr){fq.timing_metadata_received=b4.time();fq.cursor=fr.cursor;return fq._load_metadata_callback(fr.photos,fr.key_to_duplicates,(fr.more!=null)&&fr.more)}})(this)})};i.prototype.load_metadata_range=function(T,j){if(!(this._is_valid_photo_index(T)&&this._is_valid_photo_index(j))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=T*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(T)}else{return this.load_metadata(j)}};i.prototype.load_cached_metadata=function(){var j,T;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((T=bO.event_metadata_cache)!=null?T[this.unique_id]:void 0)==null)){return false}j=bO.event_metadata_cache[this.unique_id];this.cursor=j.cursor;this._load_metadata_callback(j.photos,j.key_to_duplicates,j.more);return true};i.prototype._load_metadata_callback=function(fw,fm,fn){var fv,fo,fu,ft,fA,fx,fq,fp,fB,T,fr,fz,fl,fy,fk,fs;fp=[];fl=[];fs=false;for(fv=fu=0,fx=fw.length;fu<fx;fv=++fu){fr=fw[fv];if(this.has_loaded_metadata()){T=new K(this);if(this._is_loading_from_bottom()){this.photos.unshift(T)}else{this.photos.push(T)}fs=true}else{if(this.num_photos_loaded<this.photos.length){fo=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;T=this.photos[fo]}else{cJ(false,"num_photos_loaded should never be greater than photos.length")}}T.init_metadata(fr);if(T.uniqueness_key in fm){T.set_duplicates(fm[T.uniqueness_key])}if(fv<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){fl.push(T.preview_obj)}fp.push(T)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var j,fC,fE,fD;fD=[];for(j=0,fC=fl.length;j<fC;j++){fE=fl[j];fD.push(fE.preload())}return fD}),500)}eT.refresh(fp);for(ft=0,fq=fp.length;ft<fq;ft++){T=fp[ft];if(T.item_counter in this.init_sel_items){eT._add(T);this.num_to_select--;if(this.num_to_select===0){eT.dec_num_loading_events_before_select()}delete this.init_sel_items[T.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;fk=this.timeline;fA=T.uniqueness_key;bD(document).ready(function(){return fk.scroll_to_photo_with_key(fA)})}}}if(!fn){if(this.num_photos_loaded<this.photos.length){fB=this.photos.length-this.num_photos_loaded;fy=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(fy,fB);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(fs||fB){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(i.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){fz=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(fz)}};i.prototype._fix_photo_miscount=function(){var fk,T,j;fk=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);T=this.get_num_rows()-fk;if(typeof g!=="undefined"&&g!==null){g.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}j=C.scroll_offsets().top;if(this.top_offset+this.get_height()<j){C.scroll_to(0,j+T*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(i.EVENT_MISCOUNT_EVT,this)};i.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};i.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};i.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};i.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};i.prototype.visible_thumbs_loaded=function(fr){var fl,fm,fo,T,fn,fk,fq,fp;if(fr==null){fr=this.timeline.get_viewport_info()}fk=this.get_photo_range_to_render(fr,false),fl=fk[0],fo=fk[1];if(fl===null&&fo===null){return true}for(fn=fm=fq=fl,fp=fo;fq<=fp?fm<=fp:fm>=fp;fn=fq<=fp?++fm:--fm){T=this.photos[fn];if((T==null)||!(T.status>=K.RENDERED)){return false}}return true};i.prototype._is_loaded=function(j){var T,fk;if(this._is_loading_from_bottom()){fk=this.photos.length-this.num_photos_loaded;T=this.photos.length-1}else{fk=0;T=this.num_photos_loaded-1}return(fk<=j&&j<=T)};i.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};i.prototype._is_valid_photo_index=function(j){return(j!=null)&&(j>=0)&&(j<=this.photos.length-1)};i.prototype.update_photo_divs=function(){var fk,T,fr,fI,fH,fG,fq,fJ,fv,fE,fD,fu,fF,fs,fo,fm,ft,fB,fA,fz,fy,fx,fC,fn,fl,fK,fp,fw;if(!this.num_photos_loaded){return}fw=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(fw)){return}ft=this.get_photo_range_to_render(fw),fr=ft[0],fq=ft[1];cJ((fr!=null)&&(fq!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(fr))||(!this._is_loaded(fq)))){this.load_metadata_range(fr,fq);if(this._is_loading_from_bottom()){fr=Math.max(fr,this.photos.length-this.num_photos_loaded)}else{fq=Math.min(fq,this.num_photos_loaded-1)}if(fr>fq){return}}fF=Math.floor(fr/this.timeline.THUMBS_PER_ROW);fp=fF*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:fp+"px"});fu=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(fq/this.timeline.THUMBS_PER_ROW);T=fu*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:T+"px"});this._hide_photos((function(){fC=[];for(var fL=0;0<=fr?fL<fr:fL>fr;0<=fr?fL++:fL--){fC.push(fL)}return fC}).apply(this));this._hide_photos((function(){fn=[];for(var fL=fB=fq+1,j=this.photos.length;fB<=j?fL<j:fL>j;fB<=j?fL++:fL--){fn.push(fL)}return fn}).apply(this));this._show_photos((function(){fl=[];for(var j=fr;fr<=fq?j<=fq:j>=fq;fr<=fq?j++:j--){fl.push(j)}return fl}).apply(this));fz=eT.get();for(fE=0,fJ=fz.length;fE<fJ;fE++){fo=fz[fE];if((fy=$(fo.uniqueness_key))!=null){fy.addClassName("selected")}}this.scroll_count=bO.scroll_count;fk=[];fx=this.get_thumb_indexes_to_load(fw);for(fD=0,fv=fx.length;fD<fv;fD++){fm=fx[fD];fo=this.photos[fm];if((fo!=null)&&fo.status>=K.RENDERED){fK=$(fo.uniqueness_key);if((fK!=null?fK.down("img"):void 0)!=null){fk.push(fK.down("img"))}}}fs=function(j){return j.up(".cu-thumb").addClassName("thumb-loaded")};return bq.batch_load_thumbs(fk,this.timeline.THUMBS_BATCH_SIZE,fs,this.log_thumb_load.bind(this))};i.prototype._hide_photos=function(fn){var fm,fk,T,fl;fl=[];for(fk=0,T=fn.length;fk<T;fk++){fm=fn[fk];fl.push(this._hide_photo(fm))}return fl};i.prototype._hide_photo=function(j){var T;T=this.photos[j];if((T==null)||!(T.status===K.DISPLAYED)){return}$(T.uniqueness_key).hide();return T.status=K.RENDERED};i.prototype._show_photos=function(fz){var fv,fu,fy,fk,fx,fs,fq,fn,fw,fr,fp,fm,fl,ft,fo,T;fk=[];for(fs=0,fw=fz.length;fs<fw;fs++){fu=fz[fs];fx=this._get_photo_insert_info(fu);if(!fx){continue}fy=fx[0],T=fx[1];fo=false;for(fq=0,fr=fk.length;fq<fr;fq++){fv=fk[fq];if(fv.after===fy){fv.photos.push(T);fo=true;break}}if(!fo){fk.push({after:fy,photos:[T]})}}for(fn=0,fp=fk.length;fn<fp;fn++){fv=fk[fn];fv.after.__sert({after:fv.photos})}ft=[];for(fl=0,fm=fz.length;fl<fm;fl++){fu=fz[fl];ft.push(this.photos[fu].status=K.DISPLAYED)}return ft};i.prototype._get_photo_insert_info=function(T){var fn,fk,fm,fl,fq,fp,fo;fl=this.photos[T];if((fl==null)||fl.status===K.DISPLAYED){return}if(fl.status===K.RENDERED){$(fl.uniqueness_key).show()}else{fk=$("p-top-"+this.unique_id);if(T!==0){for(fn=fm=fo=T-1;fo<=0?fm<=0:fm>=0;fn=fo<=0?++fm:--fm){fq=this.photos[fn];if((fq!=null)&&fq.status>=K.RENDERED){fp=$(fq.uniqueness_key);cJ(fp!=null,"photo "+fn+" was marked as rendered, but its thumb elm doesn't exist");fk=fp;break}}}return[fk,fl.thumb_html]}};i.prototype.in_y_range=function(T,j){return !(this.top_offset+this.timeline.HEADER_HEIGHT>j||this.top_offset+this.get_height()<T)};i.prototype.in_current_viewport=function(fl,fm){var fk,j,T;if(fl==null){fl=this.timeline.get_viewport_info()}if(fm==null){fm=true}T=fl.top;j=fl.top+fl.height;if(fm){fk=this._blur_range(T,j,fl),T=fk[0],j=fk[1]}return this.in_y_range(T,j)};i.prototype.hide_photos_if_not_in_current_viewport=function(fp){var fn,fm,fl,fo,fk,T;if(!this.in_current_viewport(fp)){if(this._is_loading_from_bottom()){for(fn=fm=fo=this.photos.length-this.num_photos_loaded,fk=this.photos.length;fo<=fk?fm<fk:fm>fk;fn=fo<=fk?++fm:--fm){this._hide_photo(fn)}}else{for(fn=fl=0,T=this.num_photos_loaded;0<=T?fl<T:fl>T;fn=0<=T?++fl:--fl){this._hide_photo(fn)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};i.prototype._blur_range=function(fl,j,fn){var fk,T,fm;if(fn==null){fn=this.timeline.get_viewport_info()}fm=dy.get();if(fm>=0){T=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;fk=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(fm<0){T=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;fk=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}fl-=T*fn.height;j+=fk*fn.height;return[fl,j]};i.prototype.get_photo_range_to_render=function(fq,fl){var fo,fk,fn,T,fp,fm,j;if(fl==null){fl=true}j=fq.top;fm=fq.bottom;if(fl){T=this._blur_range(j,fm,fq),j=T[0],fm=T[1]}if(!this.in_y_range(j,fm)){return[null,null]}fp=Math.floor((j-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fo=Math.floor((fm-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fk=Math.min(this.photos.length-1,fp*this.timeline.THUMBS_PER_ROW);fn=Math.min(this.photos.length-1,(fo+1)*this.timeline.THUMBS_PER_ROW-1);cJ(!isNaN(fn),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+fq.bottom+" ")+("viewport_data.height="+fq.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+fo+" "),true,["photo_event_nan_limit"]);return[Math.max(0,fk),fn]};i.prototype.get_photo_range_to_render_with_blur=function(fm){var j,fo,fk,fn,fl,T;fl=this.get_photo_range_to_render(fm,true),fo=fl[0],fn=fl[1];T=this.get_photo_range_to_render(fm,false),j=T[0],fk=T[1];return[fo,j,fk,fn]};i.prototype.get_thumb_indexes_to_load=function(fr){var fD,fo,fB,fA,fz,fn,fm,fy,fv,fC,fs,fw,fp,fu,ft,fx,fl,fk,T,fq;fp=this.get_photo_range_to_render_with_blur(fr),fo=fp[0],fD=fp[1],fn=fp[2],fm=fp[3];if(fD==null){fv=(function(){fx=[];for(var fE=fo;fo<=fm?fE<=fm:fE>=fm;fo<=fm?fE++:fE--){fx.push(fE)}return fx}).apply(this);if(this.top_offset>fr.bottom){return fv}else{return fv.reverse()}}fw=(function(){fl=[];for(var j=fD;fD<=fn?j<=fn:j>=fn;fD<=fn?j++:j--){fl.push(j)}return fl}).apply(this);fC=[];fs=[];if(fo<fD){fC=(function(){fk=[];for(var j=fu=fD-1;fu<=fo?j<=fo:j>=fo;fu<=fo?j++:j--){fk.push(j)}return fk}).apply(this)}if(fm>fn){fs=(function(){T=[];for(var j=ft=fn+1;ft<=fm?j<=fm:j>=fm;ft<=fm?j++:j--){T.push(j)}return T}).apply(this)}fq=dy.get();if(fq>=0){return fw.concat(fs).concat(fC)}else{return fw.concat(fC).concat(fs)}};i.prototype.log_thumb_load=function(T,fl){var fm,fk,j;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===bO.scroll_count&&!this.logged_thumbs_arrived){if((T+1)%this.timeline.THUMBS_PER_ROW===0||T+1===fl){if(this.visible_thumbs_loaded()){j=this.timeline.get_viewport_info();fm=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<j.bottom&&j.bottom<this.top_offset+this.get_height())||fm){if(bO.scroll_count<2&&((fk=g.get_current_view())===cl.PHOTOS_VIEW||fk===cl.CAMERA_VIEW)){this.log_timing_event(J.viewport_initial_load);bO.scroll_count+=2}else{this.log_timing_event(J.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};i.prototype.log_timing_event=function(fl){var j,T,fk,fm;T=b4.time();j={};if(fl===J.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(fk=performance.timing)!=null?fk.navigationStart:void 0:void 0)!=null){fm=b4.time()-performance.timing.navigationStart;j={current_view:g.get_current_view()};ee.log_ajax_transition(fm,fl,j,fl)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(fl===J.viewport_loaded){fm=T-this.timing_stopped_scrolling_on_event}return ee.log_ajax_transition(fm,fl,j,fl)};return i})();var K;K=E.Photo=(function(){i.PLACEHOLDER=0;i.LOADED=1;i.RENDERED=2;i.DISPLAYED=3;i.uniqueness_key;i.item_counter;i.filename;i.ns_id;i.ns_path;i.fq_path;i.href;i.thumbnail_url;i.large_thumbnail_url;i.time_taken;i.display_time_taken;i.preview_type;i.mtime;i.video_streaming_url;i.is_visible;i.user_id;i.event;i.status;i.thumb_html;i.preview_obj;i.duplicates_info;function i(j){this.event=j;this.status=i.PLACEHOLDER;this.preview_obj=j.unique_id}i.prototype.init_metadata=function(j){this.uniqueness_key=j.uniqueness_key;this.item_counter=j.item_counter;this.filename=j.filename;this.ns_id=j.ns_id;this.ns_path=j.ns_path;this.fq_path=j.path;this.href=j.href;this.thumbnail_url=j.thumbnail_url;this.large_thumbnail_url=j.large_thumbnail_url;this.time_taken=j.time_taken;this.display_time_taken=j.display_time_taken;this.preview_type=j.preview_type;this.mtime=j.mtime;this.video_streaming_url=j.video_streaming_url;this.is_visible=j.is_visible;this.user_id=j.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true,Sprite:cv});this.preview_obj=this._get_preview_obj();this.status=i.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};i.prototype.set_duplicates=function(fl){var fk,T,j;for(T=0,j=fl.length;T<j;T++){fk=fl[T];fk.fq_path=fk.path}return this.duplicates_info=fl};i.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(bO.in_single_collection_view()){return new eQ({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new dr({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(bO.in_single_collection_view()){return new au({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new e1({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:G.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};i.prototype._get_display_date=function(){var j;if(this.time_taken!=null){j=new Date(this.time_taken);return b4.nice_date_with_month_name(j,j.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return i})();var ad;ad=E.PhotoCollection=(function(){i.CREATE_EVT="db:photocollection:create";i.ADD_EVT="db:photocollection:add";i.REMOVE_EVT="db:photocollection:remove";i.UNDO_REMOVE_EVT="db:photocollection:undo_remove";i.RENAME_EVT="db:photocollection:rename";i.DELETE_EVT="db:photocollection:delete";i.SHARE_EVT="db:photocollection:share";i.UNSHARE_EVT="db:photocollection:unshare";i.COVER_CHANGE_EVT="db:photocollection:cover_change";i.gid;i.name;i.num_items;i.num_photos;i.num_videos;i.thumbnail_url_32;i.thumbnail_url_256;i.is_anonymous;i.share_tkey;i.shmodel_url;i.short_url;i.is_creator;i.member_fnames;function i(T,j){if(j==null){j=true}cJ((T.gid!=null)&&(T.url!=null)&&(T.name!=null)&&(T.num_items!=null)&&(T.num_photos!=null)&&(T.num_videos!=null),"missing required PhotoCollection params");this.gid=T.gid;this.url=T.url;this.name=T.name;this.num_items=T.num_items;this.num_photos=T.num_photos;this.num_videos=T.num_videos;this.thumbnail_url_32=T.thumbnail_url_32||null;this.thumbnail_url_256=T.thumbnail_url_256||null;this.is_anonymous=T.is_anonymous!=null?T.is_anonymous:false;this.share_tkey=T.share_tkey||null;this.shmodel_url=T.shmodel_url||null;this.short_url=T.short_url||null;this.is_creator=T.is_creator!=null?T.is_creator:true;this.member_fnames=T.member_fnames||[ey("You")];if(j){document.fire(i.CREATE_EVT,{collection:this})}}i.prototype.add_photos=function(fo,fn,fk,fm){var j,fl,T;if(fk==null){fk=false}if(fm==null){fm=true}j=(function(){var fr,fp,fq;fq=[];for(fr=0,fp=fo.length;fr<fp;fr++){T=fo[fr];fq.push(T.item_counter)}return fq})();cJ(j.length,"Have to add at least one photo");fl={collection_gid:this.gid,item_counters:JSON.stringify(j),source_collection_gid:fn};return new Ajax.DBRequest("/collection_add",{parameters:fl,job:fk,job_user:cK.get_viewer().photos_user,progress_text:ey("Adding to album..."),onSuccess:(function(fp){return function(fs){var fq,ft,fr,fu;fu=JSON.parse(fs.responseText);fp.thumbnail_url_32=fu.thumbnail_url_32;fp.thumbnail_url_256=fu.thumbnail_url_256;ft=fu.new_num_photos-fp.num_photos;fr=fu.new_num_videos-fp.num_videos;fq=fu.new_num_items-fp.num_items;fp.num_photos=fu.new_num_photos;fp.num_videos=fu.new_num_videos;fp.num_items=fu.new_num_items;return document.fire(i.ADD_EVT,{collection:fp,photos:fo,num_items_added:fq,num_photos_added:ft,num_videos_added:fr,promote_collection:fm})}})(this)})};i.prototype.remove_photos=function(fl,fk){var j,T;if(fk==null){fk=false}j=(function(){var fo,fm,fn;fn=[];for(fo=0,fm=fl.length;fo<fm;fo++){T=fl[fo];fn.push(T.item_counter)}return fn})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(j),is_shared:this.share_tkey!=null,num_items:this.num_items},job:fk,job_user:cK.get_viewer().photos_user,progress_text:ey("Removing from album..."),onSuccess:(function(fm){return function(fn){var fo;fo=JSON.parse(fn.responseText);fm.thumbnail_url_32=fo.thumbnail_url_32;fm.thumbnail_url_256=fo.thumbnail_url_256;fm.num_photos=fo.new_num_photos;fm.num_videos=fo.new_num_videos;fm.num_items=fo.new_num_items;return document.fire(i.REMOVE_EVT,{collection:fm,photos:fl,undo_changeset:fo.undo_changeset})}})(this)})};i.prototype.undo_remove=function(j){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:j},html_in_error_msg:true,progress_text:ey("Undoing..."),onSuccess:(function(T){return function(){return document.fire(i.UNDO_REMOVE_EVT,{collection:T})}})(this)})};i.prototype.rename=function(T){var j;bO.enable_selection();j=new Ajax.InPlaceEditor(T,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return bD("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:ey("Saving..."),onLeaveEditMode:bO.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(fk){return function(fl){fk.name=fl.responseText;return document.fire(i.RENAME_EVT,{collection:fk})}})(this)},callback:(function(fk){return function(fl,fm){return{collection_gid:fk.gid,new_collection_name:fm,is_shared:fk.share_tkey!=null}}})(this)});return j.enterEditMode()};i.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:cK.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:cK.get_viewer().photos_user,onSuccess:(function(j){return function(){return document.fire(i.DELETE_EVT,{collection:j})}})(this)})};i.prototype.attach_to_token=function(fk,fm,T,fl,j){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:fk,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(fn){return function(){fn.share_tkey=fk;fn.shmodel_url=fm;fn.short_url=T;if(typeof fl==="function"){fl()}return document.fire(i.SHARE_EVT,{collection:fn})}})(this),onFailure:function(){return typeof j==="function"?j():void 0}})};i.prototype.send_link=function(T,fl,fp,fk,fo,j){var fn,fm;fn=(function(fq){return function(){fq.share_tkey=fl;fq.shmodel_url=fp;fq.short_url=fk;if(typeof fo==="function"){fo()}return document.fire(i.SHARE_EVT,{collection:fq})}})(this);fm={collection_gid:this.gid,share_tkey:fl,num_items:this.num_items};return bR.ajax_submit(T,"/collection_share",fn,j,T.down(".tokenizer-submit-button"),fm)};i.prototype.unshare=function(){cJ(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(j){return function(){j.share_tkey=null;j.shmodel_url=null;j.short_url=null;return document.fire(i.UNSHARE_EVT,{collection:j})}})(this),subject_user:cK.get_viewer().photos_user})};i.prototype.set_cover=function(j){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:j.item_counter},onSuccess:(function(T){return function(fk){var fl;fl=JSON.parse(fk.responseText);T.thumbnail_url_32=fl.thumbnail_url_32;T.thumbnail_url_256=fl.thumbnail_url_256;return document.fire(i.COVER_CHANGE_EVT,{collection:T})}})(this)})};return i})();var b5,l;b5=__PARENT_SCOPE__.FilePreview=INLINE_JS.FilePreview=E.FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,pdfLink:null,_pdfLoader:new ax(),init_pdf:function(fm,fl,T,i,fn){var j,fk;this.pdfLink=i;this.iframe_src=fl;this._log_pdf_render_time(fm);if(fm==="pdf-native"||fm==="pdf-embedded"||fm==="pdf-js"){window.addEventListener("message",l,false);bD((function(fo){return function(){var fs,fr,fq,fp;fp=G.parse(fl);fs=bD("#pdf-embed-container");if(fs.attr("data-docpreview-annotation-marker-enabled")==="True"){fp=fp.updateQuery("annotation_marker","1")}if(fs.attr("data-docpreview-annotation-highlight-enabled")==="True"){fp=fp.updateQuery("annotation_highlight","1")}if(fs.attr("data-docpreview-annotation-region-enabled")==="True"){fp=fp.updateQuery("annotation_region","1")}if(fm==="pdf-js"){fq=fp.getQuery();fo._pdfLoader.startListening();fo._pdfLoader.openFile(fq.file,{presentationMode:fn});delete fq.file;fp.setQuery(fq)}fr=bD("#pdf-embed-iframe");fr.attr("src",String(fp));fr.attr("type","application/pdf");fr.attr("allowfullscreen","");fr.addClass("pdfjs");bD("html, body").addClass("full_height");return fo._fire_pdf_render_event()}})(this));this.preview_status=T;if(bZ.chrome){fk=function(){var fo;fo=bD('link[rel="shortcut icon"]').remove();return bD("head").append(fo)};setTimeout(fk,1000)}j=$$("#pdf-embed-container iframe");return window.setTimeout(((function(fo){return function(){return j.invoke("setStyle",{visibility:"visible"})}})(this)),200)}},init_excel:function(i){window.addEventListener("message",l,false);return bD("#pdf-embed-iframe").attr("src",i)},excel_preview_unsupported:function(){return this.preview_failed()},init_font:function(){return bD((function(i){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this.preview_failed();return}return setTimeout(((function(i){return function(){if(!window.htmlified_height){return i.preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var i;if((i=$("htmlified-loading"))!=null){i.remove()}if(bD("#htmlified-wrapper[data-docpreview-ui-rams-enabled='True'] iframe, code-wrapper[data-docpreview-ui-rams-enabled='True'] iframe").length===0){$("htmlified").style.height=window.htmlified_height+"px"}return $("htmlified").style.visibility=""},init_video:function(fl,fn,j,fk,i,T,fm){return bD((function(fo){return function(){var fr,fp,fq;fq=fm.width()*0.9;fp=fq*0.55;fr=fo._video_preview_failed;if(fk==="hls"){fo.player=br.embed("#video",{src:j,type:"application/vnd.apple.mpegurl",width:fq,height:fp,controls:true,poster:i,onError:fr,onReady:fo._player_ready,metadata_link:T})}else{bD("#video").empty();if(fl){if(fn){fo.player=br.embed("#video",{src:j,type:"video/mp4",width:fq,height:fp,controls:true,poster:i,onError:fr,onReady:fo._player_ready,metadata_link:T})}else{fr()}}else{fo.player=br.embed("#video",{src:j,type:"video/flv",width:fq,height:fp,controls:true,poster:i,onError:fr,onReady:fo._player_ready,metadata_link:T})}}bD(".vjs-poster").hide();bD(".vjs-big-play-button").hide();fo.player.on("play",fo._onPlay);return fo.player.on("ended",fo._onEnded)}})(this))},photo_loaded:function(T){var j,i;if((j=window.performance)!=null?(i=j.timing)!=null?i.navigationStart:void 0:void 0){T=T-window.performance.timing.navigationStart;return ee.log_ajax_transition(T,"file-preview-photo")}},switch_preview:function(j,fl,fo){var fn,fm,fk,T,i;fk=INLINE_JS.URI.parse(this.iframe_src);i=INLINE_JS.URI.parse(fk.getQuery().file);T=i.updateQuery({revision_id:j}).toString();fm=G.parse(this.iframe_src).updateQuery({file:T});if(fl){fm.updateQuery({annotation_marker:"1"});fm.updateQuery({annotation_highlight:"1"});fm.updateQuery({annotation_region:"1"})}else{fm.removeQuery("annotation_marker");fm.removeQuery("annotation_highlight");fm.removeQuery("annotation_region")}fn=bD("#pdf-embed-iframe");fn.attr("src",fm.toString());fn.on("load",fo);return this._fire_pdf_render_event()},_player_ready:function(){var i;i=function(){bD(".vjs-poster").show();bD(".vjs-big-play-button").show();return bD(".vjs-big-play-button").focus()};return i.defer()},_onPlay:function(){bD(".vjs-poster").hide();return bD(".vjs-big-play-button").hide()},_onEnded:function(){bD(".vjs-poster").show();bD(".vjs-big-play-button").show();return bD(".vjs-loading-spinner").hide()},_video_preview_failed:function(i){if(i==="needflash"){bD("#video-preview-flash-message").show()}return b5.preview_failed()},preview_failed:function(){var i;i=bD(document.body);if(i.hasClass("shmodel-body")){i.removeClass("file-preview-body")}ah.error(ey("Preview failed."));return bD(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var i;if(document.createEvent&&window.dispatchEvent){i=document.createEvent("UIEvents");i.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(i)}},_log_pdf_render_time:function(j){var i;i=function(fm){var fl,T,fk;if((fl=window.performance)!=null?(T=fl.timing)!=null?T.navigationStart:void 0:void 0){fk=b4.time()-window.performance.timing.navigationStart;return ee.log_ajax_transition(fk,fm)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return i(j)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return i(j+"-parse")})}};l=function(fl){var fk,j,T,i,fm;j={"https://dl.dropbox.com":true};j["https://"+fi.DL_DOC_DOMAIN]=true;j["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;j["https://"+Constants.PUBSERVER]=true;j["https://"+Constants.WEB_STATIC_DROPBOX_HOST]=true;if(j[fl.origin]){T={};try{T=JSON.parse(fl.data);fk=T.action}catch(fm){i=fm;fk=fl.data}switch(fk){case"failed":return b5.preview_failed()}}};var aD;aD=E.ClientDownload=(function(){function i(){}i.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(j){var T;T=bD("<div",{"class":"brodal-header",text:ey("Install Dropbox")});return fa.show(T[0],$("client-download"),{},false,450)},subject_user:cr.active_user})};return i})();var cy,ej,g,J,a7,da,cl;cy=E.AlbumsLogger={log_share:function(j,fl,fk,T,i){return cy.log(j,fl,true,fk,T,i)},log_event:function(i,fk,T,j){return cy.log(i,fk,false,T,j)},log:function(j,fn,fk,fm,fl,i){var T;T={evt:j,collection_gid:fn,is_anonymous:fl};if(fk!=null){T.share_event=fk}if(fm!=null){T.num_items=fm}if(i!=null){T.on_create=i}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:T})}};ej=INLINE_JS.PhotosEvents=E.PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};a7=INLINE_JS.PhotosTourEvents=E.PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};da=INLINE_JS.PhotosTriggers=E.PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};cl=E.PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};g=INLINE_JS.PhotosLogger=E.PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var i,j,T;i=((j=$("modal"))!=null?j.visible():void 0)&&$("shmodal").visible();T=i?"-foshmodal":"";if(bO.in_single_collection_view()){return cl.SINGLE_COLLECTION_VIEW+T}else{if(bO.in_all_collections_view()){return cl.ALBUMS_VIEW+T}else{if(bO.initialized){return cl.PHOTOS_VIEW+T}else{return cl.NOT_PHOTOS}}}},log_interaction:function(i,j,T){return g.log(i,j,null,g.get_current_view(),T)},log_transition_to:function(i){return g.log(i,null,null,g.get_current_view(),null,true)},log:function(j,T,i,fn,fl,fm){var fk;fk={evt:j,trigger:T,view:i};if(fl!=null){fk.data=JSON.stringify(fl)}if(fn!=null){fk.start_view=fn}if(fm!=null){fk.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:fk})}};J=E.PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var dI,aP;aP=E.ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(i){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:i,url:window.location.href}})},attachLogListener:function(i,j){if(j==null){return}return j.observe("click",function(T){aP.log(i);if(j.href&&j.href!=="#"&&j.target!=="_blank"){Event.stop(T);return(function(){return window.location.href=j.href}).defer()}})}};dI=E.RegistrationLogger={log:function(i){var j;j=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:i,url:j}})},attachLogListener:function(i,j){if(j==null){return}return j.observe("click",function(T){dI.log(i);if(j.href&&j.href!=="#"&&j.target!=="_blank"){Event.stop(T);return(function(){return window.location.href=j.href}).defer()}})}};var f;f=E.ModalFlow=(function(){function i(fm,fq,fs,fl,T,fp,fr){var fn,fo,fk,j;this.title=fm;this.icon=fq;this.states=fs;this.next_state_table=fl;this.previous_state_table=T;this.initial=fp;this.onStart=fr;this._state_map={};fk=this.states;for(fn=0,fo=fk.length;fn<fo;fn++){j=fk[fn];this._state_map[j.name]=j}this.state=null;this._exit_listeners=[];this._cleanup_queue=[]}i.prototype.start=function(){var T,j,fk,fl;this.vars={};fk=this.states;for(T=0,j=fk.length;T<j;T++){fl=fk[T];fl.next=this._next.bind(this,fl);fl.back=this._back.bind(this,fl);if(fl.onSubmit){fl.onSubmitFn=(function(fm,fn){fm.onSubmit(this,fm,fn);return false}).bind(this,fl)}else{fl.onSubmitFn=((function(fm){return function(fn,fo){fn.next();return false}})(this)).bind(this,fl)}fl.contents.on("submit",fl.onSubmitFn);fl.contents.find(".backbutton").on("click",fl.back)}fa.onHide=this._onExit.bind(this);if(this.onStart){this.onStart()}this.to_state(this.initial);return false};i.prototype.to_state=function(T){var j;this.state=this._state_map[T];j=this.title;if(this.state.title!=null){j=this.state.title}fa.show(j,this.state.contents[0]);return this.state.enter(this)};i.prototype._next=function(j){var T;if(j===this.state){T=this.next_state_table[this.state.name](this);if(T==="__exit__"){return this.exit()}else{return this.to_state(T)}}};i.prototype._back=function(j){var T;if(j===this.state){T=this.previous_state_table[this.state.name](this);if(T==="__cancel__"){return this.exit()}else{if(T){return this.to_state(T)}}}};i.prototype.exit=function(){return this._onExit()};i.prototype._onExit=function(fr){var fo,fm,fp,fn,fk,fl,fq,T;fl=this.states;for(fo=0,fp=fl.length;fo<fp;fo++){T=fl[fo];T.contents.off("submit",T.onSubmitFn)}this._cleanUpExitListeners();fq=this._exit_listeners;for(fm=0,fn=fq.length;fm<fn;fm++){fk=fq[fm];fk(fr)}fa.onHide=null;return fa.hide()};i.prototype.addExitListener=function(j){return this._exit_listeners.push(j)};i.prototype.removeExitListener=function(j){return this._cleanup_queue.push(j)};i.prototype._cleanUpExitListeners=function(){var fm,fl,T,j,fo,fk;fo=this._cleanup_queue;fk=[];for(fl=0,j=fo.length;fl<j;fl++){fm=fo[fl];T=this._exit_listeners.indexOf(fm);fk.push(this._exit_listeners.splice(T,1))}return fk};return i})();var cF;cF=E.TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(i){this._user=cK.get_viewer().get_user_by_id(i);cJ(this._user,i+" is invalid");return bD("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){bD("#resend-link").on("click",this.resend_phone_code.bind(this));return bD("#code").focus()},init:function(j,i){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();d3.async_load_script(j);return d3.async_load_script(i)},account_listen:function(){var fw,T,fu,fr,fs,fq,fn,fv,i,j,fk,fm,fl,ft,fp,fo;fu={name:"delivery_choice",enter:(function(fx){return function(fy){var fz;fx.hide_error();fz=0;bD(".delivery-choice").each(function(){var fA;fA=bD(this).height();return fz=Math.max(fA,fz)});bD(".delivery-choice").height(fz);return bD(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:bD("#twofactor-delivery-choice"),onSubmit:(function(fx){return function(fy,fz,fA){fy.vars.sms=!!(bD("#use-sms")[0].getValue()==="on");if(!fy.vars.sms){return fx.fetch_offline_key(fy,fz)}else{return fz.next()}}})(this)};fr={name:"enter_phone_number",enter:(function(fx){return function(fz){var fA,fy;fx.hide_error();fx._is_offline_setup=false;fx._phone_number=null;fA=$("twofactor-enter-phone");fy=fx.fill_phone_number_for_edit(fA,bD("#twofactor-row-"+fx._user.role+" #twofactor-sms-number").text());return fy.focus()}})(this),contents:bD("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};fs={name:"offline_setup",enter:(function(fx){return function(fy){fx.hide_error();fx._is_offline_setup=true;return fx._phone_number=null}})(this),contents:bD("#twofactor-offline-setup")};T={name:"confirm_phone",enter:(function(fx){return function(fy){var fz;fx._invalid_code_count=0;if(fx._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{fz=fy.vars.phone_number;cJ(fz,"expected a display_phone argument");$("phone-number-placeholder").__date(fz);$("twofactor-enable-confirm").removeClassName("offline")}fx.hide_error();$("phone-code").clear().focus();return fx.fill_delivery_choice(fz)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:bD("#twofactor-enable-confirm")};fw={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:bD("#twofactor-enter-backup-phone")};fm=new f(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:bD("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(fx){return function(fy,fz){fx.successfully_enabled=false;fy.vars.mode="ENABLE";fy.vars.passed_password=true;return fz.next()}})(this)),contents:bD("#twofactor-enter-password")},fu,fr,fs,T,fw,{name:"recovery_code",enter:(function(fx){return function(){fx.fill_backup_phone(fx._backup_phone);return fx.hide_error.bind(fx)}})(this),onSubmit:this.submit_finish.bind(this,false),contents:bD("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:ey("Congrats! You've enabled two-step verification!"),contents:bD("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:(function(fx){if(fx.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fx){if(fx.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});fm.addExitListener((function(fx){return function(fy){if(fm.vars.passed_password&&fy&&!fx.successfully_enabled){return ah.error(ey("Two-step verification isn\u2019t enabled"))}}})(this));fk=new f(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fx){return function(fz,fA){var fy;fx.successfully_enabled=false;bD(".delivery-choice").removeClass("selected");fy=!bD("#twofactor-row").hasClass("with-sms");bD(fy?"#app-choice":"#sms-choice").addClass("selected");bD("#twofactor-recovery").addClass("edit-mode");fz.vars.passed_password=true;return fA.next()}})(this)),contents:bD("#twofactor-enter-password")},fu,fr,fs,T,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:bD("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:(function(fx){if(fx.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fx){if(fx.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});fk.addExitListener((function(fx){return function(fy){if(fk.vars.passed_password&&fy&&!fx.successfully_enabled){return ah.error(ey("Two-step verification has not been changed"))}}})(this));i=new f(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(fx){return function(fy,fz){fx.successfully_disabled=false;fy.vars.passed_password=true;return fz.next()}})(this)),contents:bD("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:bD("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});i.addExitListener((function(fx){return function(fy){if(i.vars.passed_password&&fy&&!fx.successfully_disabled){return ah.error(ey("Two-step verification is still enabled"))}}})(this));fq=new f(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fx,fy){return fy.next()}),contents:bD("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:bD("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");j=new f(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fx,fy){return fy.next()}),contents:bD("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:bD("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");ft=new f(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fx){return function(fy,fz){return new Ajax.DBRequest(fx.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fx._checkpoint_token,use_json:true},onSuccess:function(fB){var fA,fC;fC=JSON.parse(fB.responseText.strip());if(fC.result==="OK"){fA=fC.codes;fx.fill_recovery_codes(fA,"backup-code-list-edit");return fz.next()}else{switch(fC.result){case"EXPIRED":return fx.show_error_expired();case"ALREADY_DISABLED":bD("#twofactor-row").removeClass("twofactor-enabled");ah.success(ey("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fa.hide()}}},onFailure:fx.show_error500.bind(fx),cleanUp:fx.hide_loading.bind(fx),subject_user:fx._user})}})(this)),contents:bD("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:bD("#twofactor-recovery-edit"),onSubmit:(function(fx){return function(fy,fz){fx._checkpoint_token=null;return fz.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");fo=(function(fx){return function(fy){return new Ajax.DBRequest(fx.ADD_SECURITY_KEY_FINISH_HREF,{parameters:{checkpoint_token:fx._checkpoint_token,device_response:JSON.stringify(fy)},noAutonotify:true,onSuccess:function(fz){var fA;fA=fz.responseText.strip();fn.to_state("register_success");return bD(document).trigger("security-key-manager:UPDATE_KEYS",fx._user.id)},onFailure:function(fB){var fz,fA;fz=JSON.parse(fB.responseText.substr(4));fA=fz.security_key_register!=null?fz.security_key_register["message_text"]:ah.DEFAULT_ERROR;bD("#twofactor-security-key-register-error #error-msg").text(fA);return fn.to_state("register_error")},cleanUp:fx.hide_loading.bind(fx),subject_user:fx._user})}})(this);fl=(function(fx){return function(fy,fz){return new Ajax.DBRequest(fx.ADD_SECURITY_KEY_START_HREF,{parameters:{checkpoint_token:fx._checkpoint_token},onSuccess:function(fA){var fB;fB=JSON.parse(fA.responseText);u2f.register(fB.registerRequests,fB.authenticateRequests,fo);return fz.next()},onFailure:fx.show_error500.bind(fx),cleanUp:fx.hide_loading.bind(fx),subject_user:fx._user})}})(this);fp=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"unsupported_browser",enter:this.hide_error.bind(this),contents:bD("#twofactor-security-key-unsupported-browser")}],{unsupported_browser:function(){return"__exit__"}},{},"unsupported_browser");fv=new f("Confirm password",this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fx){return function(fy,fz){bD(document).trigger("security-key-modal:PASSWORD_CONFIRMED",[fx._user.id,fx._checkpoint_token]);return fa.hide()}})(this)),contents:bD("#twofactor-enter-password")}],{password:function(){return"__exit__"}},{},"password");fn=new f(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fx,fy){return fy.next()}),contents:bD("#twofactor-enter-password")},{name:"intro",enter:this.hide_error.bind(this),contents:bD("#twofactor-security-key-intro")},{name:"prepare_register",enter:this.hide_error.bind(this),contents:bD("#twofactor-security-key-prepare-register"),onSubmit:fl},{name:"register",enter:this.hide_error.bind(this),contents:bD("#twofactor-security-key-register")},{name:"register_error",enter:this.hide_error.bind(this),contents:bD("#twofactor-security-key-register-error"),onSubmit:fl},{name:"register_success",enter:(function(fx){return function(){fx.hide_error.bind(fx);return fx._checkpoint_token=null}})(this),onSubmit:function(fx,fy){ah.success(ey("Successfully added security key."));return fy.next()},contents:bD("#twofactor-security-key-register-success")}],{password:function(){return"intro"},intro:function(){return"prepare_register"},prepare_register:function(){return"register"},register:function(){return"register_success"},register_error:function(){return"register"},register_success:function(){return"__exit__"}},{},"password");this._bind_phone_input_to_save_button();this._register_skip_link_click_to_submit_finish();bD(".enable-twofactor").on("click",(function(fx){return function(fy){return fx.start_flow(fy,fm)}})(this));bD(".disable-twofactor").on("click",(function(fx){return function(fy){return fx.start_flow(fy,i)}})(this));bD(".add-twofactor-backup-link").on("click",(function(fx){return function(fy){return fx.start_flow(fy,fq)}})(this));bD(".edit-twofactor-backup").on("click",(function(fx){return function(fy){return fx.start_flow(fy,j)}})(this));bD(".edit-twofactor-recovery").on("click",(function(fx){return function(fy){return fx.start_flow(fy,ft)}})(this));bD(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(fx){return function(fy){return fx.start_flow(fy,fk)}})(this));bD(document).on("twofactor:ADD_SECURITY_KEY",(function(fx){return function(fz,fy){if(bD("#twofactor-security-key-unsupported-browser").length){return fx.start_flow(fz,fp,fy)}else{return fx.start_flow(fz,fn,fy)}}})(this));bD(document).on("twofactor:ASK_PASSWORD_CONFIRM",(function(fx){return function(fz,fy){return fx.start_flow(fz,fv,fy)}})(this));bD("#generate-new-recovery-code").on("click",(function(fx){return function(fy){fx.show_loading();return new Ajax.DBRequest(fx.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fx._checkpoint_token,use_json:true},onSuccess:function(fA){var fB,fz;fB=fA.responseText.strip();fz=JSON.parse(fB);if(fz.result==="OK"){return fx.fill_recovery_codes(fz.codes,"backup-code-list-edit")}else{switch(fB){case"EXPIRED":ft.to_state("password");return fx.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ah.success(ey("Two-step verification is disabled. Did you maybe disable it in another window?"));return fa.hide()}}},onFailure:fx.show_error500.bind(fx),cleanUp:fx.hide_loading.bind(fx),subject_user:fx._user})}})(this));bD("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));bD("#resend-link").on("click",this.enable_resend_phone_code.bind(this));bD("#twofactor-delivery-choice input").change(function(){bD(".delivery-choice").removeClass("selected");return bD(this).parents(".delivery-choice").addClass("selected")});bD("#show-qr").on("click",function(fx){bD("#twofactor-offline-setup").addClass("showing-qr");return false});bD("#hide-qr").on("click",function(fx){bD("#twofactor-offline-setup").removeClass("showing-qr");return false});if(window.location.hash==="#backup2fa"&&bD("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(fq)}},_bind_phone_input_to_save_button:function(){this.$save_button=bD("#twofactor-enter-backup-phone").find(".back-next").find(".savebutton");this.$phone_input=bD("#twofactor-enter-backup-phone").find(".twofactor-backup-phone-number").find(".phone-text");this.$phone_input.on("keyup",(function(i){return function(j){return i._toggle_save_phone_button(i.$phone_input,i.$save_button)}})(this));this.$phone_input.on("input",(function(i){return function(j){return i._toggle_save_phone_button(i.$phone_input,i.$save_button)}})(this));return this._toggle_save_phone_button(this.$phone_input,this.$save_button)},_register_skip_link_click_to_submit_finish:function(){return bD("#twofactor-enter-backup-phone").find(".back-next").find("#skipstep").on("click",(function(i){return function(){return i.submit_finish(true,i._current_flow,i._current_flow.state,null)}})(this))},_toggle_save_phone_button:function(i,j){var T;T=bD.trim(i.val())==="";return j.prop("disabled",T)},start_flow:function(T,j,i){if(i==null){i=null}T.preventDefault();delete this._phone_number;if(i==null){i=bD(T.target).data("uid")}cF.set_user(cK.get_viewer().get_user_by_id(i));this._current_flow=j;j.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return bD("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(j){var i;if(this.is_resending()){return}this.show_resending();i="/twofactor_resend";if(bD("#twofactor-confirm").hasClass("backup")){i=G.parse(i).updateQuery({backup:true}).toString()}new Ajax.DBRequest(i,{onSuccess:(function(T){return function(fk){switch(fk.responseText.strip()){case"OK":T.hide_error();return T.notify_resent();case"UNREACHABLE":return T.show_error_unreachable(true);case"BADCARRIER":return T.show_error_bad_carrier();case"INVALIDNUMBER":return T.show_error_invalid_number();case"NOTAMOBILE":return T.show_error_not_a_mobile();case"RATELIMIT":return ah.error(ey("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(i){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(j){return function(T){switch(T.responseText.strip()){case"OK":j.hide_error();return j.notify_resent();case"UNREACHABLE":return ah.error(error_unreachable(true));case"BADCARRIER":return ah.error(error_bad_carrier());case"INVALIDNUMBER":return j.show_error_invalid_number();case"NOTAMOBILE":return ah.error(error_not_a_mobile());case"RATELIMIT":return ah.error(ey("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(j){return function(T){return ah.error(j.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(i){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(j){return function(T){switch(T.responseText.strip()){case"OK":j.hide_error();return j.notify_resent();case"UNREACHABLE":return j.show_error_unreachable();case"BADCARRIER":return j.show_error_bad_carrier();case"INVALIDNUMBER":return j.show_error_invalid_number();case"NOTAMOBILE":return j.show_error_not_a_mobile();case"RATELIMIT":return ah.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":j._current_flow.to_state("password");return j.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:ey("Enable two-step verification"),DEFAULT_EDIT_TITLE:ey("Edit two-step verification"),DEFAULT_DISABLE_TITLE:ey("Disable two-step verification"),ADD_BACKUP_TITLE:ey("Add a backup phone number"),EDIT_BACKUP_TITLE:ey("Edit backup phone number"),EDIT_RECOVERY_TITLE:ey("View recovery code"),ADD_SECURITY_KEY_TITLE:ey("Add security key"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",ADD_SECURITY_KEY_START_HREF:"/account/twofactor/u2f_start_registration",ADD_SECURITY_KEY_FINISH_HREF:"/account/twofactor/u2f_finish_registration",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var i;this.hide_error();bD("#twofactor-recovery").removeClass("edit-mode");i=$("twofactor-enter-password");bD("#password",i).val("").focus();return false},submit_password:function(T,fm,i,fk,fl){var j;j=$("password").getValue();if(!j){this.show_error(ey("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(T,{parameters:{password:j},onSuccess:(function(fn){return function(fo){var fp;fp=fo.responseText.strip();if(fp.startsWith("OK:")){fn._checkpoint_token=fp.substr(3);return fm(i,fk)}else{switch(fp){case"EXPIRED_PASSWORD":return fn.show_error_expired_password();case"INVALID":return fn.show_error(ey("Invalid password"));case"RATELIMIT":return fn.show_error(ey("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");ah.success(ey("Two-step verification is already enabled. Did you maybe enable it in another window?"));return fa.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ah.success(ey("Two-step verification is already disabled. Did you maybe disable it in another window?"));return fa.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(i,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(T){return function(fk){var fl;fl=fk.responseText.strip();if(fl.startsWith("OK:")){T.fill_key(fl.substr(3));return j.next()}else{switch(fl){case"EXPIRED":i.to_state("password");return T.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(j){var i,fk,T;j=j.replace(new RegExp("=+$"),"");i=j.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(i);$("qr-div").__date();T=Constants.IS_PROD?"Dropbox":"DropboxDev";fk={text:"otpauth://totp/"+T+":"+this._user.email+"?secret="+j+"&issuer="+T,width:200,height:200};if(!Modernizr.canvas){fk.render="table"}bD("#qr-div").qrcode(fk);if(!Modernizr.canvas){return bD("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(j,fk,fl){var i,T;i=bD("#twofactor-enter-phone .twofactor-phone-number");if(!C.controller(i).validate_on_submit()){return}T=i.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:T},onSuccess:(function(fm){return function(fn){switch(fn.responseText.strip()){case"OK":fm._phone_number=T;j.vars.phone_number=T;return fk.next();case"EXPIRED":j.to_state("password");return fm.show_error_expired();case"UNREACHABLE":return fm.show_error_unreachable(i);case"BADCARRIER":return fm.show_error_bad_carrier(i);case"INVALIDNUMBER":return fm.show_error_invalid_number(i);case"NOTAMOBILE":return fm.show_error_not_a_mobile(i);case"RATELIMIT":return fm.show_error(ey("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(i,j,fk){var T;T=$("phone-code").getValue().strip();if(!T){this.show_error(ey("Please enter the security code"));return}if(T.search(/^\d{6}$/)===-1){this.show_error(ey("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:T,use_json:true},onSuccess:(function(fl){return function(fm){var fo,fn;fn=JSON.parse(fm.responseText.strip());if(fn.result==="OK"){fl.fill_recovery_codes(fn.codes,"backup-code-list");return j.next()}else{switch(fn.result){case"INVALID":fl._invalid_code_count+=1;fo=fl._invalid_code_count<=2?ey("Invalid code"):fl._is_offline_setup?ey("Invalid code. Check the clock on your phone: it must be accurate to the minute."):ey("Invalid code");return fl.show_error(fo);case"EXPIRED":i.to_state("password");return fl.show_error_expired();case"RATELIMIT":return fl.show_error(ey("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(fk,j){var T,i;this.hide_error();T=$("twofactor-enter-backup-phone");i=this.fill_phone_number_for_edit(T,bD("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());i.focus();if(fk==="back_next"){bD("#twofactor-backup-back-next").show();bD("#twofactor-backup-cancel-save").hide();return bD("#twofactor-backup-back-save").hide()}else{if(fk==="cancel_save"){bD("#twofactor-backup-back-next").hide();bD("#twofactor-backup-cancel-save").show();return bD("#twofactor-backup-back-save").hide()}else{if(fk==="back_save"){bD("#twofactor-backup-back-next").hide();bD("#twofactor-backup-cancel-save").hide();return bD("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(fl,fk,j,fm,fn){var i,T;i=bD("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!C.controller(i).validate_on_blur()){return}T=i.val();if(T){if(this.is_primary_number(T)){C.controller(i).show_error(ey("You can't use your primary phone as your backup",i));return}}else{if(fl){C.controller(i).show_error(ey("Please enter phone number",i));return}}this._backup_phone=T;if(fk==="save_backup_phone"){this.save_added_backup_phone(j,fl,T)}else{if(fk==="save_everything"){this.submit_finish(false,j,fm,fn)}else{if(fk==="save_none"){return fm.next()}}}},is_same_phone_number:function(j,i){if(!j||!i){return false}return j.replace(/\D+/g,"")===i.replace(/\D+/g,"")},is_primary_number:function(i){var j;j=bD("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this._phone_number){return this.is_same_phone_number(i,this._phone_number)}else{if(this.is_same_phone_number(i,j.data("primary_phone"))){return true}if(this.is_same_phone_number(i,bD("#twofactor-sms-number",j).text())){return true}}return false},save_added_backup_phone:function(i,T,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:j},onSuccess:(function(fk){return function(fl){var fm;switch(fl.responseText.strip()){case"OK":fk.hide_error();fm="#twofactor-row-"+fk._user.role;bD(fm+" #twofactor-backup-number").text(j);bD(fm).toggleClass("with-backup",!!j);if(!j){ah.success(ey("Backup phone number removed"))}else{if(!T){ah.success(ey("Backup phone number updated"))}else{ah.success(ey("Backup phone number added"))}}return fa.hide();case"EXPIRED":i.to_state("password");return fk.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(T,fk){var i,j;j=bD("input.text-input-input",T);if(!fk){return j.val("")}i=C.controller(bD(".phone-number-input",T));i.set(fk);j.val(i.get_local_number());if(j.length){j[0].select()}bD("#twofactor-backup-back-save").find("#skipstep").hide();bD(".text-input-wrapper").find("label").hide();return j},fill_delivery_choice:function(i){bD("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!i);bD("#twofactor-delivery-offline-label").toggle(!i);bD("#confirm-phone-primary-number").text(i);return bD("#twofactor-row-"+this._user.role).data("primary_phone",i)},fill_backup_phone:function(i){bD("#confirm-phone-backup").toggle(!!i);return bD("#confirm-phone-backup-number").text(i)},insert_spaces_into_code:function(i){return i.toLowerCase().replace(/(.{4})/g,"$1 ")},fill_recovery_codes:function(j,fm){var fp,fk,T,fn,fq,fo,fl;fp=bD("#"+fm);fp.empty();T=j[0].length;if(T===16){fp.css("column-count","1")}fo=[];for(fn=0,fq=j.length;fn<fq;fn++){fk=j[fn];fl=bD("<li/>",{"class":"twofactor-backup-list__item"});fo.push(fp.append(fl.append(bD("<span/>",{"class":"twofactor-backup-list__code",text:this.insert_spaces_into_code(fk)}))))}return fo},submit_finish:function(j,i,T,fk){var fl;this.show_loading();fl={checkpoint_token:this._checkpoint_token};if(this._backup_phone&&!j){fl.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:fl,onSuccess:(function(fm){return function(fn){switch(fn.responseText.strip()){case"OK":fm.successfully_enabled=true;if(i.vars.mode!=="ENABLE"){return fm.after_enabled(i,T)}else{return T.next()}break;case"EXPIRED":i.to_state("password");return fm.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(j,fk){var i,T;this._checkpoint_token=null;this.hide_error();i=bD("#twofactor-row-"+this._user.role);i.toggleClass("with-sms",!!this._phone_number);bD("#twofactor-sms-number",i).text(this._phone_number||"");i.toggleClass("with-backup",!!this._backup_phone);bD("#twofactor-backup-number",i).text(this._backup_phone||"");i.addClass("twofactor-enabled");bD("tr[id^='session_row_']").slice(1).hide();if(j.vars.mode!=="ENABLE"){T="/account/#security";ah.success(new ff(ey('Two-step verification updated. Any <a href="%(path)s">existing sessions, devices and apps</a> can still access your Dropbox.').format({path:T})));return fk!=null?fk.next():void 0}},disable_submit:function(i,j){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(T){return function(fl){var fk;switch(fl.responseText.strip()){case"OK":T.successfully_disabled=true;T._checkpoint_token=null;fk=bD("#twofactor-row-"+T._user.role);fk.removeClass("twofactor-enabled with-sms with-backup");bD(document).trigger("security-key-manager:UPDATE_KEYS",T._user.id);bD("#twofactor-sms-number, #twofactor-backup-number",fk).text("");bD("tr[id^='session_row_']").slice(1).hide();ah.success(ey("Two-step verification is now disabled."));return j.next();case"EXPIRED":i.to_state("password");return T.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(T,i){var j;if(i){C.controller(i).show_error(T);return}j=$$(this._error_selector);if(T===this.error_expired_password()||T===this.error_unreachable(true)){j.invoke("update",T)}else{j.invoke("__date",T)}return j.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(i){return this.show_error(this.error_bad_carrier(),i)},show_error_invalid_number:function(i){return this.show_error(this.error_invalid_number(),i)},show_error_not_a_mobile:function(i){return this.show_error(this.error_not_a_mobile(),i)},show_error_unreachable:function(i,j){if(j==null){j=false}return this.show_error(this.error_unreachable(j),i)},show_error_expired:function(i){return this.show_error(this.error_expired(),i)},show_error_expired_password:function(i){return this.show_error(this.error_expired_password(),i)},error_500:function(){return ey("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return ey("Unfortunately, your carrier isn\u2019t supported at this time.")},error_invalid_number:function(){return ey("That isn\u2019t a valid phone number.")},error_not_a_mobile:function(){return ey("That phone number doesn\u2019t appear to be a valid mobile number.")},error_unreachable:function(i){if(i==null){i=false}if(i){return ey('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return ey("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return ey("Since it's been a while, please enter your password again.")},error_expired_password:function(){return ey('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return ah.success(ey("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(j){var i,T;i=j.element();T=bD(".sick-input",i.form);bD("input",T).val("").focus();return this.fill_example_phone_number(i,T)},fill_example_phone_number:function(i,fk){var T,j;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){T=bD(i).val().substr(1);j=phone_helpers.get_example_mobile_number(T);return bD("label",fk).text(ey("Example: ")+j)}},reset_phone_field_and_backup_country:function(j){var i;this.reset_phone_field(j);if(bD("#backup-phone-number").val()===""){i=bD("#twofactor-enter-backup-phone #country-code");i.val(j.element().getValue());return this.fill_example_phone_number(i,bD(".sick-input",i[0].form))}}};var n,cR=[].indexOf||function(fk){for(var T=0,j=this.length;T<j;T++){if(T in this&&this[T]===fk){return T}}return -1};n=__PARENT_SCOPE__.FileViewer=INLINE_JS.FileViewer=E.FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,MAX_CHECK_LOCK_TRIES:8,_FADE_MSEC:300,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,is_loaded:false,has_key_listener:false,preview_status_timeout_obj:null,preview_status_request:null,hiding:false,check_lock_request:null,check_lock_timeout:null,file_locked:false,file_view_mode:aW.FileViewModeType.UNKNOWN,_frameMessenger:null,_cached_browser_window_title:null,annotation_enabled_for_this_revision:true,_preview_flippable_component:null,active_user:null,_pdfLoader:new ax(),_is_browse_drag_enabled:null,_file_view_attempts:0,globalPreviewStateModel:new ei.Model({state:"closed",file_obj:null}),globalOpenWithWebButtonStateModel:new ei.Model({state:"hidden",file_extension:null}),_get_extension:function(j){var i;i=j.lastIndexOf(".");return(i===-1?"":j.substr(i+1))},_get_preview_type_from_extension:function(T){var j,i;j=T.substring(0,3);if(j==="rtf"||j==="odt"){i="doc"}else{if(j==="pps"){i="ppt"}else{i=j}}return i},_file_view_mode_is_browse:function(){var i;return i=this.file_view_mode,cR.call(aW.FileViewModeCategories.BROWSE_FILE_VIEW_MODE_TYPES,i)>=0},_file_view_mode_is_shared_or_member_link:function(){var j,T,i;j=aW.FileViewModeCategories;return(T=this.file_view_mode,cR.call(j.SHARED_LINK_FILE_VIEW_MODE_TYPES,T)>=0)||(i=this.file_view_mode,cR.call(j.MEMBER_LINK_FILE_VIEW_MODE_TYPES,i)>=0)},show:function(fk,i,T,j){this._file_view_attempts=0;this._cached_browser_window_title=document.title;return this._setup_and_load.apply(this,arguments)},_setup_and_load:function(fm,T,fl,fk){var fn,j,i;if(fl==null){fl={}}fl=bv.defaults(fl,{files:[],force_file_unlocked:true,file_view_mode:aW.FileViewModeType.UNKNOWN,should_focus_comment_input:false,hide_comments:false,hide_restore:false});if(this._is_browse_drag_enabled==null){this._is_browse_drag_enabled=bD.proxy((function(){return !this.shown()}),this)}i=bD("#file-viewer");if(this.hiding){i.finish()}else{if(this.shown()){this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);return}else{i.hide()}}fn=i.find(".file-viewer-comment-container");if(fl.hide_comments){fn.hide()}else{fn.show()}j=i.find(".restore-button");if(j.length){if(fl.hide_restore){j.hide()}else{j.show()}}this.file=fm;this.active_user=T;this.flippable_files=this._filterFlippableFiles(fl.files);this.file_view_mode=fl.file_view_mode;this.should_focus_comment_input=fl.should_focus_comment_input;this.total_files=fl.files.length;this._start_time=Date.now();if(this.file.preview_type==="download"){window.location.href=this.file.href}else{C.scroll_lock_document();i.css("pointer-events","").fadeIn(this._FADE_MSEC);return this.load(this.file,fl.force_file_unlocked,fk)}},_getFilesToPreloadActivities:function(){var fk,fo,fm,fp,fl,T,fn;fo=[];fk=this.currentFlippableFileIndex();fn=[1,2,3,4,5,6,-1,-2];for(fl=0,T=fn.length;fl<T;fl++){fm=fn[fl];fp=fk+fm;if((0<=fp&&fp<this.flippable_files.length)){fo.push(this.flippable_files[fp])}}return fo},load:function(T,fm,j){var i,fl,fk;if(fm==null){fm=false}this.file=T;document.title=this.file.filename;i=bD("#file-viewer");if(i.data("is-openwith-allowed")==="True"){if(__CONDITIONAL_JS__.OpenWith.file_supported(this.file)){if(fm){this.file_locked=false}else{this.file_locked=true;this.check_lock()}}}bD(document.activeElement).blur();this._render_viewer();fk=this.modal_type===this._MODAL_FILEINFO;fl=this._getFilesToPreloadActivities();return bD("#file-viewer").trigger("db:filepreview:open",[this.file,this.file_view_mode,this.active_user.id,this.should_focus_comment_input,fk,j,fl])},_filterFlippableFiles:function(j){var i;return(function(){var fk,T,fl;fl=[];for(fk=0,T=j.length;fk<T;fk++){i=j[fk];if(d2.isFlippable(i.preview_type)){fl.push(i)}}return fl})()},currentFlippableFileIndex:function(){var fm,fl,fk,T,fn;fn=this.flippable_files;for(fl=fk=0,T=fn.length;fk<T;fl=++fk){fm=fn[fl];if(this.file.sjid===fm.sjid){return fl}}return -1},cancel_check_lock:function(){this.file_locked=false;if(this.check_lock_request!=null){this.check_lock_request.abort();this.check_lock_request=null}if(this.check_lock_timeout!=null){clearTimeout(this.check_lock_timeout);return this.check_lock_timeout=null}},check_lock:function(){var fo,fl,fk,fn,T,j,fm,i;if(this.check_lock_request!=null){return}this.check_lock_timeout=null;T=0;i=this.active_user.id;fm=this.file.fq_path;j=1000;fn=(function(fp){return function(){T++;if(T<fp.MAX_CHECK_LOCK_TRIES){if(T===2){INLINE_JS.Notify.warning(ey("Office Online is saving your file."))}else{if(T===5){INLINE_JS.Notify.warning(ey("Office Online is taking longer than expected to save. ",+"Your changes are safe and will eventually be saved to Dropbox."))}}fp.check_lock_timeout=setTimeout(fo,j);return j=j*2}else{clearTimeout(fp.check_lock_timeout);fp.check_lock_request=null;fp.file_locked=false;return fp._render_preview(true,true)}}})(this);fk=(function(fp){return function(fq){fq=JSON.parse(fq);if(fq!=null?fq.has_lock:void 0){return fn()}else{fp.check_lock_request=null;fp.file_locked=false;return fp._render_preview(true,true)}}})(this);fl=function(fr,fp,fq){return fn()};fo=(function(fp){return function(){return fp.check_lock_request=cC.WebRequest({url:"/ow/msft/check_lock",data:{user_id:i,fq_path:fm},success:fk,error:fl})}})(this);return fo()},shown:function(){return bD("#file-viewer").css("display")!=="none"},clear_preview_url_timer:function(){if(this.previewUrlTimer!=null){return clearTimeout(this.previewUrlTimer)}},set_preview_url_w_timeout:function(){this.clear_preview_url_timer();return this.previewUrlTimer=setTimeout((function(i){return function(){return i.set_preview_url()}})(this),250)},set_preview_url:function(){var T,j,i;T=G.parse(eB.get_url());j=T.getPath();i=T.removeQuery("select").updateQuery({preview:this.file.filename}).getQuery();return eB.push_state(G.encode_parts(j),i,{immediatelyRestoreState:false})},unset_preview_url:function(){var T,j,i;this.clear_preview_url_timer();T=G.parse(eB.get_url());if(!this._file_view_mode_is_shared_or_member_link()&&(T.getPath().match(/^\/s[h]?\/.+/)||!this._file_view_mode_is_browse())){return}if(!("preview" in T.getQuery())){return}j=T.getPath();i=T.removeQuery("select").removeQuery("preview").getQuery();return eB.push_state(G.encode_parts(j),i)},render_file_failed:function(){var i,j;j=this.file;i=this.active_user;this._teardown_and_hide();j.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this._setup_and_load(j,i,{files:this.flippable_files,force_file_unlocked:!this.file_locked,file_view_mode:this.file_view_mode,should_focus_comment_input:this.should_focus_comment_input});bD("#file-viewer").show();return bD("#file-viewer").trigger("preview_failed")},_log_view:function(i,j,fk){var T;if(fk==null){fk=aW.FileViewModeType.FILE_PREVIEW}this._file_view_attempts++;T={user_id:this.active_user.id,context:aW.FileViewContextType.PRIVATE,platform:aW.FileViewPlatformType.WEB,ns_id:this.file.ns_id,sjid:this.file.sjid,ns_path:this.file.ns_path,shared_link_url:null,extra:{mode:fk,file_ext:aA.file_extension_for_logging(this.file.filename),file_bytes:this.file.bytes,file_mtime:this.file.ts,preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:i,in_progress:j,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,file_view_attempts:this._file_view_attempts}};return a9.FileViewLogger.log(T)},preload_office_static:function(j){var fk,T,i;if(__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS==null){return}T=this._get_extension(j);if(T in __CONDITIONAL_JS__.OpenWith.PRELOAD_URLS){fk=bD("#file-viewer .open-with-static-content-container");i=bD("<iframe/>",{src:__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS[T]});return fk.html(i)}},unload_office_static:function(){var i;i=bD("#file-viewer .open-with-static-content-container");return i.empty()},_render_viewer:function(){var fo,j,fr,fs,fk,fu,i,ft,fq,fv,fl,T,fm,fp,fn;j=bD("#file-viewer");fo=j.find(".download-button");fs=G.parse(this.file.href).updateQuery({dl:1}).toString();this.preload_office_static(this.file.filename);fp=(function(fw){return function(fD){var fz,fB,fy,fx,fA,fC;if(fD==null){fD=true}fx=bS.em_snippet(fw.file.filename,35);fz=j.find(".title-bar .filename");fC={"class":"icon",alt:fw.file.caption};fA=cv.html("web",fw.file.icon,fC).toHTML();fB=bD("<span />",{"class":"filename-text"}).text(fx);fz.html(fA).append(fB);j.addClass("has-preview");if(cK.get_viewer().is_team_assume_user_session){j.addClass("room-for-team-assume-user-top-bar")}if(fw.file.htmlified_link){j.addClass("htmlified-preview")}else{if(fw.file.preview_type==="excel"){j.addClass("html-preview");j.find(".loading").css("z-index","-1")}else{j.addClass(fw.file.preview_type+"-preview")}}if(fD){j.find(".loading").show()}fo.on("click",function(fE){fE.preventDefault();return window.location.href=fs});if(fw.file.tkey===void 0&&n.active_user.is_email_verified){fy=function(fE){this.file.tkey=fE.tkey;return this._update_title_bar_buttons()};cC.WebRequest({url:"/sm/get_token",type:"POST",data:{path:fw.file.fq_path},dataType:"json",subject_user:fw.active_user.id,success:fy.bind(fw)})}else{fw._update_title_bar_buttons()}fw.modal_type=fw._MODAL_PREVIEW;fw._first_render_completed=false;return fw._listen()}})(this);fu=(function(fw){return function(){j.removeClass();j.find(".loading").hide();return fw._unlisten()}})(this);fm=(function(fw){return function(fx,fC,fA,fz,fy){var fB;if(fx==null){fx=false}if(fC==null){fC=true}if(fA==null){fA=false}if(fz==null){fz=false}if(fy==null){fy=true}fw._log_view(Date.now()-fw._start_time,fz,aW.FileViewModeType.FILE_PREVIEW);fB=fw._get_extension(fw.file.filename);if(fB==="doc"||fB==="docx"||fB==="odt"||fB==="ppt"||fB==="pptx"||fB==="xls"||fB==="xlsx"||fB==="pdf"||fB==="eps"||fB==="ai"||fB==="psd"||fB==="svg"||fB==="txt"||fB==="rtf"||fB==="pspimage"||fB==="tif"||fB==="tiff"||fB==="yuv"||fB==="url"||fB==="webloc"||fB==="website"){fw.globalPreviewStateModel.set({state:"open",file_obj:fw.file})}if(!fx){fp(fC);fw._update_title_bar_buttons()}fw._render_preview(fA,fy);return fw._initial_resize()}})(this);T=(function(fw){return function(fy){var fx,fA,fB,fz;if(fy==null){fy=false}fx=fw.file.filename.indexOf(".");fA=fw.file.filename.substring(fx+1);if(fA==="key"&&fw.file.preview_type===null){fz="/static/images/icons128/"+(aA.file_icon("_other"))+".png"}else{fz="/static/images/icons128/"+(aA.file_icon(fw.file.filename))+".png"}fw.globalPreviewStateModel.set({state:"closed",file_obj:null});fB=bS.em_snippet(fw.file.filename,20);j.find(".title-bar .filename").text(fB);j.addClass("no-preview");j.find(".file-thumbnail img").attr({src:fz});j.find(".file-type").text(fB);j.find(".file-size").text(fw.file.size);j.find(".file-modified").text(fw.file.ago||"");fo.on("click",function(){return bZ.unsafeRedirect(fs)});fw.modal_type=fw._MODAL_FILEINFO;fw._listen();fw._log_view(Date.now()-fw._start_time,fy,aW.FileViewModeType.FILE_INFO);fw._update_title_bar_buttons();return fw._initial_resize()}})(this);fk=this._get_extension(this.file.filename);fv=((fl=this.file.preview_type)==="doc"||fl==="excel"||fl==="keynote"||fl==="adobecs"||fl==="linkfile")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||aA.file_extension(this.file.filename).toLowerCase()!=="pdf")&&!bZ.msie_version_at_most(9);this.has_preview=d2.isFlippable(this.file.preview_type)||(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(this.file.preview_type==="linkfile")||((fv&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE)&&(!this.file_locked));i=fv&&this._preview_progressive_try(fk)&&this.file.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE&&!this.file_locked;if(this.has_preview||i){return fm(false,!(this.file.preview_type==="doc"),false,false,this.has_preview)}ft=this.file_locked||(fv&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS);if(!ft){return T()}fp();fq=G({path:"/doc_preview_status"+this.file.fq_path}).toString();fn=Date.now();return(fr=(function(fw){return function(){var fx;fx=Date.now();if(fx-fn>=5000){setTimeout(bD.proxy(fw.render_file_failed,fw),0);return}return fw.preview_status_request=bD.ajax(fq,{success:function(fy){if(fw.file){return fw.file.doc_preview_status=parseInt(fy,10)}},complete:function(fy,fz){if(fz==="abort"){return}if(fw.file_locked){return}if(fw.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){fw.has_preview=true;return fm(true,false,true,true)}else{if(fw.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return fw.preview_status_timeout_obj=setTimeout(fr,1000)}else{fw.render_file_failed()}}},timeout:5000-(fx-fn),subject_user:fw.active_user})}})(this))()},switch_preview:function(T,j,fl,fm){var fk,i;if((T!=null)||(j!=null)){if(this.file!=null){this.annotation_enabled_for_this_revision=fl;if(T!=null){this.file.href=T}if(j!=null){this.file.direct_blockserver_link=j}fk=bD("#file-viewer .preview-content-container");if(this.file.preview_type!=="photo"){i="";fk.html(i)}return this._render_preview(false,true,fm,T)}}},_remove_loading:function(i){var j;if(i==null){i=true}j=bD("#file-viewer .loading");j.hide();j.css("z-index","");return this.is_loaded=i},_render_blank:function(){var j,i;j=bD("#file-viewer .preview-content-container");i=dA.createElement(H,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size});return dA.render(i,j.get(0))},_render_linkfile:function(){var j,i;j=bD("#file-viewer .preview-content-container");i=dA.createElement(S,{filename:this.file.filename,source:"browse","authenticated-data-link":true});return dA.render(i,j.get(0))},_update_title_bar_buttons:function(){var T,j,fq,fA,fv,fp,ft,fw,fE,fr,fs,fm,fk,i,fy,fn,fl,fC,fD,fo,fx,fu,fz,fB,fF;fp=bD("#file-viewer");fv=fp.find(".share-button");if(this._file_view_mode_is_shared_or_member_link()){fv.remove()}T=fp.find(".download-button");j=fp.find(".split-button.openwith");fA=j!=null?j.find(".main-button"):void 0;fq=j!=null?j.find(".more-button"):void 0;fE=ey("Open",{comment:"Open a file natively on the user's computer"});fw=function(){return fp.data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)};ft=(function(fG){return function(fI){var fJ,fH;return fp.data("is-openwith-allowed")==="True"&&((fJ=__CONDITIONAL_JS__.OpenWith)!=null?fJ.get_open_handler_for(fI,fG.active_user):void 0)&&fI.bytes<((fH=__CONDITIONAL_JS__.OpenWith)!=null?fH.MAX_SUPPORTED_FILE_SIZE_B:void 0)&&fI.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC}})(this);fC=(function(fG){return function(fH){return __CONDITIONAL_JS__.UnityFeatures.open_file(fG.file.ns_id,fG.file.ns_path,fG.file.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fI){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)},fH)}})(this);fn=function(){return fC(false)};fl=function(){return fC(true)};fD=(function(fG){return function(){var fI,fH,fJ;fI=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fG.file,fG.active_user);if(fI){if((fJ=__CONDITIONAL_JS__.OpenWithMicrosoftLogger)!=null){fJ.log_open_button_pressed(fG.active_user.id,aA.file_extension(fG.file.filename).toLowerCase(),fG.file.ns_id,fG.file.ns_path)}fH=fI.uri+"?hpt_click_ts="+Date.now();return bZ.redirect(fH)}}})(this);fF=(function(fG){return function(fO,fP,fH){var fL,fK,fQ,fJ,fI,fS,fM,fN,fR;fR=[];fM=fP!=null;if(fM&&(fP.can_open_directly||(fP.can_open_directly==null))){fL=fP.open_application_name||ey("Open");fN=ey("Desktop");if(__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fN=ey("Open in %(app_name)s").format({app_name:fL})}fR.push({id:"ow_desktop",label:fN,icon:"ow_desktop",callback:fn})}if(fO){fS=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fG.file,fG.active_user);fR.push({id:"ow_web",label:fS.name,icon:fS.icon,callback:fD})}if(fM&&__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fI=fP.file_browser_display_name||ey("File Browser");fN=ey("Show in %(file_browser)s").format({file_browser:fI});if(fM&&!fP.can_open_directly&&!fO){fE=fN}fR.push({id:"ow_folder",label:fN,icon:"ow_folder",callback:fl})}fu(fE,fR);if(!fO&&!fM){fQ=false}else{if(fM){fQ=false}else{fQ=true}}if(!fQ&&!fH){fG._hide_more_button()}else{fG._show_more_button(fH,fQ)}fK=function(fT,fV,fW,fU){if(fG._open_button_update_state_timeout){clearTimeout(fG._open_button_update_state_timeout)}return fG._open_button_update_state_timeout=setTimeout((function(){fG.globalOpenWithWebButtonStateModel.set({user_id:fT,state:fV,file_extension:fW,target_button:fU});return fG._open_button_update_state_timeout=null}),200)};if(fO){fJ=aA.file_extension(fG.file.filename).toLowerCase();if(fM){return fK(fG.active_user.id,"visible",fJ,fq)}else{return fK(fG.active_user.id,"visible",fJ,fA)}}else{return fK(null,"hidden",null,null)}}})(this);fz=function(fG){if(j!=null){j.toggleClass("shown",fG)}return T.toggle(!fG)};fu=function(fH,fG){if(!(fG instanceof Array)){fG=[fG]}if(fG.length===0){return fz(false)}else{if(fG.length===1){return fm(fH,fG[0].callback)}else{return fk(fH,fG)}}};fm=function(fG,fH){if((j==null)&&(fA==null)){return}fz(true);j.removeClass("split");fA.text(fG);return fA.off("click").on("click",fH)};fk=function(fM,fH){var fL,fK,fI,fG,fJ;if((j==null)&&(fA==null)&&(fq==null)){return}fz(true);j.addClass("split");fA.text(fM);fL=fp.find(".openwith-dropdown");fA.off("click").on("click",function(fN){return fH[0].callback(fN)});fq.off("click").on("click",function(fO){var fN;fN=bD(this).parent().siblings(".openwith-dropdown");if(fN.is(":visible")){return}fN.removeAttr("style");eR.show(fN,this,null,true);return fO.stopPropagation()});fL.find("li").hide();fK=function(fN){var fO;fO=fL.find("."+fN.id);fO.find("a .sprite-text-inner").text(fN.label);cv.src(fO.find("a .sprite")[0],"web",fN.icon);fO.find("a").off("click").on("click",function(fP){fP.preventDefault();return fN.callback(fP)});return fO.show()};for(fI=0,fG=fH.length;fI<fG;fI++){fJ=fH[fI];fK(fJ)}return bD("#file-viewer-container").off("click",eR.hide_all).on("click",eR.hide_all)};fB=!!fw();fr=!!ft(this.file);fs=!!this.file.tkey;fF(fr,null,fs);if(fB){i=function(fG){var fH,fI;fI=function(fJ){fG.file_browser_display_name=fJ;return fF(fr,fG,fs)};fH=function(){return fF(fr,null,fs)};return __CONDITIONAL_JS__.UnityFeatures.file_browser_display_name(fI,fH)};if((fo=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fo.is_cached_and_locally_available(this.file.ns_id,this.file.ns_path):void 0){return i((fx=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fx.get(this.file.ns_id,this.file.ns_path):void 0)}else{fy=function(fG){if(fG.is_locally_available){return i(fG)}};return __CONDITIONAL_JS__.UnityFeatures.check_file(this.file.ns_id,this.file.ns_path,this.file.user_id,fy)}}},_show_more_button:function(fn,j){var fl,fm,T,fk,i;i=bD("#file-viewer");fl=i.find(".more-options-button");fl.show();T=i.find(".more-options-dropdown");fl.on("click",function(fo){if(T.is(":visible")){return}eR.show(T,fl,null,true);return fo.stopPropagation()});bD("#file-viewer-container").on("click",eR.hide_all);fk=T.find(".remove-link");fk.off("click");if(fn){fk.show();fk.on("click",(function(fo){return function(fp){eR.hide_all();return am.confirm_remove(fo.file.filename,fo.file.tkey,0,0,0,fo.file.user_id)}})(this))}else{fk.hide()}fm=T.find(".download-button");return fm.toggle(j)},_hide_more_button:function(){var j,i;i=bD("#file-viewer");j=i.find(".more-options-button");j.off("click").hide();bD("#file-viewer-container").off("click",eR.hide_all);return i.find(".remove-link").off("click")},_initial_resize:function(){var i;if(this.is_loaded){return}i=function(){return bD("window").trigger("resize")};return setTimeout(i,0)},_is_pptx_slim_enabled:function(){return az.getGandalfRule("docpreview-pptx-slim")},_get_progressive_url:function(fl,fk){var fm,i,T,j;j=this.active_user;fl=this._get_preview_type_from_extension(fl);T=G.parse(fk);i=false;if(fl==="doc"||fl==="key"||fl==="keynote"||fl==="adobecs"){if(!(Constants.PDF_PREVIEW_MODE==="pdf-js")){T=T.updateQuery({post_message_on_failure:1})}}else{if(fl==="ppt"&&!this._is_pptx_slim_enabled()){fm="private_progressive_viewer";i=true}else{if(fl==="xls"){if(j.xls_edit){fm="xls/edit"}else{fm="xls/preview"}}}}if(fm){if(i){T.setAuthority(Constants.WEBSERVER)}else{T.setAuthority(T.getAuthority().replace("dl-web","dl-doc"))}T.setPath(T.getPath().replace("/pri/get/","/get/"));T.setPath(T.getPath().replace("/get/","/"+fm+"/"))}T=T.updateQuery({get_preview:1,rams_ui:this._is_rams_ui()?1:0,saveas:this._is_saveas_experiment_enabled()?1:0});return T},_get_pdf_js_url:function(i){if(Constants.PDF_PREVIEW_MODE==="pdf-js"){i=G.parse(Constants.static_url_pdfjs_viewer)}return i},_preview_is_progressive:function(i){i=this._get_preview_type_from_extension(i);return i==="doc"||i==="ppt"||i==="xls"||i==="key"||i==="keynote"||i==="eps"||i==="ai"},_preview_progressive_try:function(j){var T,i;if(!this._preview_is_progressive(j)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}j=this._get_preview_type_from_extension(j);T=this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED;i=j==="key"||j==="keynote";return T||i},_set_previews_sandbox_params:function(j,i){j=this._get_preview_type_from_extension(j);if(j!=="xls"){return""}else{return null}},_prepare_annotation_url:function(i){if(this._is_annotation_marker_enabled()){i=i.updateQuery("annotation_marker","1")}if(this._is_annotation_highlight_enabled()){i=i.updateQuery("annotation_highlight","1")}if(this._is_annotation_region_enabled()){i=i.updateQuery("annotation_region","1")}return i},_render_preview:function(fE,fB,fn,fz){var fk,fo,fs,fC,fx,fl,fF,ft,fA,fr,fH,fD,fG,fI,fq,fy,T,fv,fp,fw,fu,fm;if(fE==null){fE=false}if(fB==null){fB=true}if(fn==null){fn=null}if(fz==null){fz=null}fq=(function(i){return function(){i._remove_loading();return typeof fn==="function"?fn():void 0}})(this);if(fE){this._remove_loading(false)}fy=bD("#file-viewer .preview-content-container");if(fy.find("iframe").length>0){return}if(this.file.htmlified_link){ft=bD("<iframe/>",{src:this.file.htmlified_link,sandbox:"allow-scripts allow-forms"});fy.append(ft);return ft.on("load",fq)}else{if(this.file.preview_type==="doc"){fs=this._get_extension(this.file.filename);fo=this._get_preview_type_from_extension(fs);if(fo==="ppt"&&!this._is_pptx_slim_enabled()){fm=this._get_progressive_url(fs,this.file.href);ft=bD("<iframe/>",{src:fm.toString(),allowfullscreen:"",type:"application/pdf"});fy.append(ft)}else{if(az.getGandalfRule("security-primodel")){fm=this._get_progressive_url(fs,this.file.direct_blockserver_link)}else{fm=this._get_progressive_url(fs,this.file.href)}if(this.active_user.inline_commenting){bD("#file-viewer-container").css({marginLeft:"0",width:"90%",left:"5%"});fm.setAuthority(fm.getAuthority().replace("dl-web","dl-doc"));fm.setPath(fm.getPath().replace("/get/","/dochax_private_commentless_preview/"));fx=fm.toString();fm=G.parse(Constants.static_url_pdfjs_hack_viewer);fm.setQuery({file:fx})}else{if(!fB){fm=fm.updateQuery({generate_preview:1});fm.setAuthority(fm.getAuthority().replace("dl-web","dl-doc"))}fH=fo==="ppt"&&this._is_pptx_slim_enabled();fm.updateQuery("sjid",this.file.sjid);this._pdfLoader.openFile(fm,{presentationMode:fH});fm=this._get_pdf_js_url()}fm=fm.updateQuery(Constants.UID_PARAM_NAME,this.active_user);fm=this._prepare_annotation_url(fm);ft=bD("<iframe/>",{src:String(fm),type:"application/pdf"});ft.addClass("pdfjs");fy.append(ft)}return ft.on("load",fq)}else{if(this.file.preview_type==="html"){ft=bD("<iframe/>",{src:this.file.href,sandbox:""});fy.append(ft);return ft.on("load",fq)}else{if(this.file.preview_type==="excel"){if(az.getGandalfRule("security-primodel")){fm=this._get_progressive_url("xls",this.file.direct_blockserver_link)}else{fm=this._get_progressive_url("xls",this.file.href)}ft=bD("<iframe/>",{src:fm,sandbox:"allow-scripts allow-forms"});this._set_previews_sandbox_params("xls",ft);fy.append(ft);return ft.on("load",fq)}else{if(this.file.preview_type==="keynote"){fm=this._get_progressive_url("html",this.file.href);fm=fm.updateQuery({generate_preview:1});fm=fm.updateQuery({post_message_on_failure:1});ft=bD("<iframe/>",{src:fm,type:"text/html"});fy.append(ft);return ft.on("load",fq)}else{if(this.file.preview_type==="adobecs"){if(az.getGandalfRule("security-primodel")){fm=this._get_progressive_url("adobecs",this.file.direct_blockserver_link)}else{fm=this._get_progressive_url("adobecs",this.file.href)}fm=fm.updateQuery({generate_preview:1});this._pdfLoader.openFile(fm);fm=this._get_pdf_js_url();fm=fm.updateQuery(Constants.UID_PARAM_NAME,this.active_user);fm=this._prepare_annotation_url(fm);ft=bD("<iframe/>",{src:String(fm),type:"application/pdf"});ft.addClass("pdfjs");fy.append(ft);return ft.on("load",fq)}else{if(this.file.preview_type==="linkfile"){this._remove_loading();return this._render_linkfile()}else{fk=this.currentFlippableFileIndex();fC=this._get_extension(this.file.filename);if(d2.isFlippable(this.file.preview_type)){bD("#file-viewer .loading").css("z-index","1");if(this.file.preview_type==="video"){fv=typeof this.file.video_transcode_url==="string"?this.file.video_transcode_url:this.file.fq_path!=null?br.video_transcode_url(this.file.fq_path,this.file.hash,this.active_user):void 0;fu=this.file.thumbnail_url_tmpl}else{if(this.file.preview_type==="photo"&&!(fC==="gif"&&this.file.bytes>Constants.MAX_GIF_FILE_SIZE_B)){if(fC==="gif"){fu=this.file.href}else{if(fz){fu=fz}else{fu=this.file.thumbnail_url_tmpl}}fA=[];fp=[1,2,3,4,5,6,-1,-2];for(fD=0,fG=fp.length;fD<fG;fD++){fF=fp[fD];fr=fk+fF;if(0<=fr&&fr<this.flippable_files.length){fA.push(this.flippable_files[fr].thumbnail_url_tmpl)}}}}fl={"preview-type":this.file.preview_type,"preview-url":fv,"thumbnail-url-tmpl":fu,"file-extension":fC,"file-meta":{filename:this.file.filename,mtime:this.file.ts,formattedSize:this.file.size},imagesToPreload:fA,index:fk,count:this.flippable_files.length,totalFiles:this.total_files,onPrevious:(function(i){return function(){return i.loadPreviousFlippable()}})(this),onNext:(function(i){return function(){return i.loadNextFlippable()}})(this),onLoad:fq,onError:(function(i){return function(){i._remove_loading()}})(this)};if((fw=this._preview_flippable_component)!=null?fw.isMounted():void 0){fI=this._preview_flippable_component.props;return this._preview_flippable_component.setProps(fl)}else{T=dA.createElement(d2,fl);return this._preview_flippable_component=dA.render(T,fy.get(0))}}else{return this._render_blank()}}}}}}}}},post_preview_message:function(fq){var fp,fk,fn,fl,fo,fr,T,fm,i;fn=bD("#file-viewer .preview-content-container iframe");fm=[];for(fl=0,fo=fn.length;fl<fo;fl++){fk=fn[fl];i=fk.src;T="://";fr=i.indexOf(T);if(fr===-1){fp=i.indexOf("/")}else{fp=i.indexOf("/",fr+T.length)}if(fp!==-1){i=i.substring(0,fp)}fm.push(fk.contentWindow.postMessage(fq,i))}return fm},_watchFile:function(){if(!az.getGandalfRule("tap-to-refresh")){return}return this.subscription=aa.subscribe(this.file,this.active_user,this._onFileUpdate.bind(this))},_onFileUpdate:function(){if(this.file_locked){this.cancel_check_lock();this._render_preview(true,false)}n.post_preview_message('{"action":"notify_sfj"}');return ah.success(ey("Someone edited this file."))},_unwatchFile:function(){if(!this.subscription){return}this.subscription.cancel();return delete this.subscription},loadPreviousFlippable:function(){var i;if(d2.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()>0){this.load(this.flippable_files[this.currentFlippableFileIndex()-1]);this.set_preview_url();i=this._getFilesToPreloadActivities();return bD("#file-viewer").trigger("db:filepreview:prev",[this.file,this.file_view_mode,this.active_user.id,i])}},loadNextFlippable:function(){var i;if(d2.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()<this.flippable_files.length-1){this.load(this.flippable_files[this.currentFlippableFileIndex()+1]);this.set_preview_url();i=this._getFilesToPreloadActivities();return bD("#file-viewer").trigger("db:filepreview:next",[this.file,this.file_view_mode,this.active_user.id,i])}},_listen:function(){var j,i,T;j=bD("#file-viewer");this._pdfLoader.startListening();cL.addFileDragEnabledCheck(this._is_browse_drag_enabled);j.find(".js-close-button").on("click",bD.proxy(this._on_close,this));this._watchFile();if(!this.has_key_listener){key("esc",this.KEY_SCOPE,(function(fk){return function(fl){if(eU.isFullscreen()||C.focus_in_input()||C.is_input(fl.target)){return}return fk._teardown_and_hide()}})(this));key("left",this.KEY_SCOPE,(function(fk){return function(fl){return fk.loadPreviousFlippable()}})(this));key("right",this.KEY_SCOPE,(function(fk){return function(fl){return fk.loadNextFlippable()}})(this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){j.find(".share-button").on("click",bD.proxy(this._share,this));T=(function(fk){return function(fl){if(fk.file.fq_path.toLowerCase()===fl.memo.fq_path.toLowerCase()){fk.file.tkey=fl.memo.tkey;return fk._update_title_bar_buttons()}}})(this);i=(function(fk){return function(fl){if(fk.file.tkey===fl.memo.token){fk.file.tkey=null;return fk._update_title_bar_buttons()}}})(this);this.share_link_callback=T.bind(this);this.remove_link_callback=i.bind(this);document.observe(aH.LINKS_ADD,this.share_link_callback);document.observe(aH.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){j.find(".share-button").on("click",bD.proxy(this._share,this))}}bD(window).on("resize",bD.proxy(this._resize,this));this.handleMessageFromChild=function(fk){switch(fk.action){case"failed":return n.render_file_failed();case"lock_preview":return n.preview_locked=true;case"unlock_preview":return n.preview_locked=false;case"toggle_preview_lock":return n.preview_locked=!n.preview_locked;case"hide_iframe":return n._teardown_and_hide();case"loaded":return n.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return n._handle_page_rendered(fk.parameters)}};this._frameMessenger=new er();this._frameMessenger.configureChildMessaging(".preview-content-container > iframe",bD.proxy(this.handleMessageFromChild,this),["failed","lock_preview","unlock_preview","toggle_preview_lock","hide_iframe","loaded","pagerendered"]);this._frameMessenger.startListening();return window.onbeforeunload=function(fk){if(n.preview_locked){return""}else{return void 0}}},_unlisten:function(){var i;i=bD("#file-viewer");this._pdfLoader.stopListening();i.off("click",bD.proxy(this._teardown_and_hide,this));cL.removeFileDragEnabledCheck(this._is_browse_drag_enabled);i.find("#file-viewer-container").off("click",function(j){return j.stopPropagation()});i.find(".js-close-button").off("click",bD.proxy(this._on_close,this));if(this.modal_type===this._MODAL_PREVIEW){i.find(".share-button").off("click",bD.proxy(this._share,this));i.find(".download-button").off("click");bD(document).off("click",eR.hide_all);document.stopObserving(aH.LINKS_ADD,this.share_link_callback);document.stopObserving(aH.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){i.find(".share-button").off("click",bD.proxy(this._share,this))}}bD(window).off("resize",bD.proxy(this._resize,this));key.setScope(this.prev_scope);return this._unwatchFile()},_resize:function(T){var j,i;if(!this._is_rams_ui()){j=bD("#file-viewer");i=j.find("#file-viewer-container").height()-(j.find(".title-bar").height()+1);j.find(".preview").height(i);return j.trigger("height-resize",{height:i})}},_share:function(i){a9.ShmodelUILogger.log("via-browse-file-viewer");i.preventDefault();return new df(this.active_user.id,this.file.fq_path,"file_viewer").show()},_on_close:function(i){i.preventDefault();return this._teardown_and_hide()},_teardown_and_hide:function(){var i;if(this.hiding){return}this.hiding=true;this.clear_preview_url_timer();this.unload_office_static();this.globalPreviewStateModel.set({state:"closed",file_obj:null});if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this._file_view_mode_is_browse()){eV.set_selected_files(this.file)}if(this._file_view_mode_is_browse()||this._file_view_mode_is_shared_or_member_link()){n.unset_preview_url()}C.scroll_unlock_document();i=bD("#file-viewer");return i.css("pointer-events","none").fadeOut({duration:this._FADE_MSEC,always:(function(j){return function(){var fl,fk,T;if(eU.isFullscreen()){eU.exitFullscreen()}if(__CONDITIONAL_JS__.UnityFeatures!=null){T=ey("Download");fl=i.find(".download-button");fl.text(T);fl.off("click")}j._hide_more_button();i.removeClass("has-preview").removeClass("no-preview");fk=i.find(".preview-content-container");dA.unmountComponentAtNode(fk.get(0));j._preview_flippable_component=null;fk.empty();i.find(".file-thumbnail img").attr({src:""});i.find(".title-bar .filename").text("");i.attr({"class":""});j._unlisten();j._remove_loading();document.title=j._cached_browser_window_title;j._cached_browser_window_title=null;j.last_file=j.file;j.file=null;j.preview_locked=false;window.removeEventListener("message",j.preview_lock_listener);j.is_loaded=false;j.hiding=false;j.cancel_check_lock();i.trigger("db:filepreview:close")}})(this)})},_handle_page_rendered:function(i){var fk,fl,fq,fo,fr,fp,T,fm,fn;if(!this._first_render_completed){fk=aA.file_extension_for_logging(this.file.filename);fn=i.stats;fp=((T=this.file)!=null?T.bytes:void 0)!=null?this.file.bytes:0;fo=bD.extend(i.attributes,{total_time:Date.now()-this._start_time,file_ext:fk,source:"file-viewer",originalSize:fp,docPreviewStatus:this.file.doc_preview_status});for(fl=0,fq=fn.length;fl<fq;fl++){fm=fn[fl];fr=(function(){switch(fm.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();fo[fr]=fm.end-fm.start}a9.UserActivityLogger.log("web","file_view_first_page_rendered",fo);a9.PreviewActivityLogger.log("file_view_first_page_rendered",{file_ext:fk,extra:JSON.stringify(fo)});return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._teardown_and_hide()},_is_annotation_marker_enabled:function(){return bD("#file-viewer").attr("data-docpreview-annotation-marker-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_highlight_enabled:function(){return bD("#file-viewer").attr("data-docpreview-annotation-highlight-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_region_enabled:function(){return bD("#file-viewer").attr("data-docpreview-annotation-region-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_saveas_experiment_enabled:function(){return bD("#file-viewer").attr("data-docpreview-saveas-experiment")==="True"},_is_rams_ui:function(){return bD("#file-viewer").attr("data-docpreview-ui-rams-enabled")==="True"}};var dX;dX=E.Index2={init:function(fq,fk){var fo,fr,fp,j,T,fl,fs,fm,i;if(fk){bD("#sign-in").on("click",function(fx){var fn,fv,fu,ft,fw;fx.preventDefault();fu=bD("#sign-in-form");fa.show(ey("Sign in"),fu[0],false,false,416,false,"sign-in-modal");fv=fu.find("#login_email");fv.focus();return new b6(fn=fv,fw=function(){fu.find("#password-field").hide();fu.find("#remember-me").hide();fu.find("#login_submit").val(ey("Continue"));fu.find("#forgot_password_link").hide();return fu.find("#sso_description_footer").show()},ft=function(){fu.find("#password-field").show();fu.find("#remember-me").show();fu.find("#login_submit").val(ey("Sign in"));fu.find("#forgot_password_link").show();return fu.find("#sso_description_footer").hide()})})}fo=function(){if(!bD("#signup-container").hasClass("form_shown")){return bD.when(bD("#signup-container").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){bD("#signup-container").addClass("form_shown");return bD("#signup-container .text-input input:visible").first().focus()})}};if(!fq){bD(".register").find(".login-button").on("click",function(fn){if(!bD("#signup-container").hasClass("form_shown")){fn.preventDefault();return fo()}});dX.animate()}else{bD(".photo").show()}fr=function(){if(!bD("#signup-container").hasClass("form_shown")){return bD(".register").find(".login-button").trigger("click")}};bD(".buttons .freshbutton-blue").on("click",function(fn){fn.preventDefault();bD("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:fr});return false});bD("#learn-more").on("click",function(fn){fn.preventDefault();bD("html, body").animate({scrollTop:bD("#divider").offset().top},{queue:false,duration:500});return false});if(bu.are_enabled()){a9.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{ah.error(ey("Please enable browser-cookies to use the Dropbox website."))}i=["#devices-background",".register-button","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];fp=function(fn){return bD(fn).on("click",function(){return a9.WebMiscActivityLogger.log("index_page",{event_name:"click",id:fn})})};for(T=0,fl=i.length;T<fl;T++){j=i[T];fp(j)}fm=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];fs={};return bD(window).scroll(function(){var fy,fz,fx,fv,ft,fn,fu,fw;fw=[];for(fn=0,fu=fm.length;fn<fu;fn++){fx=fm[fn];if(bD(fx).length&&!fs[fx]){fz=bD(window).scrollTop();fy=fz+bD(window).outerHeight();ft=bD(fx).offset().top;fv=ft+bD(fx).outerHeight();if(fv<=fy){a9.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:fx});fw.push(fs[fx]=true)}else{fw.push(void 0)}}else{fw.push(void 0)}}return fw})},_animate_points:function(fp,fq,fr,fk,ft,fo,T){var fm,fl,fn,fs;if(T==null){T=0}T=Math.min(Math.max(T,0),1);fn=fo(T);fs=[(function(){var i,fu,j;j=[];for(fm=i=0,fu=fq.length;0<=fu?i<fu:i>fu;fm=0<=fu?++i:--i){j.push([(function(){var fv,fw;fw=[];for(fl=fv=0;fv<2;fl=++fv){fw.push(fq[fm][fl]+(fr[fm][fl]-fq[fm][fl])*fn)}return fw})()])}return j})()];fp.attr("points",dX.points_array_to_str(fs));if(T>=1){return ft.resolve()}else{return setTimeout(function(){return dX._animate_points(fp,fq,fr,fk,ft,fo,T+(10/fk))},10)}},animate_points:function(j,fn,fm,T,fl,fk){var i;if(fk==null){fk=jQuery.easing.linear}i=bD.Deferred();dX._animate_points(j,fn,fm,T,i,fk);return i.done(function(){return typeof fl==="function"?fl():void 0}).promise()},animate_hide_rects:function(fk,fp,fq){var T,fm,fl,j,fo;T=bD.Deferred().resolve().promise();fm=function(fn){var fv,fs,fu,fr,ft;fr=bD(fk[fn]);fv=dX.points_str_to_array(fr.attr("points"));ft=[fv[1],fv[1],fv[2],fv[2]];fs=dX.inverse(jQuery.easing.linear);fu=fp*(fs((fn+1)/fk.length)-fs(fn/fk.length));return T=T.then(function(){return dX.animate_points(fr,fv,ft,fu)})};for(fl=j=0,fo=fk.length;0<=fo?j<fo:j>fo;fl=0<=fo?++j:--j){fm(fl)}return T.done(function(){return typeof fq==="function"?fq():void 0}).promise()},animate_delay:function(j){var i;i=bD.Deferred();setTimeout(i.resolve,j);return i.promise()},animate:function(){return bD.Deferred().resolve().promise().then(function(){return dX.animate_docs()}).then(function(){return dX.animate_graphs()}).then(function(){return dX.animate_photos()})},inverse:function(j,i){if(i==null){i=0.000001}return function(fm){var fk,fl,T;fl=0;fk=1;while(fk-fl>i){T=(fl+fk)/2;if(j(T)<fm){fl=T}else{fk=T}}return fl}},points_str_to_array:function(fo){var fl,T,j,fn,fm,fk;fm=fo.split(" ");fk=[];for(T=0,j=fm.length;T<j;T++){fn=fm[T];fk.push((function(){var i,fr,fp,fq;fp=fn.split(",");fq=[];for(i=0,fr=fp.length;i<fr;i++){fl=fp[i];fq.push(parseFloat(fl))}return fq})())}return fk},points_array_to_str:function(j){var i;return((function(){var fk,T,fl;fl=[];for(fk=0,T=j.length;fk<T;fk++){i=j[fk];fl.push(i.join(","))}return fl})()).join(" ")},animate_docs:function(){var fn,fk,i,fl,T,fm,j;j=[[5,6],[177,1],[184,157],[13,180]];i="";for(fm=fk=0.475;fk<=0.625;fm=fk+=0.05){fn=fm+0.05;fl=[[j[0][0]+(j[3][0]-j[0][0])*fm,j[0][1]+(j[3][1]-j[0][1])*fm],[j[1][0]+(j[2][0]-j[1][0])*fm,j[1][1]+(j[2][1]-j[1][1])*fm],[j[1][0]+(j[2][0]-j[1][0])*fn,j[1][1]+(j[2][1]-j[1][1])*fn],[j[0][0]+(j[3][0]-j[0][0])*fn,j[0][1]+(j[3][1]-j[0][1])*fn]];fl=dX.points_array_to_str(fl);i+="<polygon points='"+fl+"' style='fill:#f5f9fc;stroke:none;' />"}T=bD('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+i+"\n</svg>");return bD.Deferred().resolve().promise().then(function(){bD(".doc, .graph, .photo").hide();bD(".comp.doc").append(T);return bD(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return dX.animate_hide_rects(T.find("polygon"),2500,function(){return T.remove()})}).then(function(){return dX.animate_delay(500)}).then(function(){return bD(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return dX.animate_delay(1500)}).then(function(){return bD(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var j,i;j=[[83,98],[158,37],[241,77],[171,145]];i=bD('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');i.find("polygon").attr("points",dX.points_array_to_str(j));return bD.Deferred().resolve().promise().then(function(){bD(".doc, .graph, .photo").hide();bD(".tablet.graph .graph-grid").hide();bD(".tablet.graph").append(i);return bD(".tablet.graph").show("fade",{},500).promise()}).then(function(){var T;T=[j[0],j[1],j[1],j[0]];return dX.animate_points(i.find("polygon"),j,T,600,function(){return i.remove()})}).then(function(){if(!bZ.msie_version_at_most(8)){return bD(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return dX.animate_delay(500)}).then(function(){return bD(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return dX.animate_delay(2000)}).then(function(){return bD(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return bD.Deferred().resolve().promise().then(function(){bD(".doc, .graph, .photo").hide();bD(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});bD(".phone.photo").show();return bD.when((function(){if(!bZ.msie_version_at_most(8)){return bD(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return bD.Deferred().resolve().promise().then(function(){return bD(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return dX.animate_delay(750)}).then(function(){return bD(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var bz,cm,eM;eM=E.UnsupportedBrowser={init:function(){return bD("#unsupported-browser-dismiss").on("click",function(i){i.preventDefault();e6.hide();return bD.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};cm=E.ExpiredCCNotificationBar={init:function(i){return bD(".expired-dismiss").on("click",function(j){j.preventDefault();e6.hide();return bD.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:i}})})}};bz=E.BetaLocaleNotificationBar={init:function(i){return bD(".beta-locale-dismiss").on("click",function(j){j.preventDefault();e6.hide();return bD.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:i}})})}};var e;e=INLINE_JS.viewer=cK.get_viewer();var L,ew,ev,b2,O,cb,e0,bB;if(!Constants.is_test){bD(eO.check_timezone)}if(window._document_observe_listeners){e0=window._document_observe_listeners;for(ew=0,b2=e0.length;ew<b2;ew++){cb=e0[ew];if(document.loaded){cb.func()}else{document.observe(cb.event,cb.func)}}}if(window._jquery_ready_handlers){bB=window._jquery_ready_handlers;for(ev=0,O=bB.length;ev<O;ev++){L=bB[ev];bD(L)}}bD(function(){return Event.fire(document,"script:loaded")});return E});